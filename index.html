<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skore Point | Professional School Report Card Generator</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4361ee">
  <meta name="description" content="Professional School Report Card Generator by SERUSOFT">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="/testing/manifest.json">
  <link rel="icon" href="/testing/skore-icon.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="/testing/skore-icon.jpg">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #4895ef;
      --secondary: #4cc9f0;
      --accent: #7209b7;
      --accent-light: #9d4edd;
      --dark: #0f172a;
      --darker: #0a0f1f;
      --light: #f8fafc;
      --gray: #334155;
      --gray-light: #64748b;
      --gray-lighter: #cbd5e1;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      --card-gradient: linear-gradient(135deg, rgba(67, 97, 238, 0.08) 0%, rgba(114, 9, 183, 0.08) 100%);
      --border-radius: 12px;
      --border-radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      font-size: 15px;
      line-height: 1.5;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient);
      opacity: 0.03;
      z-index: -1;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* PWA Install */
    .desktop-install-btn {
      position: fixed;
      bottom: 90px;
      right: 20px;
      background: linear-gradient(135deg, #ff0080, #ff8c00, #40e0d0);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 700;
      transition: var(--transition);
      display: none;
      align-items: center;
      gap: 10px;
      z-index: 1001;
      box-shadow: 0 8px 25px rgba(255, 0, 128, 0.4);
      animation: pulse 2s infinite;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 14px;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 0, 128, 0.7);
        transform: scale(1);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(255, 0, 128, 0);
        transform: scale(1.05);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(255, 0, 128, 0);
        transform: scale(1);
      }
    }

    .mobile-install-prompt {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      z-index: 9998;
      display: none;
      animation: slideUp 0.5s ease-out;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes slideUp {
      from {
        transform: translate(-50%, 100%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    .mobile-install-prompt.show {
      display: block;
    }

    .container {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .container.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .navbar {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .navbar-brand {
      font-size: 24px;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-brand i {
      font-size: 22px;
    }

    .navbar-nav {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-link {
      color: var(--light);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      z-index: 1000;
      padding: 10px 0;
    }

    .mobile-bottom-nav.active {
      display: flex;
    }

    .mobile-nav-items {
      display: flex;
      justify-content: space-around;
      width: 100%;
      position: relative;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--gray-lighter);
      text-decoration: none;
      padding: 8px;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      min-width: 60px;
      font-size: 12px;
      background: none;
      border: none;
      cursor: pointer;
      touch-action: manipulation;
    }

    .mobile-nav-item:hover,
    .mobile-nav-item.active {
      color: var(--primary);
      background: rgba(67, 97, 238, 0.1);
    }

    .mobile-portal-exit-btn {
      position: absolute;
      right: 10px;
      top: -45px;
      background: var(--error);
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 10px 15px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .portal-exit-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--error);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      box-shadow: var(--shadow);
      display: none;
    }

    .launch-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .launch-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      z-index: 2;
      max-width: 800px;
      width: 100%;
      height: 100%;
    }

    .logo-wrapper {
      position: relative;
      margin-bottom: 40px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .logo {
      font-size: clamp(40px, 8vw, 80px);
      font-weight: 800;
      color: white;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
      position: relative;
      display: inline-block;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                     0 0 30px rgba(255, 255, 255, 0.4);
      }
      to {
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
                     0 0 50px rgba(255, 255, 255, 0.6);
      }
    }

    .tagline {
      font-size: clamp(18px, 4vw, 24px);
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 50px;
      animation: fadeIn 2s ease-in;
      font-weight: 300;
      letter-spacing: 1px;
      line-height: 1.4;
      max-width: 600px;
    }

    .loader {
      width: min(300px, 80%);
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto;
      position: relative;
    }

    .loader-bar {
      height: 100%;
      background: linear-gradient(90deg, #fff, #f0f0f0, #fff);
      background-size: 200% 100%;
      border-radius: 10px;
      animation: loading 2s ease-in-out infinite;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    @keyframes loading {
      0% {
        width: 0%;
        background-position: 0% 0%;
      }
      50% {
        width: 70%;
        background-position: 100% 0%;
      }
      100% {
        width: 100%;
        background-position: 200% 0%;
      }
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 80px;
      transition: transform 0.3s ease;
    }

    .auth-container {
      width: 100%;
      max-width: 420px;
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 40px 30px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.6s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      margin: 20px auto;
    }

    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--gradient);
    }

    .close-auth-form {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--gray-light);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      z-index: 10;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-right: 30px;
    }

    .header h1 {
      font-size: 28px;
      letter-spacing: 1px;
      margin-bottom: 10px;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .header p {
      font-size: 15px;
      color: var(--gray-lighter);
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--gray-lighter);
      font-weight: 500;
    }

    .form-group i {
      margin-right: 8px;
      color: var(--primary-light);
      width: 16px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray);
      border-radius: var(--border-radius-sm);
      background: var(--darker);
      color: var(--light);
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .form-group select option {
      background-color: var(--darker);
      color: var(--light);
      padding: 10px;
      font-size: 15px;
    }

    .form-group select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 40px;
      cursor: pointer;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }

    .password-toggle {
      position: absolute;
      right: 15px;
      top: 40px;
      background: none;
      border: none;
      color: var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 5px;
      border-radius: 4px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-size: 15px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      touch-action: manipulation;
      user-select: none;
    }

    .btn-block {
      width: 100%;
    }

    .btn-primary {
      background: var(--gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
    }

    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .loading-state {
      display: none;
      text-align: center;
      padding: 20px;
      background: var(--darker);
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .loading-state.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }

    .alert {
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in;
    }

    .error { 
      background: rgba(239, 68, 68, 0.15); 
      border: 1px solid var(--error); 
      color: var(--error); 
    }
    
    .success { 
      background: rgba(16, 185, 129, 0.15); 
      border: 1px solid var(--success); 
      color: var(--success); 
    }
    
    .warning { 
      background: rgba(245, 158, 11, 0.15); 
      border: 1px solid var(--warning); 
      color: var(--warning); 
    }
    
    .info { 
      background: rgba(59, 130, 246, 0.15); 
      border: 1px solid var(--info); 
      color: var(--info); 
    }

    .footer-links {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--gray-light);
    }

    .footer-links button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      padding: 0 5px;
      touch-action: manipulation;
    }

    .dashboard {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-header h1 {
      font-size: clamp(24px, 5vw, 32px);
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }

    .user-info {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 400px;
    }

    .user-profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--primary);
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-light);
    }

    .user-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .user-role {
      font-weight: 700;
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      align-self: flex-start;
    }

    .user-role.admin {
      background: rgba(67, 97, 238, 0.2);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .user-role.teacher {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .user-name {
      font-weight: 600;
      color: var(--light);
      font-size: 18px;
    }

    .user-email {
      color: var(--gray-light);
      font-size: 14px;
    }

    .logout-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      touch-action: manipulation;
      align-self: flex-start;
      margin-top: 10px;
    }

    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .card {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
      border-color: rgba(67, 97, 238, 0.3);
    }

    .card i {
      font-size: 40px;
      margin-bottom: 20px;
      color: var(--primary-light);
    }

    .school-logo {
      max-width: 150px;
      max-height: 100px;
      margin: 15px 0;
      object-fit: contain;
      background: white;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--gray-lighter);
    }

    .school-management {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      min-height: calc(100vh - 80px);
    }

    .management-header {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 25px 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .management-header h2 {
      font-size: clamp(20px, 4vw, 28px);
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .school-code {
      background: rgba(67, 97, 238, 0.1);
      padding: 10px 20px;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      letter-spacing: 1px;
      border: 1px solid var(--primary);
      font-family: 'Courier New', monospace;
    }

    .management-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 30px;
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      white-space: nowrap;
      color: var(--gray-lighter);
      border: none;
      background: transparent;
      font-size: 15px;
      touch-action: manipulation;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    .list-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 80px;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .list-item {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    .item-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .file-upload {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 40px 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.02);
      position: relative;
    }

    .image-upload {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
    }

    .image-preview {
      max-width: 200px;
      max-height: 200px;
      margin: 0 auto 15px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      display: none;
    }

    .marks-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 80px;
    }

    .marks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .analytics-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
      margin-bottom: 25px;
    }

    .marks-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .student-search-container {
      position: relative;
      margin-bottom: 20px;
    }

    .student-search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .student-search-input {
      width: 100%;
      padding: 14px 50px 14px 45px;
      border: 2px solid var(--gray);
      border-radius: var(--border-radius-sm);
      background: var(--darker);
      color: var(--light);
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
    }

    .student-search-icon {
      position: absolute;
      left: 15px;
      color: var(--primary-light);
      font-size: 18px;
    }

    .student-search-clear {
      position: absolute;
      right: 15px;
      background: none;
      border: none;
      color: var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 5px;
      border-radius: 4px;
      display: none;
    }

    .student-search-clear.show {
      display: block;
    }

    .student-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark);
      border: 1px solid var(--gray);
      border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow);
    }

    .selected-student {
      background: rgba(67, 97, 238, 0.1);
      border: 1px solid var(--primary);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      margin-bottom: 30px;
    }

    .marks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .mark-input {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .mark-input input {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      background: var(--darker);
      border: 1px solid var(--gray);
      color: var(--light);
      border-radius: 6px;
    }

    .enhanced-report-card {
      background: white;
      color: #333;
      border-radius: 0;
      padding: 20px;
      margin: 20px auto 100px;
      border: 1px solid #ddd;
      position: relative;
      overflow: hidden;
      font-family: 'Times New Roman', Times, serif;
      width: 210mm;
      min-height: 297mm;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      page-break-inside: avoid;
      font-size: 11px;
    }

    .report-header {
      text-align: center;
      margin-bottom: 15px;
      position: relative;
      padding-top: 10px;
    }

    .skore-point-badge {
      position: absolute;
      left: 20px;
      top: 10px;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .skore-point-icon {
      width: 25px;
      height: 25px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .skore-point-text {
      font-size: 9px;
      font-weight: bold;
      color: #4361ee;
      margin: 0;
      line-height: 1.1;
    }

    .serusoft-text {
      font-size: 7px;
      color: #666;
      font-style: italic;
      margin: 1px 0 0 0;
      line-height: 1;
    }

    .school-logo-large {
      display: inline-block;
      margin: 0 auto 8px;
      width: 70px;
      height: 70px;
    }

    .school-name {
      font-size: 18px;
      font-weight: bold;
      margin: 3px 0 2px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #000;
    }

    .report-title {
      font-size: 14px;
      font-weight: bold;
      margin: 8px 0 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-decoration: underline;
      color: #000;
    }

    .student-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      font-size: 10px;
    }

    .subject-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      border: 1px solid #000;
      font-size: 10px;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 10px;
    }

    .signature-area {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 8px;
      border-top: 1px solid #000;
      font-size: 10px;
    }

    .subject-analytics-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 80px;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .subject-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .reports-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 80px;
    }

    .report-filters {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-light);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .full-screen-form {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark);
      z-index: 1000;
      overflow-y: auto;
      padding: 40px 20px;
      display: none;
    }

    .full-screen-form.active {
      display: block;
    }

    .close-fullscreen {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--error);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      z-index: 1001;
      transition: var(--transition);
    }

    .school-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark);
      border: 1px solid var(--gray);
      border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow);
    }

    .school-suggestion {
      padding: 12px 15px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .subject-assignment-container {
      max-height: 300px;
      overflow-y: auto;
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .offline-indicator {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      background: var(--warning);
      color: var(--dark);
      text-align: center;
      padding: 10px;
      font-weight: 600;
      z-index: 999;
      display: none;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }

    .pwa-installed-badge {
      position: fixed;
      top: 80px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      animation: slideInRight 0.5s ease-out;
      box-shadow: var(--shadow);
    }

    .teacher-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .marks-buttons-row {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .required {
      color: var(--error);
    }

    .d-none {
      display: none !important;
    }

    .mobile-only {
      display: none;
    }

    .desktop-only {
      display: block;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 12px 15px;
      }
      
      .navbar-nav {
        display: none !important;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .management-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .management-tabs.desktop-only {
        display: none;
      }
      
      .enhanced-report-card {
        padding: 15px;
        width: 100%;
        min-height: auto;
        font-size: 9px;
        margin-bottom: 150px;
      }
      
      .student-info-grid {
        grid-template-columns: 1fr;
        font-size: 9px;
      }
      
      .portal-exit-btn {
        display: none !important;
      }
      
      .list-grid {
        grid-template-columns: 1fr;
      }
      
      .analytics-filters {
        flex-direction: column;
      }
      
      .mobile-only {
        display: block !important;
      }
      
      .desktop-only {
        display: none !important;
      }
      
      .desktop-install-btn {
        display: none !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-bottom-nav {
        display: none !important;
      }
      
      .mobile-install-prompt {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">
    <i class="fas fa-wifi-slash"></i> You are currently offline
  </div>

  <!-- PWA Installed Badge -->
  <div class="pwa-installed-badge" id="pwaInstalledBadge" style="display: none;">
    <i class="fas fa-check-circle"></i> App Installed
  </div>

  <!-- PWA Install Prompts -->
  <div class="pwa-install-prompts">
    <button class="desktop-install-btn" id="desktopInstallBtn">
      <i class="fas fa-download"></i> Install App
    </button>
    
    <div class="mobile-install-prompt" id="mobileInstallPrompt">
      <button class="close-prompt" id="closeMobilePrompt">
        <i class="fas fa-times"></i>
      </button>
      <div class="mobile-install-header">
        <div class="mobile-install-icon">
          <i class="fas fa-graduation-cap"></i>
        </div>
        <h3>Install Skore Point</h3>
      </div>
      <div class="mobile-install-body">
        Install the Skore Point app for a better experience.
      </div>
      <div class="mobile-install-actions">
        <button class="mobile-install-btn primary" id="mobileInstallBtn">
          <i class="fas fa-plus"></i> Install App
        </button>
        <button class="mobile-install-btn secondary" id="laterMobileBtn">
          Later
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3 id="loadingText">Loading...</h3>
    </div>
  </div>

  <!-- LAUNCH SCREEN -->
  <div class="launch-screen" id="launchScreen">
    <div class="launch-container">
      <div class="logo-wrapper">
        <div class="logo">Skore Point</div>
      </div>
      <div class="tagline">Professional School Report Card Generator by SERUSOFT</div>
      <div class="loader">
        <div class="loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- FIXED NAVIGATION BAR -->
  <nav class="navbar" id="navbar">
    <div class="navbar-brand">
      <i class="fas fa-graduation-cap"></i> Skore Point
    </div>
    <div class="navbar-nav">
      <a href="#" class="nav-link" id="userGuideBtn">
        <i class="fas fa-question-circle"></i> User Guide
      </a>
      <button class="logout-btn desktop-only" id="desktopLogoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>

  <!-- MOBILE BOTTOM NAVIGATION -->
  <div class="mobile-bottom-nav" id="mobileBottomNav">
    <button class="mobile-portal-exit-btn" id="mobilePortalExitBtn">
      <i class="fas fa-door-closed"></i> Close Portal
    </button>
    <div class="mobile-nav-items">
      <button class="mobile-nav-item" data-tab="classes">
        <i class="fas fa-chalkboard"></i>
        <span>Classes</span>
      </button>
      <button class="mobile-nav-item" data-tab="students">
        <i class="fas fa-users"></i>
        <span>Students</span>
      </button>
      <button class="mobile-nav-item" data-tab="subjects">
        <i class="fas fa-book"></i>
        <span>Subjects</span>
      </button>
      <button class="mobile-nav-item" data-tab="teachers">
        <i class="fas fa-chalkboard-teacher"></i>
        <span>Teachers</span>
      </button>
      <button class="mobile-nav-item" data-tab="marks">
        <i class="fas fa-edit"></i>
        <span>Marks</span>
      </button>
      <button class="mobile-nav-item" data-tab="reports">
        <i class="fas fa-chart-bar"></i>
        <span id="reportsTabLabel">Reports</span>
      </button>
    </div>
  </div>

  <!-- DESKTOP PORTAL EXIT BUTTON -->
  <button class="portal-exit-btn desktop-only" id="portalExitBtn">
    <i class="fas fa-door-open"></i> Exit Portal
  </button>

  <!-- MAIN CONTENT CONTAINER -->
  <div class="main-container">
    
    <!-- LOGIN SECTION -->
    <div class="container" id="loginSection">
      <div class="auth-container">
        <div class="header">
          <h1>Welcome Back</h1>
          <p>Sign in to your account</p>
        </div>

        <div id="loginError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="loginErrorText"></span>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input type="email" id="loginEmail" placeholder="teacher@school.edu" required>
          </div>

          <div class="form-group">
            <label for="loginPassword">
              <i class="fas fa-lock"></i> Password
            </label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
            <button type="button" class="password-toggle" id="loginToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> Sign In
          </button>

          <div class="loading-state" id="loginLoading">
            <div class="loading-spinner"></div>
            <p class="loading-text">Signing in...</p>
          </div>
        </form>

        <div class="footer-links">
          <p>
            Don't have an account? 
            <button id="goRegister">Create User Account</button>
          </p>
          <p>
            <button id="forgotPassword">Forgot Password?</button>
          </p>
        </div>
      </div>
    </div>

    <!-- REGISTER SECTION -->
    <div class="container" id="registerSection">
      <div class="auth-container">
        <div class="header">
          <h1>Create User Account</h1>
          <p>Join Skore Point today</p>
        </div>

        <div id="registerError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="registerErrorText"></span>
        </div>

        <div id="registerSuccess" class="alert success d-none">
          <i class="fas fa-check-circle"></i>
          <span>Account created successfully!</span>
        </div>

        <form id="registerForm">
          <div class="form-group">
            <label for="regName">
              <i class="fas fa-user"></i> Full Name <span class="required">*</span>
            </label>
            <input type="text" id="regName" placeholder="John Doe" required>
          </div>

          <div class="form-group">
            <label for="regEmail">
              <i class="fas fa-envelope"></i> Email Address <span class="required">*</span>
            </label>
            <input type="email" id="regEmail" placeholder="john@school.edu" required>
          </div>

          <div class="form-group">
            <label for="regSubject">
              <i class="fas fa-book"></i> Primary Teaching Subject <span class="required">*</span>
            </label>
            <input type="text" id="regSubject" placeholder="Mathematics" required>
          </div>

          <div class="image-upload" id="profileUploadArea">
            <i class="fas fa-user-circle"></i>
            <p>Upload Profile Picture <span class="required">*</span></p>
            <span>Click to upload (Required)</span>
            <div class="image-preview profile-preview" id="profilePreview">
              <img id="profilePreviewImg" src="" alt="Profile Preview">
            </div>
            <input type="file" class="file-input" id="profileFile" accept="image/*" required>
            <input type="hidden" id="profileUrl">
            <div class="loading-state" id="profileUploadLoading">
              <div class="loading-spinner"></div>
              <p class="loading-text">Uploading...</p>
            </div>
          </div>

          <div class="form-group">
            <label for="regPassword">
              <i class="fas fa-lock"></i> Password <span class="required">*</span>
            </label>
            <input type="password" id="regPassword" placeholder="Minimum 6 characters" required minlength="6">
            <button type="button" class="password-toggle" id="registerToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div class="form-group">
            <label for="confirmPassword">
              <i class="fas fa-lock"></i> Confirm Password <span class="required">*</span>
            </label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <button type="button" class="password-toggle" id="confirmToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-user-plus"></i> Create User Account
          </button>

          <div class="loading-state" id="registerLoading">
            <div class="loading-spinner"></div>
            <p class="loading-text">Creating account...</p>
          </div>
        </form>

        <div class="footer-links">
          <p>
            Already have an account? 
            <button id="goLogin">Sign In</button>
          </p>
        </div>
      </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div class="container" id="dashboardSection">
      <div class="dashboard">
        <div class="dashboard-header">
          <h1>Dashboard</h1>
          <div class="user-info" id="userInfoCard">
            <!-- Profile picture and details will be loaded here -->
          </div>
        </div>

        <div class="dashboard-cards">
          <!-- School Portal Card -->
          <div class="card" id="manageSchoolCard" style="display: none;">
            <i class="fas fa-school"></i>
            <h3>School Portal</h3>
            <p>Access your school's management portal to manage classes, students, and generate reports.</p>
            <div id="schoolCardInfo" class="mt-30">
              <img id="schoolCardLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
              <h4 id="schoolCardName"></h4>
              <p>Code: <strong id="schoolCardCode"></strong></p>
              <div class="mt-20">
                <button class="btn btn-success btn-block" id="openSchoolPortalBtn">
                  <i class="fas fa-door-open"></i> Enter Portal
                </button>
              </div>
            </div>
          </div>

          <div class="card" id="joinSchoolCard">
            <i class="fas fa-user-plus"></i>
            <h3>Join School</h3>
            <p>Join an existing school using the school name and unique access code provided by your administrator.</p>
            <button class="btn btn-secondary btn-block mt-20" id="joinSchoolBtn">
              <i class="fas fa-sign-in-alt"></i> Join School
            </button>
          </div>

          <div class="card" id="registerSchoolCard">
            <i class="fas fa-plus-circle"></i>
            <h3>Register School</h3>
            <p>Create a new school on Skore Point and become the administrator. Get a unique code for other teachers to join.</p>
            <button class="btn btn-primary btn-block mt-20" id="registerSchoolBtn">
              <i class="fas fa-school"></i> Register School
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCHOOL MANAGEMENT SECTION -->
    <div class="container" id="schoolManagementSection">
      <div class="school-management">
        <div class="management-header">
          <div>
            <h2 id="managementSchoolName">School Name</h2>
            <div class="school-code mt-10">
              School Code: <span id="managementSchoolCode"></span>
            </div>
          </div>
          <img id="managementSchoolLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
          <button class="refresh-btn" id="refreshSchoolData">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>

        <!-- Academic Level Selector -->
        <div class="form-group mb-20" id="academicLevelSelector" style="display: none;">
          <label><i class="fas fa-graduation-cap"></i> Select Academic Level</label>
          <select id="academicLevelSelect" class="w-100">
            <option value="">Select Level</option>
            <option value="lower-primary">Lower Primary (P1-P3)</option>
            <option value="upper-primary">Upper Primary (P4-P7)</option>
            <option value="olevel">O-Level (S1-S4)</option>
            <option value="alevel">A-Level (S5-S6)</option>
          </select>
        </div>

        <!-- Desktop Tabs -->
        <div class="management-tabs desktop-only" id="managementTabs">
          <button class="tab active" data-tab="classes">
            <i class="fas fa-chalkboard"></i> Classes
          </button>
          <button class="tab" data-tab="students">
            <i class="fas fa-users"></i> Students
          </button>
          <button class="tab" data-tab="subjects">
            <i class="fas fa-book"></i> Subjects
          </button>
          <button class="tab" data-tab="teachers">
            <i class="fas fa-chalkboard-teacher"></i> Teachers
          </button>
          <button class="tab" data-tab="marks">
            <i class="fas fa-edit"></i> Enter Marks
          </button>
          <button class="tab" data-tab="reports" id="desktopReportsTab">
            <i class="fas fa-chart-bar"></i> <span id="desktopReportsLabel">Reports</span>
          </button>
        </div>

        <!-- Classes Tab -->
        <div class="tab-content active" id="classesTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Classes</h3>
              <div id="classPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to classes.
              </div>
              <button class="btn btn-primary" id="addClassBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Class
              </button>
            </div>

            <div class="list-grid" id="classList">
              <!-- Classes will be loaded here -->
            </div>

            <div class="empty-state d-none" id="classesEmptyState">
              <i class="fas fa-chalkboard"></i>
              <h3>No Classes Yet</h3>
              <p>Start by adding your first class to the school.</p>
            </div>
          </div>
        </div>

        <!-- Students Tab -->
        <div class="tab-content" id="studentsTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Students</h3>
              <div id="studentPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to students.
              </div>
              <button class="btn btn-primary" id="addStudentBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Student
              </button>
            </div>

            <div class="form-group mb-30">
              <label><i class="fas fa-filter"></i> Filter by Class</label>
              <select id="studentClassSelect" class="w-100">
                <option value="">All Classes</option>
              </select>
            </div>

            <div class="file-upload-container" id="studentUploadContainer" style="display: none;">
              <div class="file-upload" id="studentUploadArea">
                <i class="fas fa-file-excel"></i>
                <h4>Upload Student List</h4>
                <p>Upload an Excel file with student names. The first column should contain student names.</p>
                <span>Supported formats: .xlsx, .xls</span>
                <input type="file" class="file-input" id="studentFile" accept=".xlsx,.xls">
              </div>
            </div>

            <div class="list-grid" id="studentList">
              <!-- Students will be loaded here -->
            </div>

            <div class="empty-state d-none" id="studentsEmptyState">
              <i class="fas fa-users"></i>
              <h3>No Students Yet</h3>
              <p>Add students individually or upload an Excel file with student names.</p>
            </div>
          </div>
        </div>

        <!-- Subjects Tab -->
        <div class="tab-content" id="subjectsTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Subjects</h3>
              <div id="subjectPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to subjects.
              </div>
              <button class="btn btn-primary" id="addSubjectBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Subject
              </button>
            </div>

            <div class="list-grid" id="subjectsList">
              <!-- Subjects will be loaded here -->
            </div>

            <div class="empty-state d-none" id="subjectsEmptyState">
              <i class="fas fa-book"></i>
              <h3>No Subjects Yet</h3>
              <p>Add subjects to your school curriculum.</p>
            </div>
          </div>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-content" id="teachersTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Teachers</h3>
              <div id="teacherPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to teachers.
              </div>
              <div class="teacher-actions" style="display: none;" id="teacherAdminActions">
                <button class="btn btn-primary" id="addTeacherBtn">
                  <i class="fas fa-user-plus"></i> Add Teacher
                </button>
                <button class="btn btn-warning" id="assignSubjectsBtn">
                  <i class="fas fa-tasks"></i> Assign Subjects
                </button>
              </div>
            </div>

            <div id="teacherList">
              <!-- Teachers will be loaded here -->
            </div>

            <div class="empty-state d-none" id="teachersEmptyState">
              <i class="fas fa-chalkboard-teacher"></i>
              <h3>No Teachers Yet</h3>
              <p>Add teachers to your school staff.</p>
            </div>
          </div>
        </div>

        <!-- Marks Tab -->
        <div class="tab-content" id="marksTab">
          <div class="marks-container">
            <div class="marks-header">
              <h3>Enter Marks</h3>
              <div id="marksPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You can only enter marks for your assigned subjects.
              </div>
            </div>

            <div id="marksEntrySection">
              <div class="marks-filters">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Select Class</label>
                  <select id="marksClassSelect" class="w-100">
                    <option value="">Select a class</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Select Term</label>
                  <select id="termSelect" class="w-100">
                    <option value="">Select Term</option>
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>

                <div class="form-group" id="marksSubjectFilter" style="display: none;">
                  <label><i class="fas fa-book"></i> Select Subject</label>
                  <select id="marksSubjectSelect" class="w-100">
                    <option value="">All Assigned Subjects</option>
                  </select>
                </div>
              </div>

              <div class="student-search-container mb-30">
                <label><i class="fas fa-user-graduate"></i> Find Student</label>
                <div class="student-search-wrapper">
                  <i class="fas fa-search student-search-icon"></i>
                  <input type="text" id="studentSearch" class="student-search-input" placeholder="Type student name to search...">
                  <button type="button" class="student-search-clear" id="studentSearchClear">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="student-suggestions" id="studentSuggestions"></div>
              </div>

              <div class="selected-student d-none" id="selectedStudentInfo">
                <h4><i class="fas fa-user-graduate"></i> Selected Student: <span id="selectedStudentName"></span></h4>
                <p>Enter marks for each subject below (0-100)</p>
              </div>

              <div class="marks-grid" id="marksGrid">
                <!-- Marks inputs will be generated here -->
              </div>

              <div id="marksAlert" class="alert d-none">
                <i class="fas fa-info-circle"></i>
                <span id="marksAlertText"></span>
              </div>

              <div class="marks-buttons-row">
                <button class="btn btn-primary" id="saveMarksBtn" disabled>
                  <i class="fas fa-save"></i> Save Marks
                </button>
                <button class="btn btn-info" id="clearMarksBtn">
                  <i class="fas fa-eraser"></i> Clear Form
                </button>
              </div>
            </div>

            <div class="empty-state d-none" id="marksEmptyState">
              <i class="fas fa-edit"></i>
              <h3>Select Class and Term</h3>
              <p>Select a class and term to start entering marks.</p>
            </div>
          </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reportsTab">
          <!-- Admin Reports Section -->
          <div id="adminReportsSection" style="display: none;">
            <div class="reports-container">
              <div class="list-header">
                <h3>Reports & Analytics</h3>
                <button class="refresh-btn" id="refreshReports">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>

              <div class="report-filters">
                <h4 class="mb-20">Generate Report</h4>
                <div class="filter-grid">
                  <div class="form-group">
                    <label><i class="fas fa-chalkboard"></i> Class</label>
                    <select id="reportClassSelect" class="w-100">
                      <option value="">All Classes</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><i class="fas fa-user-graduate"></i> Student</label>
                    <select id="reportStudentSelect" class="w-100" disabled>
                      <option value="">All Students</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Term</label>
                    <select id="reportTermSelect" class="w-100">
                      <option value="beginning">Beginning of Term</option>
                      <option value="mid">Mid Term</option>
                      <option value="end">End of Term</option>
                    </select>
                  </div>
                </div>
                <div class="report-actions">
                  <button class="btn btn-primary" id="generateReportBtn">
                    <i class="fas fa-chart-bar"></i> Generate Report
                  </button>
                  <button class="btn btn-success" id="exportPDFBtn">
                    <i class="fas fa-file-pdf"></i> Export Report Cards
                  </button>
                  <button class="btn btn-warning" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i> Export Class Analysis
                  </button>
                </div>
              </div>

              <div class="stats-grid d-none" id="statsGrid">
                <div class="stat-card">
                  <h4>Total Students</h4>
                  <p id="statTotalStudents">0</p>
                </div>
                <div class="stat-card">
                  <h4>Average Score</h4>
                  <p id="statAvgScore">0</p>
                </div>
                <div class="stat-card">
                  <h4>Highest Score</h4>
                  <p id="statHighScore">0</p>
                </div>
                <div class="stat-card">
                  <h4>Lowest Score</h4>
                  <p id="statLowScore">0</p>
                </div>
              </div>

              <div id="reportPreview" class="d-none">
                <h4 class="mb-20">Report Preview</h4>
                <div id="enhancedReportCard" class="enhanced-report-card">
                  <!-- Report card content will be generated here -->
                </div>
              </div>

              <div class="empty-state" id="reportsEmptyState">
                <i class="fas fa-chart-line"></i>
                <h3>No Data Available</h3>
                <p>Generate a report to see student performance analytics.</p>
              </div>
            </div>
          </div>

          <!-- Teacher Subject Analytics Section -->
          <div id="teacherAnalyticsSection" style="display: none;">
            <div class="subject-analytics-container">
              <div class="analytics-header">
                <h3>My Subject Analytics</h3>
                <div class="marks-analytics-buttons">
                  <button class="btn btn-success" id="exportSubjectAnalyticsBtn">
                    <i class="fas fa-file-excel"></i> Export Analytics
                  </button>
                  <button class="btn btn-primary" id="refreshAnalyticsBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                  </button>
                </div>
              </div>

              <div class="analytics-filters">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Select Class</label>
                  <select id="analyticsClassSelect" class="w-100">
                    <option value="">All Classes</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Select Term</label>
                  <select id="analyticsTermSelect" class="w-100">
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>

                <button class="btn btn-primary" id="generateAnalyticsBtn">
                  <i class="fas fa-chart-pie"></i> Generate Analytics
                </button>
              </div>

              <div class="form-group subject-select-container">
                <label><i class="fas fa-book"></i> Select Subjects for Analysis</label>
                <div class="subject-checkboxes" id="subjectCheckboxesList">
                  <!-- Subject checkboxes will be loaded here -->
                </div>
                <div class="mt-10">
                  <button class="btn btn-light btn-sm" id="selectAllSubjects">
                    <i class="fas fa-check-square"></i> Select All
                  </button>
                  <button class="btn btn-light btn-sm" id="deselectAllSubjects">
                    <i class="fas fa-square"></i> Deselect All
                  </button>
                </div>
              </div>

              <div class="analytics-grid" id="analyticsGrid">
                <!-- Analytics cards will be loaded here -->
              </div>

              <div id="gradeChartContainer" class="d-none">
                <h4 class="mb-20">Grade Distribution</h4>
                <div style="background: var(--darker); border-radius: var(--border-radius-sm); padding: 20px; border: 1px solid rgba(255,255,255,0.1);">
                  <canvas id="gradeDistributionChart"></canvas>
                </div>
              </div>

              <div class="empty-state" id="analyticsEmptyState">
                <i class="fas fa-chart-pie"></i>
                <h3>No Analytics Data</h3>
                <p>Select subjects and generate analytics to see performance data.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS AND FULL SCREEN FORMS -->
  
  <!-- Join School Form -->
  <div class="full-screen-form" id="joinSchoolForm">
    <button class="close-fullscreen" id="closeJoinForm">
      <i class="fas fa-times"></i>
    </button>
    <div class="auth-container">
      <div class="header">
        <h2>Join a School</h2>
        <p>Enter school details to join</p>
      </div>

      <div id="joinSchoolError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="joinSchoolErrorText"></span>
      </div>

      <div id="joinSchoolSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span id="joinSchoolSuccessText"></span>
      </div>

      <div class="loading-state" id="joinSchoolLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Joining school...</p>
      </div>

      <form id="joinSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <div class="position-relative">
            <input type="text" id="joinSchoolName" placeholder="Start typing school name" required 
                   autocomplete="off" oninput="searchSchools(this.value)">
            <div class="school-suggestions" id="schoolSuggestions"></div>
          </div>
          <small class="text-muted">School names will be suggested as you type</small>
        </div>
        <div class="form-group">
          <label><i class="fas fa-key"></i> School Code</label>
          <input type="text" id="joinSchoolCode" placeholder="6-digit school code" required maxlength="6"
                 oninput="formatSchoolCode(this)" style="text-transform: uppercase; letter-spacing: 2px;">
          <small class="text-muted">Code will be automatically converted to uppercase</small>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-sign-in-alt"></i> Join School
        </button>
      </form>
    </div>
  </div>

  <!-- Register School Form -->
  <div class="full-screen-form" id="registerSchoolForm">
    <button class="close-fullscreen" id="closeRegisterForm">
      <i class="fas fa-times"></i>
    </button>
    <div class="auth-container">
      <div class="header">
        <h2>Register a School</h2>
        <p>Create a new school on Skore Point</p>
      </div>

      <div id="registerSchoolError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="registerSchoolErrorText"></span>
      </div>

      <div id="registerSchoolSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>School registered successfully!</span>
      </div>

      <div class="loading-state" id="registerSchoolLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Registering school...</p>
      </div>

      <form id="registerSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name <span class="required">*</span></label>
          <input type="text" id="registerSchoolName" placeholder="Enter school name" required
                 oninput="formatSchoolName(this)">
        </div>
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> School Location <span class="required">*</span></label>
          <input type="text" id="registerSchoolLocation" placeholder="City, Country" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-phone"></i> School Phone <span class="required">*</span></label>
          <input type="tel" id="registerSchoolPhone" placeholder="+1234567890" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> School Level <span class="required">*</span></label>
          <select id="registerSchoolLevel" required>
            <option value="">Select School Level</option>
            <option value="primary">Primary School</option>
            <option value="secondary">Secondary School</option>
          </select>
        </div>

        <div class="image-upload" id="logoUploadArea">
          <i class="fas fa-image"></i>
          <p>Upload School Logo <span class="required">*</span></p>
          <span>Click to upload (Required)</span>
          <div class="image-preview" id="logoPreview">
            <img id="logoPreviewImg" src="" alt="Logo Preview">
          </div>
          <input type="file" class="file-input" id="logoFile" accept="image/*" required>
          <input type="hidden" id="logoUrl">
          <div class="loading-state" id="logoUploadLoading">
            <div class="loading-spinner"></div>
            <p class="loading-text">Uploading...</p>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus-circle"></i> Register School
        </button>
      </form>
    </div>
  </div>

  <!-- Add Class Modal -->
  <div class="modal" id="addClassModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Class</h3>
        <button class="close-modal" id="closeAddClassModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addClassForm">
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class Name</label>
          <input type="text" id="className" placeholder="e.g., Grade 5A, Form 3" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> Academic Level</label>
          <select id="classAcademicLevel" required>
            <option value="">Select Level</option>
            <option value="lower-primary">Lower Primary (P1-P3)</option>
            <option value="upper-primary">Upper Primary (P4-P7)</option>
            <option value="olevel">O-Level (S1-S4)</option>
            <option value="alevel">A-Level (S5-S6)</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Class
        </button>
      </form>
    </div>
  </div>

  <!-- Add Subject Modal -->
  <div class="modal" id="addSubjectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Subject</h3>
        <button class="close-modal" id="closeAddSubjectModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addSubjectForm">
        <div class="form-group">
          <label><i class="fas fa-book"></i> Subject Name</label>
          <input type="text" id="subjectName" placeholder="e.g., Mathematics, English" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> Academic Level</label>
          <select id="subjectAcademicLevel" required>
            <option value="">Select Level</option>
            <option value="lower-primary">Lower Primary (P1-P3)</option>
            <option value="upper-primary">Upper Primary (P4-P7)</option>
            <option value="olevel">O-Level (S1-S4)</option>
            <option value="alevel">A-Level (S5-S6)</option>
          </select>
        </div>
        <div class="form-group" id="subjectPapersContainer" style="display: none;">
          <label><i class="fas fa-file-alt"></i> Number of Papers (A-Level)</label>
          <input type="number" id="subjectPapers" min="1" max="3" value="1">
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Subject
        </button>
      </form>
    </div>
  </div>

  <!-- Add Teacher Modal -->
  <div class="modal" id="addTeacherModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Teacher</h3>
        <button class="close-modal" id="closeAddTeacherModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="addTeacherError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="addTeacherErrorText"></span>
      </div>
      <div class="loading-state" id="addTeacherLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Adding teacher...</p>
      </div>
      <form id="addTeacherForm">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Full Name</label>
          <input type="text" id="teacherName" placeholder="Teacher's full name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="teacherEmail" placeholder="teacher@school.edu" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book"></i> Primary Teaching Subject</label>
          <input type="text" id="teacherSubject" placeholder="Primary subject they teach" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book-open"></i> Additional Subjects (Optional)</label>
          <textarea id="teacherAdditionalSubjects" placeholder="Enter additional subjects separated by commas" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label><i class="fas fa-user-tag"></i> Role</label>
          <select id="teacherRole">
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-user-plus"></i> Add Teacher
        </button>
      </form>
    </div>
  </div>

  <!-- Assign Subjects Modal -->
  <div class="modal" id="assignSubjectsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Subjects to Teacher</h3>
        <button class="close-modal" id="closeAssignSubjectsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="assignSubjectsError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="assignSubjectsErrorText"></span>
      </div>
      <div class="loading-state" id="assignSubjectsLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Assigning subjects...</p>
      </div>
      <form id="assignSubjectsForm">
        <input type="hidden" id="assignTeacherId">
        <div class="form-group">
          <label><i class="fas fa-chalkboard-teacher"></i> Teacher</label>
          <input type="text" id="assignTeacherName" readonly>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book"></i> Available Subjects</label>
          <div class="subject-assignment-container" id="subjectAssignmentList">
            <!-- Subjects checkboxes will be loaded here -->
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-tasks"></i> Assign Selected Subjects
        </button>
      </form>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div class="modal" id="forgotPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reset Password</h3>
        <button class="close-modal" id="closeForgotPasswordModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="forgotPasswordError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="forgotPasswordErrorText"></span>
      </div>
      <div id="forgotPasswordSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>Password reset email sent! Check your inbox.</span>
      </div>
      <div class="loading-state" id="forgotPasswordLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Sending reset email...</p>
      </div>
      <form id="forgotPasswordForm">
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-key"></i> Send Reset Link
        </button>
      </form>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div class="modal" id="addStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Student</h3>
        <button class="close-modal" id="closeAddStudentModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addStudentForm">
        <div class="form-group">
          <label><i class="fas fa-user-graduate"></i> Student Name</label>
          <input type="text" id="studentName" placeholder="Enter student's full name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class</label>
          <select id="studentClass" required>
            <option value="">Select Class</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Student
        </button>
      </form>
    </div>
  </div>

<script>
  // App Configuration
  const APP_CONFIG = {
    academicLevels: {
      'lower-primary': {
        name: 'Lower Primary',
        classes: ['P1', 'P2', 'P3'],
        subjects: ['Literacy I', 'Literacy II', 'Mathematics', 'English', 'Numeracy', 'Christian Religious Education (CRE)'],
        grading: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
      },
      'upper-primary': {
        name: 'Upper Primary',
        classes: ['P4', 'P5', 'P6', 'P7'],
        subjects: ['Science', 'Mathematics', 'English', 'Social Studies'],
        grading: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
      },
      'olevel': {
        name: 'O-Level',
        classes: ['S1', 'S2', 'S3', 'S4'],
        subjects: [
          'English Language', 'Mathematics', 'Biology', 'Chemistry', 'Physics',
          'Geography', 'History', 'Computer Studies', 'Business Studies',
          'Religious Education', 'French', 'Kiswahili', 'Agriculture'
        ],
        grading: ['A', 'B', 'C', 'D', 'E', 'F']
      },
      'alevel': {
        name: 'A-Level',
        classes: ['S5', 'S6'],
        subjects: {
          'principal': ['Mathematics', 'Physics', 'Chemistry', 'Biology', 'Computer Studies', 'Agriculture', 
                       'Economics', 'History', 'Geography', 'Divinity (CRE)', 'Islamic Religious Education (IRE)',
                       'Literature in English', 'Fine Art', 'Entrepreneurship Education', 'Luganda'],
          'subsidiary': ['Subsidiary Mathematics', 'Subsidiary ICT', 'General Paper']
        },
        grading: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
      }
    },
    
    aLevelCombinations: {
      'PCM': ['Physics', 'Chemistry', 'Mathematics'],
      'PCB': ['Physics', 'Chemistry', 'Biology'],
      'BCM': ['Biology', 'Chemistry', 'Mathematics'],
      'PME': ['Physics', 'Mathematics', 'Economics'],
      'PAM': ['Physics', 'Agriculture', 'Mathematics'],
      'PCA': ['Physics', 'Chemistry', 'Agriculture'],
      'BCG': ['Biology', 'Chemistry', 'Geography'],
      'BCA': ['Biology', 'Chemistry', 'Agriculture'],
      'PEM': ['Physics', 'Economics', 'Mathematics'],
      'LEG': ['Luganda', 'Economics', 'Geography'],
      'LEA': ['Literature', 'Economics', 'Art'],
      'LAG': ['Luganda', 'Art', 'Geography'],
      'FEL': ['French', 'Economics', 'Literature'],
      'GEL': ['Geography', 'Economics', 'Literature']
    },
    
    gradePoints: {
      'primary': { D1: 1, D2: 2, C3: 3, C4: 4, C5: 5, C6: 6, P7: 7, P8: 8, F9: 9 },
      'secondary': { A: 1, B: 2, C: 3, D: 4, E: 5, F: 6 }
    }
  };

  // Global State
  let currentUser = null;
  let currentUserData = null;
  let currentSchool = null;
  let currentClasses = [];
  let currentStudents = [];
  let currentSubjects = [];
  let currentTeachers = [];
  let selectedStudentId = null;
  let schoolLogoUrl = null;
  let userProfileUrl = null;
  let isSchoolPortalOpen = false;
  let isMobileView = window.innerWidth <= 768;
  let gradeChart = null;
  let deferredPrompt = null;
  let isAppInstalled = false;
  let allSchoolsCache = [];

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyASIdYdW94ZJQXsc6BN9Bc28eou0yjPE1U",
    authDomain: "upgrade-16092.firebaseapp.com",
    projectId: "upgrade-16092",
    storageBucket: "upgrade-16092.firebasestorage.app",
    messagingSenderId: "466381827996",
    appId: "1:466381827996:web:6f030e68c526e734a26259",
    measurementId: "G-RGCH68RJ8H"
  };

  // Firebase Modules
  let firebaseApp, firebaseAuth, firestoreDB;
  let authModule, firestoreModule;

  // DOM Elements
  const containers = {
    launchScreen: document.getElementById('launchScreen'),
    navbar: document.getElementById('navbar'),
    mobileBottomNav: document.getElementById('mobileBottomNav'),
    mobilePortalExitBtn: document.getElementById('mobilePortalExitBtn'),
    loginSection: document.getElementById('loginSection'),
    registerSection: document.getElementById('registerSection'),
    dashboardSection: document.getElementById('dashboardSection'),
    schoolManagementSection: document.getElementById('schoolManagementSection'),
    joinSchoolForm: document.getElementById('joinSchoolForm'),
    registerSchoolForm: document.getElementById('registerSchoolForm'),
    addClassModal: document.getElementById('addClassModal'),
    addSubjectModal: document.getElementById('addSubjectModal'),
    addTeacherModal: document.getElementById('addTeacherModal'),
    assignSubjectsModal: document.getElementById('assignSubjectsModal'),
    addStudentModal: document.getElementById('addStudentModal'),
    forgotPasswordModal: document.getElementById('forgotPasswordModal'),
    portalExitBtn: document.getElementById('portalExitBtn'),
    offlineIndicator: document.getElementById('offlineIndicator'),
    loadingOverlay: document.getElementById('loadingOverlay'),
    desktopInstallBtn: document.getElementById('desktopInstallBtn'),
    mobileInstallPrompt: document.getElementById('mobileInstallPrompt'),
    pwaInstalledBadge: document.getElementById('pwaInstalledBadge')
  };

  // Initialize the application
  document.addEventListener('DOMContentLoaded', async () => {
    checkMobileView();
    window.addEventListener('resize', checkMobileView);
    
    containers.launchScreen.style.display = 'flex';
    
    try {
      const firebaseInitialized = await initializeFirebase();
      
      if (firebaseInitialized) {
        authModule.onAuthStateChanged(firebaseAuth, async (user) => {
          if (user) {
            currentUser = user;
            await loadUserData(user.uid);
            showContainer('dashboardSection');
            hideLaunchScreen();
          } else {
            hideLaunchScreen();
            showContainer('loginSection');
          }
        });
      }
    } catch (error) {
      console.error('App initialization error:', error);
      hideLaunchScreen();
      showContainer('loginSection');
      showAlert('loginError', 'Application failed to initialize. Please refresh the page.', 'error');
    }
    
    setupEventListeners();
    setupPWA();
    
    setTimeout(() => {
      hideLaunchScreen();
      if (!currentUser) {
        showContainer('loginSection');
      }
    }, 2000);
  });

  // Setup PWA functionality
  function setupPWA() {
    checkIfAppInstalled();
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      if (!isAppInstalled) {
        showInstallPrompts();
      }
    });
    
    window.addEventListener('appinstalled', () => {
      isAppInstalled = true;
      hideInstallPrompts();
      showPWAInstalledBadge();
      localStorage.setItem('pwaInstalled', 'true');
      deferredPrompt = null;
    });
    
    checkStandaloneMode();
  }

  // Check standalone mode
  function checkStandaloneMode() {
    if (window.matchMedia('(display-mode: standalone)').matches) {
      isAppInstalled = true;
      showPWAInstalledBadge();
      hideInstallPrompts();
    }
  }

  // Check if app is installed
  function checkIfAppInstalled() {
    if (localStorage.getItem('pwaInstalled') === 'true') {
      isAppInstalled = true;
      showPWAInstalledBadge();
      hideInstallPrompts();
    }
    
    checkStandaloneMode();
  }

  // Show install prompts
  function showInstallPrompts() {
    if (isAppInstalled || !deferredPrompt) return;
    
    if (isMobileView) {
      setTimeout(() => {
        if (!isAppInstalled && deferredPrompt) {
          containers.mobileInstallPrompt.classList.add('show');
        }
      }, 3000);
    } else {
      containers.desktopInstallBtn.style.display = 'flex';
    }
  }

  // Hide install prompts
  function hideInstallPrompts() {
    containers.desktopInstallBtn.style.display = 'none';
    containers.mobileInstallPrompt.classList.remove('show');
  }

  // Show PWA installed badge
  function showPWAInstalledBadge() {
    containers.pwaInstalledBadge.style.display = 'flex';
    setTimeout(() => {
      containers.pwaInstalledBadge.style.display = 'none';
    }, 5000);
  }

  // Install PWA
  async function installPWA() {
    if (!deferredPrompt) {
      alert('Your browser does not support PWA installation.');
      return;
    }
    
    try {
      deferredPrompt.prompt();
      const choiceResult = await deferredPrompt.userChoice;
      
      if (choiceResult.outcome === 'accepted') {
        isAppInstalled = true;
        localStorage.setItem('pwaInstalled', 'true');
        hideInstallPrompts();
        showPWAInstalledBadge();
      }
      
      deferredPrompt = null;
    } catch (error) {
      console.error('Error installing PWA:', error);
    }
  }

  // Check mobile view
  function checkMobileView() {
    isMobileView = window.innerWidth <= 768;
    if (isSchoolPortalOpen) {
      if (isMobileView) {
        containers.mobileBottomNav.style.display = 'flex';
        containers.mobileBottomNav.classList.add('active');
        containers.portalExitBtn.style.display = 'none';
      } else {
        containers.mobileBottomNav.style.display = 'none';
        containers.mobileBottomNav.classList.remove('active');
        containers.portalExitBtn.style.display = 'flex';
      }
    }
  }

  // Initialize Firebase
  async function initializeFirebase() {
    try {
      const appModule = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
      authModule = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
      firestoreModule = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

      firebaseApp = appModule.initializeApp(firebaseConfig);
      firebaseAuth = authModule.getAuth(firebaseApp);
      firestoreDB = firestoreModule.getFirestore(firebaseApp);

      console.log('Firebase initialized successfully');
      return true;
    } catch (error) {
      console.error('Firebase initialization error:', error);
      return false;
    }
  }

  // Load user data from Firestore
  async function loadUserData(userId) {
    try {
      const userDocRef = firestoreModule.doc(firestoreDB, 'users', userId);
      const userDoc = await firestoreModule.getDoc(userDocRef);
      
      if (userDoc.exists()) {
        currentUserData = userDoc.data();
        updateUserProfileCard();
        
        if (currentUserData.schoolId) {
          await loadSchoolData(currentUserData.schoolId);
        } else {
          document.getElementById('manageSchoolCard').style.display = 'none';
        }
      } else {
        // Create user document
        const userData = {
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          createdAt: firestoreModule.serverTimestamp()
        };
        
        await firestoreModule.setDoc(
          firestoreModule.doc(firestoreDB, 'users', userId),
          userData
        );
        
        currentUserData = userData;
        updateUserProfileCard();
      }
    } catch (error) {
      console.error('Error loading user data:', error);
      currentUserData = {
        name: currentUser.displayName || 'User',
        email: currentUser.email
      };
      updateUserProfileCard();
    }
  }

  // Update user profile card
  function updateUserProfileCard() {
    const userInfoCard = document.getElementById('userInfoCard');
    if (!userInfoCard) return;
    
    const initials = getInitials(currentUserData.name || 'U');
    const profileUrl = currentUserData.profileUrl || '';
    const name = currentUserData.name || 'User';
    const email = currentUser.email || '';
    const role = currentUserData.role || 'teacher';
    
    userInfoCard.innerHTML = `
      <div class="user-profile-img">
        ${profileUrl && profileUrl.startsWith('data:image') 
          ? `<img src="${profileUrl}" alt="${name}" onerror="this.parentElement.innerHTML='${initials}'">`
          : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">${initials}</div>`
        }
      </div>
      <div class="user-details">
        <span class="user-role ${role}">${role.toUpperCase()}</span>
        <span class="user-name">${name}</span>
        <span class="user-email">${email}</span>
        <button class="logout-btn mobile-only" id="mobileLogoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    `;
    
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    if (mobileLogoutBtn) {
      mobileLogoutBtn.addEventListener('click', handleLogout);
    }
  }

  // Get initials from name
  function getInitials(name) {
    if (!name) return 'U';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  }

  // Load school data
  async function loadSchoolData(schoolId) {
    try {
      const schoolDocRef = firestoreModule.doc(firestoreDB, 'schools', schoolId);
      const schoolDoc = await firestoreModule.getDoc(schoolDocRef);
      
      if (schoolDoc.exists()) {
        currentSchool = {
          id: schoolDoc.id,
          ...schoolDoc.data()
        };
        
        // Check if user is admin of this school
        const isAdmin = currentSchool.admins && currentSchool.admins.includes(currentUser.uid);
        currentUserData.role = isAdmin ? 'admin' : 'teacher';
        
        const schoolPortalCard = document.getElementById('manageSchoolCard');
        schoolPortalCard.style.display = 'block';
        
        document.getElementById('schoolCardName').textContent = currentSchool.name;
        document.getElementById('schoolCardCode').textContent = currentSchool.code;
        
        if (currentSchool.logoUrl) {
          schoolLogoUrl = currentSchool.logoUrl;
          const schoolLogo = document.getElementById('schoolCardLogo');
          schoolLogo.src = currentSchool.logoUrl;
          schoolLogo.style.display = 'block';
        }
        
        await Promise.all([
          loadClasses(),
          loadSubjects(),
          loadTeachers()
        ]);
        
        updateUserProfileCard();
      } else {
        // Remove school ID from user document
        await firestoreModule.updateDoc(
          firestoreModule.doc(firestoreDB, 'users', currentUser.uid),
          { schoolId: null }
        );
        
        document.getElementById('manageSchoolCard').style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading school data:', error);
    }
  }

  // Setup all event listeners
  function setupEventListeners() {
    // Navigation
    document.getElementById('goRegister').addEventListener('click', () => showContainer('registerSection'));
    document.getElementById('goLogin').addEventListener('click', () => showContainer('loginSection'));
    document.getElementById('joinSchoolBtn').addEventListener('click', () => {
      containers.joinSchoolForm.classList.add('active');
      preloadAllSchools();
    });
    document.getElementById('registerSchoolBtn').addEventListener('click', () => containers.registerSchoolForm.classList.add('active'));
    document.getElementById('desktopLogoutBtn').addEventListener('click', handleLogout);
    document.getElementById('userGuideBtn').addEventListener('click', showUserGuide);
    document.getElementById('forgotPassword').addEventListener('click', () => containers.forgotPasswordModal.classList.add('active'));
    document.getElementById('openSchoolPortalBtn').addEventListener('click', openSchoolPortal);
    document.getElementById('refreshSchoolData').addEventListener('click', refreshSchoolData);
    document.getElementById('refreshReports').addEventListener('click', refreshReportsData);
    
    // Portal exit buttons
    containers.portalExitBtn.addEventListener('click', closeSchoolPortal);
    containers.mobilePortalExitBtn.addEventListener('click', closeSchoolPortal);
    
    // PWA Install buttons
    document.getElementById('desktopInstallBtn')?.addEventListener('click', installPWA);
    document.getElementById('mobileInstallBtn')?.addEventListener('click', installPWA);
    document.getElementById('laterMobileBtn')?.addEventListener('click', () => {
      containers.mobileInstallPrompt.classList.remove('show');
    });
    document.getElementById('closeMobilePrompt')?.addEventListener('click', () => {
      containers.mobileInstallPrompt.classList.remove('show');
    });
    
    // Close buttons
    document.getElementById('closeJoinForm').addEventListener('click', () => containers.joinSchoolForm.classList.remove('active'));
    document.getElementById('closeRegisterForm').addEventListener('click', () => containers.registerSchoolForm.classList.remove('active'));
    document.getElementById('closeAddClassModal').addEventListener('click', () => containers.addClassModal.classList.remove('active'));
    document.getElementById('closeAddSubjectModal').addEventListener('click', () => containers.addSubjectModal.classList.remove('active'));
    document.getElementById('closeAddTeacherModal').addEventListener('click', () => containers.addTeacherModal.classList.remove('active'));
    document.getElementById('closeAssignSubjectsModal').addEventListener('click', () => containers.assignSubjectsModal.classList.remove('active'));
    document.getElementById('closeAddStudentModal').addEventListener('click', () => containers.addStudentModal.classList.remove('active'));
    document.getElementById('closeForgotPasswordModal').addEventListener('click', () => containers.forgotPasswordModal.classList.remove('active'));
    
    // File upload buttons
    document.getElementById('studentUploadArea').addEventListener('click', () => document.getElementById('studentFile').click());
    
    // File change events
    document.getElementById('profileFile').addEventListener('change', (e) => handleImageUpload(e, 'profile'));
    document.getElementById('logoFile').addEventListener('change', (e) => handleImageUpload(e, 'logo'));
    document.getElementById('studentFile').addEventListener('change', handleStudentFileUpload);
    
    // Form submissions
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    document.getElementById('joinSchoolFormFields').addEventListener('submit', handleJoinSchool);
    document.getElementById('registerSchoolFormFields').addEventListener('submit', handleRegisterSchool);
    document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);
    document.getElementById('addClassForm').addEventListener('submit', handleAddClass);
    document.getElementById('addSubjectForm').addEventListener('submit', handleAddSubject);
    document.getElementById('addTeacherForm').addEventListener('submit', handleAddTeacher);
    document.getElementById('assignSubjectsForm').addEventListener('submit', handleAssignSubjects);
    document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
    
    // Tab switching
    setupTabs();
    setupMobileTabs();
    
    // Password toggles
    setupPasswordToggles();
    
    // Student search
    document.getElementById('studentSearch').addEventListener('input', handleStudentSearch);
    document.getElementById('studentSearchClear').addEventListener('click', clearStudentSearch);
    
    // Marks entry
    document.getElementById('marksClassSelect').addEventListener('change', handleClassSelectForMarks);
    document.getElementById('termSelect').addEventListener('change', handleTermSelect);
    document.getElementById('marksSubjectSelect').addEventListener('change', handleSubjectSelectForMarks);
    document.getElementById('saveMarksBtn').addEventListener('click', handleSaveMarks);
    document.getElementById('clearMarksBtn').addEventListener('click', clearMarksForm);
    
    // Reports
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);
    document.getElementById('exportPDFBtn').addEventListener('click', exportReportCards);
    document.getElementById('exportExcelBtn').addEventListener('click', exportClassAnalysis);
    document.getElementById('exportSubjectAnalyticsBtn').addEventListener('click', exportSubjectAnalytics);
    document.getElementById('reportClassSelect').addEventListener('change', updateReportStudentSelect);
    
    // Enhanced Analytics
    document.getElementById('generateAnalyticsBtn').addEventListener('click', generateEnhancedAnalytics);
    document.getElementById('analyticsClassSelect').addEventListener('change', loadAnalyticsSubjects);
    document.getElementById('selectAllSubjects').addEventListener('click', selectAllSubjects);
    document.getElementById('deselectAllSubjects').addEventListener('click', deselectAllSubjects);
    document.getElementById('refreshAnalyticsBtn').addEventListener('click', refreshAnalytics);
    
    // Add buttons
    document.getElementById('addClassBtn').addEventListener('click', () => containers.addClassModal.classList.add('active'));
    document.getElementById('addSubjectBtn').addEventListener('click', () => containers.addSubjectModal.classList.add('active'));
    document.getElementById('addTeacherBtn').addEventListener('click', () => containers.addTeacherModal.classList.add('active'));
    document.getElementById('assignSubjectsBtn').addEventListener('click', showAssignSubjectsModal);
    document.getElementById('addStudentBtn').addEventListener('click', () => containers.addStudentModal.classList.add('active'));
    
    // Academic level selector
    document.getElementById('academicLevelSelect').addEventListener('change', handleAcademicLevelChange);
    document.getElementById('registerSchoolLevel').addEventListener('change', handleSchoolLevelChange);
    document.getElementById('subjectAcademicLevel').addEventListener('change', handleSubjectLevelChange);
    
    // A-Level combination selector
    const academicLevelSelect = document.getElementById('academicLevelSelect');
    if (academicLevelSelect) {
      academicLevelSelect.addEventListener('change', function() {
        if (this.value === 'alevel') {
          showALevelCombinationSelector();
        }
      });
    }
  }

  // Setup tabs
  function setupTabs() {
    const tabs = document.querySelectorAll('.desktop-only .tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = tab.dataset.tab;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        setTimeout(() => {
          switchTab(tabId);
        }, 300);
      });
    });
  }

  // Setup mobile tabs
  function setupMobileTabs() {
    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
    mobileNavItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = item.dataset.tab;
        
        const tabContent = document.getElementById(`${tabId}Tab`);
        if (tabContent) {
          const headerHeight = 70;
          const elementPosition = tabContent.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerHeight;
          
          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });
          
          setTimeout(() => {
            switchTab(tabId);
          }, 100);
        }
      });
    });
  }

  // Switch tab
  function switchTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mobile-nav-item').forEach(m => m.classList.remove('active'));
    
    const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
    const selectedMobileTab = document.querySelector(`.mobile-nav-item[data-tab="${tabId}"]`);
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedMobileTab) selectedMobileTab.classList.add('active');
    
    document.getElementById(`${tabId}Tab`).classList.add('active');
    
    switch(tabId) {
      case 'classes':
        loadClasses();
        break;
      case 'students':
        loadStudents();
        break;
      case 'subjects':
        loadSubjects();
        break;
      case 'teachers':
        loadTeachers();
        break;
      case 'marks':
        setupMarksTab();
        break;
      case 'reports':
        setupReportsTab();
        break;
    }
  }

  // Handle image upload
  function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.match('image.*')) {
      showAlert(`${type}Error`, 'Please select an image file (JPEG, PNG, GIF)', 'error');
      return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
      showAlert(`${type}Error`, 'Image size should be less than 2MB', 'error');
      return;
    }
    
    const loadingId = `${type}UploadLoading`;
    const loadingElement = document.getElementById(loadingId);
    if (loadingElement) {
      loadingElement.classList.add('active');
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const imageUrl = e.target.result;
      
      if (type === 'profile') {
        const previewImg = document.getElementById('profilePreviewImg');
        previewImg.src = imageUrl;
        const previewContainer = document.getElementById('profilePreview');
        previewContainer.style.display = 'block';
        document.getElementById('profileUrl').value = imageUrl;
        userProfileUrl = imageUrl;
        updateUserProfileCard();
      } else {
        const previewImg = document.getElementById('logoPreviewImg');
        previewImg.src = imageUrl;
        const previewContainer = document.getElementById('logoPreview');
        previewContainer.style.display = 'block';
        document.getElementById('logoUrl').value = imageUrl;
        schoolLogoUrl = imageUrl;
      }
      
      if (loadingElement) {
        loadingElement.classList.remove('active');
      }
    };
    
    reader.readAsDataURL(file);
  }

  // Show loading overlay
  function showLoadingOverlay(text = 'Loading...') {
    document.getElementById('loadingText').textContent = text;
    containers.loadingOverlay.classList.add('active');
  }

  // Hide loading overlay
  function hideLoadingOverlay() {
    containers.loadingOverlay.classList.remove('active');
  }

  // Handle student file upload
  async function handleStudentFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.match(/\.(xlsx|xls)$/)) {
      alert('Please upload an Excel file (.xlsx or .xls)');
      return;
    }
    
    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        let addedCount = 0;
        const classId = document.getElementById('studentClassSelect').value;
        
        if (!classId) {
          alert('Please select a class first');
          return;
        }
        
        showLoadingOverlay('Adding students from Excel...');
        
        for (let i = 0; i < jsonData.length; i++) {
          const studentName = jsonData[i][0];
          if (studentName && typeof studentName === 'string' && studentName.trim()) {
            try {
              await firestoreModule.addDoc(
                firestoreModule.collection(firestoreDB, 'students'),
                {
                  name: studentName.trim(),
                  classId: classId,
                  schoolId: currentSchool.id,
                  createdAt: firestoreModule.serverTimestamp(),
                  createdBy: currentUser.uid
                }
              );
              addedCount++;
            } catch (error) {
              console.error('Error adding student:', error);
            }
          }
        }
        
        hideLoadingOverlay();
        alert(`Successfully added ${addedCount} students from the file.`);
        loadStudents();
      };
      
      reader.readAsArrayBuffer(file);
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('Error processing Excel file:', error);
      alert('Error processing Excel file. Please check the format and try again.');
    }
  }

  // Setup password toggles
  function setupPasswordToggles() {
    const toggles = [
      { toggle: 'loginToggle', field: 'loginPassword' },
      { toggle: 'registerToggle', field: 'regPassword' },
      { toggle: 'confirmToggle', field: 'confirmPassword' }
    ];
    
    toggles.forEach(({ toggle, field }) => {
      const toggleBtn = document.getElementById(toggle);
      const fieldInput = document.getElementById(field);
      
      if (toggleBtn && fieldInput) {
        toggleBtn.addEventListener('click', () => {
          const type = fieldInput.type === 'password' ? 'text' : 'password';
          fieldInput.type = type;
          toggleBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
      }
    });
  }

  // Format school name input
  window.formatSchoolName = function(input) {
    input.value = input.value.replace(/\s+/g, ' ').trim();
  };

  // Format school code input
  window.formatSchoolCode = function(input) {
    input.value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
  };

  // Preload all schools for search
  async function preloadAllSchools() {
    try {
      const schoolsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'schools')
      );
      
      const querySnapshot = await firestoreModule.getDocs(schoolsQuery);
      allSchoolsCache = [];
      
      querySnapshot.forEach(doc => {
        allSchoolsCache.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      console.log(`Preloaded ${allSchoolsCache.length} schools for search`);
    } catch (error) {
      console.error('Error preloading schools:', error);
    }
  }

  // Search schools as user types
  window.searchSchools = async function(searchTerm) {
    const suggestions = document.getElementById('schoolSuggestions');
    suggestions.innerHTML = '';
    
    if (searchTerm.length < 2) {
      suggestions.style.display = 'none';
      return;
    }
    
    const searchTermLower = searchTerm.toLowerCase().trim();
    
    // Filter cached schools
    const filteredSchools = allSchoolsCache.filter(school => 
      school.name.toLowerCase().includes(searchTermLower)
    );
    
    if (filteredSchools.length > 0) {
      filteredSchools.forEach(school => {
        const suggestion = document.createElement('div');
        suggestion.className = 'school-suggestion';
        suggestion.innerHTML = `
          <span class="suggestion-name">${school.name}</span>
        `;
        suggestion.addEventListener('click', () => {
          document.getElementById('joinSchoolName').value = school.name;
          document.getElementById('joinSchoolCode').value = school.code;
          suggestions.style.display = 'none';
        });
        suggestions.appendChild(suggestion);
      });
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  };

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    document.getElementById('loginLoading').classList.add('active');
    hideAlert('loginError');
    
    try {
      await authModule.signInWithEmailAndPassword(firebaseAuth, email, password);
    } catch (error) {
      document.getElementById('loginLoading').classList.remove('active');
      let errorMessage = 'Login failed. ';
      switch(error.code) {
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        case 'auth/user-disabled':
          errorMessage += 'This account has been disabled.';
          break;
        case 'auth/user-not-found':
        case 'auth/wrong-password':
          errorMessage += 'Invalid email or password.';
          break;
        default:
          errorMessage += error.message;
      }
      showAlert('loginError', errorMessage, 'error');
    }
  }

  // Handle registration
  async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const subject = document.getElementById('regSubject').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const profileUrl = document.getElementById('profileUrl').value;
    
    if (!profileUrl) {
      showAlert('registerError', 'Profile picture is required', 'error');
      return;
    }
    
    if (password !== confirmPassword) {
      showAlert('registerError', 'Passwords do not match', 'error');
      return;
    }
    
    document.getElementById('registerLoading').classList.add('active');
    hideAlert('registerError');
    
    try {
      const userCredential = await authModule.createUserWithEmailAndPassword(firebaseAuth, email, password);
      
      const userData = {
        name: name,
        email: email,
        subject: subject,
        profileUrl: profileUrl,
        createdAt: firestoreModule.serverTimestamp()
      };
      
      await firestoreModule.setDoc(
        firestoreModule.doc(firestoreDB, 'users', userCredential.user.uid),
        userData
      );
      
      if (name) {
        await authModule.updateProfile(userCredential.user, {
          displayName: name
        });
      }
      
      document.getElementById('registerLoading').classList.remove('active');
      showAlert('registerSuccess', 'Account created successfully!', 'success');
      
      setTimeout(() => {
        showContainer('dashboardSection');
        window.location.reload();
      }, 2000);
      
    } catch (error) {
      document.getElementById('registerLoading').classList.remove('active');
      let errorMessage = 'Registration failed. ';
      switch(error.code) {
        case 'auth/email-already-in-use':
          errorMessage += 'Email is already registered.';
          break;
        default:
          errorMessage += error.message;
      }
      showAlert('registerError', errorMessage, 'error');
    }
  }

  // Handle join school - FIXED VERSION
  async function handleJoinSchool(e) {
    e.preventDefault();
    
    let schoolName = document.getElementById('joinSchoolName').value.trim();
    let schoolCode = document.getElementById('joinSchoolCode').value.trim().toUpperCase();
    
    hideAlert('joinSchoolError');
    hideAlert('joinSchoolSuccess');
    
    if (!schoolName || !schoolCode) {
      showAlert('joinSchoolError', 'Please enter both school name and code', 'error');
      return;
    }
    
    if (schoolCode.length !== 6) {
      showAlert('joinSchoolError', 'School code must be exactly 6 characters', 'error');
      return;
    }
    
    try {
      document.getElementById('joinSchoolLoading').classList.add('active');
      
      // Clean school name
      schoolName = schoolName.replace(/\s+/g, ' ').trim();
      
      // Get all schools
      const schoolsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'schools')
      );
      
      const querySnapshot = await firestoreModule.getDocs(schoolsQuery);
      let foundSchool = null;
      
      querySnapshot.forEach(doc => {
        const schoolData = doc.data();
        const schoolNameLower = schoolData.name.toLowerCase();
        const searchNameLower = schoolName.toLowerCase();
        
        if (schoolData.code === schoolCode && schoolNameLower.includes(searchNameLower)) {
          foundSchool = {
            id: doc.id,
            ...schoolData
          };
        }
      });
      
      if (!foundSchool) {
        document.getElementById('joinSchoolLoading').classList.remove('active');
        showAlert('joinSchoolError', 
          'School not found. Please check the school name and code.', 
          'error');
        return;
      }
      
      currentSchool = foundSchool;
      
      // Update user document with new school ID
      await firestoreModule.updateDoc(
        firestoreModule.doc(firestoreDB, 'users', currentUser.uid),
        {
          schoolId: foundSchool.id,
          role: 'teacher'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = foundSchool.id;
      currentUserData.role = 'teacher';
      
      // Add user to school's teacher list
      await firestoreModule.updateDoc(
        firestoreModule.doc(firestoreDB, 'schools', foundSchool.id),
        {
          teachers: firestoreModule.arrayUnion(currentUser.uid)
        }
      );
      
      // Update UI
      document.getElementById('schoolCardName').textContent = currentSchool.name;
      document.getElementById('schoolCardCode').textContent = currentSchool.code;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Load school data
      await loadSchoolData(foundSchool.id);
      
      document.getElementById('joinSchoolLoading').classList.remove('active');
      
      // Show success message
      showAlert('joinSchoolSuccess', `Successfully joined ${currentSchool.name}!`, 'success');
      
      // Hide form after delay
      setTimeout(() => {
        containers.joinSchoolForm.classList.remove('active');
        showAlert('joinSchoolSuccess', '', 'success', true);
      }, 3000);
      
    } catch (error) {
      document.getElementById('joinSchoolLoading').classList.remove('active');
      console.error('Error joining school:', error);
      showAlert('joinSchoolError', 
        'Error joining school. Please try again.', 
        'error');
    }
  }

  // Handle register school
  async function handleRegisterSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('registerSchoolName').value.trim();
    const schoolLocation = document.getElementById('registerSchoolLocation').value.trim();
    const schoolPhone = document.getElementById('registerSchoolPhone').value.trim();
    const schoolLevel = document.getElementById('registerSchoolLevel').value;
    const logoUrl = document.getElementById('logoUrl').value;
    
    if (!logoUrl) {
      showAlert('registerSchoolError', 'School logo is required', 'error');
      return;
    }
    
    if (!schoolLevel) {
      showAlert('registerSchoolError', 'Please select school level', 'error');
      return;
    }
    
    hideAlert('registerSchoolError');
    
    try {
      document.getElementById('registerSchoolLoading').classList.add('active');
      
      // Generate school code
      const schoolCode = generateSchoolCode();
      
      // Create school document
      const schoolData = {
        name: schoolName,
        location: schoolLocation,
        phone: schoolPhone,
        level: schoolLevel,
        code: schoolCode,
        logoUrl: logoUrl,
        createdBy: currentUser.uid,
        admins: [currentUser.uid],
        teachers: [currentUser.uid],
        createdAt: firestoreModule.serverTimestamp()
      };
      
      const schoolRef = await firestoreModule.addDoc(
        firestoreModule.collection(firestoreDB, 'schools'),
        schoolData
      );
      
      // Update user document with school ID and admin role
      await firestoreModule.updateDoc(
        firestoreModule.doc(firestoreDB, 'users', currentUser.uid),
        {
          schoolId: schoolRef.id,
          role: 'admin'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolRef.id;
      currentUserData.role = 'admin';
      updateUserProfileCard();
      
      // Add default subjects based on school level
      if (schoolLevel === 'primary') {
        // Add primary school subjects
        const primarySubjects = [
          ...APP_CONFIG.academicLevels['lower-primary'].subjects,
          ...APP_CONFIG.academicLevels['upper-primary'].subjects
        ];
        
        for (const subjectName of [...new Set(primarySubjects)]) {
          await firestoreModule.addDoc(
            firestoreModule.collection(firestoreDB, 'subjects'),
            {
              name: subjectName,
              schoolId: schoolRef.id,
              level: subjectName.includes('Literacy') ? 'lower-primary' : 'upper-primary',
              createdAt: firestoreModule.serverTimestamp()
            }
          );
        }
        
        // Add primary classes
        const primaryClasses = [
          ...APP_CONFIG.academicLevels['lower-primary'].classes,
          ...APP_CONFIG.academicLevels['upper-primary'].classes
        ];
        
        for (const className of primaryClasses) {
          await firestoreModule.addDoc(
            firestoreModule.collection(firestoreDB, 'classes'),
            {
              name: className,
              schoolId: schoolRef.id,
              level: className.startsWith('P') && parseInt(className.substring(1)) <= 3 ? 'lower-primary' : 'upper-primary',
              createdAt: firestoreModule.serverTimestamp()
            }
          );
        }
      } else {
        // Add secondary school subjects
        const secondarySubjects = [
          ...APP_CONFIG.academicLevels['olevel'].subjects,
          ...APP_CONFIG.academicLevels['alevel'].subjects.principal,
          ...APP_CONFIG.academicLevels['alevel'].subjects.subsidiary
        ];
        
        for (const subjectName of [...new Set(secondarySubjects)]) {
          await firestoreModule.addDoc(
            firestoreModule.collection(firestoreDB, 'subjects'),
            {
              name: subjectName,
              schoolId: schoolRef.id,
              level: APP_CONFIG.academicLevels['alevel'].subjects.subsidiary.includes(subjectName) ? 'alevel' : 'olevel',
              papers: subjectName.includes('Subsidiary') || subjectName === 'General Paper' ? 1 : 
                     ['Biology', 'Chemistry', 'Physics'].includes(subjectName) ? 3 : 2,
              createdAt: firestoreModule.serverTimestamp()
            }
          );
        }
        
        // Add secondary classes
        const secondaryClasses = [
          ...APP_CONFIG.academicLevels['olevel'].classes,
          ...APP_CONFIG.academicLevels['alevel'].classes
        ];
        
        for (const className of secondaryClasses) {
          await firestoreModule.addDoc(
            firestoreModule.collection(firestoreDB, 'classes'),
            {
              name: className,
              schoolId: schoolRef.id,
              level: className.startsWith('S') && parseInt(className.substring(1)) <= 4 ? 'olevel' : 'alevel',
              createdAt: firestoreModule.serverTimestamp()
            }
          );
        }
      }
      
      // Update current school data
      currentSchool = {
        id: schoolRef.id,
        ...schoolData
      };
      
      // Update UI
      document.getElementById('schoolCardName').textContent = schoolName;
      document.getElementById('schoolCardCode').textContent = schoolCode;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      document.getElementById('registerSchoolLoading').classList.remove('active');
      showAlert('registerSchoolSuccess', 'School registered successfully!', 'success');
      
      setTimeout(() => {
        containers.registerSchoolForm.classList.remove('active');
        window.location.reload();
      }, 2000);
      
    } catch (error) {
      document.getElementById('registerSchoolLoading').classList.remove('active');
      console.error('Error registering school:', error);
      showAlert('registerSchoolError', 'Error registering school. Please try again.', 'error');
    }
  }

  // Handle forgot password
  async function handleForgotPassword(e) {
    e.preventDefault();
    
    const email = document.getElementById('forgotPasswordEmail').value;
    
    hideAlert('forgotPasswordError');
    hideAlert('forgotPasswordSuccess');
    
    try {
      document.getElementById('forgotPasswordLoading').classList.add('active');
      await authModule.sendPasswordResetEmail(firebaseAuth, email);
      document.getElementById('forgotPasswordLoading').classList.remove('active');
      showAlert('forgotPasswordSuccess', 'Password reset email sent! Check your inbox.', 'success');
      
      setTimeout(() => {
        document.getElementById('forgotPasswordEmail').value = '';
        containers.forgotPasswordModal.classList.remove('active');
      }, 3000);
      
    } catch (error) {
      document.getElementById('forgotPasswordLoading').classList.remove('active');
      console.error('Error sending password reset:', error);
      showAlert('forgotPasswordError', 'Error sending password reset email. Please try again.', 'error');
    }
  }

  // Handle school level change
  function handleSchoolLevelChange(e) {
    const level = e.target.value;
    const academicLevelSelector = document.getElementById('academicLevelSelector');
    
    if (level === 'primary' || level === 'secondary') {
      academicLevelSelector.style.display = 'block';
    } else {
      academicLevelSelector.style.display = 'none';
    }
  }

  // Handle academic level change
  function handleAcademicLevelChange(e) {
    const level = e.target.value;
    if (level === 'alevel') {
      showALevelCombinationSelector();
    }
  }

  // Handle subject level change
  function handleSubjectLevelChange(e) {
    const level = e.target.value;
    const papersContainer = document.getElementById('subjectPapersContainer');
    
    if (level === 'alevel') {
      papersContainer.style.display = 'block';
    } else {
      papersContainer.style.display = 'none';
    }
  }

  // Show A-Level combination selector
  function showALevelCombinationSelector() {
    const modalContent = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>Select A-Level Combination</h3>
          <button class="close-modal" id="closeCombinationModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> A-Level Combination</label>
          <select id="alevelCombinationSelect" class="w-100">
            <option value="">Select Combination</option>
            ${Object.keys(APP_CONFIG.aLevelCombinations).map(comb => `
              <option value="${comb}">${comb} - ${APP_CONFIG.aLevelCombinations[comb].join(', ')}</option>
            `).join('')}
          </select>
        </div>
        <button class="btn btn-primary btn-block mt-20" id="selectCombinationBtn">
          <i class="fas fa-check"></i> Use Selected Combination
        </button>
      </div>
    `;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'combinationModal';
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    
    document.getElementById('closeCombinationModal').addEventListener('click', () => {
      document.getElementById('combinationModal').remove();
    });
    
    document.getElementById('selectCombinationBtn').addEventListener('click', () => {
      const combination = document.getElementById('alevelCombinationSelect').value;
      if (combination) {
        document.getElementById('combinationModal').remove();
        // Store selected combination
        localStorage.setItem('selectedALevelCombination', combination);
        alert(`Selected combination: ${combination}`);
      }
    });
  }

  // Handle add class
  async function handleAddClass(e) {
    e.preventDefault();
    
    const className = document.getElementById('className').value;
    const academicLevel = document.getElementById('classAcademicLevel').value;
    
    if (!academicLevel) {
      alert('Please select academic level');
      return;
    }
    
    try {
      await firestoreModule.addDoc(
        firestoreModule.collection(firestoreDB, 'classes'),
        {
          name: className,
          schoolId: currentSchool.id,
          level: academicLevel,
          createdAt: firestoreModule.serverTimestamp(),
          createdBy: currentUser.uid
        }
      );
      
      document.getElementById('className').value = '';
      containers.addClassModal.classList.remove('active');
      loadClasses();
      
    } catch (error) {
      console.error('Error adding class:', error);
      alert('Error adding class. Please try again.');
    }
  }

  // Handle add subject
  async function handleAddSubject(e) {
    e.preventDefault();
    
    const subjectName = document.getElementById('subjectName').value;
    const academicLevel = document.getElementById('subjectAcademicLevel').value;
    const papers = document.getElementById('subjectPapers')?.value || 1;
    
    if (!academicLevel) {
      alert('Please select academic level');
      return;
    }
    
    try {
      const subjectData = {
        name: subjectName,
        schoolId: currentSchool.id,
        level: academicLevel,
        createdAt: firestoreModule.serverTimestamp(),
        createdBy: currentUser.uid
      };
      
      if (academicLevel === 'alevel') {
        subjectData.papers = parseInt(papers);
      }
      
      await firestoreModule.addDoc(
        firestoreModule.collection(firestoreDB, 'subjects'),
        subjectData
      );
      
      document.getElementById('subjectName').value = '';
      containers.addSubjectModal.classList.remove('active');
      loadSubjects();
      
    } catch (error) {
      console.error('Error adding subject:', error);
      alert('Error adding subject. Please try again.');
    }
  }

  // Handle add teacher
  async function handleAddTeacher(e) {
    e.preventDefault();
    
    const teacherName = document.getElementById('teacherName').value;
    const teacherEmail = document.getElementById('teacherEmail').value;
    const teacherSubject = document.getElementById('teacherSubject').value;
    const teacherAdditionalSubjects = document.getElementById('teacherAdditionalSubjects').value;
    const teacherRole = document.getElementById('teacherRole').value;
    
    const additionalSubjectsArray = teacherAdditionalSubjects
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0);
    
    const allSubjects = [teacherSubject, ...additionalSubjectsArray].filter((v, i, a) => a.indexOf(v) === i);
    
    try {
      document.getElementById('addTeacherLoading').classList.add('active');
      
      // First, check if user with this email already exists
      const usersQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'users'),
        firestoreModule.where('email', '==', teacherEmail)
      );
      
      const querySnapshot = await firestoreModule.getDocs(usersQuery);
      let teacherUserId = null;
      
      if (!querySnapshot.empty) {
        // User exists, update their school info
        const userDoc = querySnapshot.docs[0];
        teacherUserId = userDoc.id;
        
        await firestoreModule.updateDoc(
          firestoreModule.doc(firestoreDB, 'users', teacherUserId),
          {
            schoolId: currentSchool.id,
            subject: teacherSubject,
            additionalSubjects: additionalSubjectsArray,
            assignedSubjects: allSubjects,
            role: teacherRole
          }
        );
      } else {
        // Create new user document
        const newTeacherRef = await firestoreModule.addDoc(
          firestoreModule.collection(firestoreDB, 'users'),
          {
            name: teacherName,
            email: teacherEmail,
            subject: teacherSubject,
            additionalSubjects: additionalSubjectsArray,
            assignedSubjects: allSubjects,
            schoolId: currentSchool.id,
            role: teacherRole,
            createdAt: firestoreModule.serverTimestamp(),
            status: 'active'
          }
        );
        
        teacherUserId = newTeacherRef.id;
      }
      
      // Add teacher to school's teacher list
      await firestoreModule.updateDoc(
        firestoreModule.doc(firestoreDB, 'schools', currentSchool.id),
        {
          teachers: firestoreModule.arrayUnion(teacherUserId)
        }
      );
      
      // Add to admin list if role is admin
      if (teacherRole === 'admin') {
        await firestoreModule.updateDoc(
          firestoreModule.doc(firestoreDB, 'schools', currentSchool.id),
          {
            admins: firestoreModule.arrayUnion(teacherUserId)
          }
        );
      }
      
      document.getElementById('addTeacherLoading').classList.remove('active');
      
      // Clear form
      document.getElementById('teacherName').value = '';
      document.getElementById('teacherEmail').value = '';
      document.getElementById('teacherSubject').value = '';
      document.getElementById('teacherAdditionalSubjects').value = '';
      containers.addTeacherModal.classList.remove('active');
      
      // Reload teachers list
      loadTeachers();
      
      alert('Teacher added successfully!');
      
    } catch (error) {
      document.getElementById('addTeacherLoading').classList.remove('active');
      console.error('Error adding teacher:', error);
      showAlert('addTeacherError', 'Error adding teacher. Please try again.', 'error');
    }
  }

  // Show assign subjects modal
  function showAssignSubjectsModal() {
    loadTeachersForAssignment();
  }

  // Load teachers for subject assignment
  async function loadTeachersForAssignment() {
    try {
      // Get all users in this school who are not admins
      const usersQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'users'),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(usersQuery);
      const teachers = [];
      
      querySnapshot.forEach(doc => {
        const userData = doc.data();
        // Skip current user and admins
        if (doc.id !== currentUser.uid && userData.role !== 'admin') {
          teachers.push({
            id: doc.id,
            ...userData
          });
        }
      });
      
      if (teachers.length === 0) {
        alert('No teachers available for subject assignment.');
        return;
      }
      
      const modalContent = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Select Teacher to Assign Subjects</h3>
            <button class="close-modal" id="closeTeacherSelectModal">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="form-group">
            <label><i class="fas fa-chalkboard-teacher"></i> Select Teacher</label>
            <select id="teacherSelectForAssignment" class="w-100">
              <option value="">Select a teacher</option>
              ${teachers.map(teacher => `
                <option value="${teacher.id}">${teacher.name} (${teacher.email})</option>
              `).join('')}
            </select>
          </div>
          <button class="btn btn-primary btn-block mt-20" id="selectTeacherBtn">
            <i class="fas fa-arrow-right"></i> Continue
          </button>
        </div>
      `;
      
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'teacherSelectModal';
      modal.innerHTML = modalContent;
      document.body.appendChild(modal);
      
      document.getElementById('closeTeacherSelectModal').addEventListener('click', () => {
        document.getElementById('teacherSelectModal').remove();
      });
      
      document.getElementById('selectTeacherBtn').addEventListener('click', () => {
        const teacherId = document.getElementById('teacherSelectForAssignment').value;
        if (teacherId) {
          document.getElementById('teacherSelectModal').remove();
          openAssignSubjectsModal(teacherId);
        }
      });
      
    } catch (error) {
      console.error('Error loading teachers:', error);
    }
  }

  // Open assign subjects modal
  async function openAssignSubjectsModal(teacherId) {
    try {
      const teacherDoc = await firestoreModule.getDoc(
        firestoreModule.doc(firestoreDB, 'users', teacherId)
      );
      
      if (!teacherDoc.exists()) {
        alert('Teacher not found');
        return;
      }
      
      const teacher = { id: teacherDoc.id, ...teacherDoc.data() };
      
      // Get all subjects for this school
      const subjectsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'subjects'),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const subjectsSnapshot = await firestoreModule.getDocs(subjectsQuery);
      const allSubjects = [];
      
      subjectsSnapshot.forEach(doc => {
        allSubjects.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      const teacherAssignedSubjects = teacher.assignedSubjects || [teacher.subject].filter(Boolean);
      
      const subjectAssignmentList = document.getElementById('subjectAssignmentList');
      subjectAssignmentList.innerHTML = '';
      
      if (allSubjects.length === 0) {
        subjectAssignmentList.innerHTML = '<div class="alert info">No subjects available. Add subjects first.</div>';
      } else {
        allSubjects.forEach(subject => {
          const isAssigned = teacherAssignedSubjects.includes(subject.name);
          const item = document.createElement('div');
          item.className = 'subject-assignment-item';
          item.innerHTML = `
            <input type="checkbox" id="subject-${subject.id}" value="${subject.name}" ${isAssigned ? 'checked' : ''}>
            <label for="subject-${subject.id}">${subject.name}</label>
          `;
          subjectAssignmentList.appendChild(item);
        });
      }
      
      document.getElementById('assignTeacherId').value = teacher.id;
      document.getElementById('assignTeacherName').value = teacher.name;
      
      containers.assignSubjectsModal.classList.add('active');
      
    } catch (error) {
      console.error('Error opening assign subjects modal:', error);
    }
  }

  // Handle assign subjects
  async function handleAssignSubjects(e) {
    e.preventDefault();
    
    const teacherId = document.getElementById('assignTeacherId').value;
    const checkboxes = document.querySelectorAll('#subjectAssignmentList input[type="checkbox"]:checked');
    const assignedSubjects = Array.from(checkboxes).map(cb => cb.value);
    
    if (assignedSubjects.length === 0) {
      showAlert('assignSubjectsError', 'Please select at least one subject', 'error');
      return;
    }
    
    try {
      document.getElementById('assignSubjectsLoading').classList.add('active');
      
      await firestoreModule.updateDoc(
        firestoreModule.doc(firestoreDB, 'users', teacherId),
        {
          assignedSubjects: assignedSubjects,
          subject: assignedSubjects[0] // Set first subject as primary
        }
      );
      
      document.getElementById('assignSubjectsLoading').classList.remove('active');
      
      containers.assignSubjectsModal.classList.remove('active');
      loadTeachers();
      
      alert('Subjects assigned successfully!');
      
    } catch (error) {
      document.getElementById('assignSubjectsLoading').classList.remove('active');
      console.error('Error assigning subjects:', error);
      showAlert('assignSubjectsError', 'Error assigning subjects. Please try again.', 'error');
    }
  }

  // Handle add student
  async function handleAddStudent(e) {
    e.preventDefault();
    
    const studentName = document.getElementById('studentName').value;
    const studentClass = document.getElementById('studentClass').value;
    
    try {
      await firestoreModule.addDoc(
        firestoreModule.collection(firestoreDB, 'students'),
        {
          name: studentName,
          classId: studentClass,
          schoolId: currentSchool.id,
          createdAt: firestoreModule.serverTimestamp(),
          createdBy: currentUser.uid
        }
      );
      
      document.getElementById('studentName').value = '';
      containers.addStudentModal.classList.remove('active');
      loadStudents();
      
    } catch (error) {
      console.error('Error adding student:', error);
      alert('Error adding student. Please try again.');
    }
  }

  // Load classes
  async function loadClasses() {
    if (!currentSchool) return;
    
    try {
      const classesQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'classes'),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(classesQuery);
      currentClasses = [];
      const classList = document.getElementById('classList');
      classList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('classesEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('classesEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const classData = {
          id: doc.id,
          ...doc.data()
        };
        currentClasses.push(classData);
        
        const classItem = document.createElement('div');
        classItem.className = 'list-item';
        classItem.innerHTML = `
          <h4>${classData.name}</h4>
          <p>Level: ${APP_CONFIG.academicLevels[classData.level]?.name || classData.level}</p>
          <p>Created: ${classData.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteClass('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        classList.appendChild(classItem);
      });
      
      updateClassSelectors();
      
    } catch (error) {
      console.error('Error loading classes:', error);
      document.getElementById('classesEmptyState').classList.remove('d-none');
    }
  }

  // Load students
  async function loadStudents() {
    if (!currentSchool) return;
    
    const classId = document.getElementById('studentClassSelect').value;
    
    try {
      let studentsQuery;
      if (classId) {
        studentsQuery = firestoreModule.query(
          firestoreModule.collection(firestoreDB, 'students'),
          firestoreModule.where('schoolId', '==', currentSchool.id),
          firestoreModule.where('classId', '==', classId)
        );
      } else {
        studentsQuery = firestoreModule.query(
          firestoreModule.collection(firestoreDB, 'students'),
          firestoreModule.where('schoolId', '==', currentSchool.id)
        );
      }
      
      const querySnapshot = await firestoreModule.getDocs(studentsQuery);
      currentStudents = [];
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('studentsEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('studentsEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const studentData = {
          id: doc.id,
          ...doc.data()
        };
        currentStudents.push(studentData);
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <h4>${studentData.name}</h4>
          <p>Class: ${getClassName(studentData.classId)}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteStudent('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        studentList.appendChild(studentItem);
      });
      
    } catch (error) {
      console.error('Error loading students:', error);
      document.getElementById('studentsEmptyState').classList.remove('d-none');
    }
  }

  // Load subjects
  async function loadSubjects() {
    if (!currentSchool) return;
    
    try {
      const subjectsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'subjects'),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(subjectsQuery);
      currentSubjects = [];
      const subjectsList = document.getElementById('subjectsList');
      subjectsList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('subjectsEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('subjectsEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const subjectData = {
          id: doc.id,
          ...doc.data()
        };
        currentSubjects.push(subjectData);
        
        const subjectItem = document.createElement('div');
        subjectItem.className = 'list-item';
        const papersText = subjectData.papers ? ` (${subjectData.papers} paper${subjectData.papers > 1 ? 's' : ''})` : '';
        subjectItem.innerHTML = `
          <h4>${subjectData.name}${papersText}</h4>
          <p>Level: ${APP_CONFIG.academicLevels[subjectData.level]?.name || subjectData.level}</p>
          <p>Created: ${subjectData.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteSubject('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        subjectsList.appendChild(subjectItem);
      });
      
    } catch (error) {
      console.error('Error loading subjects:', error);
      document.getElementById('subjectsEmptyState').classList.remove('d-none');
    }
  }

  // Load teachers
  async function loadTeachers() {
    if (!currentSchool) return;
    
    try {
      // Get all users in this school
      const usersQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'users'),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(usersQuery);
      currentTeachers = [];
      const teacherList = document.getElementById('teacherList');
      teacherList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('teachersEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('teachersEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const teacherData = {
          id: doc.id,
          ...doc.data()
        };
        
        // Determine if user is admin
        const isAdmin = currentSchool.admins && currentSchool.admins.includes(doc.id);
        teacherData.role = teacherData.role || (isAdmin ? 'admin' : 'teacher');
        
        currentTeachers.push(teacherData);
        
        const role = teacherData.role;
        const name = teacherData.name || 'Teacher';
        const email = teacherData.email || '';
        const subjects = teacherData.assignedSubjects || [teacherData.subject].filter(Boolean);
        const subjectsText = subjects.length > 0 ? subjects.join(', ') : 'No subjects assigned';
        
        const teacherItem = document.createElement('div');
        teacherItem.className = 'list-item';
        teacherItem.innerHTML = `
          <h4>${name}</h4>
          <p>Email: ${email}</p>
          <p>Role: <span class="user-role ${role}">${role.toUpperCase()}</span></p>
          <p>Subjects: ${subjectsText}</p>
          ${currentUserData.role === 'admin' && teacherData.id !== currentUser.uid ? `
            <div class="item-actions">
              <button class="btn btn-warning btn-sm" onclick="promoteTeacher('${doc.id}', '${teacherData.role}')">
                <i class="fas fa-user-shield"></i> ${teacherData.role === 'admin' ? 'Demote' : 'Make Admin'}
              </button>
              <button class="btn btn-info btn-sm" onclick="assignSubjectsToTeacher('${doc.id}')">
                <i class="fas fa-tasks"></i> Assign Subjects
              </button>
              <button class="btn btn-danger btn-sm" onclick="removeTeacher('${doc.id}')">
                <i class="fas fa-user-minus"></i> Remove
              </button>
            </div>
          ` : ''}
        `;
        teacherList.appendChild(teacherItem);
      });
      
      // Show admin actions if user is admin
      if (currentUserData.role === 'admin') {
        document.getElementById('teacherAdminActions').style.display = 'flex';
      }
      
    } catch (error) {
      console.error('Error loading teachers:', error);
      document.getElementById('teachersEmptyState').classList.remove('d-none');
    }
  }

  // Update class selectors
  function updateClassSelectors() {
    const selectors = [
      document.getElementById('studentClassSelect'),
      document.getElementById('marksClassSelect'),
      document.getElementById('reportClassSelect'),
      document.getElementById('analyticsClassSelect'),
      document.getElementById('studentClass')
    ];
    
    selectors.forEach(select => {
      if (!select) return;
      
      // Save current value
      const currentValue = select.value;
      
      // Clear options except first
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Add class options
      currentClasses.forEach(classObj => {
        const option = document.createElement('option');
        option.value = classObj.id;
        option.textContent = classObj.name;
        select.appendChild(option);
      });
      
      // Restore selected value if it still exists
      if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
        select.value = currentValue;
      }
    });
  }

  // Get class name by ID
  function getClassName(classId) {
    const classObj = currentClasses.find(c => c.id === classId);
    return classObj ? classObj.name : 'Unknown Class';
  }

  // Setup marks tab
  function setupMarksTab() {
    const isAdmin = currentUserData.role === 'admin';
    const canEnterMarks = isAdmin || (currentUserData.subject && currentUserData.assignedSubjects?.length > 0);
    
    if (!canEnterMarks) {
      document.getElementById('marksEmptyState').classList.add('d-none');
      document.getElementById('marksEntrySection').classList.add('d-none');
      document.getElementById('marksPermissionNote').classList.remove('d-none');
      return;
    }
    
    document.getElementById('marksPermissionNote').classList.add('d-none');
    document.getElementById('marksEmptyState').classList.add('d-none');
    document.getElementById('marksEntrySection').classList.remove('d-none');
    
    updateClassSelectors();
    
    const marksSubjectFilter = document.getElementById('marksSubjectFilter');
    if (!isAdmin && currentUserData.assignedSubjects) {
      marksSubjectFilter.style.display = 'block';
      updateMarksSubjectSelector();
    } else {
      marksSubjectFilter.style.display = 'none';
    }
  }

  // Update marks subject selector for teachers
  function updateMarksSubjectSelector() {
    const select = document.getElementById('marksSubjectSelect');
    if (!select) return;
    
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
    
    assignedSubjects.forEach(subjectName => {
      const option = document.createElement('option');
      option.value = subjectName;
      option.textContent = subjectName;
      select.appendChild(option);
    });
  }

  // Handle class select for marks
  function handleClassSelectForMarks() {
    const classId = document.getElementById('marksClassSelect').value;
    const term = document.getElementById('termSelect').value;
    
    if (classId && term) {
      loadStudentsForMarks(classId);
    } else {
      clearStudentSearch();
    }
  }

  // Handle term select
  function handleTermSelect() {
    handleClassSelectForMarks();
  }

  // Handle subject select for marks
  function handleSubjectSelectForMarks() {
    generateMarkInputs();
  }

  // Load students for marks
  async function loadStudentsForMarks(classId) {
    try {
      const studentsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'students'),
        firestoreModule.where('classId', '==', classId),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        currentStudents.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      generateMarkInputs();
      
    } catch (error) {
      console.error('Error loading students for marks:', error);
      currentStudents = [];
    }
  }

  // Handle student search
  function handleStudentSearch() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const classId = document.getElementById('marksClassSelect').value;
    
    const clearBtn = document.getElementById('studentSearchClear');
    if (searchTerm.length > 0) {
      clearBtn.classList.add('show');
    } else {
      clearBtn.classList.remove('show');
    }
    
    if (!classId || searchTerm.length < 2) {
      document.getElementById('studentSuggestions').style.display = 'none';
      return;
    }
    
    const filteredStudents = currentStudents.filter(student => 
      student.name.toLowerCase().includes(searchTerm)
    );
    
    const suggestions = document.getElementById('studentSuggestions');
    suggestions.innerHTML = '';
    
    if (filteredStudents.length > 0) {
      filteredStudents.forEach(student => {
        const suggestion = document.createElement('div');
        suggestion.className = 'student-suggestion';
        suggestion.textContent = student.name;
        suggestion.addEventListener('click', () => {
          document.getElementById('studentSearch').value = student.name;
          selectedStudentId = student.id;
          document.getElementById('selectedStudentName').textContent = student.name;
          document.getElementById('selectedStudentInfo').classList.remove('d-none');
          document.getElementById('saveMarksBtn').disabled = false;
          suggestions.style.display = 'none';
          clearBtn.classList.add('show');
          loadStudentMarks(student.id);
        });
        suggestions.appendChild(suggestion);
      });
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  }

  // Clear student search
  function clearStudentSearch() {
    document.getElementById('studentSearch').value = '';
    document.getElementById('studentSearchClear').classList.remove('show');
    document.getElementById('studentSuggestions').style.display = 'none';
    document.getElementById('selectedStudentInfo').classList.add('d-none');
    selectedStudentId = null;
    document.getElementById('saveMarksBtn').disabled = true;
  }

  // Clear marks form
  function clearMarksForm() {
    clearStudentSearch();
    document.querySelectorAll('.mark-input input').forEach(input => {
      input.value = '';
    });
    document.getElementById('marksAlert').classList.add('d-none');
  }

  // Generate mark inputs
  function generateMarkInputs() {
    const marksGrid = document.getElementById('marksGrid');
    marksGrid.innerHTML = '';
    
    const isAdmin = currentUserData.role === 'admin';
    const selectedSubject = document.getElementById('marksSubjectSelect')?.value;
    
    let subjectsToShow = currentSubjects;
    
    if (!isAdmin) {
      const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
      
      if (selectedSubject && selectedSubject !== '') {
        subjectsToShow = currentSubjects.filter(subject => 
          subject.name === selectedSubject
        );
      } else {
        subjectsToShow = currentSubjects.filter(subject => 
          assignedSubjects.includes(subject.name)
        );
      }
    }
    
    if (subjectsToShow.length === 0) {
      marksGrid.innerHTML = `
        <div class="alert info" style="grid-column: 1 / -1;">
          <i class="fas fa-info-circle"></i>
          <span>No subjects found for your teaching assignment.</span>
        </div>
      `;
      return;
    }
    
    subjectsToShow.forEach(subject => {
      const markInput = document.createElement('div');
      markInput.className = 'mark-input';
      const maxMarks = subject.level === 'alevel' && subject.papers > 1 ? (subject.papers * 100) : 100;
      markInput.innerHTML = `
        <label>${subject.name}</label>
        <input type="number" min="0" max="${maxMarks}" placeholder="0-${maxMarks}" 
               data-subject="${subject.id}" 
               oninput="validateMarkInput(this, ${maxMarks})">
      `;
      marksGrid.appendChild(markInput);
    });
  }

  // Validate mark input
  window.validateMarkInput = function(input, maxMarks) {
    let value = parseInt(input.value);
    if (isNaN(value)) {
      input.value = '';
      return;
    }
    if (value < 0) input.value = 0;
    if (value > maxMarks) input.value = maxMarks;
  };

  // Load student marks
  async function loadStudentMarks(studentId) {
    const term = document.getElementById('termSelect').value;
    
    try {
      const marksDoc = await firestoreModule.getDoc(
        firestoreModule.doc(firestoreDB, 'marks', `${studentId}_${term}`)
      );
      
      if (marksDoc.exists()) {
        const marks = marksDoc.data();
        currentSubjects.forEach(subject => {
          const input = document.querySelector(`input[data-subject="${subject.id}"]`);
          if (input && marks[subject.id] !== undefined) {
            input.value = marks[subject.id];
          }
        });
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
  }

  // Handle save marks
  async function handleSaveMarks() {
    if (!selectedStudentId) {
      showMarksAlert('Please select a student first', 'error');
      return;
    }
    
    const term = document.getElementById('termSelect').value;
    if (!term) {
      showMarksAlert('Please select a term', 'error');
      return;
    }
    
    const marks = {};
    let hasMarks = false;
    
    document.querySelectorAll('.mark-input input').forEach(input => {
      const subjectId = input.dataset.subject;
      const value = parseInt(input.value);
      if (!isNaN(value) && value >= 0) {
        marks[subjectId] = value;
        hasMarks = true;
      }
    });
    
    if (!hasMarks) {
      showMarksAlert('Please enter at least one mark', 'warning');
      return;
    }
    
    try {
      await firestoreModule.setDoc(
        firestoreModule.doc(firestoreDB, 'marks', `${selectedStudentId}_${term}`),
        {
          studentId: selectedStudentId,
          schoolId: currentSchool.id,
          term: term,
          ...marks,
          updatedAt: firestoreModule.serverTimestamp(),
          updatedBy: currentUser.uid
        }
      );
      
      showMarksAlert('Marks saved successfully!', 'success');
      
      setTimeout(() => {
        clearMarksForm();
      }, 2000);
      
    } catch (error) {
      console.error('Error saving marks:', error);
      showMarksAlert('Error saving marks. Please try again.', 'error');
    }
  }

  // Show marks alert
  function showMarksAlert(message, type) {
    const alert = document.getElementById('marksAlert');
    if (!alert) return;
    
    alert.className = `alert ${type}`;
    alert.querySelector('#marksAlertText').textContent = message;
    alert.classList.remove('d-none');
    
    setTimeout(() => {
      alert.classList.add('d-none');
    }, 3000);
  }

  // Setup reports tab
  function setupReportsTab() {
    const isAdmin = currentUserData.role === 'admin';
    
    if (isAdmin) {
      document.getElementById('adminReportsSection').style.display = 'block';
      document.getElementById('teacherAnalyticsSection').style.display = 'none';
      
      document.getElementById('desktopReportsLabel').textContent = 'Reports';
      document.getElementById('reportsTabLabel').textContent = 'Reports';
      
      updateClassSelectors();
      preloadReportsData();
    } else {
      document.getElementById('adminReportsSection').style.display = 'none';
      document.getElementById('teacherAnalyticsSection').style.display = 'block';
      
      document.getElementById('desktopReportsLabel').textContent = 'Analytics';
      document.getElementById('reportsTabLabel').textContent = 'Analytics';
      
      setupAnalyticsFilters();
      preloadAnalyticsData();
    }
  }

  // Preload reports data
  async function preloadReportsData() {
    if (!currentSchool) return;
    
    try {
      await Promise.all([
        loadAllStudents(),
        preloadMarksData()
      ]);
    } catch (error) {
      console.error('Error preloading reports data:', error);
    }
  }

  // Preload analytics data
  async function preloadAnalyticsData() {
    if (!currentSchool) return;
    
    try {
      loadAnalyticsSubjects();
    } catch (error) {
      console.error('Error preloading analytics data:', error);
    }
  }

  // Load all students for reports
  async function loadAllStudents() {
    try {
      const studentsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'students'),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        currentStudents.push({
          id: doc.id,
          ...doc.data()
        });
      });
    } catch (error) {
      console.error('Error loading all students:', error);
    }
  }

  // Setup analytics filters
  async function setupAnalyticsFilters() {
    updateClassSelectors();
    loadAnalyticsSubjects();
  }

  // Load analytics subjects
  function loadAnalyticsSubjects() {
    const subjectCheckboxesList = document.getElementById('subjectCheckboxesList');
    if (!subjectCheckboxesList) return;
    
    subjectCheckboxesList.innerHTML = '';
    
    const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
    
    if (assignedSubjects.length === 0) {
      subjectCheckboxesList.innerHTML = `
        <div class="alert info">
          <i class="fas fa-info-circle"></i>
          <span>No subjects assigned to you. Please contact your administrator.</span>
        </div>
      `;
      return;
    }
    
    assignedSubjects.forEach(subjectName => {
      const checkbox = document.createElement('div');
      checkbox.className = 'subject-checkbox';
      checkbox.innerHTML = `
        <input type="checkbox" id="subject-${subjectName.replace(/\s+/g, '-')}" 
               value="${subjectName}" checked>
        <label for="subject-${subjectName.replace(/\s+/g, '-')}">${subjectName}</label>
      `;
      subjectCheckboxesList.appendChild(checkbox);
    });
  }

  // Select all subjects
  function selectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  // Deselect all subjects
  function deselectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  // Refresh analytics
  function refreshAnalytics() {
    loadAnalyticsSubjects();
    document.getElementById('analyticsGrid').innerHTML = '';
    document.getElementById('gradeChartContainer').classList.add('d-none');
    document.getElementById('analyticsEmptyState').classList.remove('d-none');
  }

  // Generate enhanced analytics
  async function generateEnhancedAnalytics() {
    const classId = document.getElementById('analyticsClassSelect').value;
    const term = document.getElementById('analyticsTermSelect').value;
    
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]:checked');
    const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedSubjects.length === 0) {
      alert('Please select at least one subject for analysis.');
      return;
    }
    
    try {
      showLoadingOverlay('Generating analytics...');
      
      // Get marks for selected term
      const marksQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'marks'),
        firestoreModule.where('schoolId', '==', currentSchool.id),
        firestoreModule.where('term', '==', term)
      );
      
      const marksSnapshot = await firestoreModule.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      // Filter students by class if selected
      let filteredStudents = currentStudents;
      if (classId) {
        filteredStudents = currentStudents.filter(s => s.classId === classId);
      }
      
      const analyticsGrid = document.getElementById('analyticsGrid');
      analyticsGrid.innerHTML = '';
      
      const allGradeDistribution = {};
      const grades = currentSchool.level === 'primary' 
        ? ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
        : ['A', 'B', 'C', 'D', 'E', 'F'];
      
      grades.forEach(grade => {
        allGradeDistribution[grade] = 0;
      });
      
      let hasData = false;
      
      for (const subjectName of selectedSubjects) {
        const subject = currentSubjects.find(s => s.name === subjectName);
        if (!subject) continue;
        
        const scores = [];
        
        marksData.forEach(mark => {
          if (mark[subject.id] !== undefined) {
            const student = filteredStudents.find(s => s.id === mark.studentId);
            if (student) {
              const score = mark[subject.id];
              scores.push(score);
            }
          }
        });
        
        if (scores.length > 0) {
          hasData = true;
          
          const total = scores.reduce((a, b) => a + b, 0);
          const average = Math.round(total / scores.length);
          const highest = Math.max(...scores);
          const lowest = Math.min(...scores);
          
          const gradeDistribution = calculateGradeDistribution(scores, currentSchool.level);
          
          Object.keys(gradeDistribution).forEach(grade => {
            if (allGradeDistribution[grade] !== undefined) {
              allGradeDistribution[grade] += gradeDistribution[grade];
            }
          });
          
          const passCount = scores.filter(score => score >= 40).length;
          const passRate = scores.length > 0 ? Math.round((passCount / scores.length) * 100) : 0;
          
          const analyticsCard = document.createElement('div');
          analyticsCard.className = 'analytics-card';
          analyticsCard.innerHTML = `
            <h4>${subjectName}</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Average</p>
                <p style="font-size: 28px; font-weight: 800; color: var(--primary);">${average}</p>
              </div>
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Students</p>
                <p style="font-size: 28px; font-weight: 800; color: var(--primary);">${scores.length}</p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Highest</p>
                <p style="font-size: 20px; font-weight: 600; color: var(--success);">${highest}</p>
              </div>
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Lowest</p>
                <p style="font-size: 20px; font-weight: 600; color: var(--error);">${lowest}</p>
              </div>
            </div>
            <div style="margin-bottom: 20px;">
              <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Pass Rate</p>
                <p style="font-size: 20px; font-weight: 600; color: ${passRate >= 70 ? 'var(--success)' : passRate >= 50 ? 'var(--warning)' : 'var(--error)'};">${passRate}%</p>
              </div>
            <h5 style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 10px;">Grade Distribution</h5>
            <div class="grade-distribution">
              ${Object.entries(gradeDistribution).map(([grade, count]) => `
                <div class="grade-item">
                  <span>${grade}</span>
                  <span>${count}</span>
                </div>
              `).join('')}
            </div>
          `;
          
          analyticsGrid.appendChild(analyticsCard);
        }
      }
      
      hideLoadingOverlay();
      
      if (hasData) {
        document.getElementById('analyticsEmptyState').classList.add('d-none');
        createGradeDistributionChart(allGradeDistribution);
        document.getElementById('gradeChartContainer').classList.remove('d-none');
      } else {
        document.getElementById('analyticsEmptyState').classList.remove('d-none');
        document.getElementById('gradeChartContainer').classList.add('d-none');
      }
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('Error generating analytics:', error);
      document.getElementById('analyticsEmptyState').classList.remove('d-none');
      document.getElementById('gradeChartContainer').classList.add('d-none');
    }
  }

  // Create grade distribution chart
  function createGradeDistributionChart(gradeDistribution) {
    const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
    
    if (gradeChart) {
      gradeChart.destroy();
    }
    
    const grades = Object.keys(gradeDistribution);
    const counts = Object.values(gradeDistribution);
    
    gradeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: grades,
        datasets: [{
          label: 'Number of Students',
          data: counts,
          backgroundColor: 'rgba(67, 97, 238, 0.8)',
          borderColor: 'rgba(67, 97, 238, 1)',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // Update report student select
  async function updateReportStudentSelect() {
    const classId = document.getElementById('reportClassSelect').value;
    const select = document.getElementById('reportStudentSelect');
    
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    if (!classId) {
      select.disabled = true;
      return;
    }
    
    select.disabled = false;
    
    try {
      const studentsQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'students'),
        firestoreModule.where('classId', '==', classId),
        firestoreModule.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await firestoreModule.getDocs(studentsQuery);
      
      querySnapshot.forEach(doc => {
        const student = { id: doc.id, ...doc.data() };
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        select.appendChild(option);
      });
      
    } catch (error) {
      console.error('Error loading students for reports:', error);
    }
  }

  // Generate report
  async function generateReport() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    try {
      showLoadingOverlay('Generating report...');
      
      if (studentId) {
        const marksDoc = await firestoreModule.getDoc(
          firestoreModule.doc(firestoreDB, 'marks', `${studentId}_${term}`)
        );
        
        if (marksDoc.exists()) {
          await displayStudentReport(studentId, marksDoc.data());
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      } else if (classId) {
        // Class report
        const marksQuery = firestoreModule.query(
          firestoreModule.collection(firestoreDB, 'marks'),
          firestoreModule.where('schoolId', '==', currentSchool.id),
          firestoreModule.where('term', '==', term)
        );
        
        const marksSnapshot = await firestoreModule.getDocs(marksQuery);
        const classStudents = currentStudents.filter(s => s.classId === classId);
        const marksData = [];
        
        marksSnapshot.forEach(doc => {
          const mark = { id: doc.id, ...doc.data() };
          if (classStudents.find(s => s.id === mark.studentId)) {
            marksData.push(mark);
          }
        });
        
        if (marksData.length > 0) {
          await displayClassReport(classId, marksData);
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      }
      
      hideLoadingOverlay();
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('Error generating report:', error);
    }
  }

  // Display student report
  async function displayStudentReport(studentId, marks) {
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) return;
    
    const classObj = currentClasses.find(c => c.id === student.classId);
    const term = document.getElementById('reportTermSelect').value;
    
    let totalMarks = 0;
    let subjectCount = 0;
    const subjectScores = [];
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        totalMarks += score;
        subjectCount++;
        subjectScores.push({
          name: subject.name,
          score: score,
          grade: calculateGrade(score, subject.level || currentSchool.level)
        });
      }
    });
    
    const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
    const averageGrade = calculateGrade(average, classObj?.level || currentSchool.level);
    
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <div class="skore-point-badge">
          <div class="skore-point-icon">
            <img src="/testing/skore-icon.jpg" alt="Skore Point" onerror="this.style.display='none'">
          </div>
          <div class="skore-point-text">SKORE POINT</div>
          <div class="serusoft-text">A product of SERUSOFT</div>
        </div>
        
        <div class="school-logo-large">
          <img src="${currentSchool.logoUrl || '/testing/skore-icon.jpg'}" alt="${currentSchool.name}" onerror="this.src='/testing/skore-icon.jpg'">
        </div>
        
        <div class="school-name">${currentSchool.name}</div>
        <div class="report-title">STUDENT PROGRESS REPORT</div>
      </div>
      
      <div class="student-info-grid">
        <div class="info-item">
          <span class="info-label">Student Name:</span>
          <span class="info-value">${student.name}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Class:</span>
          <span class="info-value">${classObj ? classObj.name : 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Date:</span>
          <span class="info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      ${subjectScores.length > 0 ? `
        <table class="subject-table">
          <thead>
            <tr>
              <th>SUBJECT</th>
              <th>SCORE</th>
              <th>GRADE</th>
            </tr>
          </thead>
          <tbody>
            ${subjectScores.map(score => `
              <tr>
                <td>${score.name}</td>
                <td>${score.score}</td>
                <td>${score.grade}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<p class="text-center" style="color: #666; margin: 20px 0;">No marks entered for this student.</p>'}
      
      ${subjectCount > 0 ? `
        <table class="summary-table">
          <thead>
            <tr>
              <th>TOTAL MARKS</th>
              <th>AVERAGE SCORE</th>
              <th>AVERAGE GRADE</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${totalMarks}</td>
              <td>${average}</td>
              <td>${averageGrade}</td>
            </tr>
          </tbody>
        </table>
      ` : ''}
      
      <div class="signature-area">
        <div class="signature-box">
          <div class="signature-line-box"></div>
          <div>Class Teacher Signature</div>
        </div>
        <div class="signature-box">
          <div class="signature-line-box"></div>
          <div>Head Teacher Signature</div>
        </div>
      </div>
    `;
    
    document.getElementById('statTotalStudents').textContent = '1';
    document.getElementById('statAvgScore').textContent = average;
    document.getElementById('statHighScore').textContent = Math.max(...subjectScores.map(s => s.score));
    document.getElementById('statLowScore').textContent = Math.min(...subjectScores.map(s => s.score));
    
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
  }

  // Display class report
  async function displayClassReport(classId, marksData) {
    const classObj = currentClasses.find(c => c.id === classId);
    const students = currentStudents.filter(s => s.classId === classId);
    
    const studentAverages = [];
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        const average = total / count;
        studentAverages.push(average);
      }
    });
    
    const totalStudents = students.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const avgGrade = calculateGrade(avgScore, classObj?.level || currentSchool.level);
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <div class="skore-point-badge">
          <div class="skore-point-icon">
            <img src="/testing/skore-icon.jpg" alt="Skore Point" onerror="this.style.display='none'">
          </div>
          <div class="skore-point-text">SKORE POINT</div>
          <div class="serusoft-text">A product of SERUSOFT</div>
        </div>
        
        <div class="school-logo-large">
          <img src="${currentSchool.logoUrl || '/testing/skore-icon.jpg'}" alt="${currentSchool.name}" onerror="this.src='/testing/skore-icon.jpg'">
        </div>
        
        <div class="school-name">${currentSchool.name}</div>
        <div class="report-title">CLASS PERFORMANCE SUMMARY</div>
      </div>
      
      <div class="student-info-grid">
        <div class="info-item">
          <span class="info-label">Class:</span>
          <span class="info-value">${classObj ? classObj.name : 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Total Students:</span>
          <span class="info-value">${totalStudents}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Date:</span>
          <span class="info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">Performance Statistics</h4>
      <table class="subject-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Class Average Score</td>
            <td>${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Class Average Grade</td>
            <td>${avgGrade}</td>
            <td>${getGradeRemarks(avgGrade)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td>${highScore}%</td>
            <td>Excellent</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td>${lowScore}%</td>
            <td>Needs Improvement</td>
          </tr>
          <tr>
            <td>Students with Marks</td>
            <td>${studentAverages.length}</td>
            <td>${studentAverages.length}/${totalStudents} students</td>
          </tr>
        </tbody>
      </table>
    `;
    
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
    
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
  }

  // Export report card as PDF
  async function exportReportCards() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    if (!classId) {
      alert('Please select a class first');
      return;
    }
    
    showLoadingOverlay('Preparing PDF export...');
    
    try {
      await reloadDataForExport();
      
      if (studentId && studentId !== '') {
        await exportSingleReportCard(studentId, term);
      } else {
        await exportAllStudentReportCards(classId, term);
      }
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('Error generating PDFs:', error);
      alert('Error generating report cards. Please try again.');
    }
  }

  // Export single report card
  async function exportSingleReportCard(studentId, term) {
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) {
      hideLoadingOverlay();
      alert('Student not found');
      return;
    }
    
    const marksDoc = await firestoreModule.getDoc(
      firestoreModule.doc(firestoreDB, 'marks', `${studentId}_${term}`)
    );
    
    if (!marksDoc.exists()) {
      hideLoadingOverlay();
      alert('No marks found for this student');
      return;
    }
    
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Simple PDF generation
      doc.text(`Report Card for ${student.name}`, 10, 10);
      doc.text(`School: ${currentSchool.name}`, 10, 20);
      doc.text(`Class: ${getClassName(student.classId)}`, 10, 30);
      doc.text(`Term: ${term}`, 10, 40);
      
      const marks = marksDoc.data();
      let yPos = 50;
      
      currentSubjects.forEach(subject => {
        const score = marks[subject.id];
        if (score !== undefined) {
          doc.text(`${subject.name}: ${score}`, 10, yPos);
          yPos += 10;
        }
      });
      
      doc.save(`Report_Card_${student.name.replace(/\s+/g, '_')}.pdf`);
      
      hideLoadingOverlay();
      alert(`Report card for ${student.name} exported successfully!`);
      
    } catch (error) {
      console.error('Error generating single PDF:', error);
      alert('Error generating report card. Please try again.');
    }
  }

  // Export all student report cards
  async function exportAllStudentReportCards(classId, term) {
    hideLoadingOverlay();
    alert('Batch PDF export feature is being developed.');
  }

  // Export class analysis as Excel
  async function exportClassAnalysis() {
    const classId = document.getElementById('reportClassSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    if (!classId) {
      alert('Please select a class first');
      return;
    }
    
    showLoadingOverlay('Generating Excel report...');
    
    try {
      await reloadDataForExport();
      
      const classStudents = currentStudents.filter(s => s.classId === classId);
      const classObj = currentClasses.find(c => c.id === classId);
      
      if (classStudents.length === 0) {
        hideLoadingOverlay();
        alert('No students found in this class');
        return;
      }
      
      const marksQuery = firestoreModule.query(
        firestoreModule.collection(firestoreDB, 'marks'),
        firestoreModule.where('schoolId', '==', currentSchool.id),
        firestoreModule.where('term', '==', term)
      );
      
      const marksSnapshot = await firestoreModule.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      const wb = XLSX.utils.book_new();
      
      const classAnalysisData = [
        ['SKORE POINT - ANALYSIS GENERATED WITH SKORE POINT'],
        ['Professional School Report Card Generator by SERUSOFT'],
        [''],
        ['Class Analysis Report'],
        [`Class: ${classObj ? classObj.name : 'N/A'}`],
        [`Term: ${term}`],
        [`Date: ${new Date().toLocaleDateString()}`],
        [''],
        ['Student Performance Analysis'],
        ['Rank', 'Student Name', ...currentSubjects.map(s => s.name), 'Total Marks', 'Average Score', 'Average Grade']
      ];
      
      const studentScores = [];
      
      classStudents.forEach(student => {
        const studentMarks = marksData.find(m => m.studentId === student.id);
        if (!studentMarks) return;
        
        let totalMarks = 0;
        let subjectCount = 0;
        const scores = [];
        
        currentSubjects.forEach(subject => {
          const score = studentMarks[subject.id];
          if (score !== undefined && score > 0) {
            totalMarks += score;
            subjectCount++;
            scores.push(score);
          } else {
            scores.push(0);
          }
        });
        
        const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
        const averageGrade = calculateGrade(average, classObj?.level || currentSchool.level);
        
        studentScores.push({
          name: student.name,
          scores: scores,
          total: totalMarks,
          average: average,
          averageGrade: averageGrade
        });
      });
      
      studentScores.sort((a, b) => b.average - a.average);
      
      studentScores.forEach((student, index) => {
        classAnalysisData.push([
          index + 1,
          student.name,
          ...student.scores,
          student.total,
          student.average,
          student.averageGrade
        ]);
      });
      
      const classAnalysisWs = XLSX.utils.aoa_to_sheet(classAnalysisData);
      XLSX.utils.book_append_sheet(wb, classAnalysisWs, 'Class Analysis');
      
      const fileName = `Class_Analysis_${classObj ? classObj.name.replace(/\s+/g, '_') : 'Class'}_${term}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      hideLoadingOverlay();
      alert(`Excel report "${fileName}" generated successfully!`);
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('Error generating Excel:', error);
      alert('Error generating Excel report. Please try again.');
    }
  }

  // Export subject analytics
  async function exportSubjectAnalytics() {
    showLoadingOverlay('Generating analytics export...');
    
    try {
      const wb = XLSX.utils.book_new();
      const analyticsData = [
        ['SKORE POINT - SUBJECT ANALYTICS'],
        ['Generated:', new Date().toLocaleDateString()],
        ['Teacher:', currentUserData.name],
        ['School:', currentSchool.name],
        [''],
        ['Subject', 'Students', 'Average', 'Highest', 'Lowest', 'Pass Rate']
      ];
      
      const ws = XLSX.utils.aoa_to_sheet(analyticsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Analytics');
      
      const fileName = `Subject_Analytics_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      hideLoadingOverlay();
      alert(`Analytics exported successfully as ${fileName}`);
      
    } catch (error) {
      hideLoadingOverlay();
      console.error('Error exporting subject analytics:', error);
      alert('Error exporting analytics. Please try again.');
    }
  }

  // Reload data before export
  async function reloadDataForExport() {
    try {
      showLoadingOverlay('Loading data for export...');
      
      await Promise.all([
        loadClasses(),
        loadSubjects(),
        loadAllStudents()
      ]);
      
    } catch (error) {
      console.error('Error reloading data for export:', error);
      throw new Error('Failed to reload data. Please try again.');
    }
  }

  // Calculate grade
  function calculateGrade(score, level) {
    if (!level) level = 'primary';
    
    if (level.includes('primary')) {
      if (score >= 90) return 'D1';
      if (score >= 80) return 'D2';
      if (score >= 70) return 'C3';
      if (score >= 60) return 'C4';
      if (score >= 50) return 'C5';
      if (score >= 40) return 'C6';
      if (score >= 30) return 'P7';
      if (score >= 20) return 'P8';
      return 'F9';
    } else if (level === 'olevel') {
      if (score >= 80) return 'A';
      if (score >= 70) return 'B';
      if (score >= 60) return 'C';
      if (score >= 50) return 'D';
      if (score >= 40) return 'E';
      return 'F';
    } else {
      // A-Level grading
      if (score >= 90) return 'D1';
      if (score >= 80) return 'D2';
      if (score >= 70) return 'C3';
      if (score >= 60) return 'C4';
      if (score >= 50) return 'C5';
      if (score >= 40) return 'C6';
      if (score >= 30) return 'P7';
      if (score >= 20) return 'P8';
      return 'F9';
    }
  }

  // Calculate grade distribution
  function calculateGradeDistribution(scores, level) {
    const distribution = {};
    
    let grades;
    if (level.includes('primary') || level === 'alevel') {
      grades = ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9'];
    } else {
      grades = ['A', 'B', 'C', 'D', 'E', 'F'];
    }
    
    grades.forEach(grade => {
      distribution[grade] = 0;
    });
    
    scores.forEach(score => {
      const grade = calculateGrade(score, level);
      if (distribution[grade] !== undefined) {
        distribution[grade]++;
      }
    });
    
    return distribution;
  }

  // Get grade remarks
  function getGradeRemarks(grade) {
    if (grade === 'D1' || grade === 'D2' || grade === 'A') return 'Distinction';
    if (grade === 'C3' || grade === 'C4' || grade === 'C5' || grade === 'B') return 'Credit';
    if (grade === 'C6' || grade === 'C' || grade === 'D') return 'Pass';
    if (grade === 'P7' || grade === 'P8' || grade === 'E') return 'Pass with Support';
    return 'Fail';
  }

  // Get performance remarks
  function getPerformanceRemarks(average) {
    if (average >= 80) return 'Excellent';
    if (average >= 70) return 'Very Good';
    if (average >= 60) return 'Good';
    if (average >= 50) return 'Satisfactory';
    if (average >= 40) return 'Fair';
    return 'Needs Improvement';
  }

  // Generate school code
  function generateSchoolCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Open school portal
  function openSchoolPortal() {
    isSchoolPortalOpen = true;
    
    document.getElementById('managementSchoolName').textContent = currentSchool.name;
    document.getElementById('managementSchoolCode').textContent = currentSchool.code;
    
    if (currentSchool.logoUrl) {
      const managementLogo = document.getElementById('managementSchoolLogo');
      managementLogo.src = currentSchool.logoUrl;
      managementLogo.style.display = 'block';
    }
    
    if (isMobileView) {
      containers.mobileBottomNav.style.display = 'flex';
      containers.mobileBottomNav.classList.add('active');
      containers.portalExitBtn.style.display = 'none';
    } else {
      containers.portalExitBtn.style.display = 'flex';
    }
    
    showContainer('schoolManagementSection');
    
    updatePermissions();
    
    loadClasses();
    
    if (isMobileView) {
      document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
      document.querySelector('.mobile-nav-item[data-tab="classes"]').classList.add('active');
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Refresh school data
  async function refreshSchoolData() {
    showLoadingOverlay('Refreshing school data...');
    await loadSchoolData(currentSchool.id);
    hideLoadingOverlay();
    alert('School data refreshed successfully!');
  }

  // Refresh reports data
  async function refreshReportsData() {
    showLoadingOverlay('Refreshing reports data...');
    await preloadReportsData();
    hideLoadingOverlay();
    alert('Reports data refreshed successfully!');
  }

  // Close school portal
  function closeSchoolPortal() {
    isSchoolPortalOpen = false;
    
    containers.portalExitBtn.style.display = 'none';
    containers.mobileBottomNav.style.display = 'none';
    containers.mobileBottomNav.classList.remove('active');
    
    showContainer('dashboardSection');
  }

  // Update permissions
  function updatePermissions() {
    const isAdmin = currentUserData.role === 'admin';
    
    const addButtons = ['addClassBtn', 'addSubjectBtn', 'addStudentBtn'];
    addButtons.forEach(btnId => {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.style.display = isAdmin ? 'block' : 'none';
      }
    });
    
    document.getElementById('studentUploadContainer').style.display = isAdmin ? 'block' : 'none';
    
    const permissionNotes = {
      classPermissionNote: !isAdmin,
      studentPermissionNote: !isAdmin,
      subjectPermissionNote: !isAdmin,
      teacherPermissionNote: !isAdmin,
      marksPermissionNote: !isAdmin && currentUserData.subject
    };
    
    Object.entries(permissionNotes).forEach(([id, show]) => {
      const note = document.getElementById(id);
      if (note) {
        note.classList.toggle('d-none', !show);
      }
    });
    
    // Show academic level selector for secondary schools
    if (currentSchool.level === 'secondary') {
      document.getElementById('academicLevelSelector').style.display = 'block';
    }
  }

  // Show user guide
  function showUserGuide() {
    alert(`Skore Point User Guide

SCHOOL JOINING:
 Type school name - get suggestions as you type
 Enter 6-digit school code (obtained from school admin)
 Codes automatically convert to UPPERCASE

ACADEMIC LEVELS:
 Lower Primary (P1-P3): Literacy, Mathematics, English
 Upper Primary (P4-P7): Science, Mathematics, English, Social Studies
 O-Level (S1-S4): Standard secondary subjects
 A-Level (S5-S6): Principal & Subsidiary subjects

A-LEVEL FEATURES:
 Select subject combinations (PCM, PCB, etc.)
 Multiple papers per subject
 UNEB grading system

REPORT CARDS:
 Professional A4 design
 SKORE POINT branding
 School logo display
 Export as PDF/Excel

ADMIN FEATURES:
 Manage classes, students, subjects, teachers
 Assign subjects to teachers
 Generate comprehensive reports
 Role management

TEACHER FEATURES:
 Enter marks for assigned subjects
 Generate subject analytics
 Export performance reports

SUPPORT:
Contact your school administrator for assistance.`);
  }

  // Handle logout
  async function handleLogout() {
    try {
      await authModule.signOut(firebaseAuth);
      currentUser = null;
      currentUserData = null;
      currentSchool = null;
      isSchoolPortalOpen = false;
      containers.mobileBottomNav.style.display = 'none';
      containers.mobileBottomNav.classList.remove('active');
      containers.portalExitBtn.style.display = 'none';
      showContainer('loginSection');
    } catch (error) {
      console.error('Error signing out:', error);
      alert('Error signing out. Please try again.');
    }
  }

  // Utility functions
  function showContainer(containerId) {
    document.querySelectorAll('.container').forEach(container => {
      container.classList.remove('active');
    });
    
    const container = document.getElementById(containerId);
    if (container) {
      container.classList.add('active');
    }
  }

  function hideLaunchScreen() {
    containers.launchScreen.style.display = 'none';
  }

  function showAlert(id, message, type) {
    const alert = document.getElementById(id);
    if (!alert) return;
    
    alert.className = `alert ${type}`;
    const textElement = alert.querySelector(`#${id}Text`);
    if (textElement) {
      textElement.innerHTML = message;
    }
    alert.classList.remove('d-none');
  }

  function hideAlert(id) {
    const alert = document.getElementById(id);
    if (alert) alert.classList.add('d-none');
  }

  // Global functions for button clicks
  window.deleteClass = async function(classId) {
    if (confirm('Are you sure you want to delete this class?')) {
      try {
        await firestoreModule.deleteDoc(
          firestoreModule.doc(firestoreDB, 'classes', classId)
        );
        loadClasses();
        alert('Class deleted successfully!');
      } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please try again.');
      }
    }
  };

  window.deleteStudent = async function(studentId) {
    if (confirm('Are you sure you want to delete this student?')) {
      try {
        await firestoreModule.deleteDoc(
          firestoreModule.doc(firestoreDB, 'students', studentId)
        );
        loadStudents();
        alert('Student deleted successfully!');
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student. Please try again.');
      }
    }
  };

  window.deleteSubject = async function(subjectId) {
    if (confirm('Are you sure you want to delete this subject?')) {
      try {
        await firestoreModule.deleteDoc(
          firestoreModule.doc(firestoreDB, 'subjects', subjectId)
        );
        loadSubjects();
        alert('Subject deleted successfully!');
      } catch (error) {
        console.error('Error deleting subject:', error);
        alert('Error deleting subject. Please try again.');
      }
    }
  };

  window.promoteTeacher = async function(teacherId, currentRole) {
    const newRole = currentRole === 'admin' ? 'teacher' : 'admin';
    const action = currentRole === 'admin' ? 'demote from admin' : 'promote to admin';
    
    if (confirm(`Are you sure you want to ${action} this teacher?`)) {
      try {
        // Update user role
        await firestoreModule.updateDoc(
          firestoreModule.doc(firestoreDB, 'users', teacherId),
          {
            role: newRole
          }
        );
        
        // Update school admin list
        if (newRole === 'admin') {
          await firestoreModule.updateDoc(
            firestoreModule.doc(firestoreDB, 'schools', currentSchool.id),
            {
              admins: firestoreModule.arrayUnion(teacherId)
            }
          );
        } else {
          await firestoreModule.updateDoc(
            firestoreModule.doc(firestoreDB, 'schools', currentSchool.id),
            {
              admins: firestoreModule.arrayRemove(teacherId)
            }
          );
        }
        
        loadTeachers();
        alert(`Teacher ${action} successfully!`);
        
      } catch (error) {
        console.error(`Error ${action} teacher:`, error);
        alert(`Error ${action} teacher. Please try again.`);
      }
    }
  };

  window.assignSubjectsToTeacher = async function(teacherId) {
    openAssignSubjectsModal(teacherId);
  };

  window.removeTeacher = async function(teacherId) {
    if (confirm('Are you sure you want to remove this teacher from the school?')) {
      try {
        // Remove from school lists
        await firestoreModule.updateDoc(
          firestoreModule.doc(firestoreDB, 'schools', currentSchool.id),
          {
            teachers: firestoreModule.arrayRemove(teacherId),
            admins: firestoreModule.arrayRemove(teacherId)
          }
        );
        
        // Remove school from user
        await firestoreModule.updateDoc(
          firestoreModule.doc(firestoreDB, 'users', teacherId),
          {
            schoolId: null,
            role: 'teacher'
          }
        );
        
        loadTeachers();
        alert('Teacher removed from school successfully!');
        
      } catch (error) {
        console.error('Error removing teacher:', error);
        alert('Error removing teacher. Please try again.');
      }
    }
  };
</script>
</body>
</html>

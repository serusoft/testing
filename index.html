<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skore Point | Professional School Report Card Generator</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4361ee">
  <meta name="description" content="Professional School Report Card Generator by SERUSOFT">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="skore-icon.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="skore-icon.jpg">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #4895ef;
      --secondary: #4cc9f0;
      --accent: #7209b7;
      --accent-light: #9d4edd;
      --dark: #0f172a;
      --darker: #0a0f1f;
      --light: #f8fafc;
      --gray: #334155;
      --gray-light: #64748b;
      --gray-lighter: #cbd5e1;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      --card-gradient: linear-gradient(135deg, rgba(67, 97, 238, 0.08) 0%, rgba(114, 9, 183, 0.08) 100%);
      --border-radius: 12px;
      --border-radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      font-size: 15px;
      line-height: 1.5;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient);
      opacity: 0.03;
      z-index: -1;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Container Management */
    .container {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .container.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Fixed Navigation Bar */
    .navbar {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .navbar-brand {
      font-size: 24px;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-brand i {
      font-size: 22px;
    }

    .navbar-nav {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-link {
      color: var(--light);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .nav-link.active {
      background: var(--primary);
    }

    .close-portal {
      background: var(--error);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .close-portal:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      z-index: 1000;
      padding: 10px 0;
    }

    .mobile-bottom-nav.active {
      display: flex;
    }

    .mobile-nav-items {
      display: flex;
      justify-content: space-around;
      width: 100%;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--gray-lighter);
      text-decoration: none;
      padding: 8px;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      min-width: 60px;
      font-size: 12px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .mobile-nav-item:hover,
    .mobile-nav-item.active {
      color: var(--primary);
      background: rgba(67, 97, 238, 0.1);
    }

    .mobile-nav-item i {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .mobile-nav-item span {
      font-size: 11px;
      font-weight: 500;
      text-align: center;
    }

    /* Desktop Portal Exit Button */
    .portal-exit-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--error);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      box-shadow: var(--shadow);
      display: none;
    }

    .portal-exit-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    /* Launch Screen */
    .launch-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .launch-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      z-index: 2;
      max-width: 800px;
      width: 100%;
      height: 100%;
    }

    .logo-wrapper {
      position: relative;
      margin-bottom: 40px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .logo {
      font-size: clamp(40px, 8vw, 80px);
      font-weight: 800;
      color: white;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
      position: relative;
      display: inline-block;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                     0 0 30px rgba(255, 255, 255, 0.4);
      }
      to {
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
                     0 0 50px rgba(255, 255, 255, 0.6);
      }
    }

    .tagline {
      font-size: clamp(18px, 4vw, 24px);
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 50px;
      animation: fadeIn 2s ease-in;
      font-weight: 300;
      letter-spacing: 1px;
      line-height: 1.4;
      max-width: 600px;
    }

    .loader {
      width: min(300px, 80%);
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto;
      position: relative;
    }

    .loader-bar {
      height: 100%;
      background: linear-gradient(90deg, #fff, #f0f0f0, #fff);
      background-size: 200% 100%;
      border-radius: 10px;
      animation: loading 2s ease-in-out infinite;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    @keyframes loading {
      0% {
        width: 0%;
        background-position: 0% 0%;
      }
      50% {
        width: 70%;
        background-position: 100% 0%;
      }
      100% {
        width: 100%;
        background-position: 200% 0%;
      }
    }

    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 80px;
    }

    /* Auth Containers */
    .auth-container {
      width: 100%;
      max-width: 420px;
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 40px 30px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.6s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      margin: 20px auto;
    }

    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--gradient);
    }

    .close-auth-form {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--gray-light);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      z-index: 10;
    }

    .close-auth-form:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--error);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-right: 30px;
    }

    .header h1 {
      font-size: 28px;
      letter-spacing: 1px;
      margin-bottom: 10px;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .header p {
      font-size: 15px;
      color: var(--gray-lighter);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--gray-lighter);
      font-weight: 500;
    }

    .form-group i {
      margin-right: 8px;
      color: var(--primary-light);
      width: 16px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray);
      border-radius: var(--border-radius-sm);
      background: var(--darker);
      color: var(--light);
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
    }

    .form-group select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 40px;
      cursor: pointer;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }

    .password-toggle {
      position: absolute;
      right: 15px;
      top: 40px;
      background: none;
      border: none;
      color: var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 5px;
      border-radius: 4px;
    }

    .password-toggle:hover {
      color: var(--primary);
      background: rgba(255, 255, 255, 0.05);
    }

    /* Student Search */
    .student-search-container {
      position: relative;
      margin-bottom: 20px;
    }

    .student-search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .student-search-input {
      width: 100%;
      padding: 14px 50px 14px 45px;
      border: 2px solid var(--gray);
      border-radius: var(--border-radius-sm);
      background: var(--darker);
      color: var(--light);
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
    }

    .student-search-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }

    .student-search-icon {
      position: absolute;
      left: 15px;
      color: var(--primary-light);
      font-size: 18px;
    }

    .student-search-clear {
      position: absolute;
      right: 15px;
      background: none;
      border: none;
      color: var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 5px;
      border-radius: 4px;
      display: none;
    }

    .student-search-clear:hover {
      color: var(--error);
      background: rgba(239, 68, 68, 0.1);
    }

    .student-search-clear.show {
      display: block;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-size: 15px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      touch-action: manipulation;
      user-select: none;
    }

    .btn-block {
      width: 100%;
    }

    .btn-primary {
      background: var(--gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
    }

    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover {
      background: rgba(67, 97, 238, 0.1);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn-info {
      background: var(--info);
      color: white;
    }

    .btn-light {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Alerts */
    .alert {
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in;
    }

    .error { 
      background: rgba(239, 68, 68, 0.15); 
      border: 1px solid var(--error); 
      color: var(--error); 
    }
    
    .success { 
      background: rgba(16, 185, 129, 0.15); 
      border: 1px solid var(--success); 
      color: var(--success); 
    }
    
    .warning { 
      background: rgba(245, 158, 11, 0.15); 
      border: 1px solid var(--warning); 
      color: var(--warning); 
    }
    
    .info { 
      background: rgba(59, 130, 246, 0.15); 
      border: 1px solid var(--info); 
      color: var(--info); 
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 10px;
    }

    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }

    /* Footer Links */
    .footer-links {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--gray-light);
    }

    .footer-links button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      padding: 0 5px;
      touch-action: manipulation;
    }

    .footer-links button:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }

    /* Dashboard */
    .dashboard {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-header h1 {
      font-size: clamp(24px, 5vw, 32px);
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }

    /* User Profile Card */
    .user-info {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 400px;
    }

    .user-profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--primary);
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-light);
    }

    .user-profile-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .user-role {
      font-weight: 700;
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      align-self: flex-start;
    }

    .user-role.admin {
      background: rgba(67, 97, 238, 0.2);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .user-role.teacher {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .user-name {
      font-weight: 600;
      color: var(--light);
      font-size: 18px;
    }

    .user-email {
      color: var(--gray-light);
      font-size: 14px;
    }

    .logout-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      touch-action: manipulation;
      align-self: flex-start;
      margin-top: 10px;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .card {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
      border-color: rgba(67, 97, 238, 0.3);
    }

    .card i {
      font-size: 40px;
      margin-bottom: 20px;
      color: var(--primary-light);
    }

    .card h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--light);
    }

    .card p {
      color: var(--gray-lighter);
      font-size: 15px;
      line-height: 1.6;
    }

    .school-logo {
      max-width: 150px;
      max-height: 100px;
      margin: 15px 0;
      object-fit: contain;
      background: white;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--gray-lighter);
    }

    /* School Management */
    .school-management {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .management-header {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 25px 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .management-header h2 {
      font-size: clamp(20px, 4vw, 28px);
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .school-code {
      background: rgba(67, 97, 238, 0.1);
      padding: 10px 20px;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      letter-spacing: 1px;
      border: 1px solid var(--primary);
      font-family: 'Courier New', monospace;
    }

    .management-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 30px;
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      white-space: nowrap;
      color: var(--gray-lighter);
      border: none;
      background: transparent;
      font-size: 15px;
      touch-action: manipulation;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    .tab:not(.active):hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    /* Lists */
    .list-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .list-header h3 {
      font-size: 20px;
      color: var(--light);
    }

    /* List Grid */
    .list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .list-item {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    .list-item:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-2px);
      border-color: rgba(67, 97, 238, 0.3);
    }

    .list-item h4 {
      font-size: 17px;
      margin-bottom: 10px;
      color: var(--light);
    }

    .list-item p {
      color: var(--gray-light);
      font-size: 14px;
      margin-bottom: 15px;
    }

    .item-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .item-actions button {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* File Upload */
    .file-upload-container {
      margin-bottom: 30px;
    }

    .file-upload {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 40px 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.02);
      position: relative;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }

    .file-upload i {
      font-size: 48px;
      margin-bottom: 20px;
      color: var(--primary-light);
    }

    .file-upload h4 {
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--light);
    }

    .file-upload p {
      color: var(--gray-lighter);
      margin-bottom: 15px;
      font-size: 14px;
    }

    .file-upload span {
      font-size: 13px;
      color: var(--gray-light);
    }

    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      z-index: 10;
    }

    /* Image Upload */
    .image-upload {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius);
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
    }

    .image-upload:hover {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }

    .image-upload i {
      font-size: 40px;
      margin-bottom: 15px;
      color: var(--primary-light);
    }

    .image-upload p {
      color: var(--gray-lighter);
      margin-bottom: 10px;
    }

    .image-upload span {
      font-size: 13px;
      color: var(--gray-light);
    }

    .image-preview {
      max-width: 200px;
      max-height: 200px;
      margin: 0 auto 15px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      display: none;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Marks Entry */
    .marks-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .marks-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .student-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark);
      border: 1px solid var(--gray);
      border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm);
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: var(--shadow);
    }

    .student-suggestion {
      padding: 12px 15px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--light);
    }

    .student-suggestion:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .selected-student {
      background: rgba(67, 97, 238, 0.1);
      border: 1px solid var(--primary);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      margin-bottom: 30px;
    }

    .selected-student h4 {
      color: var(--primary);
      margin-bottom: 5px;
    }

    .marks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .mark-input {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .mark-input label {
      display: block;
      margin-bottom: 10px;
      color: var(--light);
      font-weight: 500;
    }

    .mark-input input {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      background: var(--darker);
      border: 1px solid var(--gray);
      color: var(--light);
      border-radius: 6px;
    }

    /* Reports */
    .reports-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .report-filters {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .report-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-gradient);
      border-radius: var(--border-radius-sm);
      padding: 25px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-card h4 {
      font-size: 14px;
      color: var(--gray-lighter);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-card p {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
    }

    /* Enhanced Report Card - MATCHING TEMPLATE 100% */
    .enhanced-report-card {
      background: white;
      color: #333;
      border-radius: 0;
      padding: 30px;
      margin-top: 30px;
      border: 1px solid #ddd;
      position: relative;
      overflow: hidden;
      font-family: 'Times New Roman', Times, serif;
      width: 210mm;
      min-height: 297mm;
      margin: 20px auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      page-break-inside: avoid;
      font-size: 12px;
    }

    /* Report Card Header matching template */
    .report-header {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      padding-top: 10px;
    }

    .skore-point-badge {
      position: absolute;
      left: 20px;
      top: 10px;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .skore-point-icon {
      width: 40px;
      height: 40px;
      margin-bottom: 2px;
    }

    .skore-point-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .skore-point-text {
      font-size: 10px;
      font-weight: bold;
      color: #4361ee;
      margin: 0;
      line-height: 1.2;
    }

    .serusoft-text {
      font-size: 8px;
      color: #666;
      font-style: italic;
      margin: 2px 0 0 0;
      line-height: 1;
    }

    .school-logo-large {
      display: inline-block;
      margin: 5px auto 10px;
      width: 80px;
      height: 80px;
    }

    .school-logo-large img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border: 1px solid #ddd;
      padding: 2px;
      background: white;
    }

    .school-name {
      font-size: 20px;
      font-weight: bold;
      margin: 5px 0 3px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #000;
    }

    .report-title {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-decoration: underline;
      color: #000;
    }

    /* Student Information - Adjusted for better fit */
    .student-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
      padding: 12px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      font-size: 11px;
    }

    .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .info-label {
      font-weight: bold;
      min-width: 100px;
      color: #333;
      font-size: 11px;
    }

    .info-value {
      flex: 1;
      color: #000;
      font-weight: normal;
      font-size: 11px;
    }

    /* Subject Table matching template - Adjusted for better fit */
    .subject-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border: 2px solid #000;
      font-size: 11px;
    }

    .subject-table th {
      background: #f0f0f0;
      font-weight: bold;
      text-align: center;
      padding: 6px 4px;
      border: 1px solid #000;
      font-size: 11px;
      text-transform: uppercase;
    }

    .subject-table td {
      padding: 6px 4px;
      border: 1px solid #000;
      text-align: center;
      font-size: 11px;
    }

    /* Summary Table matching template - Adjusted for better fit */
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 11px;
    }

    .summary-table th {
      background: #4361ee;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 8px;
      border: 1px solid #000;
      font-size: 11px;
      text-transform: uppercase;
    }

    .summary-table td {
      padding: 8px;
      text-align: center;
      border: 1px solid #000;
      font-weight: bold;
      font-size: 11px;
      background: #f8f8f8;
    }

    /* Remarks Section - Adjusted for better fit */
    .remarks-section {
      margin: 20px 0;
      font-size: 11px;
    }

    .remarks-section h4 {
      margin-bottom: 6px;
      font-weight: bold;
      font-size: 11px;
      color: #333;
    }

    .signature-line {
      border-bottom: 1px solid #000;
      margin-top: 3px;
      padding-top: 15px;
      height: 25px;
    }

    .next-term-info {
      margin-top: 15px;
      font-size: 11px;
    }

    .next-term-info p {
      margin-bottom: 3px;
    }

    /* Signature Area - Adjusted for better fit */
    .signature-area {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 10px;
      border-top: 2px solid #000;
      font-size: 11px;
    }

    .signature-box {
      text-align: center;
      flex: 1;
      min-width: 100px;
    }

    .signature-line-box {
      border-bottom: 1px solid #000;
      margin: 20px auto 5px;
      width: 80%;
    }

    .signature-box div {
      margin-top: 3px;
      font-weight: bold;
      color: #333;
      font-size: 11px;
    }

    /* Analytics */
    .subject-analytics-container {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .analytics-header h3 {
      font-size: 20px;
      color: var(--light);
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .analytics-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .analytics-card h4 {
      font-size: 16px;
      margin-bottom: 15px;
      color: var(--light);
    }

    .grade-distribution {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }

    .grade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
    }

    /* Subject Checkboxes */
    .subject-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .subject-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }

    .subject-checkbox:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-light);
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 25px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin-bottom: 15px;
      font-size: 22px;
      color: var(--gray-lighter);
    }

    .empty-state p {
      max-width: 500px;
      margin: 0 auto;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .modal-header h3 {
      font-size: 22px;
      color: var(--light);
    }

    .close-modal {
      background: var(--error);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
    }

    .close-modal:hover {
      background: #dc2626;
      transform: rotate(90deg);
    }

    /* Full Screen Forms */
    .full-screen-form {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark);
      z-index: 1000;
      overflow-y: auto;
      padding: 40px 20px;
      display: none;
    }

    .full-screen-form.active {
      display: block;
    }

    .close-fullscreen {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--error);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      z-index: 1001;
      transition: var(--transition);
    }

    .close-fullscreen:hover {
      background: #dc2626;
      transform: rotate(90deg);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .navbar {
        padding: 12px 15px;
      }
      
      .navbar-nav {
        display: none !important;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-info {
        width: 100%;
      }
      
      .management-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .management-tabs.desktop-only {
        display: none;
      }
      
      .enhanced-report-card {
        padding: 15px;
        width: 100%;
        min-height: auto;
        font-size: 10px;
      }
      
      .student-info-grid {
        grid-template-columns: 1fr;
        font-size: 10px;
      }
      
      .signature-area {
        flex-direction: column;
        gap: 15px;
      }
      
      .portal-exit-btn {
        display: none !important;
      }
      
      .list-grid {
        grid-template-columns: 1fr;
      }
      
      .subject-table,
      .summary-table {
        font-size: 9px;
      }
      
      .subject-table th,
      .subject-table td {
        padding: 4px 3px;
      }
    }

    @media (min-width: 769px) {
      .mobile-bottom-nav {
        display: none !important;
      }
    }

    /* Smooth scrolling for tabs */
    .smooth-scroll {
      scroll-behavior: smooth;
    }

    .required {
      color: var(--error);
    }
    
    /* Offline Indicator */
    .offline-indicator {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      background: var(--warning);
      color: var(--dark);
      text-align: center;
      padding: 10px;
      font-weight: 600;
      z-index: 999;
      display: none;
    }

    .offline-indicator.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Utility Classes */
    .d-none {
      display: none !important;
    }
    
    .mt-10 { margin-top: 10px; }
    .mt-20 { margin-top: 20px; }
    .mt-30 { margin-top: 30px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-30 { margin-bottom: 30px; }
    .w-100 { width: 100%; }
    .text-center { text-align: center; }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">
    <i class="fas fa-wifi-slash"></i> You are currently offline
  </div>

  <!-- LAUNCH SCREEN -->
  <div class="launch-screen" id="launchScreen">
    <div class="launch-container">
      <div class="logo-wrapper">
        <div class="logo">Skore Point</div>
      </div>
      <div class="tagline">Professional School Report Card Generator by SERUSOFT</div>
      <div class="loader">
        <div class="loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- FIXED NAVIGATION BAR -->
  <nav class="navbar" id="navbar">
    <div class="navbar-brand">
      <i class="fas fa-graduation-cap"></i> Skore Point
    </div>
    <div class="navbar-nav">
      <a href="#" class="nav-link" id="userGuideBtn">
        <i class="fas fa-question-circle"></i> User Guide
      </a>
      <button class="logout-btn desktop-only" id="desktopLogoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>

  <!-- MOBILE BOTTOM NAVIGATION -->
  <div class="mobile-bottom-nav" id="mobileBottomNav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-item" data-tab="classes">
        <i class="fas fa-chalkboard"></i>
        <span>Classes</span>
      </button>
      <button class="mobile-nav-item" data-tab="students">
        <i class="fas fa-users"></i>
        <span>Students</span>
      </button>
      <button class="mobile-nav-item" data-tab="subjects">
        <i class="fas fa-book"></i>
        <span>Subjects</span>
      </button>
      <button class="mobile-nav-item" data-tab="teachers">
        <i class="fas fa-chalkboard-teacher"></i>
        <span>Teachers</span>
      </button>
      <button class="mobile-nav-item" data-tab="marks">
        <i class="fas fa-edit"></i>
        <span>Marks</span>
      </button>
      <button class="mobile-nav-item" data-tab="reports">
        <i class="fas fa-chart-bar"></i>
        <span id="reportsTabLabel">Reports</span>
      </button>
    </div>
  </div>

  <!-- DESKTOP PORTAL EXIT BUTTON -->
  <button class="portal-exit-btn" id="portalExitBtn">
    <i class="fas fa-door-open"></i> Exit Portal
  </button>

  <!-- MAIN CONTENT CONTAINER -->
  <div class="main-container">
    
    <!-- LOGIN SECTION -->
    <div class="container" id="loginSection">
      <div class="auth-container">
        <div class="header">
          <h1>Welcome Back</h1>
          <p>Sign in to your account</p>
        </div>

        <div id="loginError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="loginErrorText"></span>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input type="email" id="loginEmail" placeholder="teacher@school.edu" required>
          </div>

          <div class="form-group">
            <label for="loginPassword">
              <i class="fas fa-lock"></i> Password
            </label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
            <button type="button" class="password-toggle" id="loginToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> Sign In
          </button>

          <div class="loading d-none" id="loginLoading">
            <div class="spinner"></div>
            <p>Signing in...</p>
          </div>
        </form>

        <div class="footer-links">
          <p>
            Don't have an account? 
            <button id="goRegister">Create User Account</button>
          </p>
          <p>
            <button id="forgotPassword">Forgot Password?</button>
          </p>
        </div>
      </div>
    </div>

    <!-- REGISTER SECTION -->
    <div class="container" id="registerSection">
      <div class="auth-container">
        <div class="header">
          <h1>Create User Account</h1>
          <p>Join Skore Point today</p>
        </div>

        <div id="registerError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="registerErrorText"></span>
        </div>

        <div id="registerSuccess" class="alert success d-none">
          <i class="fas fa-check-circle"></i>
          <span>Account created successfully!</span>
        </div>

        <form id="registerForm">
          <div class="form-group">
            <label for="regName">
              <i class="fas fa-user"></i> Full Name <span class="required">*</span>
            </label>
            <input type="text" id="regName" placeholder="John Doe" required>
          </div>

          <div class="form-group">
            <label for="regEmail">
              <i class="fas fa-envelope"></i> Email Address <span class="required">*</span>
            </label>
            <input type="email" id="regEmail" placeholder="john@school.edu" required>
          </div>

          <div class="form-group">
            <label for="regSubject">
              <i class="fas fa-book"></i> Primary Teaching Subject <span class="required">*</span>
            </label>
            <input type="text" id="regSubject" placeholder="Mathematics" required>
          </div>

          <div class="image-upload" id="profileUploadArea">
            <i class="fas fa-user-circle"></i>
            <p>Upload Profile Picture <span class="required">*</span></p>
            <span>Click to upload (Required)</span>
            <div class="image-preview profile-preview" id="profilePreview">
              <img id="profilePreviewImg" src="" alt="Profile Preview">
            </div>
            <input type="file" class="file-input" id="profileFile" accept="image/*" required>
            <input type="hidden" id="profileUrl">
            <div class="loading d-none" id="profileUploadLoading">
              <div class="spinner"></div>
              <p>Uploading...</p>
            </div>
          </div>

          <div class="form-group">
            <label for="regPassword">
              <i class="fas fa-lock"></i> Password <span class="required">*</span>
            </label>
            <input type="password" id="regPassword" placeholder="Minimum 6 characters" required minlength="6">
            <button type="button" class="password-toggle" id="registerToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div class="form-group">
            <label for="confirmPassword">
              <i class="fas fa-lock"></i> Confirm Password <span class="required">*</span>
            </label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <button type="button" class="password-toggle" id="confirmToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-user-plus"></i> Create User Account
          </button>

          <div class="loading d-none" id="registerLoading">
            <div class="spinner"></div>
            <p>Creating account...</p>
          </div>
        </form>

        <div class="footer-links">
          <p>
            Already have an account? 
            <button id="goLogin">Sign In</button>
          </p>
        </div>
      </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div class="container" id="dashboardSection">
      <div class="dashboard">
        <div class="dashboard-header">
          <h1>Dashboard</h1>
          <div class="user-info" id="userInfoCard">
            <!-- Profile picture and details will be loaded here -->
          </div>
        </div>

        <div class="dashboard-cards">
          <!-- School Portal Card -->
          <div class="card" id="manageSchoolCard" style="display: none;">
            <i class="fas fa-school"></i>
            <h3>School Portal</h3>
            <p>Access your school's management portal to manage classes, students, and generate reports.</p>
            <div id="schoolCardInfo" class="mt-30">
              <img id="schoolCardLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
              <h4 id="schoolCardName"></h4>
              <p>Code: <strong id="schoolCardCode"></strong></p>
              <div class="mt-20">
                <button class="btn btn-success btn-block" id="openSchoolPortalBtn">
                  <i class="fas fa-door-open"></i> Enter Portal
                </button>
              </div>
            </div>
          </div>

          <div class="card" id="joinSchoolCard">
            <i class="fas fa-user-plus"></i>
            <h3>Join School</h3>
            <p>Join an existing school using the school name and unique access code provided by your administrator.</p>
            <button class="btn btn-secondary btn-block mt-20" id="joinSchoolBtn">
              <i class="fas fa-sign-in-alt"></i> Join School
            </button>
          </div>

          <div class="card" id="registerSchoolCard">
            <i class="fas fa-plus-circle"></i>
            <h3>Register School</h3>
            <p>Create a new school on Skore Point and become the administrator. Get a unique code for other teachers to join.</p>
            <button class="btn btn-primary btn-block mt-20" id="registerSchoolBtn">
              <i class="fas fa-school"></i> Register School
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCHOOL MANAGEMENT SECTION -->
    <div class="container" id="schoolManagementSection">
      <div class="school-management">
        <div class="management-header">
          <div>
            <h2 id="managementSchoolName">School Name</h2>
            <div class="school-code mt-10">
              School Code: <span id="managementSchoolCode"></span>
            </div>
          </div>
          <img id="managementSchoolLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
        </div>

        <!-- Desktop Tabs -->
        <div class="management-tabs desktop-only" id="managementTabs">
          <button class="tab active" data-tab="classes">
            <i class="fas fa-chalkboard"></i> Classes
          </button>
          <button class="tab" data-tab="students">
            <i class="fas fa-users"></i> Students
          </button>
          <button class="tab" data-tab="subjects">
            <i class="fas fa-book"></i> Subjects
          </button>
          <button class="tab" data-tab="teachers">
            <i class="fas fa-chalkboard-teacher"></i> Teachers
          </button>
          <button class="tab" data-tab="marks">
            <i class="fas fa-edit"></i> Enter Marks
          </button>
          <button class="tab" data-tab="reports" id="desktopReportsTab">
            <i class="fas fa-chart-bar"></i> <span id="desktopReportsLabel">Reports</span>
          </button>
        </div>

        <!-- Classes Tab -->
        <div class="tab-content active" id="classesTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Classes</h3>
              <div id="classPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to classes.
              </div>
              <button class="btn btn-primary" id="addClassBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Class
              </button>
            </div>

            <div class="list-grid" id="classList">
              <!-- Classes will be loaded here -->
            </div>

            <div class="empty-state d-none" id="classesEmptyState">
              <i class="fas fa-chalkboard"></i>
              <h3>No Classes Yet</h3>
              <p>Start by adding your first class to the school.</p>
            </div>
          </div>
        </div>

        <!-- Students Tab -->
        <div class="tab-content" id="studentsTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Students</h3>
              <div id="studentPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to students.
              </div>
              <button class="btn btn-primary" id="addStudentBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Student
              </button>
            </div>

            <div class="form-group mb-30">
              <label><i class="fas fa-filter"></i> Filter by Class</label>
              <select id="studentClassSelect" class="w-100">
                <option value="">All Classes</option>
              </select>
            </div>

            <div class="file-upload-container" id="studentUploadContainer" style="display: none;">
              <div class="file-upload" id="studentUploadArea">
                <i class="fas fa-file-excel"></i>
                <h4>Upload Student List</h4>
                <p>Upload an Excel file with student names. The first column should contain student names.</p>
                <span>Supported formats: .xlsx, .xls</span>
                <input type="file" class="file-input" id="studentFile" accept=".xlsx,.xls">
              </div>
            </div>

            <div class="list-grid" id="studentList">
              <!-- Students will be loaded here -->
            </div>

            <div class="empty-state d-none" id="studentsEmptyState">
              <i class="fas fa-users"></i>
              <h3>No Students Yet</h3>
              <p>Add students individually or upload an Excel file with student names.</p>
            </div>
          </div>
        </div>

        <!-- Subjects Tab -->
        <div class="tab-content" id="subjectsTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Subjects</h3>
              <div id="subjectPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to subjects.
              </div>
              <button class="btn btn-primary" id="addSubjectBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Subject
              </button>
            </div>

            <div class="list-grid" id="subjectsList">
              <!-- Subjects will be loaded here -->
            </div>

            <div class="empty-state d-none" id="subjectsEmptyState">
              <i class="fas fa-book"></i>
              <h3>No Subjects Yet</h3>
              <p>Add subjects to your school curriculum.</p>
            </div>
          </div>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-content" id="teachersTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Teachers</h3>
              <div id="teacherPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to teachers.
              </div>
              <button class="btn btn-primary" id="addTeacherBtn" style="display: none;">
                <i class="fas fa-user-plus"></i> Add Teacher
              </button>
            </div>

            <div id="teacherList">
              <!-- Teachers will be loaded here -->
            </div>

            <div class="empty-state d-none" id="teachersEmptyState">
              <i class="fas fa-chalkboard-teacher"></i>
              <h3>No Teachers Yet</h3>
              <p>Add teachers to your school staff.</p>
            </div>
          </div>
        </div>

        <!-- Marks Tab -->
        <div class="tab-content" id="marksTab">
          <div class="marks-container">
            <div class="list-header">
              <h3>Enter Marks</h3>
              <div id="marksPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You can only enter marks for your assigned subjects.
              </div>
            </div>

            <!-- Marks Entry Section - ALWAYS VISIBLE -->
            <div id="marksEntrySection">
              <div class="marks-filters">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Select Class</label>
                  <select id="marksClassSelect" class="w-100">
                    <option value="">Select a class</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Select Term</label>
                  <select id="termSelect" class="w-100">
                    <option value="">Select Term</option>
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>

                <div class="form-group" id="marksSubjectFilter" style="display: none;">
                  <label><i class="fas fa-book"></i> Select Subject</label>
                  <select id="marksSubjectSelect" class="w-100">
                    <option value="">All Assigned Subjects</option>
                  </select>
                </div>
              </div>

              <div class="student-search-container mb-30">
                <label><i class="fas fa-user-graduate"></i> Find Student</label>
                <div class="student-search-wrapper">
                  <i class="fas fa-search student-search-icon"></i>
                  <input type="text" id="studentSearch" class="student-search-input" placeholder="Type student name to search...">
                  <button type="button" class="student-search-clear" id="studentSearchClear">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="student-suggestions" id="studentSuggestions"></div>
              </div>

              <div class="selected-student d-none" id="selectedStudentInfo">
                <h4><i class="fas fa-user-graduate"></i> Selected Student: <span id="selectedStudentName"></span></h4>
                <p>Enter marks for each subject below (0-100)</p>
              </div>

              <div class="marks-grid" id="marksGrid">
                <!-- Marks inputs will be generated here -->
              </div>

              <div id="marksAlert" class="alert d-none">
                <i class="fas fa-info-circle"></i>
                <span id="marksAlertText"></span>
              </div>

              <button class="btn btn-primary btn-block" id="saveMarksBtn" disabled>
                <i class="fas fa-save"></i> Save Marks
              </button>
            </div>

            <div class="empty-state d-none" id="marksEmptyState">
              <i class="fas fa-edit"></i>
              <h3>Select Class and Term</h3>
              <p>Select a class and term to start entering marks.</p>
            </div>
          </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reportsTab">
          <!-- Admin Reports Section -->
          <div id="adminReportsSection" style="display: none;">
            <div class="reports-container">
              <div class="list-header">
                <h3>Reports & Analytics</h3>
              </div>

              <div class="report-filters">
                <h4 class="mb-20">Generate Report</h4>
                <div class="filter-grid">
                  <div class="form-group">
                    <label><i class="fas fa-chalkboard"></i> Class</label>
                    <select id="reportClassSelect" class="w-100">
                      <option value="">All Classes</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><i class="fas fa-user-graduate"></i> Student</label>
                    <select id="reportStudentSelect" class="w-100" disabled>
                      <option value="">All Students</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Term</label>
                    <select id="reportTermSelect" class="w-100">
                      <option value="beginning">Beginning of Term</option>
                      <option value="mid">Mid Term</option>
                      <option value="end">End of Term</option>
                    </select>
                  </div>
                </div>
                <div class="report-actions">
                  <button class="btn btn-primary" id="generateReportBtn">
                    <i class="fas fa-chart-bar"></i> Generate Report
                  </button>
                  <button class="btn btn-success" id="exportPDFBtn">
                    <i class="fas fa-file-pdf"></i> Export Report Cards
                  </button>
                  <button class="btn btn-warning" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i> Export Class Analysis
                  </button>
                </div>
              </div>

              <div class="stats-grid d-none" id="statsGrid">
                <div class="stat-card">
                  <h4>Total Students</h4>
                  <p id="statTotalStudents">0</p>
                </div>
                <div class="stat-card">
                  <h4>Average Score</h4>
                  <p id="statAvgScore">0</p>
                </div>
                <div class="stat-card">
                  <h4>Highest Score</h4>
                  <p id="statHighScore">0</p>
                </div>
                <div class="stat-card">
                  <h4>Lowest Score</h4>
                  <p id="statLowScore">0</p>
                </div>
              </div>

              <div id="reportPreview" class="d-none">
                <h4 class="mb-20">Report Preview</h4>
                <div id="enhancedReportCard" class="enhanced-report-card">
                  <!-- Report card content will be generated here -->
                </div>
              </div>

              <div class="empty-state" id="reportsEmptyState">
                <i class="fas fa-chart-line"></i>
                <h3>No Data Available</h3>
                <p>Generate a report to see student performance analytics.</p>
              </div>
            </div>
          </div>

          <!-- Teacher Subject Analytics Section -->
          <div id="teacherAnalyticsSection" style="display: none;">
            <div class="subject-analytics-container">
              <div class="analytics-header">
                <h3>My Subject Analytics</h3>
                <button class="btn btn-success" id="exportSubjectAnalyticsBtn">
                  <i class="fas fa-file-excel"></i> Export Analytics
                </button>
              </div>

              <div class="analytics-filters">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Select Class</label>
                  <select id="analyticsClassSelect" class="w-100">
                    <option value="">All Classes</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Select Term</label>
                  <select id="analyticsTermSelect" class="w-100">
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>

                <div class="form-group subject-select-container">
                  <label><i class="fas fa-book"></i> Select Subjects for Analysis</label>
                  <div class="subject-checkboxes" id="subjectCheckboxesList">
                    <!-- Subject checkboxes will be loaded here -->
                  </div>
                  <div class="mt-10">
                    <button class="btn btn-light btn-sm" id="selectAllSubjects">
                      <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button class="btn btn-light btn-sm" id="deselectAllSubjects">
                      <i class="fas fa-square"></i> Deselect All
                    </button>
                  </div>
                </div>

                <button class="btn btn-primary" id="generateAnalyticsBtn">
                  <i class="fas fa-chart-pie"></i> Generate Analytics
                </button>
              </div>

              <div class="analytics-grid" id="analyticsGrid">
                <!-- Analytics cards will be loaded here -->
              </div>

              <div id="gradeChartContainer" class="d-none">
                <h4 class="mb-20">Grade Distribution</h4>
                <div style="background: var(--darker); border-radius: var(--border-radius-sm); padding: 20px; border: 1px solid rgba(255,255,255,0.1);">
                  <canvas id="gradeDistributionChart"></canvas>
                </div>
              </div>

              <div class="empty-state" id="analyticsEmptyState">
                <i class="fas fa-chart-pie"></i>
                <h3>No Analytics Data</h3>
                <p>Select subjects and generate analytics to see performance data.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS AND FULL SCREEN FORMS -->
  
  <!-- Join School Form -->
  <div class="full-screen-form" id="joinSchoolForm">
    <button class="close-fullscreen" id="closeJoinForm">
      <i class="fas fa-times"></i>
    </button>
    <div class="auth-container">
      <div class="header">
        <h2>Join a School</h2>
        <p>Enter school details to join</p>
      </div>

      <div id="joinSchoolError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="joinSchoolErrorText"></span>
      </div>

      <form id="joinSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="joinSchoolName" placeholder="Enter exact school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-key"></i> School Code</label>
          <input type="text" id="joinSchoolCode" placeholder="6-digit school code" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-sign-in-alt"></i> Join School
        </button>
      </form>
    </div>
  </div>

  <!-- Register School Form -->
  <div class="full-screen-form" id="registerSchoolForm">
    <button class="close-fullscreen" id="closeRegisterForm">
      <i class="fas fa-times"></i>
    </button>
    <div class="auth-container">
      <div class="header">
        <h2>Register a School</h2>
        <p>Create a new school on Skore Point</p>
      </div>

      <div id="registerSchoolError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="registerSchoolErrorText"></span>
      </div>

      <div id="registerSchoolSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>School registered successfully!</span>
      </div>

      <form id="registerSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name <span class="required">*</span></label>
          <input type="text" id="registerSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> School Location <span class="required">*</span></label>
          <input type="text" id="registerSchoolLocation" placeholder="City, Country" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-phone"></i> School Phone <span class="required">*</span></label>
          <input type="tel" id="registerSchoolPhone" placeholder="+1234567890" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> School Level <span class="required">*</span></label>
          <select id="registerSchoolLevel" required>
            <option value="">Select School Level</option>
            <option value="primary">Primary School</option>
            <option value="secondary">Secondary School</option>
          </select>
        </div>

        <div class="image-upload" id="logoUploadArea">
          <i class="fas fa-image"></i>
          <p>Upload School Logo <span class="required">*</span></p>
          <span>Click to upload (Required)</span>
          <div class="image-preview" id="logoPreview">
            <img id="logoPreviewImg" src="" alt="Logo Preview">
          </div>
          <input type="file" class="file-input" id="logoFile" accept="image/*" required>
          <input type="hidden" id="logoUrl">
          <div class="loading d-none" id="logoUploadLoading">
            <div class="spinner"></div>
            <p>Uploading...</p>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus-circle"></i> Register School
        </button>
      </form>
    </div>
  </div>

  <!-- Add Class Modal -->
  <div class="modal" id="addClassModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Class</h3>
        <button class="close-modal" id="closeAddClassModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addClassForm">
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class Name</label>
          <input type="text" id="className" placeholder="e.g., Grade 5A, Form 3" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Class
        </button>
      </form>
    </div>
  </div>

  <!-- Add Subject Modal -->
  <div class="modal" id="addSubjectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Subject</h3>
        <button class="close-modal" id="closeAddSubjectModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addSubjectForm">
        <div class="form-group">
          <label><i class="fas fa-book"></i> Subject Name</label>
          <input type="text" id="subjectName" placeholder="e.g., Mathematics, English" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Subject
        </button>
      </form>
    </div>
  </div>

  <!-- Add Teacher Modal -->
  <div class="modal" id="addTeacherModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Teacher</h3>
        <button class="close-modal" id="closeAddTeacherModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="addTeacherError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="addTeacherErrorText"></span>
      </div>
      <form id="addTeacherForm">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Full Name</label>
          <input type="text" id="teacherName" placeholder="Teacher's full name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="teacherEmail" placeholder="teacher@school.edu" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book"></i> Primary Teaching Subject</label>
          <input type="text" id="teacherSubject" placeholder="Primary subject they teach" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book-open"></i> Additional Subjects (Optional)</label>
          <textarea id="teacherAdditionalSubjects" placeholder="Enter additional subjects separated by commas" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label><i class="fas fa-user-tag"></i> Role</label>
          <select id="teacherRole">
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-user-plus"></i> Add Teacher
        </button>
      </form>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div class="modal" id="forgotPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reset Password</h3>
        <button class="close-modal" id="closeForgotPasswordModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="forgotPasswordError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="forgotPasswordErrorText"></span>
      </div>
      <div id="forgotPasswordSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>Password reset email sent! Check your inbox.</span>
      </div>
      <form id="forgotPasswordForm">
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-key"></i> Send Reset Link
        </button>
      </form>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div class="modal" id="addStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Student</h3>
        <button class="close-modal" id="closeAddStudentModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addStudentForm">
        <div class="form-group">
          <label><i class="fas fa-user-graduate"></i> Student Name</label>
          <input type="text" id="studentName" placeholder="Enter student's full name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class</label>
          <select id="studentClass" required>
            <option value="">Select Class</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Student
        </button>
      </form>
    </div>
  </div>

<script>
  // App Configuration
  const APP_CONFIG = {
    defaultSubjects: {
      primary: ['Mathematics', 'English', 'Science', 'Social Studies', 'Religious Education'],
      secondary: [
        'English Language', 'Mathematics', 'Biology', 'Chemistry', 'Physics',
        'Geography', 'History', 'Computer Studies', 'Business Studies',
        'Religious Education', 'French', 'Kiswahili', 'Agriculture'
      ]
    },
    defaultClasses: {
      primary: ['Primary 1', 'Primary 2', 'Primary 3', 'Primary 4', 'Primary 5', 'Primary 6', 'Primary 7'],
      secondary: ['Senior 1', 'Senior 2', 'Senior 3', 'Senior 4', 'Senior 5', 'Senior 6']
    },
    gradingScales: {
      primary: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9'],
      secondary: ['A', 'B', 'C', 'D', 'E', 'F']
    },
    gradePoints: {
      primary: { D1: 1, D2: 2, C3: 3, C4: 4, C5: 5, C6: 6, P7: 7, P8: 8, F9: 9 },
      secondary: { A: 1, B: 2, C: 3, D: 4, E: 5, F: 6 }
    }
  };

  // Global State
  let currentUser = null;
  let currentUserData = null;
  let currentSchool = null;
  let currentClasses = [];
  let currentStudents = [];
  let currentSubjects = [];
  let currentTeachers = [];
  let selectedStudentId = null;
  let schoolLogoUrl = null;
  let userProfileUrl = null;
  let isSchoolPortalOpen = false;
  let isMobileView = window.innerWidth <= 768;
  let gradeChart = null;
  let deferredPrompt = null;

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyASIdYdW94ZJQXsc6BN9Bc28eou0yjPE1U",
    authDomain: "upgrade-16092.firebaseapp.com",
    projectId: "upgrade-16092",
    storageBucket: "upgrade-16092.firebasestorage.app",
    messagingSenderId: "466381827996",
    appId: "1:466381827996:web:6f030e68c526e734a26259",
    measurementId: "G-RGCH68RJ8H"
  };

  // Initialize Firebase
  let firebaseApp, firebaseAuth, firestore;

  // Firebase initialization function
  async function initializeFirebase() {
    try {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
      const { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
      const { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

      // Initialize Firebase
      firebaseApp = initializeApp(firebaseConfig);
      firebaseAuth = getAuth(firebaseApp);
      firestore = getFirestore(firebaseApp);

      // Make Firebase available globally
      window.firebase = {
        auth: firebaseAuth,
        db: firestore,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile,
        sendPasswordResetEmail,
        collection,
        addDoc,
        getDocs,
        query,
        where,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        deleteDoc,
        arrayUnion,
        arrayRemove
      };

      console.log('Firebase initialized successfully');
      return true;
    } catch (error) {
      console.error('Firebase initialization error:', error);
      showAlert('loginError', 'Failed to initialize application. Please check your internet connection.', 'error');
      return false;
    }
  }

  // DOM Elements
  const containers = {
    launchScreen: document.getElementById('launchScreen'),
    navbar: document.getElementById('navbar'),
    mobileBottomNav: document.getElementById('mobileBottomNav'),
    loginSection: document.getElementById('loginSection'),
    registerSection: document.getElementById('registerSection'),
    dashboardSection: document.getElementById('dashboardSection'),
    schoolManagementSection: document.getElementById('schoolManagementSection'),
    joinSchoolForm: document.getElementById('joinSchoolForm'),
    registerSchoolForm: document.getElementById('registerSchoolForm'),
    addClassModal: document.getElementById('addClassModal'),
    addSubjectModal: document.getElementById('addSubjectModal'),
    addTeacherModal: document.getElementById('addTeacherModal'),
    addStudentModal: document.getElementById('addStudentModal'),
    forgotPasswordModal: document.getElementById('forgotPasswordModal'),
    portalExitBtn: document.getElementById('portalExitBtn'),
    offlineIndicator: document.getElementById('offlineIndicator')
  };

  // Initialize the application
  document.addEventListener('DOMContentLoaded', async () => {
    // Check if mobile view
    checkMobileView();
    window.addEventListener('resize', checkMobileView);
    
    // Show launch screen
    containers.launchScreen.style.display = 'flex';
    
    try {
      // Initialize Firebase
      const firebaseInitialized = await initializeFirebase();
      
      if (firebaseInitialized) {
        // Set up auth state listener
        window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
          if (user) {
            currentUser = user;
            await loadUserData(user.uid);
            showContainer('dashboardSection');
            hideLaunchScreen();
          } else {
            hideLaunchScreen();
            showContainer('loginSection');
          }
        });
      }
    } catch (error) {
      console.error('App initialization error:', error);
      hideLaunchScreen();
      showContainer('loginSection');
      showAlert('loginError', 'Application failed to initialize. Please refresh the page.', 'error');
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup PWA
    setupPWA();
    
    // Hide launch screen after 2 seconds if still showing
    setTimeout(() => {
      hideLaunchScreen();
      if (!currentUser) {
        showContainer('loginSection');
      }
    }, 2000);
  });

  // Setup PWA functionality
  function setupPWA() {
    // Check online/offline status
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
    
    // Register service worker if supported
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful with scope:', registration.scope);
        }).catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  }

  // Update online/offline status
  function updateOnlineStatus() {
    if (navigator.onLine) {
      containers.offlineIndicator.classList.remove('show');
    } else {
      containers.offlineIndicator.classList.add('show');
    }
  }

  // Check mobile view
  function checkMobileView() {
    isMobileView = window.innerWidth <= 768;
    if (isSchoolPortalOpen) {
      if (isMobileView) {
        containers.mobileBottomNav.style.display = 'flex';
        containers.mobileBottomNav.classList.add('active');
        containers.portalExitBtn.style.display = 'none';
      } else {
        containers.mobileBottomNav.style.display = 'none';
        containers.mobileBottomNav.classList.remove('active');
        containers.portalExitBtn.style.display = 'flex';
      }
    }
  }

  // Load user data from Firestore
  async function loadUserData(userId) {
    try {
      console.log('Loading user data for:', userId);
      
      const userDocRef = window.firebase.doc(window.firebase.db, 'users', userId);
      const userDoc = await window.firebase.getDoc(userDocRef);
      
      if (userDoc.exists()) {
        currentUserData = userDoc.data();
        console.log('User data loaded:', currentUserData);
        
        // Update user profile card
        updateUserProfileCard();
        
        // Check if user has a school
        if (currentUserData.schoolId) {
          console.log('User has school:', currentUserData.schoolId);
          await loadSchoolData(currentUserData.schoolId);
        } else {
          console.log('User has no school');
          document.getElementById('manageSchoolCard').style.display = 'none';
        }
      } else {
        console.log('No user document found');
        // Create user document if it doesn't exist
        await window.firebase.setDoc(
          window.firebase.doc(window.firebase.db, 'users', userId),
          {
            name: currentUser.displayName || 'User',
            email: currentUser.email,
            role: 'teacher',
            createdAt: new Date()
          }
        );
        
        currentUserData = {
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          role: 'teacher'
        };
        
        updateUserProfileCard();
      }
    } catch (error) {
      console.error('Error loading user data:', error);
      showAlert('loginError', 'Error loading user data', 'error');
    }
  }

  // Update user profile card
  function updateUserProfileCard() {
    const userInfoCard = document.getElementById('userInfoCard');
    if (!userInfoCard) return;
    
    const initials = getInitials(currentUserData.name || 'U');
    const profileUrl = currentUserData.profileUrl || '';
    const role = currentUserData.role || 'teacher';
    const name = currentUserData.name || 'User';
    const email = currentUser.email || '';
    
    userInfoCard.innerHTML = `
      <div class="user-profile-img">
        ${profileUrl && profileUrl.startsWith('data:image') 
          ? `<img src="${profileUrl}" alt="${name}" onerror="this.parentElement.innerHTML='${initials}'">`
          : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">${initials}</div>`
        }
      </div>
      <div class="user-details">
        <span class="user-role ${role}">${role.toUpperCase()}</span>
        <span class="user-name">${name}</span>
        <span class="user-email">${email}</span>
        <button class="logout-btn mobile-only" id="mobileLogoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    `;
    
    // Re-attach logout button event
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    if (mobileLogoutBtn) {
      mobileLogoutBtn.addEventListener('click', handleLogout);
    }
  }

  // Get initials from name
  function getInitials(name) {
    if (!name) return 'U';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  }

  // Load school data
  async function loadSchoolData(schoolId) {
    try {
      console.log('Loading school data for:', schoolId);
      
      const schoolDocRef = window.firebase.doc(window.firebase.db, 'schools', schoolId);
      const schoolDoc = await window.firebase.getDoc(schoolDocRef);
      
      if (schoolDoc.exists()) {
        currentSchool = {
          id: schoolDoc.id,
          ...schoolDoc.data()
        };
        
        console.log('School data loaded:', currentSchool);
        
        // Show the "School Portal" card
        const schoolPortalCard = document.getElementById('manageSchoolCard');
        schoolPortalCard.style.display = 'block';
        
        // Update dashboard school card
        document.getElementById('schoolCardName').textContent = currentSchool.name;
        document.getElementById('schoolCardCode').textContent = currentSchool.code;
        
        // Update school logo in dashboard
        if (currentSchool.logoUrl) {
          schoolLogoUrl = currentSchool.logoUrl;
          const schoolLogo = document.getElementById('schoolCardLogo');
          schoolLogo.src = currentSchool.logoUrl;
          schoolLogo.style.display = 'block';
        }
        
        // Load school data
        await Promise.all([
          loadClasses(),
          loadSubjects(),
          loadTeachers()
        ]);
      } else {
        console.log('School document not found');
        // User has a schoolId but school doesn't exist - clear it
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
          {
            schoolId: null
          }
        );
        
        document.getElementById('manageSchoolCard').style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading school data:', error);
    }
  }

  // Setup all event listeners
  function setupEventListeners() {
    // Navigation
    document.getElementById('goRegister').addEventListener('click', () => showContainer('registerSection'));
    document.getElementById('goLogin').addEventListener('click', () => showContainer('loginSection'));
    document.getElementById('joinSchoolBtn').addEventListener('click', () => containers.joinSchoolForm.classList.add('active'));
    document.getElementById('registerSchoolBtn').addEventListener('click', () => containers.registerSchoolForm.classList.add('active'));
    document.getElementById('desktopLogoutBtn').addEventListener('click', handleLogout);
    document.getElementById('userGuideBtn').addEventListener('click', showUserGuide);
    document.getElementById('forgotPassword').addEventListener('click', () => containers.forgotPasswordModal.classList.add('active'));
    document.getElementById('openSchoolPortalBtn').addEventListener('click', openSchoolPortal);
    
    // Portal exit button
    containers.portalExitBtn.addEventListener('click', closeSchoolPortal);
    
    // Close buttons
    document.getElementById('closeJoinForm').addEventListener('click', () => containers.joinSchoolForm.classList.remove('active'));
    document.getElementById('closeRegisterForm').addEventListener('click', () => containers.registerSchoolForm.classList.remove('active'));
    document.getElementById('closeAddClassModal').addEventListener('click', () => containers.addClassModal.classList.remove('active'));
    document.getElementById('closeAddSubjectModal').addEventListener('click', () => containers.addSubjectModal.classList.remove('active'));
    document.getElementById('closeAddTeacherModal').addEventListener('click', () => containers.addTeacherModal.classList.remove('active'));
    document.getElementById('closeAddStudentModal').addEventListener('click', () => containers.addStudentModal.classList.remove('active'));
    document.getElementById('closeForgotPasswordModal').addEventListener('click', () => containers.forgotPasswordModal.classList.remove('active'));
    
    // File upload buttons
    document.getElementById('studentUploadArea').addEventListener('click', () => document.getElementById('studentFile').click());
    
    // File change events
    document.getElementById('profileFile').addEventListener('change', (e) => handleImageUpload(e, 'profile'));
    document.getElementById('logoFile').addEventListener('change', (e) => handleImageUpload(e, 'logo'));
    document.getElementById('studentFile').addEventListener('change', handleStudentFileUpload);
    
    // Form submissions
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    document.getElementById('joinSchoolFormFields').addEventListener('submit', handleJoinSchool);
    document.getElementById('registerSchoolFormFields').addEventListener('submit', handleRegisterSchool);
    document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);
    document.getElementById('addClassForm').addEventListener('submit', handleAddClass);
    document.getElementById('addSubjectForm').addEventListener('submit', handleAddSubject);
    document.getElementById('addTeacherForm').addEventListener('submit', handleAddTeacher);
    document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
    
    // Tab switching
    setupTabs();
    
    // Mobile tab switching
    setupMobileTabs();
    
    // Password toggles
    setupPasswordToggles();
    
    // Student search
    document.getElementById('studentSearch').addEventListener('input', handleStudentSearch);
    document.getElementById('studentSearchClear').addEventListener('click', clearStudentSearch);
    
    // Marks entry - ALWAYS VISIBLE
    document.getElementById('marksClassSelect').addEventListener('change', handleClassSelectForMarks);
    document.getElementById('termSelect').addEventListener('change', handleTermSelect);
    document.getElementById('marksSubjectSelect').addEventListener('change', handleSubjectSelectForMarks);
    document.getElementById('saveMarksBtn').addEventListener('click', handleSaveMarks);
    
    // Reports
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);
    document.getElementById('exportPDFBtn').addEventListener('click', exportReportCards);
    document.getElementById('exportExcelBtn').addEventListener('click', exportClassAnalysis);
    document.getElementById('exportSubjectAnalyticsBtn').addEventListener('click', exportSubjectAnalytics);
    document.getElementById('reportClassSelect').addEventListener('change', updateReportStudentSelect);
    
    // Enhanced Analytics
    document.getElementById('generateAnalyticsBtn').addEventListener('click', generateEnhancedAnalytics);
    document.getElementById('analyticsClassSelect').addEventListener('change', loadAnalyticsSubjects);
    document.getElementById('selectAllSubjects').addEventListener('click', selectAllSubjects);
    document.getElementById('deselectAllSubjects').addEventListener('click', deselectAllSubjects);
    
    // Add buttons
    document.getElementById('addClassBtn').addEventListener('click', () => containers.addClassModal.classList.add('active'));
    document.getElementById('addSubjectBtn').addEventListener('click', () => containers.addSubjectModal.classList.add('active'));
    document.getElementById('addTeacherBtn').addEventListener('click', () => containers.addTeacherModal.classList.add('active'));
    document.getElementById('addStudentBtn').addEventListener('click', () => containers.addStudentModal.classList.add('active'));
  }

  // Handle image upload
  function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.match('image.*')) {
      showAlert(`${type}Error`, 'Please select an image file (JPEG, PNG, GIF)', 'error');
      return;
    }
    
    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      showAlert(`${type}Error`, 'Image size should be less than 2MB', 'error');
      return;
    }
    
    // Show loading
    const loadingId = `${type}UploadLoading`;
    const loadingElement = document.getElementById(loadingId);
    if (loadingElement) {
      loadingElement.classList.remove('d-none');
    }
    
    // Create preview using FileReader
    const reader = new FileReader();
    reader.onload = (e) => {
      const imageUrl = e.target.result;
      
      if (type === 'profile') {
        // Update profile preview
        const previewImg = document.getElementById('profilePreviewImg');
        previewImg.src = imageUrl;
        const previewContainer = document.getElementById('profilePreview');
        previewContainer.style.display = 'block';
        document.getElementById('profileUrl').value = imageUrl;
        userProfileUrl = imageUrl;
        
        // Update user profile card
        updateUserProfileCard();
      } else {
        // Update logo preview
        const previewImg = document.getElementById('logoPreviewImg');
        previewImg.src = imageUrl;
        const previewContainer = document.getElementById('logoPreview');
        previewContainer.style.display = 'block';
        document.getElementById('logoUrl').value = imageUrl;
        schoolLogoUrl = imageUrl;
      }
      
      // Hide loading
      if (loadingElement) {
        loadingElement.classList.add('d-none');
      }
    };
    
    reader.onerror = () => {
      showAlert(`${type}Error`, 'Error reading image file', 'error');
      if (loadingElement) {
        loadingElement.classList.add('d-none');
      }
    };
    
    reader.readAsDataURL(file);
  }

  // Handle student file upload
  async function handleStudentFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check file type
    if (!file.name.match(/\.(xlsx|xls)$/)) {
      alert('Please upload an Excel file (.xlsx or .xls)');
      return;
    }
    
    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // Process data
        let addedCount = 0;
        const classId = document.getElementById('studentClassSelect').value;
        
        if (!classId) {
          alert('Please select a class first');
          return;
        }
        
        for (let i = 0; i < jsonData.length; i++) {
          const studentName = jsonData[i][0];
          if (studentName && typeof studentName === 'string' && studentName.trim()) {
            try {
              await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'students'),
                {
                  name: studentName.trim(),
                  classId: classId,
                  schoolId: currentSchool.id,
                  createdAt: new Date(),
                  createdBy: currentUser.uid
                }
              );
              addedCount++;
            } catch (error) {
              console.error('Error adding student:', error);
            }
          }
        }
        
        alert(`Successfully added ${addedCount} students from the file.`);
        loadStudents();
      };
      
      reader.readAsArrayBuffer(file);
      
    } catch (error) {
      console.error('Error processing Excel file:', error);
      alert('Error processing Excel file. Please check the format and try again.');
    }
  }

  // Setup tabs with smooth scrolling
  function setupTabs() {
    const tabs = document.querySelectorAll('.desktop-only .tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
        
        // Smooth scroll to top of tab content
        setTimeout(() => {
          const tabContent = document.getElementById(`${tabId}Tab`);
          if (tabContent) {
            tabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      });
    });
  }

  // Setup mobile tabs with smooth scrolling
  function setupMobileTabs() {
    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
    mobileNavItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = item.dataset.tab;
        
        // Update active state
        mobileNavItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // Switch tab
        switchTab(tabId);
        
        // Smooth scroll to top
        setTimeout(() => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
      });
    });
  }

  // Switch tab
  function switchTab(tabId) {
    // Update active tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mobile-nav-item').forEach(m => m.classList.remove('active'));
    
    // Activate selected tab
    const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
    const selectedMobileTab = document.querySelector(`.mobile-nav-item[data-tab="${tabId}"]`);
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedMobileTab) selectedMobileTab.classList.add('active');
    
    document.getElementById(`${tabId}Tab`).classList.add('active');
    
    // Load data for the active tab
    switch(tabId) {
      case 'classes':
        loadClasses();
        break;
      case 'students':
        loadStudents();
        break;
      case 'subjects':
        loadSubjects();
        break;
      case 'teachers':
        loadTeachers();
        break;
      case 'marks':
        setupMarksTab();
        break;
      case 'reports':
        setupReportsTab();
        break;
    }
  }

  // Setup password toggles
  function setupPasswordToggles() {
    const toggles = [
      { toggle: 'loginToggle', field: 'loginPassword' },
      { toggle: 'registerToggle', field: 'regPassword' },
      { toggle: 'confirmToggle', field: 'confirmPassword' }
    ];
    
    toggles.forEach(({ toggle, field }) => {
      const toggleBtn = document.getElementById(toggle);
      const fieldInput = document.getElementById(field);
      
      if (toggleBtn && fieldInput) {
        toggleBtn.addEventListener('click', () => {
          const type = fieldInput.type === 'password' ? 'text' : 'password';
          fieldInput.type = type;
          toggleBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
      }
    });
  }

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    showLoading('loginLoading');
    hideAlert('loginError');
    
    try {
      await window.firebase.signInWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      // Auth state listener will handle the rest
    } catch (error) {
      hideLoading('loginLoading');
      let errorMessage = 'Login failed. ';
      switch(error.code) {
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        case 'auth/user-disabled':
          errorMessage += 'This account has been disabled.';
          break;
        case 'auth/user-not-found':
        case 'auth/wrong-password':
          errorMessage += 'Invalid email or password.';
          break;
        case 'auth/network-request-failed':
          errorMessage += 'Network error. Please check your internet connection.';
          break;
        default:
          errorMessage += error.message;
      }
      showAlert('loginError', errorMessage, 'error');
    }
  }

  // Handle registration
  async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const subject = document.getElementById('regSubject').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const profileUrl = document.getElementById('profileUrl').value;
    
    // Validation
    if (!profileUrl) {
      showAlert('registerError', 'Profile picture is required', 'error');
      return;
    }
    
    if (password !== confirmPassword) {
      showAlert('registerError', 'Passwords do not match', 'error');
      return;
    }
    
    if (password.length < 6) {
      showAlert('registerError', 'Password must be at least 6 characters', 'error');
      return;
    }
    
    showLoading('registerLoading');
    hideAlert('registerError');
    
    try {
      // Create user account
      const userCredential = await window.firebase.createUserWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      
      // Create user document in Firestore
      const userData = {
        name: name,
        email: email,
        subject: subject,
        profileUrl: profileUrl,
        role: 'teacher',
        createdAt: new Date()
      };
      
      console.log('Creating user document with data:', userData);
      
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'users', userCredential.user.uid),
        userData
      );
      
      // Update profile with display name
      if (name) {
        await window.firebase.updateProfile(userCredential.user, {
          displayName: name
        });
      }
      
      hideLoading('registerLoading');
      showAlert('registerSuccess', 'Account created successfully!', 'success');
      
      // Redirect to dashboard after delay
      setTimeout(() => {
        showContainer('dashboardSection');
      }, 2000);
      
    } catch (error) {
      hideLoading('registerLoading');
      let errorMessage = 'Registration failed. ';
      switch(error.code) {
        case 'auth/email-already-in-use':
          errorMessage += 'Email is already registered.';
          break;
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        case 'auth/operation-not-allowed':
          errorMessage += 'Email/password accounts are not enabled.';
          break;
        case 'auth/weak-password':
          errorMessage += 'Password is too weak.';
          break;
        case 'auth/network-request-failed':
          errorMessage += 'Network error. Please check your internet connection.';
          break;
        default:
          errorMessage += error.message;
      }
      showAlert('registerError', errorMessage, 'error');
    }
  }

  // Handle join school
  async function handleJoinSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('joinSchoolName').value.trim();
    const schoolCode = document.getElementById('joinSchoolCode').value.trim().toUpperCase();
    
    hideAlert('joinSchoolError');
    
    if (!schoolName || !schoolCode) {
      showAlert('joinSchoolError', 'Please enter both school name and code', 'error');
      return;
    }
    
    try {
      console.log('Searching for school:', schoolName, 'code:', schoolCode);
      
      // Find school by name and code
      const schoolsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'schools'),
        window.firebase.where('name', '==', schoolName),
        window.firebase.where('code', '==', schoolCode)
      );
      
      const querySnapshot = await window.firebase.getDocs(schoolsQuery);
      
      if (querySnapshot.empty) {
        showAlert('joinSchoolError', 'School not found. Please check the name and code.', 'error');
        return;
      }
      
      const schoolDoc = querySnapshot.docs[0];
      currentSchool = {
        id: schoolDoc.id,
        ...schoolDoc.data()
      };
      
      console.log('School found:', currentSchool);
      
      // Update user document
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolDoc.id,
          role: 'teacher'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolDoc.id;
      currentUserData.role = 'teacher';
      
      // Update UI
      document.getElementById('schoolCardName').textContent = currentSchool.name;
      document.getElementById('schoolCardCode').textContent = currentSchool.code;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Load school data
      await loadSchoolData(schoolDoc.id);
      
      // Hide form
      containers.joinSchoolForm.classList.remove('active');
      
      showAlert('registerSuccess', `Successfully joined ${currentSchool.name}!`, 'success');
      
    } catch (error) {
      console.error('Error joining school:', error);
      showAlert('joinSchoolError', 'Error joining school. Please try again.', 'error');
    }
  }

  // Handle register school
  async function handleRegisterSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('registerSchoolName').value.trim();
    const schoolLocation = document.getElementById('registerSchoolLocation').value.trim();
    const schoolPhone = document.getElementById('registerSchoolPhone').value.trim();
    const schoolLevel = document.getElementById('registerSchoolLevel').value;
    const logoUrl = document.getElementById('logoUrl').value;
    
    if (!logoUrl) {
      showAlert('registerSchoolError', 'School logo is required', 'error');
      return;
    }
    
    if (!schoolLevel) {
      showAlert('registerSchoolError', 'Please select school level', 'error');
      return;
    }
    
    if (!schoolName) {
      showAlert('registerSchoolError', 'Please enter school name', 'error');
      return;
    }
    
    hideAlert('registerSchoolError');
    
    try {
      // Generate school code
      const schoolCode = generateSchoolCode();
      console.log('Generating school code:', schoolCode);
      
      // Create school document
      const schoolData = {
        name: schoolName,
        location: schoolLocation,
        phone: schoolPhone,
        level: schoolLevel,
        code: schoolCode,
        logoUrl: logoUrl,
        createdBy: currentUser.uid,
        admins: [currentUser.uid],
        teachers: [currentUser.uid],
        createdAt: new Date()
      };
      
      console.log('Creating school with data:', schoolData);
      
      const schoolRef = await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'schools'),
        schoolData
      );
      
      console.log('School created with ID:', schoolRef.id);
      
      // Update user document
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolRef.id,
          role: 'admin'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolRef.id;
      currentUserData.role = 'admin';
      
      // Update user profile card
      updateUserProfileCard();
      
      // Add default subjects
      const defaultSubjects = APP_CONFIG.defaultSubjects[schoolLevel];
      console.log('Adding default subjects:', defaultSubjects);
      
      for (const subjectName of defaultSubjects) {
        await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'subjects'),
          {
            name: subjectName,
            schoolId: schoolRef.id,
            createdAt: new Date()
          }
        );
      }
      
      // Add default classes
      const defaultClasses = APP_CONFIG.defaultClasses[schoolLevel];
      console.log('Adding default classes:', defaultClasses);
      
      for (const className of defaultClasses) {
        await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'classes'),
          {
            name: className,
            schoolId: schoolRef.id,
            createdAt: new Date()
          }
        );
      }
      
      // Update current school data
      currentSchool = {
        id: schoolRef.id,
        ...schoolData
      };
      
      // Update UI
      document.getElementById('schoolCardName').textContent = schoolName;
      document.getElementById('schoolCardCode').textContent = schoolCode;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Show success message
      showAlert('registerSchoolSuccess', 'School registered successfully!', 'success');
      
      // Hide form after delay
      setTimeout(() => {
        containers.registerSchoolForm.classList.remove('active');
      }, 2000);
      
    } catch (error) {
      console.error('Error registering school:', error);
      showAlert('registerSchoolError', 'Error registering school. Please try again.', 'error');
    }
  }

  // Handle forgot password
  async function handleForgotPassword(e) {
    e.preventDefault();
    
    const email = document.getElementById('forgotPasswordEmail').value;
    
    hideAlert('forgotPasswordError');
    hideAlert('forgotPasswordSuccess');
    
    try {
      await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
      showAlert('forgotPasswordSuccess', 'Password reset email sent! Check your inbox.', 'success');
      
      // Clear form and hide modal after delay
      setTimeout(() => {
        document.getElementById('forgotPasswordEmail').value = '';
        containers.forgotPasswordModal.classList.remove('active');
      }, 3000);
      
    } catch (error) {
      console.error('Error sending password reset:', error);
      showAlert('forgotPasswordError', 'Error sending password reset email. Please try again.', 'error');
    }
  }

  // Handle add class
  async function handleAddClass(e) {
    e.preventDefault();
    
    const className = document.getElementById('className').value;
    
    try {
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'classes'),
        {
          name: className,
          schoolId: currentSchool.id,
          createdAt: new Date(),
          createdBy: currentUser.uid
        }
      );
      
      // Clear form and reload
      document.getElementById('className').value = '';
      containers.addClassModal.classList.remove('active');
      loadClasses();
      
    } catch (error) {
      console.error('Error adding class:', error);
      alert('Error adding class. Please try again.');
    }
  }

  // Handle add subject
  async function handleAddSubject(e) {
    e.preventDefault();
    
    const subjectName = document.getElementById('subjectName').value;
    
    try {
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'subjects'),
        {
          name: subjectName,
          schoolId: currentSchool.id,
          createdAt: new Date(),
          createdBy: currentUser.uid
        }
      );
      
      // Clear form and reload
      document.getElementById('subjectName').value = '';
      containers.addSubjectModal.classList.remove('active');
      loadSubjects();
      
    } catch (error) {
      console.error('Error adding subject:', error);
      alert('Error adding subject. Please try again.');
    }
  }

  // Handle add teacher
  async function handleAddTeacher(e) {
    e.preventDefault();
    
    const teacherName = document.getElementById('teacherName').value;
    const teacherEmail = document.getElementById('teacherEmail').value;
    const teacherSubject = document.getElementById('teacherSubject').value;
    const teacherAdditionalSubjects = document.getElementById('teacherAdditionalSubjects').value;
    const teacherRole = document.getElementById('teacherRole').value;
    
    // Process additional subjects
    const additionalSubjectsArray = teacherAdditionalSubjects
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0);
    
    const allSubjects = [teacherSubject, ...additionalSubjectsArray].filter((v, i, a) => a.indexOf(v) === i);
    
    try {
      // First, check if user exists
      const usersQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'users'),
        window.firebase.where('email', '==', teacherEmail)
      );
      
      const querySnapshot = await window.firebase.getDocs(usersQuery);
      let teacherUserId = null;
      
      if (!querySnapshot.empty) {
        // User exists, update their school
        const userDoc = querySnapshot.docs[0];
        teacherUserId = userDoc.id;
        
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', teacherUserId),
          {
            schoolId: currentSchool.id,
            role: teacherRole,
            subject: teacherSubject,
            additionalSubjects: additionalSubjectsArray,
            assignedSubjects: allSubjects
          }
        );
      } else {
        // Create new user document
        const newTeacherRef = await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'users'),
          {
            name: teacherName,
            email: teacherEmail,
            subject: teacherSubject,
            additionalSubjects: additionalSubjectsArray,
            assignedSubjects: allSubjects,
            role: teacherRole,
            schoolId: currentSchool.id,
            createdAt: new Date(),
            status: 'active'
          }
        );
        
        teacherUserId = newTeacherRef.id;
      }
      
      // Update school's teacher list
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
        {
          teachers: window.firebase.arrayUnion(teacherUserId)
        }
      );
      
      // If admin, add to admins list
      if (teacherRole === 'admin') {
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
          {
            admins: window.firebase.arrayUnion(teacherUserId)
          }
        );
      }
      
      // Clear form and reload
      document.getElementById('teacherName').value = '';
      document.getElementById('teacherEmail').value = '';
      document.getElementById('teacherSubject').value = '';
      document.getElementById('teacherAdditionalSubjects').value = '';
      containers.addTeacherModal.classList.remove('active');
      loadTeachers();
      
    } catch (error) {
      console.error('Error adding teacher:', error);
      showAlert('addTeacherError', 'Error adding teacher. Please try again.', 'error');
    }
  }

  // Handle add student
  async function handleAddStudent(e) {
    e.preventDefault();
    
    const studentName = document.getElementById('studentName').value;
    const studentClass = document.getElementById('studentClass').value;
    
    try {
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'students'),
        {
          name: studentName,
          classId: studentClass,
          schoolId: currentSchool.id,
          createdAt: new Date(),
          createdBy: currentUser.uid
        }
      );
      
      // Clear form and reload
      document.getElementById('studentName').value = '';
      containers.addStudentModal.classList.remove('active');
      loadStudents();
      
    } catch (error) {
      console.error('Error adding student:', error);
      alert('Error adding student. Please try again.');
    }
  }

  // Load classes
  async function loadClasses() {
    if (!currentSchool) return;
    
    try {
      const classesQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'classes'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(classesQuery);
      currentClasses = [];
      const classList = document.getElementById('classList');
      classList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('classesEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('classesEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const classData = {
          id: doc.id,
          ...doc.data()
        };
        currentClasses.push(classData);
        
        const classItem = document.createElement('div');
        classItem.className = 'list-item';
        classItem.innerHTML = `
          <h4>${classData.name}</h4>
          <p>Created: ${classData.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteClass('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        classList.appendChild(classItem);
      });
      
      // Update class selectors
      updateClassSelectors();
      
    } catch (error) {
      console.error('Error loading classes:', error);
    }
  }

  // Load students
  async function loadStudents() {
    if (!currentSchool) return;
    
    const classId = document.getElementById('studentClassSelect').value;
    
    try {
      let studentsQuery;
      if (classId) {
        studentsQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'students'),
          window.firebase.where('schoolId', '==', currentSchool.id),
          window.firebase.where('classId', '==', classId)
        );
      } else {
        studentsQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'students'),
          window.firebase.where('schoolId', '==', currentSchool.id)
        );
      }
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('studentsEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('studentsEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const studentData = {
          id: doc.id,
          ...doc.data()
        };
        currentStudents.push(studentData);
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <h4>${studentData.name}</h4>
          <p>Class: ${getClassName(studentData.classId)}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteStudent('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        studentList.appendChild(studentItem);
      });
      
    } catch (error) {
      console.error('Error loading students:', error);
    }
  }

  // Load subjects
  async function loadSubjects() {
    if (!currentSchool) return;
    
    try {
      const subjectsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'subjects'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(subjectsQuery);
      currentSubjects = [];
      const subjectsList = document.getElementById('subjectsList');
      subjectsList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('subjectsEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('subjectsEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const subjectData = {
          id: doc.id,
          ...doc.data()
        };
        currentSubjects.push(subjectData);
        
        const subjectItem = document.createElement('div');
        subjectItem.className = 'list-item';
        subjectItem.innerHTML = `
          <h4>${subjectData.name}</h4>
          <p>Created: ${subjectData.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteSubject('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        subjectsList.appendChild(subjectItem);
      });
      
    } catch (error) {
      console.error('Error loading subjects:', error);
    }
  }

  // Load teachers
  async function loadTeachers() {
    if (!currentSchool) return;
    
    try {
      // Get all users in the school
      const usersQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'users'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(usersQuery);
      currentTeachers = [];
      const teacherList = document.getElementById('teacherList');
      teacherList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('teachersEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('teachersEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const teacherData = {
          id: doc.id,
          ...doc.data()
        };
        currentTeachers.push(teacherData);
        
        // Create teacher card
        const teacherItem = document.createElement('div');
        teacherItem.className = 'list-item';
        
        // Get initials for profile picture
        const initials = getInitials(teacherData.name || 'T');
        const profileUrl = teacherData.profileUrl || '';
        const role = teacherData.role || 'teacher';
        const name = teacherData.name || 'Teacher';
        const email = teacherData.email || '';
        const subjects = teacherData.assignedSubjects || [teacherData.subject].filter(Boolean);
        const subjectsText = subjects.length > 0 ? subjects.join(', ') : 'No subjects assigned';
        
        teacherItem.innerHTML = `
          <h4>${name}</h4>
          <p>Email: ${email}</p>
          <p>Role: <span class="user-role ${role}">${role.toUpperCase()}</span></p>
          <p>Subjects: ${subjectsText}</p>
          ${currentUserData.role === 'admin' && teacherData.id !== currentUser.uid ? `
            <div class="item-actions">
              <button class="btn btn-warning btn-sm" onclick="promoteTeacher('${doc.id}', '${teacherData.role}')">
                <i class="fas fa-user-shield"></i> ${teacherData.role === 'admin' ? 'Demote' : 'Make Admin'}
              </button>
              <button class="btn btn-danger btn-sm" onclick="removeTeacher('${doc.id}')">
                <i class="fas fa-user-minus"></i> Remove
              </button>
            </div>
          ` : ''}
        `;
        teacherList.appendChild(teacherItem);
      });
      
    } catch (error) {
      console.error('Error loading teachers:', error);
    }
  }

  // Update class selectors
  function updateClassSelectors() {
    // Get all class selectors
    const selectors = [
      document.getElementById('studentClassSelect'),
      document.getElementById('marksClassSelect'),
      document.getElementById('reportClassSelect'),
      document.getElementById('analyticsClassSelect'),
      document.getElementById('studentClass')
    ];
    
    selectors.forEach(select => {
      if (!select) return;
      
      // Clear existing options except first
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Add classes
      currentClasses.forEach(classObj => {
        const option = document.createElement('option');
        option.value = classObj.id;
        option.textContent = classObj.name;
        select.appendChild(option);
      });
    });
  }

  // Get class name by ID
  function getClassName(classId) {
    const classObj = currentClasses.find(c => c.id === classId);
    return classObj ? classObj.name : 'Unknown Class';
  }

  // Setup marks tab - ALWAYS VISIBLE
  function setupMarksTab() {
    // Show/hide based on permissions
    const isAdmin = currentUserData.role === 'admin';
    const canEnterMarks = isAdmin || currentUserData.subject;
    
    if (!canEnterMarks) {
      document.getElementById('marksEmptyState').classList.add('d-none');
      document.getElementById('marksEntrySection').classList.add('d-none');
      document.getElementById('marksPermissionNote').classList.remove('d-none');
      return;
    }
    
    document.getElementById('marksPermissionNote').classList.add('d-none');
    document.getElementById('marksEmptyState').classList.add('d-none');
    document.getElementById('marksEntrySection').classList.remove('d-none');
    
    // Update class selector
    updateClassSelectors();
    
    // Show/hide subject filter for teachers
    const marksSubjectFilter = document.getElementById('marksSubjectFilter');
    if (!isAdmin && currentUserData.assignedSubjects) {
      marksSubjectFilter.style.display = 'block';
      updateMarksSubjectSelector();
    } else {
      marksSubjectFilter.style.display = 'none';
    }
    
    // Smooth scroll to top of marks section
    setTimeout(() => {
      const marksSection = document.getElementById('marksEntrySection');
      if (marksSection) {
        marksSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);
  }

  // Update marks subject selector for teachers
  function updateMarksSubjectSelector() {
    const select = document.getElementById('marksSubjectSelect');
    if (!select) return;
    
    // Clear existing options
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    // Get teacher's assigned subjects
    const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
    
    // Add assigned subjects
    assignedSubjects.forEach(subjectName => {
      const option = document.createElement('option');
      option.value = subjectName;
      option.textContent = subjectName;
      select.appendChild(option);
    });
  }

  // Handle class select for marks - ALWAYS VISIBLE
  function handleClassSelectForMarks() {
    const classId = document.getElementById('marksClassSelect').value;
    const term = document.getElementById('termSelect').value;
    
    if (classId && term) {
      loadStudentsForMarks(classId);
    } else {
      // Clear student search if no class/term selected
      clearStudentSearch();
    }
  }

  // Handle term select
  function handleTermSelect() {
    handleClassSelectForMarks();
  }

  // Handle subject select for marks
  function handleSubjectSelectForMarks() {
    generateMarkInputs();
  }

  // Load students for marks
  async function loadStudentsForMarks(classId) {
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        currentStudents.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      // Generate mark inputs
      generateMarkInputs();
      
    } catch (error) {
      console.error('Error loading students for marks:', error);
    }
  }

  // Handle student search
  function handleStudentSearch() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const classId = document.getElementById('marksClassSelect').value;
    
    // Show/hide clear button
    const clearBtn = document.getElementById('studentSearchClear');
    if (searchTerm.length > 0) {
      clearBtn.classList.add('show');
    } else {
      clearBtn.classList.remove('show');
    }
    
    if (!classId || searchTerm.length < 2) {
      document.getElementById('studentSuggestions').style.display = 'none';
      return;
    }
    
    const filteredStudents = currentStudents.filter(student => 
      student.name.toLowerCase().includes(searchTerm)
    );
    
    const suggestions = document.getElementById('studentSuggestions');
    suggestions.innerHTML = '';
    
    if (filteredStudents.length > 0) {
      filteredStudents.forEach(student => {
        const suggestion = document.createElement('div');
        suggestion.className = 'student-suggestion';
        suggestion.textContent = student.name;
        suggestion.addEventListener('click', () => {
          document.getElementById('studentSearch').value = student.name;
          selectedStudentId = student.id;
          document.getElementById('selectedStudentName').textContent = student.name;
          document.getElementById('selectedStudentInfo').classList.remove('d-none');
          document.getElementById('saveMarksBtn').disabled = false;
          suggestions.style.display = 'none';
          clearBtn.classList.add('show');
          loadStudentMarks(student.id);
        });
        suggestions.appendChild(suggestion);
      });
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  }

  // Clear student search
  function clearStudentSearch() {
    document.getElementById('studentSearch').value = '';
    document.getElementById('studentSearchClear').classList.remove('show');
    document.getElementById('studentSuggestions').style.display = 'none';
    document.getElementById('selectedStudentInfo').classList.add('d-none');
    selectedStudentId = null;
    document.getElementById('saveMarksBtn').disabled = true;
  }

  // Generate mark inputs
  function generateMarkInputs() {
    const marksGrid = document.getElementById('marksGrid');
    marksGrid.innerHTML = '';
    
    const isAdmin = currentUserData.role === 'admin';
    const selectedSubject = document.getElementById('marksSubjectSelect')?.value;
    
    // Determine which subjects to show
    let subjectsToShow = currentSubjects;
    
    if (!isAdmin) {
      // Teachers only see their assigned subjects
      const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
      
      if (selectedSubject && selectedSubject !== '') {
        // Show only selected subject
        subjectsToShow = currentSubjects.filter(subject => 
          subject.name === selectedSubject
        );
      } else {
        // Show all assigned subjects
        subjectsToShow = currentSubjects.filter(subject => 
          assignedSubjects.includes(subject.name)
        );
      }
    }
    
    if (subjectsToShow.length === 0) {
      marksGrid.innerHTML = `
        <div class="alert info" style="grid-column: 1 / -1;">
          <i class="fas fa-info-circle"></i>
          <span>No subjects found for your teaching assignment.</span>
        </div>
      `;
      return;
    }
    
    subjectsToShow.forEach(subject => {
      const markInput = document.createElement('div');
      markInput.className = 'mark-input';
      markInput.innerHTML = `
        <label>${subject.name}</label>
        <input type="number" min="0" max="100" placeholder="0-100" 
               data-subject="${subject.id}" 
               oninput="validateMarkInput(this)">
      `;
      marksGrid.appendChild(markInput);
    });
  }

  // Validate mark input
  window.validateMarkInput = function(input) {
    let value = parseInt(input.value);
    if (isNaN(value)) {
      input.value = '';
      return;
    }
    if (value < 0) input.value = 0;
    if (value > 100) input.value = 100;
  };

  // Load student marks
  async function loadStudentMarks(studentId) {
    const term = document.getElementById('termSelect').value;
    
    try {
      const marksDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
      );
      
      if (marksDoc.exists()) {
        const marks = marksDoc.data();
        currentSubjects.forEach(subject => {
          const input = document.querySelector(`input[data-subject="${subject.id}"]`);
          if (input && marks[subject.id] !== undefined) {
            input.value = marks[subject.id];
          }
        });
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
  }

  // Handle save marks
  async function handleSaveMarks() {
    if (!selectedStudentId) {
      showMarksAlert('Please select a student first', 'error');
      return;
    }
    
    const term = document.getElementById('termSelect').value;
    if (!term) {
      showMarksAlert('Please select a term', 'error');
      return;
    }
    
    const marks = {};
    let hasMarks = false;
    
    // Collect marks
    document.querySelectorAll('.mark-input input').forEach(input => {
      const subjectId = input.dataset.subject;
      const value = parseInt(input.value);
      if (!isNaN(value) && value >= 0 && value <= 100) {
        marks[subject.id] = value;
        hasMarks = true;
      }
    });
    
    if (!hasMarks) {
      showMarksAlert('Please enter at least one mark', 'warning');
      return;
    }
    
    try {
      // Save marks
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${selectedStudentId}_${term}`),
        {
          studentId: selectedStudentId,
          schoolId: currentSchool.id,
          term: term,
          ...marks,
          updatedAt: new Date(),
          updatedBy: currentUser.uid
        }
      );
      
      showMarksAlert('Marks saved successfully!', 'success');
      
      // Reset form after delay
      setTimeout(() => {
        clearStudentSearch();
        document.querySelectorAll('.mark-input input').forEach(input => {
          input.value = '';
        });
      }, 2000);
      
    } catch (error) {
      console.error('Error saving marks:', error);
      showMarksAlert('Error saving marks', 'error');
    }
  }

  // Show marks alert
  function showMarksAlert(message, type) {
    const alert = document.getElementById('marksAlert');
    if (!alert) return;
    
    alert.className = `alert ${type}`;
    alert.querySelector('#marksAlertText').textContent = message;
    alert.classList.remove('d-none');
    
    setTimeout(() => {
      alert.classList.add('d-none');
    }, 3000);
  }

  // Setup reports tab
  function setupReportsTab() {
    const isAdmin = currentUserData.role === 'admin';
    
    if (isAdmin) {
      // Show admin reports
      document.getElementById('adminReportsSection').style.display = 'block';
      document.getElementById('teacherAnalyticsSection').style.display = 'none';
      
      // Update tab labels
      document.getElementById('desktopReportsLabel').textContent = 'Reports';
      document.getElementById('reportsTabLabel').textContent = 'Reports';
      
      updateClassSelectors();
      
      // Preload reports data for faster loading
      preloadReportsData();
    } else {
      // Show teacher analytics
      document.getElementById('adminReportsSection').style.display = 'none';
      document.getElementById('teacherAnalyticsSection').style.display = 'block';
      
      // Update tab labels
      document.getElementById('desktopReportsLabel').textContent = 'Analytics';
      document.getElementById('reportsTabLabel').textContent = 'Analytics';
      
      // Setup analytics filters
      setupAnalyticsFilters();
      
      // Preload analytics data for faster loading
      preloadAnalyticsData();
    }
    
    // Smooth scroll to top of reports section
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }

  // Preload reports data for faster loading
  async function preloadReportsData() {
    if (!currentSchool) return;
    
    try {
      // Preload students and marks data
      await Promise.all([
        loadAllStudents(),
        preloadMarksData()
      ]);
    } catch (error) {
      console.error('Error preloading reports data:', error);
    }
  }

  // Preload analytics data for faster loading
  async function preloadAnalyticsData() {
    if (!currentSchool) return;
    
    try {
      // Preload current user's assigned subjects
      loadAnalyticsSubjects();
    } catch (error) {
      console.error('Error preloading analytics data:', error);
    }
  }

  // Load all students for reports
  async function loadAllStudents() {
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        currentStudents.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      console.log(`Preloaded ${currentStudents.length} students for reports`);
    } catch (error) {
      console.error('Error loading all students:', error);
    }
  }

  // Preload marks data
  async function preloadMarksData() {
    try {
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(marksQuery);
      console.log(`Preloaded marks data: ${querySnapshot.size} documents`);
    } catch (error) {
      console.error('Error preloading marks data:', error);
    }
  }

  // Setup analytics filters
  async function setupAnalyticsFilters() {
    updateClassSelectors();
    loadAnalyticsSubjects();
  }

  // Load analytics subjects
  function loadAnalyticsSubjects() {
    const subjectCheckboxesList = document.getElementById('subjectCheckboxesList');
    if (!subjectCheckboxesList) return;
    
    subjectCheckboxesList.innerHTML = '';
    
    // Get teacher's assigned subjects
    const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
    
    if (assignedSubjects.length === 0) {
      subjectCheckboxesList.innerHTML = `
        <div class="alert info">
          <i class="fas fa-info-circle"></i>
          <span>No subjects assigned to you. Please contact your administrator.</span>
        </div>
      `;
      return;
    }
    
    // Create checkboxes for each assigned subject
    assignedSubjects.forEach(subjectName => {
      const checkbox = document.createElement('div');
      checkbox.className = 'subject-checkbox';
      checkbox.innerHTML = `
        <input type="checkbox" id="subject-${subjectName.replace(/\s+/g, '-')}" 
               value="${subjectName}" checked>
        <label for="subject-${subjectName.replace(/\s+/g, '-')}">${subjectName}</label>
      `;
      subjectCheckboxesList.appendChild(checkbox);
    });
  }

  // Select all subjects
  function selectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  // Deselect all subjects
  function deselectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  // Generate enhanced analytics
  async function generateEnhancedAnalytics() {
    const classId = document.getElementById('analyticsClassSelect').value;
    const term = document.getElementById('analyticsTermSelect').value;
    
    // Get selected subjects
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]:checked');
    const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedSubjects.length === 0) {
      alert('Please select at least one subject for analysis.');
      return;
    }
    
    try {
      // Get marks data
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      // Filter students by class if specified
      let filteredStudents = currentStudents;
      if (classId) {
        filteredStudents = currentStudents.filter(s => s.classId === classId);
      }
      
      // Calculate analytics for each selected subject
      const analyticsGrid = document.getElementById('analyticsGrid');
      analyticsGrid.innerHTML = '';
      
      const allGradeDistribution = {};
      const grades = currentSchool.level === 'primary' 
        ? ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
        : ['A', 'B', 'C', 'D', 'E', 'F'];
      
      // Initialize grade distribution
      grades.forEach(grade => {
        allGradeDistribution[grade] = 0;
      });
      
      let hasData = false;
      
      for (const subjectName of selectedSubjects) {
        const subject = currentSubjects.find(s => s.name === subjectName);
        if (!subject) continue;
        
        // Collect scores for this subject
        const scores = [];
        const studentScores = [];
        
        marksData.forEach(mark => {
          if (mark[subject.id] !== undefined) {
            const student = filteredStudents.find(s => s.id === mark.studentId);
            if (student) {
              const score = mark[subject.id];
              scores.push(score);
              
              studentScores.push({
                student: student.name,
                class: getClassName(student.classId),
                score: score,
                grade: calculateGrade(score, currentSchool.level)
              });
            }
          }
        });
        
        if (scores.length > 0) {
          hasData = true;
          
          // Calculate statistics
          const total = scores.reduce((a, b) => a + b, 0);
          const average = Math.round(total / scores.length);
          const highest = Math.max(...scores);
          const lowest = Math.min(...scores);
          
          // Calculate grade distribution
          const gradeDistribution = calculateGradeDistribution(scores, currentSchool.level);
          
          // Update overall grade distribution
          Object.keys(gradeDistribution).forEach(grade => {
            if (allGradeDistribution[grade] !== undefined) {
              allGradeDistribution[grade] += gradeDistribution[grade];
            }
          });
          
          // Calculate pass rate (assuming 40+ is pass)
          const passCount = scores.filter(score => score >= 40).length;
          const passRate = scores.length > 0 ? Math.round((passCount / scores.length) * 100) : 0;
          
          // Create analytics card
          const analyticsCard = document.createElement('div');
          analyticsCard.className = 'analytics-card';
          analyticsCard.innerHTML = `
            <h4>${subjectName}</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Average</p>
                <p style="font-size: 28px; font-weight: 800; color: var(--primary);">${average}</p>
              </div>
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Students</p>
                <p style="font-size: 28px; font-weight: 800; color: var(--primary);">${scores.length}</p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Highest</p>
                <p style="font-size: 20px; font-weight: 600; color: var(--success);">${highest}</p>
              </div>
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Lowest</p>
                <p style="font-size: 20px; font-weight: 600; color: var(--error);">${lowest}</p>
              </div>
            </div>
            <div style="margin-bottom: 20px;">
              <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Pass Rate</p>
                <p style="font-size: 20px; font-weight: 600; color: ${passRate >= 70 ? 'var(--success)' : passRate >= 50 ? 'var(--warning)' : 'var(--error)'};">${passRate}%</p>
              </div>
            <h5 style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 10px;">Grade Distribution</h5>
            <div class="grade-distribution">
              ${Object.entries(gradeDistribution).map(([grade, count]) => `
                <div class="grade-item">
                  <span>${grade}</span>
                  <span>${count}</span>
                </div>
              `).join('')}
            </div>
          `;
          
          analyticsGrid.appendChild(analyticsCard);
        }
      }
      
      if (hasData) {
        document.getElementById('analyticsEmptyState').classList.add('d-none');
        
        // Create grade distribution chart
        createGradeDistributionChart(allGradeDistribution);
        document.getElementById('gradeChartContainer').classList.remove('d-none');
      } else {
        document.getElementById('analyticsEmptyState').classList.remove('d-none');
        document.getElementById('gradeChartContainer').classList.add('d-none');
      }
      
    } catch (error) {
      console.error('Error generating analytics:', error);
      document.getElementById('analyticsEmptyState').classList.remove('d-none');
      document.getElementById('gradeChartContainer').classList.add('d-none');
    }
  }

  // Create grade distribution chart
  function createGradeDistributionChart(gradeDistribution) {
    const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
    
    // Destroy previous chart if exists
    if (gradeChart) {
      gradeChart.destroy();
    }
    
    const grades = Object.keys(gradeDistribution);
    const counts = Object.values(gradeDistribution);
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(67, 97, 238, 0.8)');
    gradient.addColorStop(1, 'rgba(114, 9, 183, 0.2)');
    
    gradeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: grades,
        datasets: [{
          label: 'Number of Students',
          data: counts,
          backgroundColor: gradient,
          borderColor: 'rgba(67, 97, 238, 1)',
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: 'white',
              font: {
                size: 14
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: 'var(--primary)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'white',
              font: {
                size: 12
              }
            },
            title: {
              display: true,
              text: 'Number of Students',
              color: 'white',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'white',
              font: {
                size: 12
              }
            },
            title: {
              display: true,
              text: 'Grades',
              color: 'white',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          }
        }
      }
    });
  }

  // Export subject analytics
  async function exportSubjectAnalytics() {
    try {
      const classId = document.getElementById('analyticsClassSelect').value;
      const term = document.getElementById('analyticsTermSelect').value;
      
      // Get selected subjects
      const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]:checked');
      const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);
      
      if (selectedSubjects.length === 0) {
        alert('Please select at least one subject for analysis.');
        return;
      }
      
      // Show loading
      const exportBtn = document.getElementById('exportSubjectAnalyticsBtn');
      const originalText = exportBtn.innerHTML;
      exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Data...';
      exportBtn.disabled = true;
      
      // Reload data before export
      await reloadDataForExport();
      
      // Get marks data
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      // Filter students by class if specified
      let filteredStudents = currentStudents;
      if (classId) {
        filteredStudents = currentStudents.filter(s => s.classId === classId);
      }
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Sheet 1: Performance Overview
      const overviewData = [
        ['P.6 Mathematics Performance Overview'],
        ['Generated:', new Date().toLocaleDateString()],
        ['Teacher:', currentUserData.name],
        ['School:', currentSchool.name],
        ['Term:', 'End of Term'],
        [''],
        ['RESULT SUMMARY'],
        ['Subject', 'Total Students', 'Highest Mark', 'Lowest Mark', 'Class Average', 'Pass Rate (%)']
      ];
      
      // Process each selected subject
      for (const subjectName of selectedSubjects) {
        const subject = currentSubjects.find(s => s.name === subjectName);
        if (!subject) continue;
        
        // Collect scores for this subject
        const scores = [];
        
        marksData.forEach(mark => {
          if (mark[subject.id] !== undefined) {
            const student = filteredStudents.find(s => s.id === mark.studentId);
            if (student) {
              const score = mark[subject.id];
              scores.push(score);
            }
          }
        });
        
        if (scores.length > 0) {
          // Calculate statistics for overview
          const totalStudents = scores.length;
          const highest = Math.max(...scores);
          const lowest = Math.min(...scores);
          const average = Math.round(scores.reduce((a, b) => a + b) / scores.length);
          const passCount = scores.filter(score => score >= 40).length;
          const passRate = Math.round((passCount / scores.length) * 100);
          
          // Add to overview
          overviewData.push([
            subjectName,
            totalStudents,
            highest,
            lowest,
            average,
            `${passRate}%`
          ]);
        }
      }
      
      // Create worksheets
      const overviewWs = XLSX.utils.aoa_to_sheet(overviewData);
      
      // Set column widths
      const colWidths = [
        { wch: 30 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 }
      ];
      
      overviewWs['!cols'] = colWidths;
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, overviewWs, 'Overview');
      
      // Save the file
      const fileName = `Subject_Analytics_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      alert(`Analytics exported successfully as ${fileName}`);
      
    } catch (error) {
      console.error('Error exporting subject analytics:', error);
      alert('Error exporting analytics. Please try again.');
    } finally {
      // Restore button
      const exportBtn = document.getElementById('exportSubjectAnalyticsBtn');
      exportBtn.innerHTML = '<i class="fas fa-file-excel"></i> Export Analytics';
      exportBtn.disabled = false;
    }
  }

  // Update report student select
  async function updateReportStudentSelect() {
    const classId = document.getElementById('reportClassSelect').value;
    const select = document.getElementById('reportStudentSelect');
    
    // Clear existing options
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    if (!classId) {
      select.disabled = true;
      return;
    }
    
    select.disabled = false;
    
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      
      querySnapshot.forEach(doc => {
        const student = { id: doc.id, ...doc.data() };
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        select.appendChild(option);
      });
      
    } catch (error) {
      console.error('Error loading students for reports:', error);
    }
  }

  // Generate report
  async function generateReport() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    try {
      // Get marks data
      let marksQuery;
      if (studentId) {
        // Specific student
        const marksDoc = await window.firebase.getDoc(
          window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
        );
        
        if (marksDoc.exists()) {
          await displayStudentReport(studentId, marksDoc.data());
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      } else if (classId) {
        // Whole class
        marksQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'marks'),
          window.firebase.where('schoolId', '==', currentSchool.id),
          window.firebase.where('term', '==', term)
        );
        
        const marksSnapshot = await window.firebase.getDocs(marksQuery);
        const classStudents = currentStudents.filter(s => s.classId === classId);
        const marksData = [];
        
        marksSnapshot.forEach(doc => {
          const mark = { id: doc.id, ...doc.data() };
          if (classStudents.find(s => s.id === mark.studentId)) {
            marksData.push(mark);
          }
        });
        
        if (marksData.length > 0) {
          await displayClassReport(classId, marksData);
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      } else {
        // All students
        marksQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'marks'),
          window.firebase.where('schoolId', '==', currentSchool.id),
          window.firebase.where('term', '==', term)
        );
        
        const marksSnapshot = await window.firebase.getDocs(marksQuery);
        const marksData = [];
        
        marksSnapshot.forEach(doc => {
          marksData.push({ id: doc.id, ...doc.data() });
        });
        
        if (marksData.length > 0) {
          await displaySchoolReport(marksData);
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      }
      
    } catch (error) {
      console.error('Error generating report:', error);
    }
  }

  // Display student report - MATCHING TEMPLATE 100%
  async function displayStudentReport(studentId, marks) {
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) return;
    
    const classObj = currentClasses.find(c => c.id === student.classId);
    const term = document.getElementById('reportTermSelect').value;
    const currentTerm = getCurrentTerm();
    const reportTitle = getReportTitle(currentTerm, term);
    
    // Calculate statistics
    let totalMarks = 0;
    let subjectCount = 0;
    const subjectScores = [];
    
    // Filter out subjects with no marks
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        totalMarks += score;
        subjectCount++;
        subjectScores.push({
          name: subject.name,
          score: score,
          grade: calculateGrade(score, currentSchool.level)
        });
      }
    });
    
    const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
    const aggregate = calculateAggregate(marks);
    const division = calculateDivision(average, aggregate);
    
    // Generate report card HTML matching DOCX template 100%
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <!-- Skore Point logo with text -->
        <div class="skore-point-badge">
          <div class="skore-point-icon">
            <img src="skore-icon.jpg" alt="Skore Point">
          </div>
          <div class="skore-point-text">SKORE POINT</div>
          <div class="serusoft-text">A product of SERUSOFT</div>
        </div>
        
        <!-- School logo in center -->
        <div class="school-logo-large">
          <img src="${currentSchool.logoUrl || 'skore-icon.jpg'}" alt="${currentSchool.name}">
        </div>
        
        <div class="school-name">${currentSchool.name}</div>
        <div class="report-title">${reportTitle}</div>
      </div>
      
      <div class="student-info-grid">
        <div class="info-item">
          <span class="info-label">Student Name:</span>
          <span class="info-value">${student.name}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Class:</span>
          <span class="info-value">${classObj ? classObj.name : 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Date:</span>
          <span class="info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      ${subjectScores.length > 0 ? `
        <table class="subject-table">
          <thead>
            <tr>
              <th>SUBJECT</th>
              <th>SCORE</th>
              <th>GRADE</th>
            </tr>
          </thead>
          <tbody>
            ${subjectScores.map(score => `
              <tr>
                <td>${score.name}</td>
                <td>${score.score}</td>
                <td>${score.grade}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<p class="text-center" style="color: #666; margin: 20px 0;">No marks entered for this student.</p>'}
      
      ${subjectCount > 0 ? `
        <table class="summary-table">
          <thead>
            <tr>
              <th>TOTAL MARKS</th>
              <th>AVERAGE MARK</th>
              <th>AGGREGATES</th>
              <th>FINAL GRADE/DIVISION</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${totalMarks}</td>
              <td>${average}</td>
              <td>${aggregate}</td>
              <td>${division}</td>
            </tr>
          </tbody>
        </table>
      ` : ''}
      
      <div class="remarks-section">
        <h4>Class Teacher's Remarks:</h4>
        <div class="signature-line"></div>
        
        <h4 style="margin-top: 30px;">Head Teacher's Remarks:</h4>
        <div class="signature-line"></div>
        
        <div class="next-term-info">
          <p><strong>Next Term Begins On:</strong> ________________________________</p>
        </div>
      </div>
      
      <div class="signature-area">
        <div class="signature-box">
          <div class="signature-line-box"></div>
          <div>Class Teacher Signature</div>
        </div>
        <div class="signature-box">
          <div class="signature-line-box"></div>
          <div>Head Teacher Signature</div>
        </div>
        <div class="signature-box">
          <div style="width: 80px; height: 80px; border: 2px dashed #666; margin: 0 auto;"></div>
          <div>School Stamp</div>
        </div>
      </div>
    `;
    
    // Update statistics
    document.getElementById('statTotalStudents').textContent = '1';
    document.getElementById('statAvgScore').textContent = average;
    document.getElementById('statHighScore').textContent = Math.max(...subjectScores.map(s => s.score));
    document.getElementById('statLowScore').textContent = Math.min(...subjectScores.map(s => s.score));
    
    // Show report
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
  }

  // Display class report
  async function displayClassReport(classId, marksData) {
    const classObj = currentClasses.find(c => c.id === classId);
    const students = currentStudents.filter(s => s.classId === classId);
    
    // Calculate statistics
    const studentAverages = [];
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        studentAverages.push(total / count);
      }
    });
    
    const totalStudents = students.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    // Generate summary report
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <!-- Skore Point logo with text -->
        <div class="skore-point-badge">
          <div class="skore-point-icon">
            <img src="skore-icon.jpg" alt="Skore Point">
          </div>
          <div class="skore-point-text">SKORE POINT</div>
          <div class="serusoft-text">A product of SERUSOFT</div>
        </div>
        
        <div class="school-logo-large">
          <img src="${currentSchool.logoUrl || 'skore-icon.jpg'}" alt="${currentSchool.name}">
        </div>
        
        <div class="school-name">${currentSchool.name}</div>
        <div class="report-title">CLASS PERFORMANCE SUMMARY</div>
      </div>
      
      <div class="student-info-grid">
        <div class="info-item">
          <span class="info-label">Class:</span>
          <span class="info-value">${classObj ? classObj.name : 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Total Students:</span>
          <span class="info-value">${totalStudents}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Term:</span>
          <span class="info-value">${document.getElementById('reportTermSelect').options[document.getElementById('reportTermSelect').selectedIndex].text}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Date:</span>
          <span class="info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">Performance Statistics</h4>
      <table class="subject-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Class Average</td>
            <td>${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td>${highScore}%</td>
            <td>Excellent</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td>${lowScore}%</td>
            <td>Needs Improvement</td>
          </tr>
          <tr>
            <td>Students with Marks</td>
            <td>${studentAverages.length}</td>
            <td>${studentAverages.length}/${totalStudents} students</td>
          </tr>
        </tbody>
      </table>
      
      <div class="remarks-section">
        <h4>Class Teacher's Remarks:</h4>
        <div class="signature-line"></div>
      </div>
    `;
    
    // Update statistics
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
    
    // Show report
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
  }

  // Display school report
  async function displaySchoolReport(marksData) {
    // Calculate school-wide statistics
    const studentAverages = [];
    const classAverages = {};
    
    // Group by class
    currentClasses.forEach(classObj => {
      classAverages[classObj.id] = [];
    });
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        const average = total / count;
        studentAverages.push(average);
        
        // Add to class average
        const student = currentStudents.find(s => s.id === mark.studentId);
        if (student && classAverages[student.classId]) {
          classAverages[student.classId].push(average);
        }
      }
    });
    
    // Calculate statistics
    const totalStudents = currentStudents.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    // Generate school report
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <!-- Skore Point logo with text -->
        <div class="skore-point-badge">
          <div class="skore-point-icon">
            <img src="skore-icon.jpg" alt="Skore Point">
          </div>
          <div class="skore-point-text">SKORE POINT</div>
          <div class="serusoft-text">A product of SERUSOFT</div>
        </div>
        
        <div class="school-logo-large">
          <img src="${currentSchool.logoUrl || 'skore-icon.jpg'}" alt="${currentSchool.name}">
        </div>
        
        <div class="school-name">${currentSchool.name}</div>
        <div class="report-title">SCHOOL PERFORMANCE REPORT</div>
      </div>
      
      <div class="student-info-grid">
        <div class="info-item">
          <span class="info-label">School Level:</span>
          <span class="info-value">${currentSchool.level === 'primary' ? 'Primary School' : 'Secondary School'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Total Students:</span>
          <span class="info-value">${totalStudents}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Term:</span>
          <span class="info-value">${document.getElementById('reportTermSelect').options[document.getElementById('reportTermSelect').selectedIndex].text}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Date:</span>
          <span class="info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">School Statistics</h4>
      <table class="subject-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>School Average</td>
            <td>${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td>${highScore}%</td>
            <td>Outstanding</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td>${lowScore}%</td>
            <td>Needs Attention</td>
          </tr>
          <tr>
            <td>Students Assessed</td>
            <td>${studentAverages.length}</td>
            <td>${studentAverages.length}/${totalStudents} students</td>
          </tr>
        </tbody>
      </table>
      
      <div class="remarks-section">
        <h4>Head Teacher's Remarks:</h4>
        <div class="signature-line"></div>
      </div>
    `;
    
    // Update statistics
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
    
    // Show report
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
  }

  // Export report card as PDF - MATCHING TEMPLATE 100%
  async function exportReportCard(studentId) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Get student data
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) return;
    
    const classObj = currentClasses.find(c => c.id === student.classId);
    const term = document.getElementById('reportTermSelect').value;
    
    // Get marks data
    const marksDoc = await window.firebase.getDoc(
      window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
    );
    
    if (!marksDoc.exists()) {
      alert('No marks found for this student');
      return;
    }
    
    const marks = marksDoc.data();
    
    // Calculate statistics
    let totalMarks = 0;
    let subjectCount = 0;
    const subjectScores = [];
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        totalMarks += score;
        subjectCount++;
        subjectScores.push({
          name: subject.name,
          score: score,
          grade: calculateGrade(score, currentSchool.level)
        });
      }
    });
    
    const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
    const aggregate = calculateAggregate(marks);
    const division = calculateDivision(average, aggregate);
    const currentTerm = getCurrentTerm();
    const reportTitle = getReportTitle(currentTerm, term);
    
    // Add Skore Point branding to top-left corner
    doc.setFontSize(8);
    doc.setTextColor(67, 97, 238);
    doc.text('SKORE POINT', 20, 15);
    
    doc.setFontSize(6);
    doc.setTextColor(100, 100, 100);
    doc.text('A product of SERUSOFT', 20, 18);
    
    // Add school logo (center)
    let schoolLogoUrl = currentSchool.logoUrl || 'skore-icon.jpg';
    try {
      const schoolLogo = await loadImage(schoolLogoUrl);
      doc.addImage(schoolLogo, 'JPEG', 85, 25, 40, 40);
    } catch (e) {
      // If image fails, continue without it
    }
    
    // School name
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text(currentSchool.name, 105, 75, { align: 'center' });
    
    // Report title
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(reportTitle, 105, 85, { align: 'center' });
    
    // Student information
    doc.setFontSize(12);
    doc.text(`Student Name: ${student.name}`, 20, 100);
    doc.text(`Class: ${classObj ? classObj.name : 'N/A'}`, 20, 107);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 114);
    
    // Subject table header
    doc.autoTable({
      startY: 120,
      head: [['SUBJECT', 'SCORE', 'GRADE']],
      theme: 'grid',
      headStyles: { 
        fillColor: [240, 240, 240],
        textColor: [0, 0, 0],
        fontStyle: 'bold'
      },
      margin: { left: 20, right: 20 },
      styles: { 
        fontSize: 10,
        cellPadding: 5,
        lineWidth: 0.5,
        lineColor: [0, 0, 0]
      }
    });
    
    // Subject rows
    const tableData = subjectScores.map(score => [score.name, score.score.toString(), score.grade]);
    
    if (tableData.length > 0) {
      doc.autoTable({
        startY: 120,
        body: tableData,
        theme: 'grid',
        margin: { left: 20, right: 20 },
        styles: { 
          fontSize: 10,
          cellPadding: 5,
          lineWidth: 0.5,
          lineColor: [0, 0, 0]
        }
      });
    }
    
    const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 140;
    
    // Summary table
    const summaryData = [
      ['TOTAL MARKS', 'AVERAGE MARK', 'AGGREGATES', 'FINAL GRADE/DIVISION'],
      [totalMarks.toString(), average.toString(), aggregate.toString(), division]
    ];
    
    doc.autoTable({
      startY: finalY,
      head: [summaryData[0]],
      body: [summaryData[1]],
      theme: 'grid',
      headStyles: { 
        fillColor: [67, 97, 238],
        textColor: [255, 255, 255],
        fontStyle: 'bold'
      },
      margin: { left: 20, right: 20 },
      styles: { 
        fontSize: 10,
        cellPadding: 5,
        lineWidth: 0.5,
        lineColor: [0, 0, 0]
      }
    });
    
    const finalY2 = doc.lastAutoTable.finalY + 15;
    
    // Remarks section
    doc.setFontSize(12);
    doc.text('Class Teacher\'s Remarks:', 20, finalY2);
    doc.line(20, finalY2 + 5, 190, finalY2 + 5);
    
    doc.text('Head Teacher\'s Remarks:', 20, finalY2 + 20);
    doc.line(20, finalY2 + 25, 190, finalY2 + 25);
    
    doc.text('Next Term Begins On: ________________________________', 20, finalY2 + 35);
    
    // Signature lines
    const signatureY = finalY2 + 50;
    doc.line(30, signatureY, 80, signatureY);
    doc.text('Class Teacher Signature', 55, signatureY + 10, { align: 'center' });
    
    doc.line(110, signatureY, 160, signatureY);
    doc.text('Head Teacher Signature', 135, signatureY + 10, { align: 'center' });
    
    // School stamp box
    doc.rect(175, signatureY - 5, 20, 20);
    doc.text('School Stamp', 185, signatureY + 25, { align: 'center' });
    
    // Save the PDF
    doc.save(`Report_Card_${student.name}_${new Date().toISOString().slice(0, 10)}.pdf`);
  }

  // Export ALL student report cards as PDF - WITH DATA RELOADING
  async function exportReportCards() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    if (!classId) {
      alert('Please select a class first');
      return;
    }
    
    // Show loading
    const exportBtn = document.getElementById('exportPDFBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Data...';
    exportBtn.disabled = true;
    
    try {
      // Reload data before export
      await reloadDataForExport();
      
      if (studentId && studentId !== '') {
        // Export single student report card
        await exportSingleReportCard(studentId, term);
      } else {
        // Export all students in the class
        await exportAllStudentReportCards(classId, term);
      }
      
    } catch (error) {
      console.error('Error generating PDFs:', error);
      alert('Error generating report cards. Please try again.');
    } finally {
      // Restore button
      exportBtn.innerHTML = originalText;
      exportBtn.disabled = false;
    }
  }

  // Export single report card
  async function exportSingleReportCard(studentId, term) {
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) {
      alert('Student not found');
      return;
    }
    
    // Check if student has marks
    const marksDoc = await window.firebase.getDoc(
      window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
    );
    
    if (!marksDoc.exists()) {
      alert('No marks found for this student');
      return;
    }
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
    
    try {
      await exportReportCard(studentId);
      alert(`Report card for ${student.name} exported successfully!`);
    } catch (error) {
      console.error('Error generating single PDF:', error);
      alert('Error generating report card. Please try again.');
    }
  }

  // Export all student report cards
  async function exportAllStudentReportCards(classId, term) {
    // Get all students in the class
    const classStudents = currentStudents.filter(s => s.classId === classId);
    const classObj = currentClasses.find(c => c.id === classId);
    
    if (classStudents.length === 0) {
      alert('No students found in this class');
      return;
    }
    
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDFs...';
    
    try {
      // Create a single PDF with all report cards
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      let currentPage = 1;
      
      for (let i = 0; i < classStudents.length; i++) {
        const student = classStudents[i];
        
        // Get marks for this student
        const marksDoc = await window.firebase.getDoc(
          window.firebase.doc(window.firebase.db, 'marks', `${student.id}_${term}`)
        );
        
        if (!marksDoc.exists()) {
          continue; // Skip students without marks
        }
        
        // Start new page for each student after the first
        if (i > 0) {
          doc.addPage();
          currentPage++;
        }
        
        const marks = marksDoc.data();
        const classObj = currentClasses.find(c => c.id === student.classId);
        
        // Calculate position on page
        const pageY = i === 0 ? 10 : 10;
        
        // Add Skore Point branding
        doc.setFontSize(8);
        doc.setTextColor(67, 97, 238);
        doc.text('SKORE POINT', 20, pageY + 10);
        
        doc.setFontSize(6);
        doc.setTextColor(100, 100, 100);
        doc.text('A product of SERUSOFT', 20, pageY + 13);
        
        // Add school logo
        try {
          const schoolLogo = await loadImage(currentSchool.logoUrl || 'skore-icon.jpg');
          doc.addImage(schoolLogo, 'JPEG', 85, pageY + 15, 40, 40);
        } catch (e) {
          // Continue without image
        }
        
        // School name
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text(currentSchool.name, 105, pageY + 65, { align: 'center' });
        
        // Report title
        const currentTerm = getCurrentTerm();
        const reportTitle = getReportTitle(currentTerm, term);
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text(reportTitle, 105, pageY + 75, { align: 'center' });
        
        // Student information
        doc.setFontSize(12);
        doc.text(`Student Name: ${student.name}`, 20, pageY + 90);
        doc.text(`Class: ${classObj ? classObj.name : 'N/A'}`, 20, pageY + 97);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, pageY + 104);
        
        // Calculate statistics
        let totalMarks = 0;
        let subjectCount = 0;
        const tableData = [];
        
        currentSubjects.forEach(subject => {
          const score = marks[subject.id];
          if (score !== undefined && score > 0) {
            totalMarks += score;
            subjectCount++;
            tableData.push([
              subject.name,
              score.toString(),
              calculateGrade(score, currentSchool.level)
            ]);
          }
        });
        
        const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
        const aggregate = calculateAggregate(marks);
        const division = calculateDivision(average, aggregate);
        
        // Add subject table
        if (tableData.length > 0) {
          doc.autoTable({
            startY: pageY + 110,
            head: [['SUBJECT', 'SCORE', 'GRADE']],
            body: tableData,
            theme: 'grid',
            headStyles: { 
              fillColor: [240, 240, 240],
              textColor: [0, 0, 0],
              fontStyle: 'bold'
            },
            margin: { left: 20, right: 20 },
            styles: { 
              fontSize: 9,
              cellPadding: 4,
              lineWidth: 0.5,
              lineColor: [0, 0, 0]
            }
          });
        }
        
        const tableEndY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 5 : pageY + 115;
        
        // Add summary table
        const summaryData = [
          ['TOTAL MARKS', 'AVERAGE MARK', 'AGGREGATES', 'FINAL GRADE/DIVISION'],
          [totalMarks.toString(), average.toString(), aggregate.toString(), division]
        ];
        
        doc.autoTable({
          startY: tableEndY,
          head: [summaryData[0]],
          body: [summaryData[1]],
          theme: 'grid',
          headStyles: { 
            fillColor: [67, 97, 238],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
          },
          margin: { left: 20, right: 20 },
          styles: { 
            fontSize: 10,
            cellPadding: 5,
            lineWidth: 0.5,
            lineColor: [0, 0, 0]
          }
        });
        
        const summaryEndY = doc.lastAutoTable.finalY + 10;
        
        // Add remarks section
        doc.setFontSize(12);
        doc.text('Class Teacher\'s Remarks:', 20, summaryEndY);
        doc.line(20, summaryEndY + 5, 190, summaryEndY + 5);
        
        doc.text('Head Teacher\'s Remarks:', 20, summaryEndY + 20);
        doc.line(20, summaryEndY + 25, 190, summaryEndY + 25);
        
        // Add page number
        doc.setFontSize(10);
        doc.setTextColor(150, 150, 150);
        doc.text(`Page ${currentPage} of ${classStudents.length}`, 105, 287, { align: 'center' });
      }
      
      // Save the PDF
      const className = currentClasses.find(c => c.id === classId)?.name || 'Class';
      doc.save(`Report_Cards_${className}_${term}_${new Date().toISOString().slice(0, 10)}.pdf`);
      
      alert(`Successfully exported ${classStudents.length} report cards!`);
      
    } catch (error) {
      console.error('Error generating PDFs:', error);
      alert('Error generating report cards. Please try again.');
    }
  }

  // Helper function to load images
  function loadImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = url;
    });
  }

  // Reload data before export to prevent empty files
  async function reloadDataForExport() {
    try {
      // Reload all necessary data
      await Promise.all([
        loadClasses(),
        loadSubjects(),
        loadStudents()
      ]);
      
      console.log('Data reloaded successfully for export');
    } catch (error) {
      console.error('Error reloading data for export:', error);
      throw new Error('Failed to reload data. Please try again.');
    }
  }

  // Export class analysis as Excel - WITH DATA RELOADING
  async function exportClassAnalysis() {
    const classId = document.getElementById('reportClassSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    if (!classId) {
      alert('Please select a class first');
      return;
    }
    
    // Show loading
    const exportBtn = document.getElementById('exportExcelBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Data...';
    exportBtn.disabled = true;
    
    try {
      // Reload data before export
      await reloadDataForExport();
      
      // Get all students in the class
      const classStudents = currentStudents.filter(s => s.classId === classId);
      const classObj = currentClasses.find(c => c.id === classId);
      
      if (classStudents.length === 0) {
        alert('No students found in this class');
        return;
      }
      
      exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Excel...';
      
      // Get marks data
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      // Check if any marks exist
      if (marksData.length === 0) {
        alert('No marks found for this class. Please enter marks first.');
        return;
      }
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Sheet 1: Class Analysis
      const classAnalysisData = [
        ['Class Analysis Report'],
        [`Class: ${classObj ? classObj.name : 'N/A'}`],
        [`Term: ${document.getElementById('reportTermSelect').options[document.getElementById('reportTermSelect').selectedIndex].text}`],
        [`Date: ${new Date().toLocaleDateString()}`],
        [''],
        ['STUDENT PERFORMANCE RANKING'],
        ['Rank', 'Student Name', ...currentSubjects.map(s => s.name), 'Total Marks', 'Average', 'Grade', 'Division']
      ];
      
      // Calculate scores for each student
      const studentScores = [];
      
      classStudents.forEach(student => {
        const studentMarks = marksData.find(m => m.studentId === student.id);
        if (!studentMarks) return;
        
        let totalMarks = 0;
        let subjectCount = 0;
        const scores = [];
        
        currentSubjects.forEach(subject => {
          const score = studentMarks[subject.id];
          if (score !== undefined && score > 0) {
            totalMarks += score;
            subjectCount++;
            scores.push(score);
          } else {
            scores.push(0);
          }
        });
        
        const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
        const aggregate = calculateAggregate(studentMarks);
        const division = calculateDivision(average, aggregate);
        const grade = calculateGrade(average, currentSchool.level);
        
        studentScores.push({
          name: student.name,
          scores: scores,
          total: totalMarks,
          average: average,
          grade: grade,
          division: division
        });
      });
      
      // Sort by average (descending)
      studentScores.sort((a, b) => b.average - a.average);
      
      // Add sorted data
      studentScores.forEach((student, index) => {
        classAnalysisData.push([
          index + 1,
          student.name,
          ...student.scores,
          student.total,
          student.average,
          student.grade,
          student.division
        ]);
      });
      
      // Create worksheets
      const classAnalysisWs = XLSX.utils.aoa_to_sheet(classAnalysisData);
      
      // Set column widths
      const colWidths = [
        { wch: 8 },  // Rank
        { wch: 25 }, // Student Name
        ...currentSubjects.map(() => ({ wch: 12 })), // Subject scores
        { wch: 12 }, // Total
        { wch: 10 }, // Average
        { wch: 8 },  // Grade
        { wch: 12 }  // Division
      ];
      
      classAnalysisWs['!cols'] = colWidths;
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, classAnalysisWs, 'Class Analysis');
      
      // Save the file
      const className = classObj ? classObj.name.replace(/\s+/g, '_') : 'Class';
      XLSX.writeFile(wb, `Class_Analysis_${className}_${term}_${new Date().toISOString().slice(0, 10)}.xlsx`);
      
      alert(`Excel report generated successfully!`);
      
    } catch (error) {
      console.error('Error generating Excel:', error);
      alert('Error generating Excel report. Please try again.');
    } finally {
      // Restore button
      exportBtn.innerHTML = originalText;
      exportBtn.disabled = false;
    }
  }

  // Calculate grade
  function calculateGrade(score, level) {
    if (level === 'primary') {
      if (score >= 90) return 'D1';
      if (score >= 80) return 'D2';
      if (score >= 70) return 'C3';
      if (score >= 60) return 'C4';
      if (score >= 50) return 'C5';
      if (score >= 40) return 'C6';
      if (score >= 30) return 'P7';
      if (score >= 20) return 'P8';
      return 'F9';
    } else {
      if (score >= 80) return 'A';
      if (score >= 70) return 'B';
      if (score >= 60) return 'C';
      if (score >= 50) return 'D';
      if (score >= 40) return 'E';
      return 'F';
    }
  }

  // Calculate aggregate
  function calculateAggregate(marks) {
    let totalPoints = 0;
    let subjectCount = 0;
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        const grade = calculateGrade(score, currentSchool.level);
        const gradePoints = APP_CONFIG.gradePoints[currentSchool.level][grade] || 9;
        totalPoints += gradePoints;
        subjectCount++;
      }
    });
    
    return subjectCount > 0 ? totalPoints : 0;
  }

  // Calculate division
  function calculateDivision(average, aggregate) {
    if (currentSchool.level === 'primary') {
      if (aggregate <= 12) return 'Division 1';
      if (aggregate <= 24) return 'Division 2';
      if (aggregate <= 36) return 'Division 3';
      return 'Division 4';
    } else {
      if (average >= 80) return 'Division 1';
      if (average >= 60) return 'Division 2';
      if (average >= 40) return 'Division 3';
      return 'Division 4';
    }
  }

  // Calculate grade distribution
  function calculateGradeDistribution(scores, level) {
    const distribution = {};
    
    // Initialize grade counts
    const grades = level === 'primary' 
      ? ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
      : ['A', 'B', 'C', 'D', 'E', 'F'];
    
    grades.forEach(grade => {
      distribution[grade] = 0;
    });
    
    // Count grades
    scores.forEach(score => {
      const grade = calculateGrade(score, level);
      if (distribution[grade] !== undefined) {
        distribution[grade]++;
      }
    });
    
    return distribution;
  }

  // Get current term
  function getCurrentTerm() {
    const now = new Date();
    const month = now.getMonth() + 1;
    
    if (month >= 2 && month <= 4) return 1;
    if (month >= 5 && month <= 8) return 2;
    return 3;
  }

  // Get report title
  function getReportTitle(currentTerm, reportType) {
    const termText = `TERM ${currentTerm}`;
    
    switch(reportType) {
      case 'beginning': return `BEGINNING OF ${termText} STUDENT PROGRESS REPORT`;
      case 'mid': return `MID ${termText} STUDENT PROGRESS REPORT`;
      case 'end': return `END OF ${termText} STUDENT PROGRESS REPORT`;
      default: return `STUDENT PROGRESS REPORT`;
    }
  }

  // Get performance remarks
  function getPerformanceRemarks(average) {
    if (average >= 80) return 'Excellent';
    if (average >= 70) return 'Very Good';
    if (average >= 60) return 'Good';
    if (average >= 50) return 'Satisfactory';
    if (average >= 40) return 'Fair';
    return 'Needs Improvement';
  }

  // Generate school code
  function generateSchoolCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Open school portal - Show exit button only after portal is opened
  function openSchoolPortal() {
    isSchoolPortalOpen = true;
    
    // Update management section
    document.getElementById('managementSchoolName').textContent = currentSchool.name;
    document.getElementById('managementSchoolCode').textContent = currentSchool.code;
    
    // Update school logo in management section
    if (currentSchool.logoUrl) {
      const managementLogo = document.getElementById('managementSchoolLogo');
      managementLogo.src = currentSchool.logoUrl;
      managementLogo.style.display = 'block';
    }
    
    // Show exit button only after portal is opened
    if (isMobileView) {
      containers.mobileBottomNav.style.display = 'flex';
      containers.mobileBottomNav.classList.add('active');
      containers.portalExitBtn.style.display = 'none'; // Hide desktop exit button on mobile
    } else {
      containers.portalExitBtn.style.display = 'flex'; // Show desktop exit button
    }
    
    // Show management section
    showContainer('schoolManagementSection');
    
    // Update permissions
    updatePermissions();
    
    // Load initial tab data
    loadClasses();
    
    // Set first tab as active for mobile
    if (isMobileView) {
      document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
      document.querySelector('.mobile-nav-item[data-tab="classes"]').classList.add('active');
    }
    
    // Smooth scroll to top
    setTimeout(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
  }

  // Close school portal - Hide exit button
  function closeSchoolPortal() {
    isSchoolPortalOpen = false;
    
    // Hide exit button
    containers.portalExitBtn.style.display = 'none';
    
    // Hide mobile bottom nav
    containers.mobileBottomNav.style.display = 'none';
    containers.mobileBottomNav.classList.remove('active');
    
    // Show dashboard
    showContainer('dashboardSection');
  }

  // Update permissions
  function updatePermissions() {
    const isAdmin = currentUserData.role === 'admin';
    
    // Show/hide add buttons
    const addButtons = ['addClassBtn', 'addSubjectBtn', 'addTeacherBtn', 'addStudentBtn'];
    addButtons.forEach(btnId => {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.style.display = isAdmin ? 'block' : 'none';
      }
    });
    
    // Show/hide student upload container
    document.getElementById('studentUploadContainer').style.display = isAdmin ? 'block' : 'none';
    
    // Show/hide permission notes
    const permissionNotes = {
      classPermissionNote: !isAdmin,
      studentPermissionNote: !isAdmin,
      subjectPermissionNote: !isAdmin,
      teacherPermissionNote: !isAdmin,
      marksPermissionNote: !isAdmin && currentUserData.subject
    };
    
    Object.entries(permissionNotes).forEach(([id, show]) => {
      const note = document.getElementById(id);
      if (note) {
        note.classList.toggle('d-none', !show);
      }
    });
    
    // Update tabs visibility based on role
    const managementTabs = document.getElementById('managementTabs');
    if (isAdmin) {
      managementTabs.classList.remove('d-none');
      
      // Update mobile bottom nav for admin
      if (isMobileView) {
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
          item.style.display = 'flex';
        });
      }
    } else {
      // Teachers only see marks and reports tabs on desktop
      const tabs = managementTabs.querySelectorAll('.tab');
      tabs.forEach(tab => {
        const tabId = tab.dataset.tab;
        if (tabId === 'marks' || tabId === 'reports') {
          tab.style.display = 'block';
        } else {
          tab.style.display = 'none';
        }
      });
      
      // Teachers on mobile only see marks and analytics tabs
      if (isMobileView) {
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
          const tabId = item.dataset.tab;
          if (tabId === 'marks' || tabId === 'reports') {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
        
        // Update reports tab label for teachers
        document.getElementById('reportsTabLabel').textContent = 'Analytics';
        document.getElementById('desktopReportsLabel').textContent = 'Analytics';
      }
    }
  }

  // Show user guide
  function showUserGuide() {
    alert(`Skore Point User Guide

KEY IMPROVEMENTS:
 Report Cards: 100% match to template with Skore Point logo + text in top-left
 Added "SKORE POINT" text below the icon and "A product of SERUSOFT" below school name
 Optimized font sizes for better A4 page fit
 Data Export: Automatic data reloading before export to prevent empty files
 Smooth Scrolling: Automatic scroll to top when switching tabs
 Marks Entry: Dropdowns always visible and functional
 Mobile Optimized: Professional mobile interface with bottom navigation
 PWA Ready: Install as native app with offline functionality

GETTING STARTED:
1. Create a user account with profile picture
2. Join existing school or register new one
3. Access school portal to manage data

REPORT CARD FEATURES:
 Professional design matching provided template
 Skore Point logo with "SKORE POINT" text in top-left corner
 "A product of SERUSOFT" displayed below school name
 School logo prominently displayed in center
 Optimized for A4 paper printing
 Export as PDF with all formatting preserved

DATA MANAGEMENT:
 Automatic data reloading before export
 Real-time updates from Firebase
 Offline capability with PWA
 Excel import/export functionality

SUPPORT:
Contact your school administrator or visit help section for assistance.`);
  }

  // Handle logout
  async function handleLogout() {
    try {
      await window.firebase.signOut(window.firebase.auth);
      currentUser = null;
      currentUserData = null;
      currentSchool = null;
      isSchoolPortalOpen = false;
      containers.mobileBottomNav.style.display = 'none';
      containers.mobileBottomNav.classList.remove('active');
      containers.portalExitBtn.style.display = 'none';
      showContainer('loginSection');
    } catch (error) {
      console.error('Error signing out:', error);
      alert('Error signing out. Please try again.');
    }
  }

  // Utility functions
  function showContainer(containerId) {
    // Hide all containers
    document.querySelectorAll('.container').forEach(container => {
      container.classList.remove('active');
    });
    
    // Show the requested container
    const container = document.getElementById(containerId);
    if (container) {
      container.classList.add('active');
    }
  }

  function hideLaunchScreen() {
    containers.launchScreen.style.display = 'none';
  }

  function showLoading(id) {
    const loading = document.getElementById(id);
    if (loading) loading.classList.remove('d-none');
  }

  function hideLoading(id) {
    const loading = document.getElementById(id);
    if (loading) loading.classList.add('d-none');
  }

  function showAlert(id, message, type) {
    const alert = document.getElementById(id);
    if (!alert) return;
    
    alert.className = `alert ${type}`;
    const textElement = alert.querySelector(`#${id}Text`);
    if (textElement) {
      textElement.textContent = message;
    }
    alert.classList.remove('d-none');
  }

  function hideAlert(id) {
    const alert = document.getElementById(id);
    if (alert) alert.classList.add('d-none');
  }

  // Global functions for button clicks
  window.deleteClass = async function(classId) {
    if (confirm('Are you sure you want to delete this class? All students in this class will also be deleted.')) {
      try {
        // Delete students in this class first
        const studentsQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'students'),
          window.firebase.where('classId', '==', classId)
        );
        
        const studentsSnapshot = await window.firebase.getDocs(studentsQuery);
        const deletePromises = [];
        
        studentsSnapshot.forEach(doc => {
          deletePromises.push(window.firebase.deleteDoc(doc.ref));
        });
        
        await Promise.all(deletePromises);
        
        // Delete the class
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'classes', classId)
        );
        
        loadClasses();
        
      } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please try again.');
      }
    }
  };

  window.deleteStudent = async function(studentId) {
    if (confirm('Are you sure you want to delete this student?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'students', studentId)
        );
        loadStudents();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student. Please try again.');
      }
    }
  };

  window.deleteSubject = async function(subjectId) {
    if (confirm('Are you sure you want to delete this subject?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'subjects', subjectId)
        );
        loadSubjects();
      } catch (error) {
        console.error('Error deleting subject:', error);
        alert('Error deleting subject. Please try again.');
      }
    }
  };

  window.promoteTeacher = async function(teacherId, currentRole) {
    const newRole = currentRole === 'admin' ? 'teacher' : 'admin';
    const action = currentRole === 'admin' ? 'demote from admin' : 'promote to admin';
    
    if (confirm(`Are you sure you want to ${action} this teacher?`)) {
      try {
        // Update teacher's role
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', teacherId),
          {
            role: newRole
          }
        );
        
        // Update school's admin list
        if (newRole === 'admin') {
          await window.firebase.updateDoc(
            window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
            {
              admins: window.firebase.arrayUnion(teacherId)
            }
          );
        } else {
          await window.firebase.updateDoc(
            window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
            {
              admins: window.firebase.arrayRemove(teacherId)
            }
          );
        }
        
        loadTeachers();
        
      } catch (error) {
        console.error(`Error ${action} teacher:`, error);
        alert(`Error ${action} teacher. Please try again.`);
      }
    }
  };

  window.removeTeacher = async function(teacherId) {
    if (confirm('Are you sure you want to remove this teacher from the school?')) {
      try {
        // Update teacher's school
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', teacherId),
          {
            schoolId: null,
            role: 'teacher'
          }
        );
        
        // Remove from school's lists
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
          {
            teachers: window.firebase.arrayRemove(teacherId),
            admins: window.firebase.arrayRemove(teacherId)
          }
        );
        
        loadTeachers();
        
      } catch (error) {
        console.error('Error removing teacher:', error);
        alert('Error removing teacher. Please try again.');
      }
    }
  };
</script>
</body>
</html>

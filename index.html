<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skore Point | Professional School Report Card Generator</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4361ee">
  <meta name="description" content="Professional School Report Card Generator by SERUSOFT">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="skore-icon.jpg">
  
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* All CSS from previous version remains here, but we'll add a few updates */
    
    /* Updated User Profile Card Structure */
    .user-info-card {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 400px;
    }

    .user-profile-img-container {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }

    .user-profile-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid var(--primary);
      object-fit: cover;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 24px;
      overflow: hidden;
    }

    .user-details-container {
      flex: 1;
      min-width: 0;
    }

    .user-role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .user-role-badge.admin {
      background: rgba(67, 97, 238, 0.2);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .user-role-badge.teacher {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .user-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--light);
      margin-bottom: 4px;
    }

    .user-email {
      font-size: 14px;
      color: var(--gray-light);
      margin-bottom: 12px;
      word-break: break-all;
    }

    /* Teacher Card Structure */
    .teacher-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    .teacher-card:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-2px);
      border-color: rgba(67, 97, 238, 0.3);
    }

    .teacher-header {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 15px;
    }

    .teacher-profile-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid var(--primary);
      object-fit: cover;
      background: var(--primary-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .teacher-details {
      flex: 1;
      min-width: 0;
    }

    .teacher-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--light);
      margin-bottom: 4px;
    }

    .teacher-email {
      font-size: 12px;
      color: var(--gray-light);
      margin-bottom: 8px;
      word-break: break-all;
    }

    /* Fix for mobile bottom nav when portal is not open */
    .mobile-bottom-nav:not(.active) {
      display: none !important;
    }

    /* Improved dropdown visibility */
    .form-group select:focus {
      z-index: 10;
    }

    /* Make dropdowns more visible */
    .marks-filters .form-group select {
      background-color: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white !important;
    }

    .marks-filters .form-group select option {
      background-color: var(--dark);
      color: white;
      padding: 10px;
    }

    /* Enhanced Report Card Styling to match template */
    .enhanced-report-card {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: white;
      color: #333;
      border-radius: 8px;
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
      border: 1px solid #e0e0e0;
      position: relative;
    }

    .report-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #4361ee;
    }

    .report-logo {
      height: 80px;
      margin-bottom: 15px;
    }

    .school-name {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .report-title {
      font-size: 16px;
      font-weight: 600;
      color: #4361ee;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .student-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }

    .student-info-item {
      display: flex;
      flex-direction: column;
    }

    .student-info-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .student-info-value {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }

    /* Table styling to match template */
    .marks-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
      font-size: 13px;
    }

    .marks-table th {
      background: #f8f9fa;
      font-weight: 600;
      text-align: left;
      padding: 12px 15px;
      border: 1px solid #dee2e6;
      color: #333;
      text-transform: uppercase;
      font-size: 12px;
    }

    .marks-table td {
      padding: 12px 15px;
      border: 1px solid #dee2e6;
      color: #333;
    }

    .marks-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      font-size: 13px;
    }

    .summary-table th {
      background: #4361ee;
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 15px;
      border: 1px solid #4361ee;
      font-size: 12px;
      text-transform: uppercase;
    }

    .summary-table td {
      padding: 15px;
      text-align: center;
      border: 1px solid #dee2e6;
      font-weight: 600;
      font-size: 14px;
    }

    /* Print-friendly styling */
    @media print {
      .enhanced-report-card {
        box-shadow: none;
        border: 1px solid #000;
        padding: 20px;
        margin: 0;
        max-width: 100%;
      }
      
      .no-print {
        display: none !important;
      }
    }

    /* Enhanced PWA Install Prompt */
    .pwa-install-prompt {
      animation: slideInUp 0.5s ease-out;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      border: none;
      color: white;
    }

    .pwa-install-prompt h4 {
      color: white;
    }

    .pwa-install-prompt p {
      color: rgba(255, 255, 255, 0.9);
    }

    /* Image upload improvements */
    .image-upload {
      position: relative;
      overflow: hidden;
    }

    .image-upload input[type="file"] {
      cursor: pointer;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }

    /* Fix for portal exit button visibility */
    .portal-exit-btn {
      z-index: 1002;
    }

    .mobile-exit-btn {
      z-index: 1002;
    }

    /* Make sure dropdowns are visible */
    .marks-container .form-group select {
      z-index: 5;
      position: relative;
    }

    /* Loading overlay for image upload */
    .upload-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: var(--border-radius-sm);
      display: none;
    }

    .upload-loading-overlay.active {
      display: flex;
    }

    /* Rest of your existing CSS remains here... */
  </style>
</head>
<body>
  <!-- PWA Install Prompt -->
  <div class="pwa-install-prompt" id="pwaInstallPrompt">
    <h4><i class="fas fa-download"></i> Install Skore Point</h4>
    <p>Install this app on your device for quick access and offline use.</p>
    <div class="pwa-install-buttons">
      <button class="btn btn-light" id="installPWA">
        <i class="fas fa-plus"></i> Install App
      </button>
      <button class="btn btn-outline-light" id="dismissInstall">
        <i class="fas fa-times"></i> Dismiss
      </button>
    </div>
  </div>

  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">
    <i class="fas fa-wifi-slash"></i> You are currently offline
  </div>

  <!-- LAUNCH SCREEN -->
  <div class="launch-screen" id="launchScreen">
    <div class="launch-container">
      <div class="logo-wrapper">
        <div class="logo">Skore Point</div>
      </div>
      <div class="tagline">Professional School Report Card Generator by SERUSOFT</div>
      <div class="loader">
        <div class="loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- FIXED NAVIGATION BAR -->
  <nav class="navbar" id="navbar">
    <div class="navbar-brand">
      <i class="fas fa-graduation-cap"></i> Skore Point
    </div>
    <div class="navbar-nav">
      <a href="#" class="nav-link" id="userGuideBtn">
        <i class="fas fa-question-circle"></i> User Guide
      </a>
      <button class="logout-btn desktop-only" id="desktopLogoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>

  <!-- MOBILE PORTAL EXIT BUTTON -->
  <button class="mobile-exit-btn" id="mobileExitBtn">
    <i class="fas fa-door-open"></i> Exit Portal
  </button>

  <!-- MOBILE BOTTOM NAVIGATION -->
  <div class="mobile-bottom-nav" id="mobileBottomNav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-item" data-tab="classes">
        <i class="fas fa-chalkboard"></i>
        <span>Classes</span>
      </button>
      <button class="mobile-nav-item" data-tab="students">
        <i class="fas fa-users"></i>
        <span>Students</span>
      </button>
      <button class="mobile-nav-item" data-tab="subjects">
        <i class="fas fa-book"></i>
        <span>Subjects</span>
      </button>
      <button class="mobile-nav-item" data-tab="teachers">
        <i class="fas fa-chalkboard-teacher"></i>
        <span>Teachers</span>
      </button>
      <button class="mobile-nav-item" data-tab="marks">
        <i class="fas fa-edit"></i>
        <span>Marks</span>
      </button>
      <button class="mobile-nav-item" data-tab="reports">
        <i class="fas fa-chart-bar"></i>
        <span id="reportsTabLabel">Reports</span>
      </button>
    </div>
  </div>

  <!-- DESKTOP PORTAL EXIT BUTTON -->
  <button class="portal-exit-btn d-none" id="portalExitBtn">
    <i class="fas fa-door-open"></i> Exit Portal
  </button>

  <!-- MAIN CONTENT CONTAINER -->
  <div class="main-container">
    
    <!-- LOGIN SECTION -->
    <div class="container" id="loginSection">
      <div class="auth-container">
        <button class="close-auth-form" id="closeLoginForm">
          <i class="fas fa-times"></i>
        </button>
        <div class="header">
          <h1>Welcome Back</h1>
          <p>Sign in to your account</p>
        </div>

        <div id="loginError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="loginErrorText"></span>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input type="email" id="loginEmail" placeholder="teacher@school.edu" required>
          </div>

          <div class="form-group">
            <label for="loginPassword">
              <i class="fas fa-lock"></i> Password
            </label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
            <button type="button" class="password-toggle" id="loginToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> Sign In
          </button>

          <div class="loading d-none" id="loginLoading">
            <div class="spinner"></div>
            <p>Signing in...</p>
          </div>
        </form>

        <div class="footer-links">
          <p>
            Don't have an account? 
            <button id="goRegister">Create User Account</button>
          </p>
          <p>
            <button id="forgotPassword">Forgot Password?</button>
          </p>
        </div>
      </div>
    </div>

    <!-- REGISTER SECTION -->
    <div class="container" id="registerSection">
      <div class="auth-container">
        <button class="close-auth-form" id="closeRegisterForm">
          <i class="fas fa-times"></i>
        </button>
        <div class="header">
          <h1>Create User Account</h1>
          <p>Join Skore Point today</p>
        </div>

        <div id="registerError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="registerErrorText"></span>
        </div>

        <div id="registerSuccess" class="alert success d-none">
          <i class="fas fa-check-circle"></i>
          <span>Account created successfully!</span>
        </div>

        <form id="registerForm">
          <div class="form-group">
            <label for="regName">
              <i class="fas fa-user"></i> Full Name <span class="required">*</span>
            </label>
            <input type="text" id="regName" placeholder="John Doe" required>
          </div>

          <div class="form-group">
            <label for="regEmail">
              <i class="fas fa-envelope"></i> Email Address <span class="required">*</span>
            </label>
            <input type="email" id="regEmail" placeholder="john@school.edu" required>
          </div>

          <div class="form-group">
            <label for="regSubject">
              <i class="fas fa-book"></i> Primary Teaching Subject <span class="required">*</span>
            </label>
            <input type="text" id="regSubject" placeholder="Mathematics" required>
          </div>

          <div class="image-upload" id="profileUploadArea">
            <div class="upload-loading-overlay" id="profileUploadLoading">
              <div class="spinner"></div>
              <p style="color: white; margin-left: 10px;">Uploading...</p>
            </div>
            <i class="fas fa-user-circle"></i>
            <p>Upload Profile Picture <span class="required">*</span></p>
            <span>Click to upload (Required)</span>
            <div class="image-preview profile-preview" id="profilePreview">
              <img id="profilePreviewImg" src="" alt="Profile Preview">
            </div>
            <input type="file" class="file-input" id="profileFile" accept="image/*" required>
            <input type="hidden" id="profileUrl">
          </div>

          <div class="form-group">
            <label for="regPassword">
              <i class="fas fa-lock"></i> Password <span class="required">*</span>
            </label>
            <input type="password" id="regPassword" placeholder="Minimum 6 characters" required minlength="6">
            <button type="button" class="password-toggle" id="registerToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div class="form-group">
            <label for="confirmPassword">
              <i class="fas fa-lock"></i> Confirm Password <span class="required">*</span>
            </label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <button type="button" class="password-toggle" id="confirmToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-user-plus"></i> Create User Account
          </button>

          <div class="loading d-none" id="registerLoading">
            <div class="spinner"></div>
            <p>Creating account...</p>
          </div>
        </form>

        <div class="footer-links">
          <p>
            Already have an account? 
            <button id="goLogin">Sign In</button>
          </p>
        </div>
      </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div class="container" id="dashboardSection">
      <div class="dashboard">
        <div class="dashboard-header">
          <h1>Dashboard</h1>
          <div class="user-info-card" id="userInfoCard">
            <div class="user-profile-img-container">
              <div id="userProfileImg" class="user-profile-img">
                <!-- Profile image or initials will be inserted here -->
              </div>
            </div>
            <div class="user-details-container">
              <div id="userRoleBadge" class="user-role-badge d-none"></div>
              <div class="user-name" id="userName">User Name</div>
              <div class="user-email" id="userEmail">user@email.com</div>
              <!-- Mobile Logout Button -->
              <button class="logout-btn mobile-only" id="mobileLogoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
              </button>
            </div>
          </div>
        </div>

        <div class="dashboard-cards">
          <!-- School Portal Card -->
          <div class="card" id="manageSchoolCard" style="display: none;">
            <i class="fas fa-school"></i>
            <h3>School Portal</h3>
            <p>Access your school's management portal to manage classes, students, and generate reports.</p>
            <div id="schoolCardInfo" class="mt-30">
              <img id="schoolCardLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
              <h4 id="schoolCardName"></h4>
              <p>Code: <strong id="schoolCardCode"></strong></p>
              <div class="mt-20">
                <button class="btn btn-success btn-block" id="openSchoolPortalBtn">
                  <i class="fas fa-door-open"></i> Enter Portal
                </button>
              </div>
            </div>
          </div>

          <div class="card" id="joinSchoolCard">
            <i class="fas fa-user-plus"></i>
            <h3>Join School</h3>
            <p>Join an existing school using the school name and unique access code provided by your administrator.</p>
            <button class="btn btn-secondary btn-block mt-20" id="joinSchoolBtn">
              <i class="fas fa-sign-in-alt"></i> Join School
            </button>
          </div>

          <div class="card" id="registerSchoolCard">
            <i class="fas fa-plus-circle"></i>
            <h3>Register School</h3>
            <p>Create a new school on Skore Point and become the administrator. Get a unique code for other teachers to join.</p>
            <button class="btn btn-primary btn-block mt-20" id="registerSchoolBtn">
              <i class="fas fa-school"></i> Register School
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCHOOL MANAGEMENT SECTION -->
    <div class="container" id="schoolManagementSection">
      <div class="school-management">
        <div class="management-header">
          <div>
            <h2 id="managementSchoolName">School Name</h2>
            <div class="school-code mt-10">
              School Code: <span id="managementSchoolCode"></span>
            </div>
          </div>
          <img id="managementSchoolLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
        </div>

        <!-- Desktop Tabs -->
        <div class="management-tabs desktop-only" id="managementTabs">
          <button class="tab active" data-tab="classes">
            <i class="fas fa-chalkboard"></i> Classes
          </button>
          <button class="tab" data-tab="students">
            <i class="fas fa-users"></i> Students
          </button>
          <button class="tab" data-tab="subjects">
            <i class="fas fa-book"></i> Subjects
          </button>
          <button class="tab" data-tab="teachers">
            <i class="fas fa-chalkboard-teacher"></i> Teachers
          </button>
          <button class="tab" data-tab="marks">
            <i class="fas fa-edit"></i> Enter Marks
          </button>
          <button class="tab" data-tab="reports" id="desktopReportsTab">
            <i class="fas fa-chart-bar"></i> <span id="desktopReportsLabel">Reports</span>
          </button>
        </div>

        <!-- Classes Tab -->
        <div class="tab-content active" id="classesTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Classes</h3>
              <div id="classPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to classes.
              </div>
              <button class="btn btn-primary" id="addClassBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Class
              </button>
            </div>

            <div class="list-grid" id="classList">
              <!-- Classes will be loaded here -->
            </div>

            <div class="empty-state d-none" id="classesEmptyState">
              <i class="fas fa-chalkboard"></i>
              <h3>No Classes Yet</h3>
              <p>Start by adding your first class to the school.</p>
            </div>
          </div>
        </div>

        <!-- Students Tab -->
        <div class="tab-content" id="studentsTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Students</h3>
              <div id="studentPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to students.
              </div>
              <button class="btn btn-primary" id="addStudentBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Student
              </button>
            </div>

            <div class="form-group mb-30">
              <label><i class="fas fa-filter"></i> Filter by Class</label>
              <select id="studentClassSelect" class="w-100">
                <option value="">All Classes</option>
              </select>
            </div>

            <div class="file-upload-container" id="studentUploadContainer" style="display: none;">
              <div class="file-upload" id="studentUploadArea">
                <i class="fas fa-file-excel"></i>
                <h4>Upload Student List</h4>
                <p>Upload an Excel file with student names. The first column should contain student names.</p>
                <span>Supported formats: .xlsx, .xls</span>
                <input type="file" class="file-input" id="studentFile" accept=".xlsx,.xls">
              </div>
            </div>

            <div class="list-grid" id="studentList">
              <!-- Students will be loaded here -->
            </div>

            <div class="empty-state d-none" id="studentsEmptyState">
              <i class="fas fa-users"></i>
              <h3>No Students Yet</h3>
              <p>Add students individually or upload an Excel file with student names.</p>
            </div>
          </div>
        </div>

        <!-- Subjects Tab -->
        <div class="tab-content" id="subjectsTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Subjects</h3>
              <div id="subjectPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to subjects.
              </div>
              <button class="btn btn-primary" id="addSubjectBtn" style="display: none;">
                <i class="fas fa-plus"></i> Add Subject
              </button>
            </div>

            <div class="list-grid" id="subjectsList">
              <!-- Subjects will be loaded here -->
            </div>

            <div class="empty-state d-none" id="subjectsEmptyState">
              <i class="fas fa-book"></i>
              <h3>No Subjects Yet</h3>
              <p>Add subjects to your school curriculum.</p>
            </div>
          </div>
        </div>

        <!-- Teachers Tab -->
        <div class="tab-content" id="teachersTab">
          <div class="list-container">
            <div class="list-header">
              <h3>Teachers</h3>
              <div id="teacherPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You have read-only access to teachers.
              </div>
              <button class="btn btn-primary" id="addTeacherBtn" style="display: none;">
                <i class="fas fa-user-plus"></i> Add Teacher
              </button>
            </div>

            <div class="list-grid" id="teacherList">
              <!-- Teachers will be loaded here -->
            </div>

            <div class="empty-state d-none" id="teachersEmptyState">
              <i class="fas fa-chalkboard-teacher"></i>
              <h3>No Teachers Yet</h3>
              <p>Add teachers to your school staff.</p>
            </div>
          </div>
        </div>

        <!-- Marks Tab -->
        <div class="tab-content" id="marksTab">
          <div class="marks-container">
            <div class="list-header">
              <h3>Enter Marks</h3>
              <div id="marksPermissionNote" class="alert info d-none">
                <i class="fas fa-info-circle"></i> You can only enter marks for your assigned subjects.
              </div>
            </div>

            <!-- Marks Entry Section -->
            <div id="marksEntrySection">
              <div class="marks-filters">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Select Class</label>
                  <select id="marksClassSelect" class="w-100" style="z-index: 10;">
                    <option value="">Select a class</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Select Term</label>
                  <select id="termSelect" class="w-100" style="z-index: 10;">
                    <option value="">Select Term</option>
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>

                <div class="form-group" id="marksSubjectFilter" style="display: none;">
                  <label><i class="fas fa-book"></i> Select Subject</label>
                  <select id="marksSubjectSelect" class="w-100" style="z-index: 10;">
                    <option value="">All Assigned Subjects</option>
                  </select>
                </div>
              </div>

              <div class="student-search-container mb-30">
                <label><i class="fas fa-user-graduate"></i> Find Student</label>
                <div class="student-search-wrapper">
                  <i class="fas fa-search student-search-icon"></i>
                  <input type="text" id="studentSearch" class="student-search-input" placeholder="Type student name to search...">
                  <button type="button" class="student-search-clear" id="studentSearchClear">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="student-suggestions" id="studentSuggestions"></div>
              </div>

              <div class="selected-student d-none" id="selectedStudentInfo">
                <h4><i class="fas fa-user-graduate"></i> Selected Student: <span id="selectedStudentName"></span></h4>
                <p>Enter marks for each subject below (0-100)</p>
              </div>

              <div class="marks-grid" id="marksGrid">
                <!-- Marks inputs will be generated here -->
              </div>

              <div id="marksAlert" class="alert d-none">
                <i class="fas fa-info-circle"></i>
                <span id="marksAlertText"></span>
              </div>

              <button class="btn btn-primary btn-block" id="saveMarksBtn" disabled>
                <i class="fas fa-save"></i> Save Marks
              </button>
            </div>

            <div class="empty-state d-none" id="marksEmptyState">
              <i class="fas fa-edit"></i>
              <h3>Select Class and Term</h3>
              <p>Select a class and term to start entering marks.</p>
            </div>
          </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reportsTab">
          <!-- Admin Reports Section -->
          <div id="adminReportsSection" style="display: none;">
            <div class="reports-container">
              <div class="list-header">
                <h3>Reports & Analytics</h3>
              </div>

              <div class="report-filters">
                <h4 class="mb-20">Generate Report</h4>
                <div class="filter-grid">
                  <div class="form-group">
                    <label><i class="fas fa-chalkboard"></i> Class</label>
                    <select id="reportClassSelect" class="w-100">
                      <option value="">All Classes</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><i class="fas fa-user-graduate"></i> Student</label>
                    <select id="reportStudentSelect" class="w-100" disabled>
                      <option value="">All Students</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Term</label>
                    <select id="reportTermSelect" class="w-100">
                      <option value="beginning">Beginning of Term</option>
                      <option value="mid">Mid Term</option>
                      <option value="end">End of Term</option>
                    </select>
                  </div>
                </div>
                <div class="report-actions">
                  <button class="btn btn-primary" id="generateReportBtn">
                    <i class="fas fa-chart-bar"></i> Generate Report
                  </button>
                  <button class="btn btn-success d-none" id="exportPDFBtn">
                    <i class="fas fa-file-pdf"></i> Export Report Card
                  </button>
                  <button class="btn btn-warning d-none" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i> Export Class Analysis
                  </button>
                </div>
              </div>

              <div class="stats-grid d-none" id="statsGrid">
                <div class="stat-card">
                  <h4>Total Students</h4>
                  <p id="statTotalStudents">0</p>
                </div>
                <div class="stat-card">
                  <h4>Average Score</h4>
                  <p id="statAvgScore">0</p>
                </div>
                <div class="stat-card">
                  <h4>Highest Score</h4>
                  <p id="statHighScore">0</p>
                </div>
                <div class="stat-card">
                  <h4>Lowest Score</h4>
                  <p id="statLowScore">0</p>
                </div>
              </div>

              <div id="reportPreview" class="d-none">
                <h4 class="mb-20">Report Preview</h4>
                <div id="enhancedReportCard" class="enhanced-report-card">
                  <!-- Report card content will be generated here -->
                </div>
              </div>

              <div class="empty-state" id="reportsEmptyState">
                <i class="fas fa-chart-line"></i>
                <h3>No Data Available</h3>
                <p>Generate a report to see student performance analytics.</p>
              </div>
            </div>
          </div>

          <!-- Teacher Subject Analytics Section -->
          <div id="teacherAnalyticsSection" style="display: none;">
            <div class="subject-analytics-container">
              <div class="analytics-header">
                <h3>My Subject Analytics</h3>
                <button class="btn btn-success" id="exportSubjectAnalyticsBtn">
                  <i class="fas fa-file-excel"></i> Export Analytics
                </button>
              </div>

              <div class="analytics-filters">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Select Class</label>
                  <select id="analyticsClassSelect" class="w-100">
                    <option value="">All Classes</option>
                  </select>
                </div>

                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Select Term</label>
                  <select id="analyticsTermSelect" class="w-100">
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>

                <div class="form-group subject-select-container">
                  <label><i class="fas fa-book"></i> Select Subjects for Analysis</label>
                  <div class="subject-checkboxes" id="subjectCheckboxesList">
                    <!-- Subject checkboxes will be loaded here -->
                  </div>
                  <div class="mt-10">
                    <button class="btn btn-light btn-sm" id="selectAllSubjects">
                      <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button class="btn btn-light btn-sm" id="deselectAllSubjects">
                      <i class="fas fa-square"></i> Deselect All
                    </button>
                  </div>
                </div>

                <button class="btn btn-primary" id="generateAnalyticsBtn">
                  <i class="fas fa-chart-pie"></i> Generate Analytics
                </button>
              </div>

              <div class="analytics-grid" id="analyticsGrid">
                <!-- Analytics cards will be loaded here -->
              </div>

              <div id="gradeChartContainer" class="d-none">
                <h4 class="mb-20">Grade Distribution</h4>
                <div style="background: var(--darker); border-radius: var(--border-radius-sm); padding: 20px; border: 1px solid rgba(255,255,255,0.1);">
                  <canvas id="gradeDistributionChart"></canvas>
                </div>
              </div>

              <div class="empty-state" id="analyticsEmptyState">
                <i class="fas fa-chart-pie"></i>
                <h3>No Analytics Data</h3>
                <p>Select subjects and generate analytics to see performance data.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS AND FULL SCREEN FORMS -->
  
  <!-- Join School Form -->
  <div class="full-screen-form" id="joinSchoolForm">
    <button class="close-fullscreen" id="closeJoinForm">
      <i class="fas fa-times"></i>
    </button>
    <div class="auth-container">
      <button class="close-auth-form" id="closeJoinSchoolForm">
        <i class="fas fa-times"></i>
      </button>
      <div class="header">
        <h2>Join a School</h2>
        <p>Enter school details to join</p>
      </div>

      <div id="joinSchoolError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="joinSchoolErrorText"></span>
      </div>

      <form id="joinSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="joinSchoolName" placeholder="Enter exact school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-key"></i> School Code</label>
          <input type="text" id="joinSchoolCode" placeholder="6-digit school code" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-sign-in-alt"></i> Join School
        </button>
      </form>
    </div>
  </div>

  <!-- Register School Form -->
  <div class="full-screen-form" id="registerSchoolForm">
    <button class="close-fullscreen" id="closeRegisterForm">
      <i class="fas fa-times"></i>
    </button>
    <div class="auth-container">
      <button class="close-auth-form" id="closeRegisterSchoolForm">
        <i class="fas fa-times"></i>
      </button>
      <div class="header">
        <h2>Register a School</h2>
        <p>Create a new school on Skore Point</p>
      </div>

      <div id="registerSchoolError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="registerSchoolErrorText"></span>
      </div>

      <div id="registerSchoolSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>School registered successfully!</span>
      </div>

      <form id="registerSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name <span class="required">*</span></label>
          <input type="text" id="registerSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> School Location <span class="required">*</span></label>
          <input type="text" id="registerSchoolLocation" placeholder="City, Country" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-phone"></i> School Phone <span class="required">*</span></label>
          <input type="tel" id="registerSchoolPhone" placeholder="+1234567890" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> School Level <span class="required">*</span></label>
          <select id="registerSchoolLevel" required>
            <option value="">Select School Level</option>
            <option value="primary">Primary School</option>
            <option value="secondary">Secondary School</option>
          </select>
        </div>

        <div class="image-upload" id="logoUploadArea">
          <div class="upload-loading-overlay" id="logoUploadLoading">
            <div class="spinner"></div>
            <p style="color: white; margin-left: 10px;">Uploading...</p>
          </div>
          <i class="fas fa-image"></i>
          <p>Upload School Logo <span class="required">*</span></p>
          <span>Click to upload (Required)</span>
          <div class="image-preview" id="logoPreview">
            <img id="logoPreviewImg" src="" alt="Logo Preview">
          </div>
          <input type="file" class="file-input" id="logoFile" accept="image/*" required>
          <input type="hidden" id="logoUrl">
        </div>

        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus-circle"></i> Register School
        </button>
      </form>
    </div>
  </div>

  <!-- Add Class Modal -->
  <div class="modal" id="addClassModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Class</h3>
        <button class="close-modal" id="closeAddClassModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addClassForm">
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class Name</label>
          <input type="text" id="className" placeholder="e.g., Grade 5A, Form 3" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Class
        </button>
      </form>
    </div>
  </div>

  <!-- Add Subject Modal -->
  <div class="modal" id="addSubjectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Subject</h3>
        <button class="close-modal" id="closeAddSubjectModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addSubjectForm">
        <div class="form-group">
          <label><i class="fas fa-book"></i> Subject Name</label>
          <input type="text" id="subjectName" placeholder="e.g., Mathematics, English" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Subject
        </button>
      </form>
    </div>
  </div>

  <!-- Add Teacher Modal -->
  <div class="modal" id="addTeacherModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Teacher</h3>
        <button class="close-modal" id="closeAddTeacherModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="addTeacherError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="addTeacherErrorText"></span>
      </div>
      <form id="addTeacherForm">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Full Name</label>
          <input type="text" id="teacherName" placeholder="Teacher's full name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="teacherEmail" placeholder="teacher@school.edu" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book"></i> Primary Teaching Subject</label>
          <input type="text" id="teacherSubject" placeholder="Primary subject they teach" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book-open"></i> Additional Subjects (Optional)</label>
          <textarea id="teacherAdditionalSubjects" placeholder="Enter additional subjects separated by commas (e.g., Mathematics, Physics, Chemistry)" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label><i class="fas fa-user-tag"></i> Role</label>
          <select id="teacherRole">
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-user-plus"></i> Add Teacher
        </button>
      </form>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div class="modal" id="forgotPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reset Password</h3>
        <button class="close-modal" id="closeForgotPasswordModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="forgotPasswordError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="forgotPasswordErrorText"></span>
      </div>
      <div id="forgotPasswordSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>Password reset email sent! Check your inbox.</span>
      </div>
      <form id="forgotPasswordForm">
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-key"></i> Send Reset Link
        </button>
      </form>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div class="modal" id="addStudentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Student</h3>
        <button class="close-modal" id="closeAddStudentModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="addStudentForm">
        <div class="form-group">
          <label><i class="fas fa-user-graduate"></i> Student Name</label>
          <input type="text" id="studentName" placeholder="Enter student's full name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class</label>
          <select id="studentClass" required>
            <option value="">Select Class</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus"></i> Add Student
        </button>
      </form>
    </div>
  </div>

  <!-- Assign Subjects to Teacher Modal -->
  <div class="modal" id="assignSubjectsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Subjects to Teacher</h3>
        <button class="close-modal" id="closeAssignSubjectsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="assignSubjectsError" class="alert error d-none">
        <i class="fas fa-exclamation-circle"></i>
        <span id="assignSubjectsErrorText"></span>
      </div>
      <div id="assignSubjectsSuccess" class="alert success d-none">
        <i class="fas fa-check-circle"></i>
        <span>Subjects assigned successfully!</span>
      </div>
      <form id="assignSubjectsForm">
        <input type="hidden" id="assignTeacherId">
        <div class="form-group">
          <label><i class="fas fa-user"></i> Teacher</label>
          <input type="text" id="assignTeacherName" readonly>
        </div>
        <div class="form-group">
          <label><i class="fas fa-book"></i> Select Subjects</label>
          <div id="subjectCheckboxes" style="max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <!-- Subjects will be added here -->
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-save"></i> Save Assignments
        </button>
      </form>
    </div>
  </div>

<script>
  // PWA Configuration
  const PWA_CONFIG = {
    appName: 'Skore Point',
    shortName: 'SkorePoint',
    themeColor: '#4361ee',
    backgroundColor: '#0f172a'
  };

  // App Configuration
  const APP_CONFIG = {
    defaultSubjects: {
      primary: ['Mathematics', 'English', 'Science', 'Social Studies', 'Religious Education'],
      secondary: [
        'English Language', 'Mathematics', 'Biology', 'Chemistry', 'Physics',
        'Geography', 'History', 'Computer Studies', 'Business Studies',
        'Religious Education', 'French', 'Kiswahili', 'Agriculture'
      ]
    },
    defaultClasses: {
      primary: ['Primary 1', 'Primary 2', 'Primary 3', 'Primary 4', 'Primary 5', 'Primary 6', 'Primary 7'],
      secondary: ['Senior 1', 'Senior 2', 'Senior 3', 'Senior 4', 'Senior 5', 'Senior 6']
    },
    gradingScales: {
      primary: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9'],
      secondary: ['A', 'B', 'C', 'D', 'E', 'F']
    },
    gradePoints: {
      primary: { D1: 1, D2: 2, C3: 3, C4: 4, C5: 5, C6: 6, P7: 7, P8: 8, F9: 9 },
      secondary: { A: 1, B: 2, C: 3, D: 4, E: 5, F: 6 }
    }
  };

  // Global State
  let currentUser = null;
  let currentUserData = null;
  let currentSchool = null;
  let currentClasses = [];
  let currentStudents = [];
  let currentSubjects = [];
  let currentTeachers = [];
  let selectedStudentId = null;
  let schoolLogoUrl = null;
  let userProfileUrl = null;
  let isSchoolPortalOpen = false;
  let isMobileView = window.innerWidth <= 768;
  let gradeChart = null;
  let deferredPrompt = null;
  let isAppInstalled = false;

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyASIdYdW94ZJQXsc6BN9Bc28eou0yjPE1U",
    authDomain: "upgrade-16092.firebaseapp.com",
    projectId: "upgrade-16092",
    storageBucket: "upgrade-16092.firebasestorage.app",
    messagingSenderId: "466381827996",
    appId: "1:466381827996:web:6f030e68c526e734a26259",
    measurementId: "G-RGCH68RJ8H"
  };

  // Initialize Firebase
  let firebaseApp, firebaseAuth, firestore;

  // Firebase initialization function
  async function initializeFirebase() {
    try {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
      const { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
      const { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

      // Initialize Firebase
      firebaseApp = initializeApp(firebaseConfig);
      firebaseAuth = getAuth(firebaseApp);
      firestore = getFirestore(firebaseApp);

      // Make Firebase available globally
      window.firebase = {
        auth: firebaseAuth,
        db: firestore,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile,
        sendPasswordResetEmail,
        collection,
        addDoc,
        getDocs,
        query,
        where,
        doc,
        setDoc,
        getDoc,
        updateDoc,
        deleteDoc,
        arrayUnion,
        arrayRemove
      };

      console.log('Firebase initialized successfully');
      return true;
    } catch (error) {
      console.error('Firebase initialization error:', error);
      showAlert('loginError', 'Failed to initialize application. Please check your internet connection.', 'error');
      return false;
    }
  }

  // DOM Elements
  const containers = {
    launchScreen: document.getElementById('launchScreen'),
    navbar: document.getElementById('navbar'),
    mobileBottomNav: document.getElementById('mobileBottomNav'),
    mobileExitBtn: document.getElementById('mobileExitBtn'),
    loginSection: document.getElementById('loginSection'),
    registerSection: document.getElementById('registerSection'),
    dashboardSection: document.getElementById('dashboardSection'),
    schoolManagementSection: document.getElementById('schoolManagementSection'),
    joinSchoolForm: document.getElementById('joinSchoolForm'),
    registerSchoolForm: document.getElementById('registerSchoolForm'),
    addClassModal: document.getElementById('addClassModal'),
    addSubjectModal: document.getElementById('addSubjectModal'),
    addTeacherModal: document.getElementById('addTeacherModal'),
    addStudentModal: document.getElementById('addStudentModal'),
    forgotPasswordModal: document.getElementById('forgotPasswordModal'),
    assignSubjectsModal: document.getElementById('assignSubjectsModal'),
    pwaInstallPrompt: document.getElementById('pwaInstallPrompt'),
    offlineIndicator: document.getElementById('offlineIndicator')
  };

  // Initialize the application
  document.addEventListener('DOMContentLoaded', async () => {
    // Check if mobile view
    checkMobileView();
    window.addEventListener('resize', checkMobileView);
    
    // Show launch screen
    containers.launchScreen.style.display = 'flex';
    
    try {
      // Initialize Firebase
      const firebaseInitialized = await initializeFirebase();
      
      if (firebaseInitialized) {
        // Set up auth state listener
        window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
          if (user) {
            currentUser = user;
            await loadUserData(user.uid);
            showContainer('dashboardSection');
            hideLaunchScreen();
          } else {
            hideLaunchScreen();
            showContainer('loginSection');
          }
        });
      }
    } catch (error) {
      console.error('App initialization error:', error);
      hideLaunchScreen();
      showContainer('loginSection');
      showAlert('loginError', 'Application failed to initialize. Please refresh the page.', 'error');
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup PWA
    setupPWA();
    
    // Hide launch screen after 2 seconds if still showing
    setTimeout(() => {
      hideLaunchScreen();
      if (!currentUser) {
        showContainer('loginSection');
      }
    }, 2000);
  });

  // Setup PWA functionality
  function setupPWA() {
    // Check if app is installed
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true) {
      isAppInstalled = true;
      console.log('App is installed as PWA');
    }
    
    // Listen for beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('beforeinstallprompt event fired');
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install prompt only if app is not already installed
      if (!isAppInstalled) {
        setTimeout(() => {
          showPWAInstallPrompt();
        }, 5000); // Show after 5 seconds
      }
    });
    
    // Listen for app installed event
    window.addEventListener('appinstalled', () => {
      isAppInstalled = true;
      console.log('App installed successfully');
      hidePWAInstallPrompt();
      alert('Skore Point has been installed successfully!');
    });
    
    // Check online/offline status
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
    
    // Register service worker if supported
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('New service worker found:', newWorker);
            });
          })
          .catch(err => {
            console.log('ServiceWorker registration failed:', err);
          });
      });
    }
    
    // Add to home screen prompt for iOS
    if (isIOS()) {
      showIOSInstallInstructions();
    }
  }

  // Check if iOS device
  function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  }

  // Show iOS install instructions
  function showIOSInstallInstructions() {
    setTimeout(() => {
      if (!isAppInstalled) {
        alert('To install Skore Point on your iOS device:\n\n1. Tap the Share button (square with arrow up)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" in the top right corner');
      }
    }, 10000);
  }

  // Show PWA install prompt
  function showPWAInstallPrompt() {
    if (deferredPrompt && !isAppInstalled) {
      containers.pwaInstallPrompt.style.display = 'block';
      console.log('Showing PWA install prompt');
    }
  }

  // Hide PWA install prompt
  function hidePWAInstallPrompt() {
    containers.pwaInstallPrompt.style.display = 'none';
    deferredPrompt = null;
  }

  // Update online/offline status
  function updateOnlineStatus() {
    if (navigator.onLine) {
      containers.offlineIndicator.classList.remove('show');
    } else {
      containers.offlineIndicator.classList.add('show');
    }
  }

  // Check mobile view
  function checkMobileView() {
    isMobileView = window.innerWidth <= 768;
    if (isSchoolPortalOpen) {
      if (isMobileView) {
        containers.mobileBottomNav.style.display = 'flex';
        containers.mobileBottomNav.classList.add('active');
        containers.mobileExitBtn.classList.add('active');
        document.getElementById('portalExitBtn').classList.add('d-none');
      } else {
        containers.mobileBottomNav.style.display = 'none';
        containers.mobileBottomNav.classList.remove('active');
        containers.mobileExitBtn.classList.remove('active');
        document.getElementById('portalExitBtn').classList.remove('d-none');
      }
    } else {
      // Hide mobile bottom nav when portal is not open
      containers.mobileBottomNav.style.display = 'none';
      containers.mobileBottomNav.classList.remove('active');
      containers.mobileExitBtn.classList.remove('active');
      document.getElementById('portalExitBtn').classList.add('d-none');
    }
  }

  // Load user data from Firestore
  async function loadUserData(userId) {
    try {
      console.log('Loading user data for:', userId);
      
      const userDocRef = window.firebase.doc(window.firebase.db, 'users', userId);
      const userDoc = await window.firebase.getDoc(userDocRef);
      
      if (userDoc.exists()) {
        currentUserData = userDoc.data();
        console.log('User data loaded:', currentUserData);
        
        // Update UI with user data
        updateUserProfileUI();
        
        // Check if user has a school
        if (currentUserData.schoolId) {
          console.log('User has school:', currentUserData.schoolId);
          await loadSchoolData(currentUserData.schoolId);
        } else {
          console.log('User has no school');
          document.getElementById('manageSchoolCard').style.display = 'none';
        }
      } else {
        console.log('No user document found');
        // Create user document if it doesn't exist
        await window.firebase.setDoc(
          window.firebase.doc(window.firebase.db, 'users', userId),
          {
            name: currentUser.displayName || 'User',
            email: currentUser.email,
            role: 'teacher',
            createdAt: new Date()
          }
        );
        
        currentUserData = {
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          role: 'teacher'
        };
        
        updateUserProfileUI();
      }
    } catch (error) {
      console.error('Error loading user data:', error);
      showAlert('loginError', 'Error loading user data', 'error');
    }
  }

  // Update user profile UI
  function updateUserProfileUI() {
    document.getElementById('userName').textContent = currentUserData.name || 'User';
    document.getElementById('userEmail').textContent = currentUser.email;
    
    // Update profile image
    updateUserProfileImage(currentUserData.profileUrl);
    
    // Update role badge
    if (currentUserData.role) {
      const roleBadge = document.getElementById('userRoleBadge');
      roleBadge.textContent = currentUserData.role.toUpperCase();
      roleBadge.className = `user-role-badge ${currentUserData.role}`;
      roleBadge.classList.remove('d-none');
    }
  }

  // Update user profile image
  function updateUserProfileImage(profileUrl) {
    const profileImg = document.getElementById('userProfileImg');
    if (profileUrl && (profileUrl.startsWith('data:image') || profileUrl.startsWith('http'))) {
      userProfileUrl = profileUrl;
      profileImg.innerHTML = `<img src="${profileUrl}" alt="${currentUserData.name || 'User'}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='${getInitials(currentUserData.name || 'U')}'">`;
    } else {
      profileImg.innerHTML = getInitials(currentUserData.name || 'U');
    }
  }

  // Get initials from name
  function getInitials(name) {
    if (!name) return 'U';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  }

  // Load school data
  async function loadSchoolData(schoolId) {
    try {
      console.log('Loading school data for:', schoolId);
      
      const schoolDocRef = window.firebase.doc(window.firebase.db, 'schools', schoolId);
      const schoolDoc = await window.firebase.getDoc(schoolDocRef);
      
      if (schoolDoc.exists()) {
        currentSchool = {
          id: schoolDoc.id,
          ...schoolDoc.data()
        };
        
        console.log('School data loaded:', currentSchool);
        
        // Show the "School Portal" card
        const schoolPortalCard = document.getElementById('manageSchoolCard');
        schoolPortalCard.style.display = 'block';
        
        // Update dashboard school card
        document.getElementById('schoolCardName').textContent = currentSchool.name;
        document.getElementById('schoolCardCode').textContent = currentSchool.code;
        
        // Update school logo in dashboard
        if (currentSchool.logoUrl) {
          schoolLogoUrl = currentSchool.logoUrl;
          const schoolLogo = document.getElementById('schoolCardLogo');
          schoolLogo.src = currentSchool.logoUrl;
          schoolLogo.style.display = 'block';
          schoolLogo.onerror = () => {
            schoolLogo.style.display = 'none';
          };
        }
        
        // Load school data
        await Promise.all([
          loadClasses(),
          loadSubjects(),
          loadTeachers()
        ]);
      } else {
        console.log('School document not found');
        // User has a schoolId but school doesn't exist - clear it
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
          {
            schoolId: null
          }
        );
        
        document.getElementById('manageSchoolCard').style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading school data:', error);
    }
  }

  // Setup all event listeners
  function setupEventListeners() {
    // Navigation
    document.getElementById('goRegister').addEventListener('click', () => showContainer('registerSection'));
    document.getElementById('goLogin').addEventListener('click', () => showContainer('loginSection'));
    document.getElementById('joinSchoolBtn').addEventListener('click', () => containers.joinSchoolForm.classList.add('active'));
    document.getElementById('registerSchoolBtn').addEventListener('click', () => containers.registerSchoolForm.classList.add('active'));
    document.getElementById('desktopLogoutBtn').addEventListener('click', handleLogout);
    document.getElementById('mobileLogoutBtn').addEventListener('click', handleLogout);
    document.getElementById('userGuideBtn').addEventListener('click', showUserGuide);
    document.getElementById('forgotPassword').addEventListener('click', () => containers.forgotPasswordModal.classList.add('active'));
    document.getElementById('openSchoolPortalBtn').addEventListener('click', openSchoolPortal);
    
    // Portal exit buttons
    document.getElementById('portalExitBtn').addEventListener('click', closeSchoolPortal);
    document.getElementById('mobileExitBtn').addEventListener('click', closeSchoolPortal);
    
    // PWA Install buttons
    document.getElementById('installPWA').addEventListener('click', installPWA);
    document.getElementById('dismissInstall').addEventListener('click', hidePWAInstallPrompt);
    
    // Close buttons for auth forms
    document.getElementById('closeLoginForm').addEventListener('click', () => {
      if (currentUser) {
        showContainer('dashboardSection');
      } else {
        showContainer('loginSection');
      }
    });
    
    document.getElementById('closeRegisterForm').addEventListener('click', () => {
      showContainer('loginSection');
    });
    
    document.getElementById('closeJoinSchoolForm').addEventListener('click', () => {
      containers.joinSchoolForm.classList.remove('active');
    });
    
    document.getElementById('closeRegisterSchoolForm').addEventListener('click', () => {
      containers.registerSchoolForm.classList.remove('active');
    });
    
    // Other close buttons
    document.getElementById('closeJoinForm').addEventListener('click', () => containers.joinSchoolForm.classList.remove('active'));
    document.getElementById('closeRegisterForm').addEventListener('click', () => containers.registerSchoolForm.classList.remove('active'));
    document.getElementById('closeAddClassModal').addEventListener('click', () => containers.addClassModal.classList.remove('active'));
    document.getElementById('closeAddSubjectModal').addEventListener('click', () => containers.addSubjectModal.classList.remove('active'));
    document.getElementById('closeAddTeacherModal').addEventListener('click', () => containers.addTeacherModal.classList.remove('active'));
    document.getElementById('closeAddStudentModal').addEventListener('click', () => containers.addStudentModal.classList.remove('active'));
    document.getElementById('closeForgotPasswordModal').addEventListener('click', () => containers.forgotPasswordModal.classList.remove('active'));
    document.getElementById('closeAssignSubjectsModal').addEventListener('click', () => containers.assignSubjectsModal.classList.remove('active'));
    
    // File upload buttons
    document.getElementById('studentUploadArea').addEventListener('click', () => document.getElementById('studentFile').click());
    
    // File change events with improved handling
    document.getElementById('profileFile').addEventListener('change', (e) => handleImageUpload(e, 'profile'));
    document.getElementById('logoFile').addEventListener('change', (e) => handleImageUpload(e, 'logo'));
    document.getElementById('studentFile').addEventListener('change', handleStudentFileUpload);
    
    // Form submissions
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    document.getElementById('joinSchoolFormFields').addEventListener('submit', handleJoinSchool);
    document.getElementById('registerSchoolFormFields').addEventListener('submit', handleRegisterSchool);
    document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);
    document.getElementById('addClassForm').addEventListener('submit', handleAddClass);
    document.getElementById('addSubjectForm').addEventListener('submit', handleAddSubject);
    document.getElementById('addTeacherForm').addEventListener('submit', handleAddTeacher);
    document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
    document.getElementById('assignSubjectsForm').addEventListener('submit', handleAssignSubjects);
    
    // Tab switching
    setupTabs();
    
    // Mobile tab switching with smooth scroll
    setupMobileTabs();
    
    // Password toggles
    setupPasswordToggles();
    
    // Student search
    document.getElementById('studentSearch').addEventListener('input', handleStudentSearch);
    document.getElementById('studentSearchClear').addEventListener('click', clearStudentSearch);
    
    // Marks entry - FIXED: Ensure dropdowns work
    document.getElementById('marksClassSelect').addEventListener('change', handleClassSelectForMarks);
    document.getElementById('termSelect').addEventListener('change', handleTermSelect);
    document.getElementById('marksSubjectSelect').addEventListener('change', handleSubjectSelectForMarks);
    document.getElementById('saveMarksBtn').addEventListener('click', handleSaveMarks);
    
    // Reports
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);
    document.getElementById('exportPDFBtn').addEventListener('click', exportReportCard);
    document.getElementById('exportExcelBtn').addEventListener('click', exportClassAnalysis);
    document.getElementById('exportSubjectAnalyticsBtn').addEventListener('click', exportSubjectAnalytics);
    document.getElementById('reportClassSelect').addEventListener('change', updateReportStudentSelect);
    
    // Enhanced Analytics
    document.getElementById('generateAnalyticsBtn').addEventListener('click', generateEnhancedAnalytics);
    document.getElementById('analyticsClassSelect').addEventListener('change', loadAnalyticsSubjects);
    document.getElementById('selectAllSubjects').addEventListener('click', selectAllSubjects);
    document.getElementById('deselectAllSubjects').addEventListener('click', deselectAllSubjects);
    
    // Add buttons
    document.getElementById('addClassBtn').addEventListener('click', () => containers.addClassModal.classList.add('active'));
    document.getElementById('addSubjectBtn').addEventListener('click', () => containers.addSubjectModal.classList.add('active'));
    document.getElementById('addTeacherBtn').addEventListener('click', () => containers.addTeacherModal.classList.add('active'));
    document.getElementById('addStudentBtn').addEventListener('click', () => containers.addStudentModal.classList.add('active'));
  }

  // Install PWA
  async function installPWA() {
    if (deferredPrompt) {
      try {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        if (outcome === 'accepted') {
          console.log('User accepted the install prompt');
          isAppInstalled = true;
        }
        deferredPrompt = null;
        hidePWAInstallPrompt();
      } catch (error) {
        console.error('Error during PWA installation:', error);
      }
    } else {
      alert('PWA installation is not available in this browser. Please use Chrome, Edge, or Safari.');
    }
  }

  // Handle image upload with better error handling
  async function handleImageUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.match('image.*')) {
      showAlert(`${type}Error`, 'Please select an image file (JPEG, PNG, GIF)', 'error');
      return;
    }
    
    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      showAlert(`${type}Error`, 'Image size should be less than 2MB', 'error');
      return;
    }
    
    // Show loading
    const loadingId = `${type}UploadLoading`;
    const loadingElement = document.getElementById(loadingId);
    if (loadingElement) {
      loadingElement.classList.add('active');
    }
    
    try {
      // Create preview using FileReader
      const imageUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject(new Error('Error reading image file'));
        reader.readAsDataURL(file);
      });
      
      if (type === 'profile') {
        // Update profile preview
        const previewImg = document.getElementById('profilePreviewImg');
        previewImg.src = imageUrl;
        const previewContainer = document.getElementById('profilePreview');
        previewContainer.style.display = 'block';
        document.getElementById('profileUrl').value = imageUrl;
        userProfileUrl = imageUrl;
        
        // Update user profile in dashboard if logged in
        if (currentUserData) {
          updateUserProfileImage(imageUrl);
        }
      } else {
        // Update logo preview
        const previewImg = document.getElementById('logoPreviewImg');
        previewImg.src = imageUrl;
        const previewContainer = document.getElementById('logoPreview');
        previewContainer.style.display = 'block';
        document.getElementById('logoUrl').value = imageUrl;
        schoolLogoUrl = imageUrl;
      }
      
      // Hide loading
      if (loadingElement) {
        loadingElement.classList.remove('active');
      }
      
    } catch (error) {
      console.error('Error uploading image:', error);
      showAlert(`${type}Error`, 'Error uploading image. Please try again.', 'error');
      if (loadingElement) {
        loadingElement.classList.remove('active');
      }
    }
  }

  // Handle student file upload
  async function handleStudentFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check file type
    if (!file.name.match(/\.(xlsx|xls)$/)) {
      alert('Please upload an Excel file (.xlsx or .xls)');
      return;
    }
    
    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // Process data
        let addedCount = 0;
        const classId = document.getElementById('studentClassSelect').value;
        
        if (!classId) {
          alert('Please select a class first');
          return;
        }
        
        for (let i = 0; i < jsonData.length; i++) {
          const studentName = jsonData[i][0];
          if (studentName && typeof studentName === 'string' && studentName.trim()) {
            try {
              await window.firebase.addDoc(
                window.firebase.collection(window.firebase.db, 'students'),
                {
                  name: studentName.trim(),
                  classId: classId,
                  schoolId: currentSchool.id,
                  createdAt: new Date(),
                  createdBy: currentUser.uid
                }
              );
              addedCount++;
            } catch (error) {
              console.error('Error adding student:', error);
            }
          }
        }
        
        alert(`Successfully added ${addedCount} students from the file.`);
        loadStudents();
      };
      
      reader.readAsArrayBuffer(file);
      
    } catch (error) {
      console.error('Error processing Excel file:', error);
      alert('Error processing Excel file. Please check the format and try again.');
    }
  }

  // Setup tabs
  function setupTabs() {
    const tabs = document.querySelectorAll('.desktop-only .tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
      });
    });
  }

  // Setup mobile tabs with smooth scroll to relevant sections
  function setupMobileTabs() {
    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
    mobileNavItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = item.dataset.tab;
        
        // Update active state
        mobileNavItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // Switch tab first
        switchTab(tabId);
        
        // Then scroll to the relevant section
        setTimeout(() => {
          scrollToRelevantSection(tabId);
        }, 300);
      });
    });
  }

  // Scroll to relevant section based on tab
  function scrollToRelevantSection(tabId) {
    if (!isMobileView) return;
    
    const tabContent = document.getElementById(`${tabId}Tab`);
    if (!tabContent) return;
    
    // Calculate position to scroll to
    const navbarHeight = 70;
    const mobileNavHeight = 70;
    const tabTop = tabContent.offsetTop - navbarHeight;
    
    // For reports/analytics tab, scroll to the top of that section
    if (tabId === 'reports') {
      window.scrollTo({
        top: tabTop,
        behavior: 'smooth'
      });
      return;
    }
    
    // For marks tab, scroll to the marks entry section
    if (tabId === 'marks') {
      setTimeout(() => {
        const marksEntrySection = document.getElementById('marksEntrySection');
        if (marksEntrySection) {
          const marksTop = marksEntrySection.offsetTop - navbarHeight;
          window.scrollTo({
            top: marksTop,
            behavior: 'smooth'
          });
        }
      }, 300);
      return;
    }
    
    // For other tabs, scroll to the tab content
    window.scrollTo({
      top: tabTop,
      behavior: 'smooth'
    });
  }

  // Switch tab
  function switchTab(tabId) {
    // Update active tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mobile-nav-item').forEach(m => m.classList.remove('active'));
    
    // Activate selected tab
    const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
    const selectedMobileTab = document.querySelector(`.mobile-nav-item[data-tab="${tabId}"]`);
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedMobileTab) selectedMobileTab.classList.add('active');
    
    const tabContent = document.getElementById(`${tabId}Tab`);
    if (tabContent) {
      tabContent.classList.add('active');
    }
    
    // Load data for the active tab
    switch(tabId) {
      case 'classes':
        loadClasses();
        break;
      case 'students':
        loadStudents();
        break;
      case 'subjects':
        loadSubjects();
        break;
      case 'teachers':
        loadTeachers();
        break;
      case 'marks':
        setupMarksTab();
        break;
      case 'reports':
        setupReportsTab();
        break;
    }
  }

  // Setup password toggles
  function setupPasswordToggles() {
    const toggles = [
      { toggle: 'loginToggle', field: 'loginPassword' },
      { toggle: 'registerToggle', field: 'regPassword' },
      { toggle: 'confirmToggle', field: 'confirmPassword' }
    ];
    
    toggles.forEach(({ toggle, field }) => {
      const toggleBtn = document.getElementById(toggle);
      const fieldInput = document.getElementById(field);
      
      if (toggleBtn && fieldInput) {
        toggleBtn.addEventListener('click', () => {
          const type = fieldInput.type === 'password' ? 'text' : 'password';
          fieldInput.type = type;
          toggleBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
      }
    });
  }

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    showLoading('loginLoading');
    hideAlert('loginError');
    
    try {
      await window.firebase.signInWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      // Auth state listener will handle the rest
    } catch (error) {
      hideLoading('loginLoading');
      let errorMessage = 'Login failed. ';
      switch(error.code) {
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        case 'auth/user-disabled':
          errorMessage += 'This account has been disabled.';
          break;
        case 'auth/user-not-found':
        case 'auth/wrong-password':
          errorMessage += 'Invalid email or password.';
          break;
        case 'auth/network-request-failed':
          errorMessage += 'Network error. Please check your internet connection.';
          break;
        default:
          errorMessage += error.message;
      }
      showAlert('loginError', errorMessage, 'error');
    }
  }

  // Handle registration
  async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const subject = document.getElementById('regSubject').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const profileUrl = document.getElementById('profileUrl').value;
    
    // Validation
    if (!profileUrl) {
      showAlert('registerError', 'Profile picture is required', 'error');
      return;
    }
    
    if (password !== confirmPassword) {
      showAlert('registerError', 'Passwords do not match', 'error');
      return;
    }
    
    if (password.length < 6) {
      showAlert('registerError', 'Password must be at least 6 characters', 'error');
      return;
    }
    
    showLoading('registerLoading');
    hideAlert('registerError');
    
    try {
      // Create user account
      const userCredential = await window.firebase.createUserWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      
      // Create user document in Firestore
      const userData = {
        name: name,
        email: email,
        subject: subject,
        profileUrl: profileUrl || null,
        role: 'teacher',
        createdAt: new Date()
      };
      
      console.log('Creating user document with data:', userData);
      
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'users', userCredential.user.uid),
        userData
      );
      
      // Update profile with display name
      if (name) {
        await window.firebase.updateProfile(userCredential.user, {
          displayName: name
        });
      }
      
      hideLoading('registerLoading');
      showAlert('registerSuccess', 'Account created successfully!', 'success');
      
      // Redirect to dashboard after delay
      setTimeout(() => {
        showContainer('dashboardSection');
      }, 2000);
      
    } catch (error) {
      hideLoading('registerLoading');
      let errorMessage = 'Registration failed. ';
      switch(error.code) {
        case 'auth/email-already-in-use':
          errorMessage += 'Email is already registered.';
          break;
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        case 'auth/operation-not-allowed':
          errorMessage += 'Email/password accounts are not enabled.';
          break;
        case 'auth/weak-password':
          errorMessage += 'Password is too weak.';
          break;
        case 'auth/network-request-failed':
          errorMessage += 'Network error. Please check your internet connection.';
          break;
        default:
          errorMessage += error.message;
      }
      showAlert('registerError', errorMessage, 'error');
    }
  }

  // Handle join school
  async function handleJoinSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('joinSchoolName').value.trim();
    const schoolCode = document.getElementById('joinSchoolCode').value.trim().toUpperCase();
    
    hideAlert('joinSchoolError');
    
    if (!schoolName || !schoolCode) {
      showAlert('joinSchoolError', 'Please enter both school name and code', 'error');
      return;
    }
    
    try {
      console.log('Searching for school:', schoolName, 'code:', schoolCode);
      
      // Find school by name and code
      const schoolsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'schools'),
        window.firebase.where('name', '==', schoolName),
        window.firebase.where('code', '==', schoolCode)
      );
      
      const querySnapshot = await window.firebase.getDocs(schoolsQuery);
      
      if (querySnapshot.empty) {
        showAlert('joinSchoolError', 'School not found. Please check the name and code.', 'error');
        return;
      }
      
      const schoolDoc = querySnapshot.docs[0];
      currentSchool = {
        id: schoolDoc.id,
        ...schoolDoc.data()
      };
      
      console.log('School found:', currentSchool);
      
      // Update user document
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolDoc.id,
          role: 'teacher'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolDoc.id;
      currentUserData.role = 'teacher';
      
      // Update UI
      document.getElementById('schoolCardName').textContent = currentSchool.name;
      document.getElementById('schoolCardCode').textContent = currentSchool.code;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Load school data
      await loadSchoolData(schoolDoc.id);
      
      // Hide form
      containers.joinSchoolForm.classList.remove('active');
      
      showAlert('registerSuccess', `Successfully joined ${currentSchool.name}!`, 'success');
      
    } catch (error) {
      console.error('Error joining school:', error);
      showAlert('joinSchoolError', 'Error joining school. Please try again.', 'error');
    }
  }

  // Handle register school
  async function handleRegisterSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('registerSchoolName').value.trim();
    const schoolLocation = document.getElementById('registerSchoolLocation').value.trim();
    const schoolPhone = document.getElementById('registerSchoolPhone').value.trim();
    const schoolLevel = document.getElementById('registerSchoolLevel').value;
    const logoUrl = document.getElementById('logoUrl').value;
    
    if (!logoUrl) {
      showAlert('registerSchoolError', 'School logo is required', 'error');
      return;
    }
    
    if (!schoolLevel) {
      showAlert('registerSchoolError', 'Please select school level', 'error');
      return;
    }
    
    if (!schoolName) {
      showAlert('registerSchoolError', 'Please enter school name', 'error');
      return;
    }
    
    hideAlert('registerSchoolError');
    
    try {
      // Generate school code
      const schoolCode = generateSchoolCode();
      console.log('Generating school code:', schoolCode);
      
      // Create school document
      const schoolData = {
        name: schoolName,
        location: schoolLocation,
        phone: schoolPhone,
        level: schoolLevel,
        code: schoolCode,
        logoUrl: logoUrl || null,
        createdBy: currentUser.uid,
        admins: [currentUser.uid],
        teachers: [currentUser.uid],
        createdAt: new Date()
      };
      
      console.log('Creating school with data:', schoolData);
      
      const schoolRef = await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'schools'),
        schoolData
      );
      
      console.log('School created with ID:', schoolRef.id);
      
      // Update user document
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolRef.id,
          role: 'admin'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolRef.id;
      currentUserData.role = 'admin';
      
      // Update role badge
      const roleBadge = document.getElementById('userRoleBadge');
      roleBadge.textContent = 'ADMIN';
      roleBadge.className = 'user-role-badge admin';
      roleBadge.classList.remove('d-none');
      
      // Add default subjects
      const defaultSubjects = APP_CONFIG.defaultSubjects[schoolLevel];
      console.log('Adding default subjects:', defaultSubjects);
      
      for (const subjectName of defaultSubjects) {
        await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'subjects'),
          {
            name: subjectName,
            schoolId: schoolRef.id,
            createdAt: new Date()
          }
        );
      }
      
      // Add default classes
      const defaultClasses = APP_CONFIG.defaultClasses[schoolLevel];
      console.log('Adding default classes:', defaultClasses);
      
      for (const className of defaultClasses) {
        await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'classes'),
          {
            name: className,
            schoolId: schoolRef.id,
            createdAt: new Date()
          }
        );
      }
      
      // Update current school data
      currentSchool = {
        id: schoolRef.id,
        ...schoolData
      };
      
      // Update UI
      document.getElementById('schoolCardName').textContent = schoolName;
      document.getElementById('schoolCardCode').textContent = schoolCode;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Show success message
      showAlert('registerSchoolSuccess', 'School registered successfully!', 'success');
      
      // Hide form after delay
      setTimeout(() => {
        containers.registerSchoolForm.classList.remove('active');
      }, 2000);
      
    } catch (error) {
      console.error('Error registering school:', error);
      showAlert('registerSchoolError', 'Error registering school. Please try again.', 'error');
    }
  }

  // Handle forgot password
  async function handleForgotPassword(e) {
    e.preventDefault();
    
    const email = document.getElementById('forgotPasswordEmail').value;
    
    hideAlert('forgotPasswordError');
    hideAlert('forgotPasswordSuccess');
    
    try {
      await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
      showAlert('forgotPasswordSuccess', 'Password reset email sent! Check your inbox.', 'success');
      
      // Clear form and hide modal after delay
      setTimeout(() => {
        document.getElementById('forgotPasswordEmail').value = '';
        containers.forgotPasswordModal.classList.remove('active');
      }, 3000);
      
    } catch (error) {
      console.error('Error sending password reset:', error);
      showAlert('forgotPasswordError', 'Error sending password reset email. Please try again.', 'error');
    }
  }

  // Handle add class
  async function handleAddClass(e) {
    e.preventDefault();
    
    const className = document.getElementById('className').value;
    
    try {
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'classes'),
        {
          name: className,
          schoolId: currentSchool.id,
          createdAt: new Date(),
          createdBy: currentUser.uid
        }
      );
      
      // Clear form and reload
      document.getElementById('className').value = '';
      containers.addClassModal.classList.remove('active');
      loadClasses();
      
    } catch (error) {
      console.error('Error adding class:', error);
      alert('Error adding class. Please try again.');
    }
  }

  // Handle add subject
  async function handleAddSubject(e) {
    e.preventDefault();
    
    const subjectName = document.getElementById('subjectName').value;
    
    try {
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'subjects'),
        {
          name: subjectName,
          schoolId: currentSchool.id,
          createdAt: new Date(),
          createdBy: currentUser.uid
        }
      );
      
      // Clear form and reload
      document.getElementById('subjectName').value = '';
      containers.addSubjectModal.classList.remove('active');
      loadSubjects();
      
    } catch (error) {
      console.error('Error adding subject:', error);
      alert('Error adding subject. Please try again.');
    }
  }

  // Handle add teacher
  async function handleAddTeacher(e) {
    e.preventDefault();
    
    const teacherName = document.getElementById('teacherName').value;
    const teacherEmail = document.getElementById('teacherEmail').value;
    const teacherSubject = document.getElementById('teacherSubject').value;
    const teacherAdditionalSubjects = document.getElementById('teacherAdditionalSubjects').value;
    const teacherRole = document.getElementById('teacherRole').value;
    
    // Process additional subjects
    const additionalSubjectsArray = teacherAdditionalSubjects
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0);
    
    const allSubjects = [teacherSubject, ...additionalSubjectsArray].filter((v, i, a) => a.indexOf(v) === i);
    
    try {
      // First, check if user exists
      const usersQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'users'),
        window.firebase.where('email', '==', teacherEmail)
      );
      
      const querySnapshot = await window.firebase.getDocs(usersQuery);
      let teacherUserId = null;
      
      if (!querySnapshot.empty) {
        // User exists, update their school
        const userDoc = querySnapshot.docs[0];
        teacherUserId = userDoc.id;
        
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', teacherUserId),
          {
            schoolId: currentSchool.id,
            role: teacherRole,
            subject: teacherSubject,
            additionalSubjects: additionalSubjectsArray,
            assignedSubjects: allSubjects
          }
        );
      } else {
        // Create new user document
        const newTeacherRef = await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'users'),
          {
            name: teacherName,
            email: teacherEmail,
            subject: teacherSubject,
            additionalSubjects: additionalSubjectsArray,
            assignedSubjects: allSubjects,
            role: teacherRole,
            schoolId: currentSchool.id,
            createdAt: new Date(),
            status: 'active'
          }
        );
        
        teacherUserId = newTeacherRef.id;
      }
      
      // Update school's teacher list
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
        {
          teachers: window.firebase.arrayUnion(teacherUserId)
        }
      );
      
      // If admin, add to admins list
      if (teacherRole === 'admin') {
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
          {
            admins: window.firebase.arrayUnion(teacherUserId)
          }
        );
      }
      
      // Clear form and reload
      document.getElementById('teacherName').value = '';
      document.getElementById('teacherEmail').value = '';
      document.getElementById('teacherSubject').value = '';
      document.getElementById('teacherAdditionalSubjects').value = '';
      containers.addTeacherModal.classList.remove('active');
      loadTeachers();
      
    } catch (error) {
      console.error('Error adding teacher:', error);
      showAlert('addTeacherError', 'Error adding teacher. Please try again.', 'error');
    }
  }

  // Handle add student
  async function handleAddStudent(e) {
    e.preventDefault();
    
    const studentName = document.getElementById('studentName').value;
    const studentClass = document.getElementById('studentClass').value;
    
    try {
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'students'),
        {
          name: studentName,
          classId: studentClass,
          schoolId: currentSchool.id,
          createdAt: new Date(),
          createdBy: currentUser.uid
        }
      );
      
      // Clear form and reload
      document.getElementById('studentName').value = '';
      containers.addStudentModal.classList.remove('active');
      loadStudents();
      
    } catch (error) {
      console.error('Error adding student:', error);
      alert('Error adding student. Please try again.');
    }
  }

  // Handle assign subjects
  async function handleAssignSubjects(e) {
    e.preventDefault();
    
    const teacherId = document.getElementById('assignTeacherId').value;
    const checkboxes = document.querySelectorAll('#subjectCheckboxes input[type="checkbox"]:checked');
    const selectedSubjectIds = Array.from(checkboxes).map(cb => cb.value);
    
    try {
      // Get teacher data
      const teacherDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'users', teacherId)
      );
      
      if (!teacherDoc.exists()) {
        showAlert('assignSubjectsError', 'Teacher not found', 'error');
        return;
      }
      
      const teacherData = teacherDoc.data();
      
      // Get subject names from IDs
      const selectedSubjects = [];
      selectedSubjectIds.forEach(subjectId => {
        const subject = currentSubjects.find(s => s.id === subjectId);
        if (subject) {
          selectedSubjects.push(subject.name);
        }
      });
      
      // Update teacher's assigned subjects
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', teacherId),
        {
          assignedSubjects: selectedSubjects,
          updatedAt: new Date()
        }
      );
      
      showAlert('assignSubjectsSuccess', 'Subjects assigned successfully!', 'success');
      
      // Reload teachers after delay
      setTimeout(() => {
        containers.assignSubjectsModal.classList.remove('active');
        loadTeachers();
      }, 1500);
      
    } catch (error) {
      console.error('Error assigning subjects:', error);
      showAlert('assignSubjectsError', 'Error assigning subjects. Please try again.', 'error');
    }
  }

  // Open assign subjects modal
  window.openAssignSubjects = async function(teacherId) {
    const teacher = currentTeachers.find(t => t.id === teacherId);
    if (!teacher) return;
    
    document.getElementById('assignTeacherId').value = teacherId;
    document.getElementById('assignTeacherName').value = teacher.name;
    
    // Clear previous checkboxes
    const subjectCheckboxes = document.getElementById('subjectCheckboxes');
    subjectCheckboxes.innerHTML = '';
    
    // Create checkboxes for each subject
    currentSubjects.forEach(subject => {
      const isChecked = teacher.assignedSubjects && teacher.assignedSubjects.includes(subject.name);
      const checkbox = document.createElement('div');
      checkbox.className = 'form-group';
      checkbox.style.marginBottom = '8px';
      checkbox.innerHTML = `
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" value="${subject.id}" ${isChecked ? 'checked' : ''} 
                 style="margin-right: 10px;">
          ${subject.name}
        </label>
      `;
      subjectCheckboxes.appendChild(checkbox);
    });
    
    // Show modal
    containers.assignSubjectsModal.classList.add('active');
  };

  // Load classes
  async function loadClasses() {
    if (!currentSchool) return;
    
    try {
      const classesQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'classes'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(classesQuery);
      currentClasses = [];
      const classList = document.getElementById('classList');
      classList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('classesEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('classesEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const classData = {
          id: doc.id,
          ...doc.data()
        };
        currentClasses.push(classData);
        
        const classItem = document.createElement('div');
        classItem.className = 'list-item';
        classItem.innerHTML = `
          <h4>${classData.name}</h4>
          <p>Created: ${classData.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteClass('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        classList.appendChild(classItem);
      });
      
      // Update class selectors
      updateClassSelectors();
      
    } catch (error) {
      console.error('Error loading classes:', error);
    }
  }

  // Load students
  async function loadStudents() {
    if (!currentSchool) return;
    
    const classId = document.getElementById('studentClassSelect').value;
    
    try {
      let studentsQuery;
      if (classId) {
        studentsQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'students'),
          window.firebase.where('schoolId', '==', currentSchool.id),
          window.firebase.where('classId', '==', classId)
        );
      } else {
        studentsQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'students'),
          window.firebase.where('schoolId', '==', currentSchool.id)
        );
      }
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('studentsEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('studentsEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const studentData = {
          id: doc.id,
          ...doc.data()
        };
        currentStudents.push(studentData);
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <h4>${studentData.name}</h4>
          <p>Class: ${getClassName(studentData.classId)}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteStudent('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        studentList.appendChild(studentItem);
      });
      
    } catch (error) {
      console.error('Error loading students:', error);
    }
  }

  // Load subjects
  async function loadSubjects() {
    if (!currentSchool) return;
    
    try {
      const subjectsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'subjects'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(subjectsQuery);
      currentSubjects = [];
      const subjectsList = document.getElementById('subjectsList');
      subjectsList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('subjectsEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('subjectsEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const subjectData = {
          id: doc.id,
          ...doc.data()
        };
        currentSubjects.push(subjectData);
        
        const subjectItem = document.createElement('div');
        subjectItem.className = 'list-item';
        subjectItem.innerHTML = `
          <h4>${subjectData.name}</h4>
          <p>Created: ${subjectData.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
          ${currentUserData.role === 'admin' ? `
            <div class="item-actions">
              <button class="btn btn-danger btn-sm" onclick="deleteSubject('${doc.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          ` : ''}
        `;
        subjectsList.appendChild(subjectItem);
      });
      
    } catch (error) {
      console.error('Error loading subjects:', error);
    }
  }

  // Load teachers with new card structure
  async function loadTeachers() {
    if (!currentSchool) return;
    
    try {
      // Get all users in the school
      const usersQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'users'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(usersQuery);
      currentTeachers = [];
      const teacherList = document.getElementById('teacherList');
      teacherList.innerHTML = '';
      
      if (querySnapshot.empty) {
        document.getElementById('teachersEmptyState').classList.remove('d-none');
        return;
      }
      
      document.getElementById('teachersEmptyState').classList.add('d-none');
      
      querySnapshot.forEach(doc => {
        const teacherData = {
          id: doc.id,
          ...doc.data()
        };
        currentTeachers.push(teacherData);
        
        // Create teacher card with new structure
        const teacherCard = document.createElement('div');
        teacherCard.className = 'teacher-card';
        
        // Get initials for profile
        const initials = getInitials(teacherData.name || 'T');
        const profileUrl = teacherData.profileUrl || '';
        
        // Assigned subjects
        const assignedSubjects = teacherData.assignedSubjects || [teacherData.subject].filter(Boolean);
        const subjectsText = assignedSubjects.length > 0 
          ? `<p style="font-size: 13px; color: var(--gray-light); margin-top: 10px;"><strong>Subjects:</strong> ${assignedSubjects.join(', ')}</p>`
          : '<p style="font-size: 13px; color: var(--gray-light); margin-top: 10px;"><strong>Subjects:</strong> Not assigned</p>';
        
        // Admin actions
        const adminActions = currentUserData.role === 'admin' && teacherData.id !== currentUser.uid
          ? `
            <div class="item-actions" style="margin-top: 15px;">
              <button class="btn btn-info btn-sm" onclick="openAssignSubjects('${doc.id}')">
                <i class="fas fa-book"></i> Assign Subjects
              </button>
              <button class="btn btn-warning btn-sm" onclick="promoteTeacher('${doc.id}', '${teacherData.role}')">
                <i class="fas fa-user-shield"></i> ${teacherData.role === 'admin' ? 'Demote' : 'Make Admin'}
              </button>
              <button class="btn btn-danger btn-sm" onclick="removeTeacher('${doc.id}')">
                <i class="fas fa-user-minus"></i> Remove
              </button>
            </div>
          `
          : '';
        
        teacherCard.innerHTML = `
          <div class="teacher-header">
            <div class="teacher-profile-img">
              ${profileUrl ? 
                `<img src="${profileUrl}" alt="${teacherData.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='${initials}'">` : 
                initials}
            </div>
            <div class="teacher-details">
              <div class="teacher-role-badge ${teacherData.role}">
                ${teacherData.role === 'admin' ? 'ADMIN' : 'TEACHER'}
              </div>
              <div class="teacher-name">${teacherData.name}</div>
              <div class="teacher-email">${teacherData.email}</div>
            </div>
          </div>
          ${subjectsText}
          ${adminActions}
        `;
        teacherList.appendChild(teacherCard);
      });
      
    } catch (error) {
      console.error('Error loading teachers:', error);
    }
  }

  // Update class selectors
  function updateClassSelectors() {
    // Get all class selectors
    const selectors = [
      document.getElementById('studentClassSelect'),
      document.getElementById('marksClassSelect'),
      document.getElementById('reportClassSelect'),
      document.getElementById('analyticsClassSelect'),
      document.getElementById('studentClass')
    ];
    
    selectors.forEach(select => {
      if (!select) return;
      
      // Clear existing options except first
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Add classes
      currentClasses.forEach(classObj => {
        const option = document.createElement('option');
        option.value = classObj.id;
        option.textContent = classObj.name;
        select.appendChild(option);
      });
    });
  }

  // Get class name by ID
  function getClassName(classId) {
    const classObj = currentClasses.find(c => c.id === classId);
    return classObj ? classObj.name : 'Unknown Class';
  }

  // Setup marks tab - FIXED: Ensure dropdowns are visible
  function setupMarksTab() {
    // Show/hide based on permissions
    const isAdmin = currentUserData.role === 'admin';
    const canEnterMarks = isAdmin || currentUserData.subject;
    
    if (!canEnterMarks) {
      document.getElementById('marksEmptyState').classList.add('d-none');
      document.getElementById('marksEntrySection').classList.add('d-none');
      document.getElementById('marksPermissionNote').classList.remove('d-none');
      return;
    }
    
    document.getElementById('marksPermissionNote').classList.add('d-none');
    
    // Update class selector
    updateClassSelectors();
    
    // Show/hide subject filter for teachers
    const marksSubjectFilter = document.getElementById('marksSubjectFilter');
    if (!isAdmin && currentUserData.assignedSubjects) {
      marksSubjectFilter.style.display = 'block';
      updateMarksSubjectSelector();
    } else {
      marksSubjectFilter.style.display = 'none';
    }
    
    // Show empty state by default
    document.getElementById('marksEmptyState').classList.remove('d-none');
    document.getElementById('marksEntrySection').classList.add('d-none');
    
    // Ensure dropdowns are styled correctly
    setTimeout(() => {
      const dropdowns = document.querySelectorAll('#marksEntrySection select');
      dropdowns.forEach(dropdown => {
        dropdown.style.zIndex = '10';
        dropdown.style.position = 'relative';
      });
    }, 100);
  }

  // Update marks subject selector for teachers
  function updateMarksSubjectSelector() {
    const select = document.getElementById('marksSubjectSelect');
    if (!select) return;
    
    // Clear existing options
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    // Get teacher's assigned subjects
    const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
    
    // Add assigned subjects
    assignedSubjects.forEach(subjectName => {
      const option = document.createElement('option');
      option.value = subjectName;
      option.textContent = subjectName;
      select.appendChild(option);
    });
  }

  // Handle class select for marks - FIXED: Ensure proper display
  function handleClassSelectForMarks() {
    const classId = document.getElementById('marksClassSelect').value;
    const term = document.getElementById('termSelect').value;
    
    console.log('Class selected:', classId, 'Term selected:', term);
    
    if (classId && term) {
      loadStudentsForMarks(classId);
      document.getElementById('marksEmptyState').classList.add('d-none');
      document.getElementById('marksEntrySection').classList.remove('d-none');
    } else {
      document.getElementById('marksEmptyState').classList.remove('d-none');
      document.getElementById('marksEntrySection').classList.add('d-none');
    }
  }

  // Handle term select
  function handleTermSelect() {
    handleClassSelectForMarks();
  }

  // Handle subject select for marks
  function handleSubjectSelectForMarks() {
    generateMarkInputs();
  }

  // Load students for marks
  async function loadStudentsForMarks(classId) {
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        currentStudents.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      // Generate mark inputs
      generateMarkInputs();
      
    } catch (error) {
      console.error('Error loading students for marks:', error);
    }
  }

  // Handle student search
  function handleStudentSearch() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const classId = document.getElementById('marksClassSelect').value;
    
    // Show/hide clear button
    const clearBtn = document.getElementById('studentSearchClear');
    if (searchTerm.length > 0) {
      clearBtn.classList.add('show');
    } else {
      clearBtn.classList.remove('show');
    }
    
    if (!classId || searchTerm.length < 2) {
      document.getElementById('studentSuggestions').style.display = 'none';
      return;
    }
    
    const filteredStudents = currentStudents.filter(student => 
      student.name.toLowerCase().includes(searchTerm)
    );
    
    const suggestions = document.getElementById('studentSuggestions');
    suggestions.innerHTML = '';
    
    if (filteredStudents.length > 0) {
      filteredStudents.forEach(student => {
        const suggestion = document.createElement('div');
        suggestion.className = 'student-suggestion';
        suggestion.textContent = student.name;
        suggestion.addEventListener('click', () => {
          document.getElementById('studentSearch').value = student.name;
          selectedStudentId = student.id;
          document.getElementById('selectedStudentName').textContent = student.name;
          document.getElementById('selectedStudentInfo').classList.remove('d-none');
          document.getElementById('saveMarksBtn').disabled = false;
          suggestions.style.display = 'none';
          clearBtn.classList.add('show');
          loadStudentMarks(student.id);
        });
        suggestions.appendChild(suggestion);
      });
      suggestions.style.display = 'block';
    } else {
      suggestions.style.display = 'none';
    }
  }

  // Clear student search
  function clearStudentSearch() {
    document.getElementById('studentSearch').value = '';
    document.getElementById('studentSearchClear').classList.remove('show');
    document.getElementById('studentSuggestions').style.display = 'none';
    document.getElementById('selectedStudentInfo').classList.add('d-none');
    selectedStudentId = null;
    document.getElementById('saveMarksBtn').disabled = true;
  }

  // Generate mark inputs
  function generateMarkInputs() {
    const marksGrid = document.getElementById('marksGrid');
    marksGrid.innerHTML = '';
    
    const isAdmin = currentUserData.role === 'admin';
    const selectedSubject = document.getElementById('marksSubjectSelect')?.value;
    
    // Determine which subjects to show
    let subjectsToShow = currentSubjects;
    
    if (!isAdmin) {
      // Teachers only see their assigned subjects
      const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
      
      if (selectedSubject && selectedSubject !== '') {
        // Show only selected subject
        subjectsToShow = currentSubjects.filter(subject => 
          subject.name === selectedSubject
        );
      } else {
        // Show all assigned subjects
        subjectsToShow = currentSubjects.filter(subject => 
          assignedSubjects.includes(subject.name)
        );
      }
    }
    
    if (subjectsToShow.length === 0) {
      marksGrid.innerHTML = `
        <div class="alert info" style="grid-column: 1 / -1;">
          <i class="fas fa-info-circle"></i>
          <span>No subjects found for your teaching assignment.</span>
        </div>
      `;
      return;
    }
    
    subjectsToShow.forEach(subject => {
      const markInput = document.createElement('div');
      markInput.className = 'mark-input';
      markInput.innerHTML = `
        <label>${subject.name}</label>
        <input type="number" min="0" max="100" placeholder="0-100" 
               data-subject="${subject.id}" 
               oninput="validateMarkInput(this)">
      `;
      marksGrid.appendChild(markInput);
    });
  }

  // Validate mark input
  window.validateMarkInput = function(input) {
    let value = parseInt(input.value);
    if (isNaN(value)) {
      input.value = '';
      return;
    }
    if (value < 0) input.value = 0;
    if (value > 100) input.value = 100;
  };

  // Load student marks
  async function loadStudentMarks(studentId) {
    const term = document.getElementById('termSelect').value;
    
    try {
      const marksDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
      );
      
      if (marksDoc.exists()) {
        const marks = marksDoc.data();
        currentSubjects.forEach(subject => {
          const input = document.querySelector(`input[data-subject="${subject.id}"]`);
          if (input && marks[subject.id] !== undefined) {
            input.value = marks[subject.id];
          }
        });
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
  }

  // Handle save marks
  async function handleSaveMarks() {
    if (!selectedStudentId) {
      showMarksAlert('Please select a student first', 'error');
      return;
    }
    
    const term = document.getElementById('termSelect').value;
    if (!term) {
      showMarksAlert('Please select a term', 'error');
      return;
    }
    
    const marks = {};
    let hasMarks = false;
    
    // Collect marks
    document.querySelectorAll('.mark-input input').forEach(input => {
      const subjectId = input.dataset.subject;
      const value = parseInt(input.value);
      if (!isNaN(value) && value >= 0 && value <= 100) {
        marks[subjectId] = value;
        hasMarks = true;
      }
    });
    
    if (!hasMarks) {
      showMarksAlert('Please enter at least one mark', 'warning');
      return;
    }
    
    try {
      // Save marks
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${selectedStudentId}_${term}`),
        {
          studentId: selectedStudentId,
          schoolId: currentSchool.id,
          term: term,
          ...marks,
          updatedAt: new Date(),
          updatedBy: currentUser.uid
        }
      );
      
      showMarksAlert('Marks saved successfully!', 'success');
      
      // Reset form after delay
      setTimeout(() => {
        clearStudentSearch();
        document.querySelectorAll('.mark-input input').forEach(input => {
          input.value = '';
        });
      }, 2000);
      
    } catch (error) {
      console.error('Error saving marks:', error);
      showMarksAlert('Error saving marks', 'error');
    }
  }

  // Show marks alert
  function showMarksAlert(message, type) {
    const alert = document.getElementById('marksAlert');
    if (!alert) return;
    
    alert.className = `alert ${type}`;
    alert.querySelector('#marksAlertText').textContent = message;
    alert.classList.remove('d-none');
    
    setTimeout(() => {
      alert.classList.add('d-none');
    }, 3000);
  }

  // Setup reports tab
  function setupReportsTab() {
    const isAdmin = currentUserData.role === 'admin';
    
    if (isAdmin) {
      // Show admin reports
      document.getElementById('adminReportsSection').style.display = 'block';
      document.getElementById('teacherAnalyticsSection').style.display = 'none';
      
      // Update tab labels
      document.getElementById('desktopReportsLabel').textContent = 'Reports';
      document.getElementById('reportsTabLabel').textContent = 'Reports';
      
      updateClassSelectors();
      
      // Show/hide export buttons
      document.getElementById('exportPDFBtn').classList.remove('d-none');
      document.getElementById('exportExcelBtn').classList.remove('d-none');
    } else {
      // Show teacher analytics
      document.getElementById('adminReportsSection').style.display = 'none';
      document.getElementById('teacherAnalyticsSection').style.display = 'block';
      
      // Update tab labels
      document.getElementById('desktopReportsLabel').textContent = 'Analytics';
      document.getElementById('reportsTabLabel').textContent = 'Analytics';
      
      // Setup analytics filters
      setupAnalyticsFilters();
    }
  }

  // Setup analytics filters
  async function setupAnalyticsFilters() {
    updateClassSelectors();
    loadAnalyticsSubjects();
  }

  // Load analytics subjects
  function loadAnalyticsSubjects() {
    const subjectCheckboxesList = document.getElementById('subjectCheckboxesList');
    if (!subjectCheckboxesList) return;
    
    subjectCheckboxesList.innerHTML = '';
    
    // Get teacher's assigned subjects
    const assignedSubjects = currentUserData.assignedSubjects || [currentUserData.subject].filter(Boolean);
    
    if (assignedSubjects.length === 0) {
      subjectCheckboxesList.innerHTML = `
        <div class="alert info">
          <i class="fas fa-info-circle"></i>
          <span>No subjects assigned to you. Please contact your administrator.</span>
        </div>
      `;
      return;
    }
    
    // Create checkboxes for each assigned subject
    assignedSubjects.forEach(subjectName => {
      const checkbox = document.createElement('div');
      checkbox.className = 'subject-checkbox';
      checkbox.innerHTML = `
        <input type="checkbox" id="subject-${subjectName.replace(/\s+/g, '-')}" 
               value="${subjectName}" checked>
        <label for="subject-${subjectName.replace(/\s+/g, '-')}">${subjectName}</label>
      `;
      subjectCheckboxesList.appendChild(checkbox);
    });
  }

  // Select all subjects
  function selectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  }

  // Deselect all subjects
  function deselectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  }

  // Generate enhanced analytics
  async function generateEnhancedAnalytics() {
    const classId = document.getElementById('analyticsClassSelect').value;
    const term = document.getElementById('analyticsTermSelect').value;
    
    // Get selected subjects
    const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]:checked');
    const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedSubjects.length === 0) {
      alert('Please select at least one subject for analysis.');
      return;
    }
    
    try {
      // Get marks data
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      // Filter students by class if specified
      let filteredStudents = currentStudents;
      if (classId) {
        filteredStudents = currentStudents.filter(s => s.classId === classId);
      }
      
      // Calculate analytics for each selected subject
      const analyticsGrid = document.getElementById('analyticsGrid');
      analyticsGrid.innerHTML = '';
      
      const allGradeDistribution = {};
      const grades = currentSchool.level === 'primary' 
        ? ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
        : ['A', 'B', 'C', 'D', 'E', 'F'];
      
      // Initialize grade distribution
      grades.forEach(grade => {
        allGradeDistribution[grade] = 0;
      });
      
      let hasData = false;
      
      for (const subjectName of selectedSubjects) {
        const subject = currentSubjects.find(s => s.name === subjectName);
        if (!subject) continue;
        
        // Collect scores for this subject
        const scores = [];
        const studentScores = [];
        
        marksData.forEach(mark => {
          if (mark[subject.id] !== undefined) {
            const student = filteredStudents.find(s => s.id === mark.studentId);
            if (student) {
              const score = mark[subject.id];
              scores.push(score);
              
              studentScores.push({
                student: student.name,
                class: getClassName(student.classId),
                score: score,
                grade: calculateGrade(score, currentSchool.level)
              });
            }
          }
        });
        
        if (scores.length > 0) {
          hasData = true;
          
          // Calculate statistics
          const total = scores.reduce((a, b) => a + b, 0);
          const average = Math.round(total / scores.length);
          const highest = Math.max(...scores);
          const lowest = Math.min(...scores);
          
          // Calculate grade distribution
          const gradeDistribution = calculateGradeDistribution(scores, currentSchool.level);
          
          // Update overall grade distribution
          Object.keys(gradeDistribution).forEach(grade => {
            if (allGradeDistribution[grade] !== undefined) {
              allGradeDistribution[grade] += gradeDistribution[grade];
            }
          });
          
          // Calculate pass rate (assuming 40+ is pass)
          const passCount = scores.filter(score => score >= 40).length;
          const passRate = scores.length > 0 ? Math.round((passCount / scores.length) * 100) : 0;
          
          // Create analytics card
          const analyticsCard = document.createElement('div');
          analyticsCard.className = 'analytics-card';
          analyticsCard.innerHTML = `
            <h4>${subjectName}</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Average</p>
                <p style="font-size: 28px; font-weight: 800; color: var(--primary);">${average}</p>
              </div>
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Students</p>
                <p style="font-size: 28px; font-weight: 800; color: var(--primary);">${scores.length}</p>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Highest</p>
                <p style="font-size: 20px; font-weight: 600; color: var(--success);">${highest}</p>
              </div>
              <div>
                <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Lowest</p>
                <p style="font-size: 20px; font-weight: 600; color: var(--error);">${lowest}</p>
              </div>
            </div>
            <div style="margin-bottom: 20px;">
              <p style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 5px;">Pass Rate</p>
              <p style="font-size: 20px; font-weight: 600; color: ${passRate >= 70 ? 'var(--success)' : passRate >= 50 ? 'var(--warning)' : 'var(--error)'};">${passRate}%</p>
            </div>
            <h5 style="font-size: 14px; color: var(--gray-lighter); margin-bottom: 10px;">Grade Distribution</h5>
            <div class="grade-distribution">
              ${Object.entries(gradeDistribution).map(([grade, count]) => `
                <div class="grade-item">
                  <span>${grade}</span>
                  <span>${count}</span>
                </div>
              `).join('')}
            </div>
          `;
          
          analyticsGrid.appendChild(analyticsCard);
        }
      }
      
      if (hasData) {
        document.getElementById('analyticsEmptyState').classList.add('d-none');
        
        // Create grade distribution chart
        createGradeDistributionChart(allGradeDistribution);
        document.getElementById('gradeChartContainer').classList.remove('d-none');
      } else {
        document.getElementById('analyticsEmptyState').classList.remove('d-none');
        document.getElementById('gradeChartContainer').classList.add('d-none');
      }
      
    } catch (error) {
      console.error('Error generating analytics:', error);
      document.getElementById('analyticsEmptyState').classList.remove('d-none');
      document.getElementById('gradeChartContainer').classList.add('d-none');
    }
  }

  // Create grade distribution chart
  function createGradeDistributionChart(gradeDistribution) {
    const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
    
    // Destroy previous chart if exists
    if (gradeChart) {
      gradeChart.destroy();
    }
    
    const grades = Object.keys(gradeDistribution);
    const counts = Object.values(gradeDistribution);
    
    // Create gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(67, 97, 238, 0.8)');
    gradient.addColorStop(1, 'rgba(114, 9, 183, 0.2)');
    
    gradeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: grades,
        datasets: [{
          label: 'Number of Students',
          data: counts,
          backgroundColor: gradient,
          borderColor: 'rgba(67, 97, 238, 1)',
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              color: 'white',
              font: {
                size: 14
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: 'var(--primary)',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'white',
              font: {
                size: 12
              }
            },
            title: {
              display: true,
              text: 'Number of Students',
              color: 'white',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'white',
              font: {
                size: 12
              }
            },
            title: {
              display: true,
              text: 'Grades',
              color: 'white',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          }
        }
      }
    });
  }

  // Export subject analytics with Excel format matching template
  async function exportSubjectAnalytics() {
    try {
      const classId = document.getElementById('analyticsClassSelect').value;
      const term = document.getElementById('analyticsTermSelect').value;
      
      // Get selected subjects
      const checkboxes = document.querySelectorAll('#subjectCheckboxesList input[type="checkbox"]:checked');
      const selectedSubjects = Array.from(checkboxes).map(cb => cb.value);
      
      if (selectedSubjects.length === 0) {
        alert('Please select at least one subject for analysis.');
        return;
      }
      
      // Get marks data
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const marksData = [];
      
      marksSnapshot.forEach(doc => {
        marksData.push({ id: doc.id, ...doc.data() });
      });
      
      // Filter students by class if specified
      let filteredStudents = currentStudents;
      if (classId) {
        filteredStudents = currentStudents.filter(s => s.classId === classId);
      }
      
      // Create workbook with multiple sheets like template
      const wb = XLSX.utils.book_new();
      
      // Sheet 1: Performance Overview (like template)
      const overviewData = [
        ['P.6 Mathematics Performance Overview', '', '', '', '', ''],
        ['Generated:', new Date().toLocaleDateString(), '', '', '', ''],
        ['Teacher:', currentUserData.name, '', '', '', ''],
        ['School:', currentSchool.name, '', '', '', ''],
        ['Term:', document.getElementById('analyticsTermSelect').options[document.getElementById('analyticsTermSelect').selectedIndex].text, '', '', '', ''],
        ['', '', '', '', '', ''],
        ['RESULT SUMMARY', '', '', '', '', ''],
        ['Subject', 'Total Students', 'Highest Mark', 'Lowest Mark', 'Class Average', 'Pass Rate (%)']
      ];
      
      // Sheet 2: Student Performance
      const performanceData = [
        ['Student Name', 'Score', 'Grade']
      ];
      
      // Sheet 3: Grade Distribution Analysis
      const gradeDistributionData = [
        ['Grade Distribution Analysis', '', ''],
        ['Grade', 'Count', 'Percentage%']
      ];
      
      // Process each selected subject
      const allScores = [];
      const allGrades = [];
      
      for (const subjectName of selectedSubjects) {
        const subject = currentSubjects.find(s => s.name === subjectName);
        if (!subject) continue;
        
        // Collect scores for this subject
        const scores = [];
        const studentScores = [];
        
        marksData.forEach(mark => {
          if (mark[subject.id] !== undefined) {
            const student = filteredStudents.find(s => s.id === mark.studentId);
            if (student) {
              const score = mark[subject.id];
              scores.push(score);
              allScores.push(score);
              
              const grade = calculateGrade(score, currentSchool.level);
              allGrades.push(grade);
              
              studentScores.push({
                student: student.name,
                score: score,
                grade: grade
              });
            }
          }
        });
        
        if (scores.length > 0) {
          // Calculate statistics for overview
          const totalStudents = scores.length;
          const highest = Math.max(...scores);
          const lowest = Math.min(...scores);
          const average = Math.round(scores.reduce((a, b) => a + b) / scores.length);
          const passCount = scores.filter(score => score >= 40).length;
          const passRate = Math.round((passCount / scores.length) * 100);
          
          // Add to overview
          overviewData.push([
            subjectName,
            totalStudents,
            highest,
            lowest,
            average,
            `${passRate}%`
          ]);
          
          // Add student performance data
          studentScores.forEach(score => {
            performanceData.push([
              score.student,
              score.score,
              score.grade
            ]);
          });
          
          // Add separator between subjects
          performanceData.push(['', '', '']);
        }
      }
      
      // Calculate grade distribution
      const gradeDistribution = calculateGradeDistribution(allScores, currentSchool.level);
      const totalStudents = allScores.length;
      
      Object.entries(gradeDistribution).forEach(([grade, count]) => {
        const percentage = totalStudents > 0 ? Math.round((count / totalStudents) * 100) : 0;
        gradeDistributionData.push([
          grade,
          count,
          percentage
        ]);
      });
      
      // Create worksheets
      const overviewWs = XLSX.utils.aoa_to_sheet(overviewData);
      const performanceWs = XLSX.utils.aoa_to_sheet(performanceData);
      const gradeWs = XLSX.utils.aoa_to_sheet(gradeDistributionData);
      
      // Set column widths
      const colWidths = [
        { wch: 25 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 }
      ];
      
      overviewWs['!cols'] = colWidths;
      performanceWs['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }];
      gradeWs['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }];
      
      // Add worksheets to workbook
      XLSX.utils.book_append_sheet(wb, overviewWs, 'Performance Overview');
      XLSX.utils.book_append_sheet(wb, performanceWs, 'Student performance');
      XLSX.utils.book_append_sheet(wb, gradeWs, 'Grade Distribution Analysis');
      
      // Save the file with template-like name
      const fileName = `P6_Math_Term1_${new Date().getFullYear()}_GradeAnalysis_SkorePoint.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      alert(`Analytics exported successfully as ${fileName}`);
      
    } catch (error) {
      console.error('Error exporting subject analytics:', error);
      alert('Error exporting analytics. Please try again.');
    }
  }

  // Update report student select
  async function updateReportStudentSelect() {
    const classId = document.getElementById('reportClassSelect').value;
    const select = document.getElementById('reportStudentSelect');
    
    // Clear existing options
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    if (!classId) {
      select.disabled = true;
      return;
    }
    
    select.disabled = false;
    
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      
      querySnapshot.forEach(doc => {
        const student = { id: doc.id, ...doc.data() };
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        select.appendChild(option);
      });
      
    } catch (error) {
      console.error('Error loading students for reports:', error);
    }
  }

  // Generate report
  async function generateReport() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    try {
      // Get marks data
      let marksQuery;
      if (studentId) {
        // Specific student
        const marksDoc = await window.firebase.getDoc(
          window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
        );
        
        if (marksDoc.exists()) {
          await displayStudentReport(studentId, marksDoc.data());
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      } else if (classId) {
        // Whole class
        marksQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'marks'),
          window.firebase.where('schoolId', '==', currentSchool.id),
          window.firebase.where('term', '==', term)
        );
        
        const marksSnapshot = await window.firebase.getDocs(marksQuery);
        const classStudents = currentStudents.filter(s => s.classId === classId);
        const marksData = [];
        
        marksSnapshot.forEach(doc => {
          const mark = { id: doc.id, ...doc.data() };
          if (classStudents.find(s => s.id === mark.studentId)) {
            marksData.push(mark);
          }
        });
        
        if (marksData.length > 0) {
          await displayClassReport(classId, marksData);
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      } else {
        // All students
        marksQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'marks'),
          window.firebase.where('schoolId', '==', currentSchool.id),
          window.firebase.where('term', '==', term)
        );
        
        const marksSnapshot = await window.firebase.getDocs(marksQuery);
        const marksData = [];
        
        marksSnapshot.forEach(doc => {
          marksData.push({ id: doc.id, ...doc.data() });
        });
        
        if (marksData.length > 0) {
          await displaySchoolReport(marksData);
        } else {
          document.getElementById('reportsEmptyState').classList.remove('d-none');
          document.getElementById('reportPreview').classList.add('d-none');
          document.getElementById('statsGrid').classList.add('d-none');
        }
      }
      
    } catch (error) {
      console.error('Error generating report:', error);
    }
  }

  // Display student report - UPDATED to match template
  async function displayStudentReport(studentId, marks) {
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) return;
    
    const classObj = currentClasses.find(c => c.id === student.classId);
    const term = document.getElementById('reportTermSelect').value;
    const currentTerm = getCurrentTerm();
    const reportTitle = getReportTitle(currentTerm, term);
    
    // Calculate statistics
    let totalMarks = 0;
    let subjectCount = 0;
    const subjectScores = [];
    
    // Filter out subjects with no marks
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        totalMarks += score;
        subjectCount++;
        subjectScores.push({
          name: subject.name,
          score: score,
          grade: calculateGrade(score, currentSchool.level)
        });
      }
    });
    
    const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
    const aggregate = calculateAggregate(marks);
    const division = calculateDivision(average, aggregate);
    
    // Generate report card HTML matching the template
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 28px; font-weight: 800; color: #4361ee; letter-spacing: 2px; margin-bottom: 5px;">Skore Point</div>
          <div style="font-size: 12px; color: #666; margin-bottom: 15px;">A product of SERUSOFT</div>
          <div class="school-name">${currentSchool.name.toUpperCase()}</div>
          <div class="report-title">${reportTitle.toUpperCase()}</div>
        </div>
      </div>
      
      <div class="student-info-grid">
        <div class="student-info-item">
          <span class="student-info-label">Student Name:</span>
          <span class="student-info-value">${student.name.toUpperCase()}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Class:</span>
          <span class="student-info-value">${classObj ? classObj.name.toUpperCase() : 'N/A'}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Date:</span>
          <span class="student-info-value">${new Date().toLocaleDateString()}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">School Level:</span>
          <span class="student-info-value">${currentSchool.level === 'primary' ? 'PRIMARY' : 'SECONDARY'}</span>
        </div>
      </div>
      
      ${subjectScores.length > 0 ? `
        <table class="marks-table">
          <thead>
            <tr>
              <th>SUBJECT</th>
              <th>SCORE</th>
              <th>GRADE</th>
            </tr>
          </thead>
          <tbody>
            ${subjectScores.map(score => `
              <tr>
                <td>${score.name.toUpperCase()}</td>
                <td style="text-align: center; font-weight: 600;">${score.score}</td>
                <td style="text-align: center; font-weight: 600;">${score.grade}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<p class="text-center" style="color: #666; margin: 20px 0;">No marks entered for this student.</p>'}
      
      ${subjectCount > 0 ? `
        <table class="summary-table">
          <thead>
            <tr>
              <th>TOTAL MARKS</th>
              <th>AVERAGE MARK</th>
              <th>AGGREGATES</th>
              <th>FINAL GRADE/DIVISION</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${totalMarks}</td>
              <td>${average}</td>
              <td>${aggregate}</td>
              <td>${division}</td>
            </tr>
          </tbody>
        </table>
      ` : ''}
      
      <div style="margin-top: 30px;">
        <div style="margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 5px;">Class Teacher's Remarks:</div>
          <div style="border-top: 1px solid #333; height: 40px; margin-top: 5px;"></div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 5px;">Head Teacher's Remarks:</div>
          <div style="border-top: 1px solid #333; height: 40px; margin-top: 5px;"></div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 5px;">Next Term Begins On:</div>
          <div style="border-top: 1px solid #333; height: 30px; margin-top: 5px;"></div>
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-between; margin-top: 40px; padding-top: 20px; border-top: 2px solid #4361ee;">
        <div style="text-align: center; flex: 1;">
          <div style="border-top: 1px solid #333; width: 80%; margin: 0 auto 10px;"></div>
          <div style="font-weight: 600;">Class Teacher Signature</div>
        </div>
        
        <div style="text-align: center; flex: 1;">
          <div style="border-top: 1px solid #333; width: 80%; margin: 0 auto 10px;"></div>
          <div style="font-weight: 600;">Head Teacher Signature</div>
        </div>
        
        <div style="text-align: center; flex: 1;">
          <div style="width: 80px; height: 80px; border: 2px dashed #666; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
            <span style="color: #666;">School Stamp</span>
          </div>
          <div style="font-weight: 600;">School Stamp</div>
        </div>
      </div>
    `;
    
    // Update statistics
    document.getElementById('statTotalStudents').textContent = '1';
    document.getElementById('statAvgScore').textContent = average;
    document.getElementById('statHighScore').textContent = Math.max(...subjectScores.map(s => s.score));
    document.getElementById('statLowScore').textContent = Math.min(...subjectScores.map(s => s.score));
    
    // Show report
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
    document.getElementById('exportPDFBtn').classList.remove('d-none');
  }

  // Display class report
  async function displayClassReport(classId, marksData) {
    const classObj = currentClasses.find(c => c.id === classId);
    const students = currentStudents.filter(s => s.classId === classId);
    
    // Calculate statistics
    const studentAverages = [];
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        studentAverages.push(total / count);
      }
    });
    
    const totalStudents = students.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    // Generate summary report
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 28px; font-weight: 800; color: #4361ee; letter-spacing: 2px; margin-bottom: 5px;">Skore Point</div>
          <div style="font-size: 12px; color: #666; margin-bottom: 15px;">A product of SERUSOFT</div>
          <div class="school-name">${currentSchool.name}</div>
          <div class="report-title">CLASS PERFORMANCE SUMMARY</div>
        </div>
      </div>
      
      <div class="student-info-grid">
        <div class="student-info-item">
          <span class="student-info-label">Class:</span>
          <span class="student-info-value">${classObj ? classObj.name : 'N/A'}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Total Students:</span>
          <span class="student-info-value">${totalStudents}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Term:</span>
          <span class="student-info-value">${document.getElementById('reportTermSelect').options[document.getElementById('reportTermSelect').selectedIndex].text}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Date:</span>
          <span class="student-info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">Performance Statistics</h4>
      <table class="marks-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Class Average</td>
            <td style="text-align: center;">${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td style="text-align: center;">${highScore}%</td>
            <td>Excellent</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td style="text-align: center;">${lowScore}%</td>
            <td>Needs Improvement</td>
          </tr>
          <tr>
            <td>Students with Marks</td>
            <td style="text-align: center;">${studentAverages.length}</td>
            <td>${studentAverages.length}/${totalStudents} students</td>
          </tr>
        </tbody>
      </table>
      
      <div style="margin-top: 30px;">
        <div style="font-weight: 600; margin-bottom: 5px;">Class Teacher's Remarks:</div>
        <div style="border-top: 1px solid #333; height: 40px; margin-top: 5px;"></div>
        <div style="border-top: 1px solid #333; height: 40px; margin-top: 5px;"></div>
      </div>
    `;
    
    // Update statistics
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
    
    // Show report
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
    document.getElementById('exportPDFBtn').classList.add('d-none');
  }

  // Display school report
  async function displaySchoolReport(marksData) {
    // Calculate school-wide statistics
    const studentAverages = [];
    const classAverages = {};
    
    // Group by class
    currentClasses.forEach(classObj => {
      classAverages[classObj.id] = [];
    });
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        const average = total / count;
        studentAverages.push(average);
        
        // Add to class average
        const student = currentStudents.find(s => s.id === mark.studentId);
        if (student && classAverages[student.classId]) {
          classAverages[student.classId].push(average);
        }
      }
    });
    
    // Calculate statistics
    const totalStudents = currentStudents.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    // Generate school report
    const enhancedReportCard = document.getElementById('enhancedReportCard');
    enhancedReportCard.innerHTML = `
      <div class="report-header">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 28px; font-weight: 800; color: #4361ee; letter-spacing: 2px; margin-bottom: 5px;">Skore Point</div>
          <div style="font-size: 12px; color: #666; margin-bottom: 15px;">A product of SERUSOFT</div>
          <div class="school-name">${currentSchool.name}</div>
          <div class="report-title">SCHOOL PERFORMANCE REPORT</div>
        </div>
      </div>
      
      <div class="student-info-grid">
        <div class="student-info-item">
          <span class="student-info-label">School Level:</span>
          <span class="student-info-value">${currentSchool.level === 'primary' ? 'Primary School' : 'Secondary School'}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Total Students:</span>
          <span class="student-info-value">${totalStudents}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Term:</span>
          <span class="student-info-value">${document.getElementById('reportTermSelect').options[document.getElementById('reportTermSelect').selectedIndex].text}</span>
        </div>
        <div class="student-info-item">
          <span class="student-info-label">Date:</span>
          <span class="student-info-value">${new Date().toLocaleDateString()}</span>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">School Statistics</h4>
      <table class="marks-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>School Average</td>
            <td style="text-align: center;">${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td style="text-align: center;">${highScore}%</td>
            <td>Outstanding</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td style="text-align: center;">${lowScore}%</td>
            <td>Needs Attention</td>
          </tr>
          <tr>
            <td>Students Assessed</td>
            <td style="text-align: center;">${studentAverages.length}</td>
            <td>${studentAverages.length}/${totalStudents} students</td>
          </tr>
        </tbody>
      </table>
      
      <h4 style="margin: 30px 0 10px; color: #4361ee;">Class Performance</h4>
      <table class="marks-table">
        <thead>
          <tr>
            <th>CLASS</th>
            <th>AVERAGE SCORE</th>
            <th>STUDENTS ASSESSED</th>
            <th>PERFORMANCE</th>
          </tr>
        </thead>
        <tbody>
          ${currentClasses.map(classObj => {
            const averages = classAverages[classObj.id] || [];
            const classAverage = averages.length > 0 ? Math.round(averages.reduce((a, b) => a + b) / averages.length) : 0;
            const classStudents = currentStudents.filter(s => s.classId === classObj.id).length;
            return `
              <tr>
                <td>${classObj.name}</td>
                <td style="text-align: center;">${classAverage}%</td>
                <td style="text-align: center;">${averages.length}/${classStudents}</td>
                <td>${getPerformanceRemarks(classAverage)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      
      <div style="margin-top: 30px;">
        <div style="font-weight: 600; margin-bottom: 5px;">Head Teacher's Remarks:</div>
        <div style="border-top: 1px solid #333; height: 40px; margin-top: 5px;"></div>
      </div>
    `;
    
    // Update statistics
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
    
    // Show report
    document.getElementById('reportsEmptyState').classList.add('d-none');
    document.getElementById('reportPreview').classList.remove('d-none');
    document.getElementById('statsGrid').classList.remove('d-none');
    document.getElementById('exportPDFBtn').classList.add('d-none');
  }

  // Export report card as PDF - UPDATED to match template
  async function exportReportCard() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Set default font
    doc.setFont('helvetica');
    
    // Add Skore Point logo and school name - matching template
    doc.setFontSize(24);
    doc.setTextColor(67, 97, 238);
    doc.text('Skore Point', 105, 15, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('A product of SERUSOFT', 105, 22, { align: 'center' });
    
    doc.setFontSize(16);
    doc.setTextColor(0, 0, 0);
    doc.text(currentSchool.name.toUpperCase(), 105, 32, { align: 'center' });
    
    // Get report title
    const term = document.getElementById('reportTermSelect').value;
    const currentTerm = getCurrentTerm();
    const reportTitle = getReportTitle(currentTerm, term);
    doc.setFontSize(14);
    doc.text(reportTitle.toUpperCase(), 105, 42, { align: 'center' });
    
    // Get student info
    const studentId = document.getElementById('reportStudentSelect').value;
    const student = currentStudents.find(s => s.id === studentId);
    const classObj = currentClasses.find(c => c.id === student.classId);
    
    // Student information in grid format
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Student Name:', 20, 60);
    doc.text('Class:', 20, 68);
    doc.text('Date:', 110, 60);
    doc.text('School Level:', 110, 68);
    
    doc.setFont(undefined, 'normal');
    doc.text(student.name.toUpperCase(), 55, 60);
    doc.text(classObj ? classObj.name.toUpperCase() : 'N/A', 40, 68);
    doc.text(new Date().toLocaleDateString(), 130, 60);
    doc.text(currentSchool.level === 'primary' ? 'PRIMARY' : 'SECONDARY', 145, 68);
    
    // Get marks data
    const marksDoc = await window.firebase.getDoc(
      window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
    );
    
    if (marksDoc.exists()) {
      const marks = marksDoc.data();
      
      // Prepare table data
      const tableData = [];
      let totalMarks = 0;
      let subjectCount = 0;
      
      currentSubjects.forEach(subject => {
        const score = marks[subject.id];
        if (score !== undefined && score > 0) {
          const grade = calculateGrade(score, currentSchool.level);
          tableData.push([subject.name.toUpperCase(), score.toString(), grade]);
          totalMarks += score;
          subjectCount++;
        }
      });
      
      if (tableData.length > 0) {
        // Add subjects table
        doc.autoTable({
          startY: 75,
          head: [['SUBJECT', 'SCORE', 'GRADE']],
          body: tableData,
          theme: 'grid',
          headStyles: { 
            fillColor: [240, 240, 240],
            textColor: [0, 0, 0],
            fontStyle: 'bold'
          },
          columnStyles: {
            0: { cellWidth: 100 },
            1: { cellWidth: 45, halign: 'center' },
            2: { cellWidth: 45, halign: 'center' }
          }
        });
        
        const finalY = doc.lastAutoTable.finalY + 10;
        
        // Calculate statistics
        const average = Math.round(totalMarks / subjectCount);
        const aggregate = calculateAggregate(marks);
        const division = calculateDivision(average, aggregate);
        
        // Add summary table with styling like template
        const summaryData = [
          ['TOTAL MARKS', 'AVERAGE MARK', 'AGGREGATES', 'FINAL GRADE/DIVISION'],
          [totalMarks.toString(), average.toString(), aggregate.toString(), division]
        ];
        
        doc.autoTable({
          startY: finalY,
          head: [summaryData[0]],
          body: [summaryData[1]],
          theme: 'grid',
          headStyles: { 
            fillColor: [67, 97, 238],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
          },
          bodyStyles: { 
            textColor: [0, 0, 0],
            fontStyle: 'bold',
            halign: 'center'
          },
          columnStyles: {
            0: { cellWidth: 45, halign: 'center' },
            1: { cellWidth: 45, halign: 'center' },
            2: { cellWidth: 45, halign: 'center' },
            3: { cellWidth: 55, halign: 'center' }
          }
        });
        
        const summaryEndY = doc.lastAutoTable.finalY + 15;
        
        // Add remarks section
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Class Teacher\'s Remarks:', 20, summaryEndY);
        doc.line(20, summaryEndY + 5, 90, summaryEndY + 5);
        doc.line(20, summaryEndY + 10, 90, summaryEndY + 10);
        
        doc.text('Head Teacher\'s Remarks:', 20, summaryEndY + 25);
        doc.line(20, summaryEndY + 30, 90, summaryEndY + 30);
        
        doc.text('Next Term Begins On:', 20, summaryEndY + 45);
        doc.line(20, summaryEndY + 50, 90, summaryEndY + 50);
        
        // Add signature lines
        const signatureY = summaryEndY + 70;
        doc.line(25, signatureY, 65, signatureY);
        doc.text('Class Teacher Signature', 45, signatureY + 10, { align: 'center' });
        
        doc.line(75, signatureY, 115, signatureY);
        doc.text('Head Teacher Signature', 95, signatureY + 10, { align: 'center' });
        
        // Add school stamp
        doc.rect(140, signatureY - 5, 40, 20);
        doc.text('School Stamp', 160, signatureY + 10, { align: 'center' });
      }
    }
    
    // Save the PDF
    doc.save(`Report_Card_${student.name.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
  }

  // Export class analysis as Excel
  function exportClassAnalysis() {
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Create worksheet data
    const wsData = [
      ['Class Analysis Report'],
      ['School:', currentSchool.name],
      ['Date:', new Date().toLocaleDateString()],
      [],
      ['Student Name', 'Class', 'Average Score', 'Grade', 'Remarks']
    ];
    
    // Add student data
    currentStudents.forEach(student => {
      const classObj = currentClasses.find(c => c.id === student.classId);
      wsData.push([
        student.name,
        classObj ? classObj.name : 'N/A',
        'N/A',
        'N/A',
        'No marks entered'
      ]);
    });
    
    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Class Analysis');
    
    // Save the file
    XLSX.writeFile(wb, `Class_Analysis_${currentSchool.name}_${new Date().toISOString().slice(0, 10)}.xlsx`);
  }

  // Calculate grade
  function calculateGrade(score, level) {
    if (level === 'primary') {
      if (score >= 90) return 'D1';
      if (score >= 80) return 'D2';
      if (score >= 70) return 'C3';
      if (score >= 60) return 'C4';
      if (score >= 50) return 'C5';
      if (score >= 40) return 'C6';
      if (score >= 30) return 'P7';
      if (score >= 20) return 'P8';
      return 'F9';
    } else {
      if (score >= 80) return 'A';
      if (score >= 70) return 'B';
      if (score >= 60) return 'C';
      if (score >= 50) return 'D';
      if (score >= 40) return 'E';
      return 'F';
    }
  }

  // Calculate aggregate
  function calculateAggregate(marks) {
    let totalPoints = 0;
    let subjectCount = 0;
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        const grade = calculateGrade(score, currentSchool.level);
        const gradePoints = APP_CONFIG.gradePoints[currentSchool.level][grade] || 9;
        totalPoints += gradePoints;
        subjectCount++;
      }
    });
    
    return subjectCount > 0 ? totalPoints : 0;
  }

  // Calculate division
  function calculateDivision(average, aggregate) {
    if (currentSchool.level === 'primary') {
      if (aggregate <= 12) return 'Division 1';
      if (aggregate <= 24) return 'Division 2';
      if (aggregate <= 36) return 'Division 3';
      return 'Division 4';
    } else {
      if (average >= 80) return 'Division 1';
      if (average >= 60) return 'Division 2';
      if (average >= 40) return 'Division 3';
      return 'Division 4';
    }
  }

  // Calculate grade distribution
  function calculateGradeDistribution(scores, level) {
    const distribution = {};
    
    // Initialize grade counts
    const grades = level === 'primary' 
      ? ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9']
      : ['A', 'B', 'C', 'D', 'E', 'F'];
    
    grades.forEach(grade => {
      distribution[grade] = 0;
    });
    
    // Count grades
    scores.forEach(score => {
      const grade = calculateGrade(score, level);
      if (distribution[grade] !== undefined) {
        distribution[grade]++;
      }
    });
    
    return distribution;
  }

  // Get current term
  function getCurrentTerm() {
    const now = new Date();
    const month = now.getMonth() + 1;
    
    if (month >= 2 && month <= 4) return 1;
    if (month >= 5 && month <= 8) return 2;
    return 3;
  }

  // Get report title
  function getReportTitle(currentTerm, reportType) {
    const termText = `TERM ${currentTerm}`;
    
    switch(reportType) {
      case 'beginning': return `BEGINNING OF ${termText} STUDENT PROGRESS REPORT`;
      case 'mid': return `MID ${termText} STUDENT PROGRESS REPORT`;
      case 'end': return `END OF ${termText} STUDENT PROGRESS REPORT`;
      default: return `STUDENT PROGRESS REPORT`;
    }
  }

  // Get performance remarks
  function getPerformanceRemarks(average) {
    if (average >= 80) return 'Excellent';
    if (average >= 70) return 'Very Good';
    if (average >= 60) return 'Good';
    if (average >= 50) return 'Satisfactory';
    if (average >= 40) return 'Fair';
    return 'Needs Improvement';
  }

  // Generate school code
  function generateSchoolCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Open school portal - FIXED: Ensure portal exit buttons only show when portal is open
  function openSchoolPortal() {
    isSchoolPortalOpen = true;
    
    // Update management section
    document.getElementById('managementSchoolName').textContent = currentSchool.name;
    document.getElementById('managementSchoolCode').textContent = currentSchool.code;
    
    // Update school logo in management section
    if (currentSchool.logoUrl) {
      const managementLogo = document.getElementById('managementSchoolLogo');
      managementLogo.src = currentSchool.logoUrl;
      managementLogo.style.display = 'block';
      managementLogo.onerror = () => {
        managementLogo.style.display = 'none';
      };
    }
    
    // Show mobile bottom nav on mobile ONLY when portal is open
    if (isMobileView) {
      containers.mobileBottomNav.style.display = 'flex';
      containers.mobileBottomNav.classList.add('active');
      containers.mobileExitBtn.classList.add('active');
    } else {
      document.getElementById('portalExitBtn').classList.remove('d-none');
    }
    
    // Show management section
    showContainer('schoolManagementSection');
    
    // Update permissions
    updatePermissions();
    
    // Load initial tab data
    loadClasses();
    
    // Set first tab as active for mobile
    if (isMobileView) {
      document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
      const firstTab = document.querySelector('.mobile-nav-item[data-tab="classes"]');
      if (firstTab) {
        firstTab.classList.add('active');
      }
    }
    
    console.log('School portal opened');
  }

  // Close school portal - FIXED: Ensure portal exit buttons are hidden
  function closeSchoolPortal() {
    isSchoolPortalOpen = false;
    
    // Hide mobile bottom nav
    containers.mobileBottomNav.style.display = 'none';
    containers.mobileBottomNav.classList.remove('active');
    containers.mobileExitBtn.classList.remove('active');
    
    // Hide portal exit button
    document.getElementById('portalExitBtn').classList.add('d-none');
    
    // Show dashboard
    showContainer('dashboardSection');
    
    console.log('School portal closed');
  }

  // Update permissions
  function updatePermissions() {
    const isAdmin = currentUserData.role === 'admin';
    
    // Show/hide add buttons
    const addButtons = ['addClassBtn', 'addSubjectBtn', 'addTeacherBtn', 'addStudentBtn'];
    addButtons.forEach(btnId => {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.style.display = isAdmin ? 'block' : 'none';
      }
    });
    
    // Show/hide student upload container
    document.getElementById('studentUploadContainer').style.display = isAdmin ? 'block' : 'none';
    
    // Show/hide permission notes
    const permissionNotes = {
      classPermissionNote: !isAdmin,
      studentPermissionNote: !isAdmin,
      subjectPermissionNote: !isAdmin,
      teacherPermissionNote: !isAdmin,
      marksPermissionNote: !isAdmin && currentUserData.subject,
      reportPermissionNote: !isAdmin
    };
    
    Object.entries(permissionNotes).forEach(([id, show]) => {
      const note = document.getElementById(id);
      if (note) {
        note.classList.toggle('d-none', !show);
      }
    });
    
    // Update tabs visibility based on role
    const managementTabs = document.getElementById('managementTabs');
    if (isAdmin) {
      managementTabs.classList.remove('d-none');
      
      // Update mobile bottom nav for admin
      if (isMobileView) {
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
          item.style.display = 'flex';
        });
      }
    } else {
      // Teachers only see marks and reports tabs on desktop
      const tabs = managementTabs.querySelectorAll('.tab');
      tabs.forEach(tab => {
        const tabId = tab.dataset.tab;
        if (tabId === 'marks' || tabId === 'reports') {
          tab.style.display = 'block';
        } else {
          tab.style.display = 'none';
        }
      });
      
      // Teachers on mobile only see marks and analytics tabs
      if (isMobileView) {
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
          const tabId = item.dataset.tab;
          if (tabId === 'marks' || tabId === 'reports') {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
        
        // Update reports tab label for teachers
        document.getElementById('reportsTabLabel').textContent = 'Analytics';
      }
    }
  }

  // Show user guide
  function showUserGuide() {
    alert(`Skore Point User Guide

GETTING STARTED:
1. Create a user account with your profile picture
2. Join an existing school or register a new one
3. Access the school portal to manage your data

ADMIN PRIVILEGES:
 Create and manage school
 Add/edit/delete classes
 Add/edit/delete subjects
 Add/remove teachers
 Assign subjects to teachers
 Promote teachers to admin
 Export reports and report cards

TEACHER PRIVILEGES:
 View assigned classes
 Enter marks for assigned subjects
 View student information (read-only)
 View subject analytics and export Excel reports

ENHANCED TEACHER ANALYTICS:
 Select specific classes for analysis
 Choose beginning, mid, or end term
 Select specific subjects for analysis
 View grade distribution bar charts
 Export enhanced Excel reports with 4 sheets:
  1. Executive Summary
  2. Detailed Scores
  3. Grade Analysis
  4. Performance Trends

MOBILE FEATURES:
 Mobile-optimized interface
 Logout button in profile card (mobile)
 Mobile exit button in bottom nav (teachers)
 Professional mobile dashboard cards
 Touch-friendly controls
 Smooth scrolling to relevant sections

PWA FEATURES:
 Install as a native app
 Offline functionality
 Fast loading
 Add to home screen

KEY IMPROVEMENTS:
 Fixed top navigation bar for mobile
 Mobile logout moved to profile card
 Mobile exit button added to bottom nav
 Teachers can select subjects for marks entry
 Enhanced analytics with grade distribution charts
 Improved Excel export with 4 structured sheets
 Teachers can filter analytics by class and term
 Clean, professional mobile interface
 PWA support for offline use
 Smooth scrolling to relevant sections on mobile

SUPPORT:
For assistance, contact your school administrator or visit the help section.`);
  }

  // Handle logout
  async function handleLogout() {
    try {
      await window.firebase.signOut(window.firebase.auth);
      currentUser = null;
      currentUserData = null;
      currentSchool = null;
      isSchoolPortalOpen = false;
      containers.mobileBottomNav.style.display = 'none';
      containers.mobileBottomNav.classList.remove('active');
      containers.mobileExitBtn.classList.remove('active');
      document.getElementById('portalExitBtn').classList.add('d-none');
      showContainer('loginSection');
    } catch (error) {
      console.error('Error signing out:', error);
      alert('Error signing out. Please try again.');
    }
  }

  // Utility functions
  function showContainer(containerId) {
    // Hide all containers
    document.querySelectorAll('.container').forEach(container => {
      container.classList.remove('active');
    });
    
    // Hide full screen forms
    document.querySelectorAll('.full-screen-form').forEach(form => {
      form.classList.remove('active');
    });
    
    // Show the requested container
    const container = containers[containerId];
    if (container && container.classList) {
      container.classList.add('active');
    }
  }

  function hideLaunchScreen() {
    containers.launchScreen.style.display = 'none';
  }

  function showLoading(id) {
    const loading = document.getElementById(id);
    if (loading) loading.classList.remove('d-none');
  }

  function hideLoading(id) {
    const loading = document.getElementById(id);
    if (loading) loading.classList.add('d-none');
  }

  function showAlert(id, message, type) {
    const alert = document.getElementById(id);
    if (!alert) return;
    
    alert.className = `alert ${type}`;
    const textElement = alert.querySelector(`#${id}Text`);
    if (textElement) {
      textElement.textContent = message;
    }
    alert.classList.remove('d-none');
  }

  function hideAlert(id) {
    const alert = document.getElementById(id);
    if (alert) alert.classList.add('d-none');
  }

  // Global functions for button clicks
  window.deleteClass = async function(classId) {
    if (confirm('Are you sure you want to delete this class? All students in this class will also be deleted.')) {
      try {
        // Delete students in this class first
        const studentsQuery = window.firebase.query(
          window.firebase.collection(window.firebase.db, 'students'),
          window.firebase.where('classId', '==', classId)
        );
        
        const studentsSnapshot = await window.firebase.getDocs(studentsQuery);
        const deletePromises = [];
        
        studentsSnapshot.forEach(doc => {
          deletePromises.push(window.firebase.deleteDoc(doc.ref));
        });
        
        await Promise.all(deletePromises);
        
        // Delete the class
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'classes', classId)
        );
        
        loadClasses();
        
      } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please try again.');
      }
    }
  };

  window.deleteStudent = async function(studentId) {
    if (confirm('Are you sure you want to delete this student?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'students', studentId)
        );
        loadStudents();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student. Please try again.');
      }
    }
  };

  window.deleteSubject = async function(subjectId) {
    if (confirm('Are you sure you want to delete this subject?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'subjects', subjectId)
        );
        loadSubjects();
      } catch (error) {
        console.error('Error deleting subject:', error);
        alert('Error deleting subject. Please try again.');
      }
    }
  };

  window.promoteTeacher = async function(teacherId, currentRole) {
    const newRole = currentRole === 'admin' ? 'teacher' : 'admin';
    const action = currentRole === 'admin' ? 'demote from admin' : 'promote to admin';
    
    if (confirm(`Are you sure you want to ${action} this teacher?`)) {
      try {
        // Update teacher's role
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', teacherId),
          {
            role: newRole
          }
        );
        
        // Update school's admin list
        if (newRole === 'admin') {
          await window.firebase.updateDoc(
            window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
            {
              admins: window.firebase.arrayUnion(teacherId)
            }
          );
        } else {
          await window.firebase.updateDoc(
            window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
            {
              admins: window.firebase.arrayRemove(teacherId)
            }
          );
        }
        
        loadTeachers();
        
      } catch (error) {
        console.error(`Error ${action} teacher:`, error);
        alert(`Error ${action} teacher. Please try again.`);
      }
    }
  };

  window.removeTeacher = async function(teacherId) {
    if (confirm('Are you sure you want to remove this teacher from the school?')) {
      try {
        // Update teacher's school
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'users', teacherId),
          {
            schoolId: null,
            role: 'teacher'
          }
        );
        
        // Remove from school's lists
        await window.firebase.updateDoc(
          window.firebase.doc(window.firebase.db, 'schools', currentSchool.id),
          {
            teachers: window.firebase.arrayRemove(teacherId),
            admins: window.firebase.arrayRemove(teacherId)
          }
        );
        
        loadTeachers();
        
      } catch (error) {
        console.error('Error removing teacher:', error);
        alert('Error removing teacher. Please try again.');
      }
    }
  };
</script>
</body>
</html>

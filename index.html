<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skore Point | School Report Card Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      query, 
      where, 
      doc, 
      setDoc,
      getDoc,
      updateDoc,
      deleteDoc,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { 
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyASIdYdW94ZJQXsc6BN9Bc28eou0yjPE1U",
      authDomain: "upgrade-16092.firebaseapp.com",
      projectId: "upgrade-16092",
      storageBucket: "upgrade-16092.firebasestorage.app",
      messagingSenderId: "466381827996",
      appId: "1:466381827996:web:6f030e68c526e734a26259",
      measurementId: "G-RGCH68RJ8H"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Make Firebase available globally
    window.firebase = { 
      auth, 
      db, 
      storage,
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged, 
      updateProfile,
      collection, 
      addDoc, 
      getDocs, 
      query, 
      where, 
      doc, 
      setDoc, 
      getDoc, 
      updateDoc,
      deleteDoc,
      arrayUnion,
      ref,
      uploadBytes,
      getDownloadURL
    };
  </script>

  <style>
    /* All the CSS styles remain exactly the same as in the original code */
    /* ... (all CSS styles from the original code) ... */
  </style>
</head>
<body>
  <!-- LAUNCH SCREEN -->
  <div class="launch-screen" id="launchScreen">
    <!-- Floating particles -->
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <!-- Orbit circles -->
    <div class="orbit">
      <div class="orbit-circle"></div>
      <div class="orbit-circle"></div>
      <div class="orbit-circle"></div>
    </div>

    <!-- Main content -->
    <div class="launch-container">
      <div class="logo-wrapper">
        <div class="logo">
          <span>S</span><span>k</span><span>o</span><span>r</span><span>e</span><span> </span><span>P</span><span>o</span><span>i</span><span>n</span><span>t</span>
        </div>
      </div>
      <div class="tagline">Empowering teachers to save time with Report Card Generator</div>
      <div class="loader">
        <div class="loader-bar"></div>
      </div>
      <div class="loading-text">Loading your experience...</div>
    </div>
  </div>

  <!-- NAVIGATION BAR -->
  <nav class="navbar" id="navbar" style="display:none;">
    <div class="navbar-brand">Skore Point</div>
    <div class="navbar-nav">
      <a href="#" class="nav-link" id="userGuideBtn"><i class="fas fa-book"></i> User Guide</a>
      <button class="close-portal" id="closePortalBtn"><i class="fas fa-times"></i> Close Portal</button>
    </div>
  </nav>

  <!-- LOGIN SECTION -->
  <div class="container" id="loginSection" style="display:none;">
    <div class="header">
      <h1>Skore Point</h1>
      <p>Teacher & Admin Login</p>
    </div>

    <div id="loginError" class="alert error" style="display:none;">
      <i class="fas fa-exclamation-circle"></i>
      <span></span>
    </div>

    <form id="loginForm">
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
      </div>

      <div class="form-group">
        <label><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" required>
        <button type="button" class="password-toggle" id="loginToggle"><i class="fas fa-eye"></i></button>
      </div>

      <button class="btn btn-primary" type="submit"><i class="fas fa-sign-in-alt"></i> Sign In</button>

      <div class="loading" id="loginLoading">
        <div class="spinner"></div>
        <p>Checking credentials...</p>
      </div>
    </form>

    <div class="footer">
      Don't have an account? <button id="goRegister">Create One</button>
    </div>
  </div>

  <!-- REGISTER SECTION -->
  <div class="container" id="registerSection" style="display:none;">
    <div class="header">
      <h1>Skore Point</h1>
      <p>Create Admin Account</p>
    </div>

    <div id="registerError" class="alert error" style="display:none;">
      <i class="fas fa-exclamation-circle"></i>
      <span></span>
    </div>
    <div id="registerSuccess" class="alert success" style="display:none;">
      <i class="fas fa-check-circle"></i>
      <span>Account created successfully! Redirecting...</span>
    </div>

    <form id="registerForm">
      <div class="form-group">
        <label><i class="fas fa-user"></i> Full Name</label>
        <input type="text" id="regName" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="regEmail" placeholder="Enter email address" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-book"></i> Subject</label>
        <input type="text" id="regSubject" placeholder="Enter your subject" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="regPassword" placeholder="Create password (min 6 characters)" required minlength="6">
        <button type="button" class="password-toggle" id="registerToggle"><i class="fas fa-eye"></i></button>
      </div>
      <div class="form-group">
        <label><i class="fas fa-lock"></i> Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
        <button type="button" class="password-toggle" id="confirmToggle"><i class="fas fa-eye"></i></button>
      </div>
      <button class="btn btn-primary" type="submit"><i class="fas fa-user-plus"></i> Create Account</button>
      <div class="loading" id="registerLoading">
        <div class="spinner"></div>
        <p>Creating account...</p>
      </div>
    </form>

    <div class="footer">
      Already registered? <button id="goLogin">Sign In</button>
    </div>
  </div>

  <!-- DASHBOARD SECTION -->
  <div class="dashboard" id="dashboardSection" style="display:none;">
    <div class="dashboard-header">
      <h1>Skore Point Dashboard</h1>
      <div class="user-info">
        <span id="userName">User Name</span>
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <div class="dashboard-cards">
      <div class="card" id="manageSchoolCard" style="display:none;">
        <i class="fas fa-cogs"></i>
        <h3>SCHOOL PORTAL ACCOUNT</h3>
        <p>Manage classes, students, and marks</p>
        <div id="schoolCardInfo" style="margin-top: 15px; text-align: center;">
          <img id="schoolCardLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
          <h4 id="schoolCardName"></h4>
          <p>Code: <span id="schoolCardCode"></span></p>
          <div style="margin-top: 15px;">
            <button class="btn btn-success" id="openSchoolPortalBtn">
              <i class="fas fa-door-open"></i> Open School Portal
            </button>
          </div>
        </div>
      </div>
      <div class="card" id="joinSchoolCard">
        <i class="fas fa-school"></i>
        <h3>Join a School</h3>
        <p>Join an existing school using its unique code</p>
      </div>
      <div class="card" id="registerSchoolCard">
        <i class="fas fa-plus-circle"></i>
        <h3>Register a School</h3>
        <p>Create a new school and get a unique code</p>
      </div>
    </div>

    <div id="schoolInfo" style="display:none;">
      <h2>Your School: <span id="currentSchoolName"></span></h2>
      <p>School Code: <span id="currentSchoolCode"></span></p>
    </div>
  </div>

  <!-- Join School Full Screen Form -->
  <div class="full-screen-form" id="joinSchoolForm" style="display:none;">
    <button class="close-form" id="closeJoinForm"><i class="fas fa-times"></i></button>
    <div class="container">
      <div class="header">
        <h2>Join a School</h2>
        <p>Enter the school details to join</p>
      </div>

      <div id="joinSchoolError" class="alert error" style="display:none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <form id="joinSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="joinSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-key"></i> School Code</label>
          <input type="text" id="joinSchoolCode" placeholder="Enter school code" required>
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-sign-in-alt"></i> Join School</button>
      </form>
    </div>
  </div>

  <!-- Register School Full Screen Form -->
  <div class="full-screen-form" id="registerSchoolForm" style="display:none;">
    <button class="close-form" id="closeRegisterForm"><i class="fas fa-times"></i></button>
    <div class="container">
      <div class="header">
        <h2>Register a School</h2>
        <p>Create a new school on Skore Point</p>
      </div>

      <div id="registerSchoolError" class="alert error" style="display:none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>
      <div id="registerSchoolSuccess" class="alert success" style="display:none;">
        <i class="fas fa-check-circle"></i>
        <span>School registered successfully!</span>
      </div>

      <form id="registerSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="registerSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> School Location</label>
          <input type="text" id="registerSchoolLocation" placeholder="Enter school location" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-phone"></i> School Phone</label>
          <input type="tel" id="registerSchoolPhone" placeholder="Enter school phone number" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> School Level</label>
          <select id="registerSchoolLevel" required>
            <option value="">Select School Level</option>
            <option value="primary">Primary School</option>
            <option value="secondary">Secondary School</option>
          </select>
        </div>
        <div class="logo-upload" id="logoUploadArea">
          <i class="fas fa-image"></i>
          <p>Upload School Logo</p>
          <span>Click to upload. Recommended size: 200x200px</span>
          <div class="logo-preview" id="logoPreview">
            <img id="logoPreviewImg" src="" alt="Logo Preview">
          </div>
          <button type="button" class="btn btn-secondary" id="uploadLogoBtn"><i class="fas fa-upload"></i> Upload Logo</button>
          <input type="hidden" id="logoUrl">
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-plus-circle"></i> Register School</button>
      </form>
    </div>
  </div>

  <!-- SCHOOL MANAGEMENT SECTION -->
  <div class="school-management" id="schoolManagementSection" style="display:none;">
    <div class="management-header">
      <div>
        <h2>School Management: <span id="managementSchoolName"></span></h2>
        <div class="school-code">Code: <span id="managementSchoolCode"></span></div>
      </div>
      <div id="schoolLogoContainer" style="display: none;">
        <img id="managementSchoolLogo" class="school-logo" src="" alt="School Logo">
      </div>
    </div>

    <div class="management-tabs" id="managementTabs" style="display:none;">
      <div class="tab active" data-tab="classes">Classes</div>
      <div class="tab" data-tab="students">Students</div>
      <div class="tab" data-tab="subjects">Subjects</div>
      <div class="tab" data-tab="marks">Enter Marks</div>
      <div class="tab" data-tab="reports">Reports</div>
    </div>

    <!-- Classes Tab -->
    <div class="tab-content active" id="classesTab">
      <div class="container">
        <div class="header">
          <h3>Manage Classes</h3>
          <p>Create and manage classes in your school</p>
        </div>

        <form id="addClassForm">
          <div class="form-group">
            <label><i class="fas fa-chalkboard"></i> Class Name</label>
            <input type="text" id="className" placeholder="e.g., Grade 5A, Form 3, etc." required>
          </div>
          <button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i> Add Class</button>
        </form>

        <div class="class-list" id="classList">
          <!-- Classes will be populated here -->
        </div>
      </div>
    </div>

    <!-- Students Tab -->
    <div class="tab-content" id="studentsTab">
      <div class="container">
        <div class="header">
          <h3>Manage Students</h3>
          <p>Upload and manage student lists</p>
        </div>

        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Select Class</label>
          <select id="studentClassSelect">
            <option value="">Select a class</option>
          </select>
        </div>

        <div class="file-upload" id="studentUploadArea">
          <i class="fas fa-file-excel"></i>
          <p>Upload Excel File with Student Names</p>
          <span>Click or drag & drop to upload. First column should contain student names.</span>
          <input type="file" id="studentFile" accept=".xlsx,.xls" style="display:none;">
        </div>

        <div id="studentUploadError" class="alert error" style="display:none;">
          <i class="fas fa-exclamation-circle"></i>
          <span></span>
        </div>

        <div id="studentUploadSuccess" class="alert success" style="display:none;">
          <i class="fas fa-check-circle"></i>
          <span>Students uploaded successfully!</span>
        </div>

        <div class="student-list" id="studentList">
          <!-- Students will be populated here -->
        </div>
      </div>
    </div>

    <!-- Subjects Tab -->
    <div class="tab-content" id="subjectsTab">
      <div class="container">
        <div class="header">
          <h3>Manage Subjects</h3>
          <p>Add and manage subjects for your school</p>
        </div>

        <form id="addSubjectForm">
          <div class="form-group">
            <label><i class="fas fa-book"></i> Subject Name</label>
            <input type="text" id="subjectName" placeholder="Enter subject name" required>
          </div>
          <button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i> Add Subject</button>
        </form>

        <div class="subjects-list" id="subjectsList">
          <!-- Subjects will be populated here -->
        </div>
      </div>
    </div>

    <!-- Marks Tab -->
    <div class="tab-content" id="marksTab">
      <div class="container">
        <div class="header">
          <h3>Enter Student Marks</h3>
          <p>Select class and enter marks for students</p>
        </div>

        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Select Class</label>
          <select id="marksClassSelect">
            <option value="">Select a class</option>
          </select>
        </div>

        <div class="form-group">
          <label><i class="fas fa-calendar-alt"></i> Term Period</label>
          <select id="termPeriodSelect" required>
            <option value="">Select Term Period</option>
            <option value="beginning">Beginning of Term</option>
            <option value="mid">Mid Term</option>
            <option value="end">End of Term</option>
          </select>
        </div>

        <div class="marks-entry" id="marksEntrySection" style="display:none;">
          <h3>Enter Marks</h3>
          
          <div class="form-group student-selector">
            <label><i class="fas fa-user"></i> Student Name</label>
            <input type="text" id="studentSearch" placeholder="Start typing student name..." autocomplete="off">
            <div class="student-suggestions" id="studentSuggestions">
              <!-- Student suggestions will appear here -->
            </div>
          </div>

        <div id="currentStudentInfo" style="display:none; margin-bottom: 20px; padding: 15px; background: var(--gray); border-radius: 8px;">
          <h4>Selected Student: <span id="selectedStudentName"></span></h4>
          <p style="font-size: 14px; color: #a0aec0; margin-top: 5px;">Enter marks for each subject below</p>
        </div>

        <div class="marks-grid" id="marksGrid">
          <!-- Mark inputs will be generated here -->
        </div>

        <div id="marksAlert" class="alert" style="display:none;">
          <i class="fas fa-info-circle"></i>
          <span></span>
        </div>

        <button class="btn btn-primary" id="saveMarksBtn" disabled><i class="fas fa-save"></i> Save Marks</button>
      </div>
    </div>
  </div>

  <!-- Reports Tab -->
  <div class="tab-content" id="reportsTab">
    <div class="container">
      <div class="header">
        <h3>Generate Reports</h3>
        <p>View and export student performance reports</p>
      </div>

      <div class="report-filters">
        <h4 style="margin-bottom: 15px;">Report Filters</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label><i class="fas fa-chalkboard"></i> Select Class</label>
            <select id="reportClassSelect">
              <option value="">All Classes</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-user"></i> Select Student</label>
            <select id="reportStudentSelect">
              <option value="">All Students</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-calendar-alt"></i> Select Term Period</label>
            <select id="reportTermPeriodSelect">
              <option value="beginning">Beginning of Term</option>
              <option value="mid">Mid Term</option>
              <option value="end" selected>End of Term</option>
            </select>
          </div>
        </div>
        <div class="report-actions">
          <button class="btn btn-primary" id="generateReportBtn"><i class="fas fa-chart-bar"></i> Generate Report</button>
          <button class="btn btn-success" id="exportPDFBtn"><i class="fas fa-file-pdf"></i> Export Report Card</button>
          <button class="btn btn-warning" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Export Class Analysis</button>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid" style="display:none;">
        <div class="stat-card">
          <h4>Total Students</h4>
          <p id="statTotalStudents">0</p>
        </div>
        <div class="stat-card">
          <h4>Average Score</h4>
          <p id="statAvgScore">0</p>
        </div>
        <div class="stat-card">
          <h4>Highest Score</h4>
          <p id="statHighScore">0</p>
        </div>
        <div class="stat-card">
          <h4>Lowest Score</h4>
          <p id="statLowScore">0</p>
        </div>
      </div>

      <div class="report-preview" id="reportPreview" style="display:none;">
        <h3>Report Preview</h3>
        
        <!-- Enhanced Report Card Preview -->
        <div id="enhancedReportCard" class="enhanced-report-card">
          <div class="header-section">
            <div class="school-name">STEM PLUS</div>
            <div class="product-info">A product of SERUSOFT</div>
            <div class="school-code">School Code: <span id="previewSchoolCode">6QWAAI</span></div>
            <div class="report-title" id="previewReportTitle">STUDENT PROGRESS REPORT</div>
          </div>
          
          <div class="student-info">
            <div class="student-details">
              <div><strong>Student Name:</strong> <span id="previewStudentName">junju</span></div>
              <div><strong>Class:</strong> <span id="previewStudentClass">Primary Four</span></div>
            </div>
            <div class="student-details">
              <div><strong>Date:</strong> <span id="previewReportDate">11/23/2025</span></div>
            </div>
          </div>
          
          <table class="subject-table">
            <thead>
              <tr>
                <th>SUBJECT</th>
                <th>SCORE</th>
                <th>GRADE</th>
              </tr>
            </thead>
            <tbody id="previewSubjectScores">
              <!-- Subject scores will be populated here -->
            </tbody>
          </table>
          
          <table class="summary-table">
            <thead>
              <tr>
                <th>TOTAL MARKS</th>
                <th>AVERAGE MARK</th>
                <th>AGGREGATES</th>
                <th>FINAL GRADE/DIVISION</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="previewTotalMarks">290</td>
                <td id="previewAverageMark">73</td>
                <td id="previewAggregates">13</td>
                <td id="previewFinalGrade">2</td>
              </tr>
            </tbody>
          </table>
          
          <div class="remarks-section">
            <h4>Class Teacher's Remarks:</h4>
            <div class="signature-line"></div>
            <div class="signature-line"></div>
            <div class="signature-line"></div>
            
            <h4 style="margin-top: 20px;">Head Teacher's Remarks:</h4>
            <div class="signature-line"></div>
            <div class="signature-line"></div>
            <div class="signature-line"></div>
            
            <h4 style="margin-top: 20px;">Next Term Begins On:</h4>
            <div class="signature-line"></div>
          </div>
          
          <div class="signature-lines">
            <div class="signature-box">
              <div>Class Teacher Signature</div>
            </div>
            <div class="signature-box">
              <div>Head Teacher Signature</div>
            </div>
            <div class="signature-box">
              <div>School Stamp</div>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" id="reportsEmptyState">
        <i class="fas fa-chart-line"></i>
        <h3>No Data Available</h3>
        <p>Please add students and marks to generate reports</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Cloudinary Configuration
  const CLOUDINARY_CLOUD_NAME = 'dbtucc6v2';
  const CLOUDINARY_UPLOAD_PRESET = 'gradeforcus';

  // DOM Elements
  const launchScreen = document.getElementById('launchScreen');
  const navbar = document.getElementById('navbar');
  const loginSection = document.getElementById('loginSection');
  const registerSection = document.getElementById('registerSection');
  const dashboardSection = document.getElementById('dashboardSection');
  const schoolManagementSection = document.getElementById('schoolManagementSection');
  const managementTabs = document.getElementById('managementTabs');
  
  // Navigation buttons
  const goRegister = document.getElementById('goRegister');
  const goLogin = document.getElementById('goLogin');
  const joinSchoolCard = document.getElementById('joinSchoolCard');
  const registerSchoolCard = document.getElementById('registerSchoolCard');
  const manageSchoolCard = document.getElementById('manageSchoolCard');
  const joinSchoolForm = document.getElementById('joinSchoolForm');
  const registerSchoolForm = document.getElementById('registerSchoolForm');
  const closeJoinForm = document.getElementById('closeJoinForm');
  const closeRegisterForm = document.getElementById('closeRegisterForm');
  const logoutBtn = document.getElementById('logoutBtn');
  const closePortalBtn = document.getElementById('closePortalBtn');
  const userGuideBtn = document.getElementById('userGuideBtn');
  
  // Form elements
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const joinSchoolFormFields = document.getElementById('joinSchoolFormFields');
  const registerSchoolFormFields = document.getElementById('registerSchoolFormFields');
  const addClassForm = document.getElementById('addClassForm');
  const addSubjectForm = document.getElementById('addSubjectForm');
  
  // User info
  const userName = document.getElementById('userName');
  const currentSchoolName = document.getElementById('currentSchoolName');
  const currentSchoolCode = document.getElementById('currentSchoolCode');
  const managementSchoolName = document.getElementById('managementSchoolName');
  const managementSchoolCode = document.getElementById('managementSchoolCode');
  const managementSchoolLogo = document.getElementById('managementSchoolLogo');
  const schoolLogoContainer = document.getElementById('schoolLogoContainer');
  
  // School card info
  const schoolCardName = document.getElementById('schoolCardName');
  const schoolCardCode = document.getElementById('schoolCardCode');
  const schoolCardLogo = document.getElementById('schoolCardLogo');
  
  // Portal buttons
  const openSchoolPortalBtn = document.getElementById('openSchoolPortalBtn');
  
  // Report preview elements
  const previewSchoolCode = document.getElementById('previewSchoolCode');
  const previewStudentName = document.getElementById('previewStudentName');
  const previewStudentClass = document.getElementById('previewStudentClass');
  const previewReportDate = document.getElementById('previewReportDate');
  const previewReportTitle = document.getElementById('previewReportTitle');
  const previewSubjectScores = document.getElementById('previewSubjectScores');
  const previewTotalMarks = document.getElementById('previewTotalMarks');
  const previewAverageMark = document.getElementById('previewAverageMark');
  const previewAggregates = document.getElementById('previewAggregates');
  const previewFinalGrade = document.getElementById('previewFinalGrade');
  
  // Global variables
  let currentUser = null;
  let currentSchool = null;
  let currentClasses = [];
  let currentStudents = [];
  let currentSubjects = [];
  let selectedStudentId = null;
  let currentMarks = {};
  let schoolLogoUrl = null;
  let isSchoolPortalOpen = false;

  // Default subjects for different school levels
  const DEFAULT_SUBJECTS = {
    primary: ['Mathematics', 'English', 'Integrated Science', 'Social Studies'],
    secondary: [
      'English Language', 'Literature', 'Mathematics', 'Biology', 'Chemistry', 
      'Physics', 'Geography', 'History & Political Education', 'Religious Education',
      'Islamic', 'Kiswahili', 'Entrepreneurship Education', 'Agriculture',
      'Computer / ICT Studies', 'Fine Art / Art & Design', 'Physical Education (PE)',
      'Luganda', 'French',  'Technology & Design'
    ]
  };

  // Default classes for secondary schools
  const DEFAULT_SECONDARY_CLASSES = [
    'Senior One', 'Senior Two', 'Senior Three', 'Senior Four',
    'Senior Five', 'Senior Six'
  ];

  // Grading scales
  const GRADING_SCALES = {
    primary: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9'],
    secondary: ['A', 'B', 'C', 'D', 'E']
  };

  // Term detection based on month - UPDATED FOR UGANDA SCHOOL CALENDAR
  const TERM_MONTHS = {
    1: 'TERM 1',  // January
    2: 'TERM 1',  // February
    3: 'TERM 1',  // March
    4: 'TERM 2',  // April
    5: 'TERM 2',  // May
    6: 'TERM 2',  // June
    7: 'TERM 2',  // July (Ends late July or early August)
    8: 'TERM 3',  // September
    9: 'TERM 3',  // October
    10: 'TERM 3', // November (Ends late November or early December)
    11: 'TERM 1', // December
    12: 'TERM 1'  // December
  };

  // Initialize the app
  document.addEventListener('DOMContentLoaded', () => {
    // Show launch screen first
    showSection(launchScreen);
    
    // After 7 seconds, check authentication and show appropriate section
    setTimeout(() => {
      // Check if user is already logged in
      window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
        if (user) {
          currentUser = user;
          loadUserData(user.uid);
          showSection(dashboardSection);
        } else {
          showSection(loginSection);
        }
      });
    }, 7000);

    // Setup event listeners
    setupEventListeners();
  });

  // Load user data from Firestore
  async function loadUserData(userId) {
    try {
      const userDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'users', userId)
      );
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        userName.textContent = userData.name || userData.email;
        
        // Check if user has a school
        if (userData.schoolId) {
          await loadSchoolData(userData.schoolId);
        }
      }
    } catch (error) {
      console.error('Error loading user data:', error);
    }
  }

  // Load school data from Firestore
  async function loadSchoolData(schoolId) {
    try {
      const schoolDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'schools', schoolId)
      );
      
      if (schoolDoc.exists()) {
        currentSchool = {
          id: schoolDoc.id,
          ...schoolDoc.data()
        };
        
        currentSchoolName.textContent = currentSchool.name;
        currentSchoolCode.textContent = currentSchool.code;
        document.getElementById('schoolInfo').style.display = 'block';
        manageSchoolCard.style.display = 'block';
        
        // Update school card info
        schoolCardName.textContent = currentSchool.name;
        schoolCardCode.textContent = currentSchool.code;
        
        // Load school logo if available
        if (currentSchool.logoUrl) {
          schoolLogoUrl = currentSchool.logoUrl;
          schoolCardLogo.src = currentSchool.logoUrl;
          schoolCardLogo.style.display = 'block';
          
          // Also set the logo in the management section
          managementSchoolLogo.src = currentSchool.logoUrl;
          schoolLogoContainer.style.display = 'block';
        }
        
        // Load school data
        await loadClasses();
        await loadSubjects();
        
        // Show management tabs
        managementTabs.style.display = 'flex';
      }
    } catch (error) {
      console.error('Error loading school data:', error);
    }
  }

  // Setup all event listeners
  function setupEventListeners() {
    // Navigation
    goRegister.onclick = () => showSection(registerSection);
    goLogin.onclick = () => showSection(loginSection);
    joinSchoolCard.onclick = () => showJoinSchoolForm();
    registerSchoolCard.onclick = () => showRegisterSchoolForm();
    manageSchoolCard.onclick = () => showSchoolManagement();
    closeJoinForm.onclick = () => hideFullScreenForm();
    closeRegisterForm.onclick = () => hideFullScreenForm();
    logoutBtn.onclick = () => logout();
    closePortalBtn.onclick = () => closeSchoolPortal();
    userGuideBtn.onclick = () => showUserGuide();

    // Portal buttons
    openSchoolPortalBtn.onclick = openSchoolPortal;

    // Form submissions
    loginForm.onsubmit = handleLogin;
    registerForm.onsubmit = handleRegister;
    joinSchoolFormFields.onsubmit = handleJoinSchool;
    registerSchoolFormFields.onsubmit = handleRegisterSchool;
    addClassForm.onsubmit = handleAddClass;
    addSubjectForm.onsubmit = handleAddSubject;

    // Password toggles
    setupPasswordToggles();

    // File upload
    setupFileUpload();

    // Logo upload
    document.getElementById('uploadLogoBtn').onclick = () => openCloudinaryUpload('logo');

    // Tab switching
    setupTabs();

    // Student search
    setupStudentSearch();

    // Marks saving
    document.getElementById('saveMarksBtn').onclick = handleSaveMarks;

    // Report generation
    document.getElementById('generateReportBtn').onclick = generateReport;
    document.getElementById('exportPDFBtn').onclick = exportReportCard;
    document.getElementById('exportExcelBtn').onclick = exportClassAnalysis;
    document.getElementById('reportClassSelect').onchange = updateStudentDropdown;
  }

  // Get current term based on month - UPDATED FOR UGANDA SCHOOL CALENDAR
  function getCurrentTerm() {
    const currentMonth = new Date().getMonth() + 1; // Months are 0-indexed
    return TERM_MONTHS[currentMonth] || 'TERM 1';
  }

  // Get full term label based on period and current term - UPDATED FOR UGANDA SCHOOL CALENDAR
  function getFullTermLabel(period) {
    const term = getCurrentTerm();
    const periodLabels = {
      'beginning': 'BEGINNING OF',
      'mid': 'MID OF',
      'end': 'END OF'
    };
    return `${periodLabels[period]} ${term}`;
  }

  // Get report title based on term period - NEW FUNCTION
  function getReportTitle(period) {
    const term = getCurrentTerm();
    const periodLabels = {
      'beginning': 'BEGINNING OF',
      'mid': 'MID OF',
      'end': 'END OF'
    };
    return `${periodLabels[period]} ${term} STUDENT PROGRESS REPORT`;
  }

  // Open Cloudinary upload widget
  function openCloudinaryUpload(type) {
    const widget = cloudinary.createUploadWidget({
      cloudName: CLOUDINARY_CLOUD_NAME,
      uploadPreset: CLOUDINARY_UPLOAD_PRESET,
      sources: ['local', 'url'],
      multiple: false,
      maxFiles: 1,
      cropping: type === 'profile',
      croppingAspectRatio: type === 'profile' ? 1 : null,
      showAdvancedOptions: false,
      styles: {
        palette: {
          window: "#1C1C1C",
          sourceBg: "#2D2D2D",
          windowBorder: "#4A4A4A",
          tabIcon: "#FFFFFF",
          inactiveTabIcon: "#8E8E8E",
          menuIcons: "#FFFFFF",
          link: "#4361EE",
          action: "#4361EE",
          inProgress: "#4361EE",
          complete: "#38A169",
          error: "#E53E3E",
          textDark: "#121212",
          textLight: "#FFFFFF"
        }
      }
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        if (type === 'logo') {
          document.getElementById('logoPreviewImg').src = result.info.secure_url;
          document.getElementById('logoPreview').style.display = 'block';
          document.getElementById('logoUrl').value = result.info.secure_url;
          schoolLogoUrl = result.info.secure_url;
        }
      }
    });
    
    widget.open();
  }

  // Open School Portal
  function openSchoolPortal() {
    isSchoolPortalOpen = true;
    
    // Hide join and register cards
    joinSchoolCard.style.display = 'none';
    registerSchoolCard.style.display = 'none';
    
    // Show navbar
    navbar.style.display = 'flex';
    
    // Show management tabs if they exist
    if (managementTabs) {
      managementTabs.style.display = 'flex';
    }
    
    // Load students when marks tab is active
    if (document.getElementById('marksTab').classList.contains('active')) {
      setupMarksEntry();
    }
    
    // Show school management section
    showSection(schoolManagementSection);
  }

  // Close School Portal
  function closeSchoolPortal() {
    isSchoolPortalOpen = false;
    
    // Show join and register cards
    joinSchoolCard.style.display = 'block';
    registerSchoolCard.style.display = 'block';
    
    // Hide navbar
    navbar.style.display = 'none';
    
    // Hide management tabs
    if (managementTabs) {
      managementTabs.style.display = 'none';
    }
    
    // Show dashboard section
    showSection(dashboardSection);
  }

  // Show user guide
  function showUserGuide() {
    alert("Skore Point User Guide:\n\n1. Register or join a school\n2. Add classes and students\n3. Add subjects\n4. Enter student marks\n5. Generate reports and export them\n\nFor more detailed instructions, please contact support.");
  }

  // Show specific section and hide others
  function showSection(section) {
    [launchScreen, loginSection, registerSection, dashboardSection, schoolManagementSection].forEach(sec => {
      sec.style.display = 'none';
    });
    section.style.display = 'block';
  }

  // Show join school form in full screen
  function showJoinSchoolForm() {
    joinSchoolForm.style.display = 'block';
  }

  // Show register school form in full screen
  function showRegisterSchoolForm() {
    registerSchoolForm.style.display = 'block';
  }

  // Hide full screen form
  function hideFullScreenForm() {
    joinSchoolForm.style.display = 'none';
    registerSchoolForm.style.display = 'none';
  }

  // Show school management section
  async function showSchoolManagement() {
    showSection(schoolManagementSection);
    managementSchoolName.textContent = currentSchool.name;
    managementSchoolCode.textContent = currentSchool.code;
    
    // Show management tabs only if school is managed
    if (currentSchool) {
      managementTabs.style.display = 'flex';
    }
    
    await loadClasses();
    await loadSubjects();
    populateClassSelectors();
  }

  // Setup password visibility toggles
  function setupPasswordToggles() {
    const togglePassword = (btn, field) => {
      btn.addEventListener('click', () => {
        const type = field.type === 'password' ? 'text' : 'password';
        field.type = type;
        btn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });
    };

    togglePassword(document.getElementById('loginToggle'), document.getElementById('loginPassword'));
    togglePassword(document.getElementById('registerToggle'), document.getElementById('regPassword'));
    togglePassword(document.getElementById('confirmToggle'), document.getElementById('confirmPassword'));
  }

  // Setup file upload for students
  function setupFileUpload() {
    const uploadArea = document.getElementById('studentUploadArea');
    const fileInput = document.getElementById('studentFile');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'var(--gray)';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--gray)';
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleStudentUpload();
      }
    });

    fileInput.addEventListener('change', handleStudentUpload);
  }

  // Setup tab switching
  function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
        
        // Load data for the active tab
        if (tab.dataset.tab === 'students') {
          loadStudents();
        } else if (tab.dataset.tab === 'subjects') {
          loadSubjects();
        } else if (tab.dataset.tab === 'marks') {
          setupMarksEntry();
        } else if (tab.dataset.tab === 'reports') {
          setupReportsTab();
        }
      });
    });
  }

  // Setup student search for marks entry
  function setupStudentSearch() {
    const studentSearch = document.getElementById('studentSearch');
    const suggestions = document.getElementById('studentSuggestions');

    studentSearch.addEventListener('input', () => {
      const searchTerm = studentSearch.value.toLowerCase();
      const classId = document.getElementById('marksClassSelect').value;
      
      if (!classId || searchTerm.length < 2) {
        suggestions.style.display = 'none';
        return;
      }

      // Filter students by class and search term
      const filteredStudents = currentStudents.filter(student => 
        student.classId === classId && 
        student.name.toLowerCase().includes(searchTerm)
      );

      // Display suggestions
      suggestions.innerHTML = '';
      if (filteredStudents.length > 0) {
        filteredStudents.forEach(student => {
          const div = document.createElement('div');
          div.className = 'student-suggestion';
          div.textContent = student.name;
          div.addEventListener('click', async () => {
            studentSearch.value = student.name;
            suggestions.style.display = 'none';
            selectedStudentId = student.id;
            document.getElementById('selectedStudentName').textContent = student.name;
            document.getElementById('currentStudentInfo').style.display = 'block';
            document.getElementById('saveMarksBtn').disabled = false;
            await loadStudentMarks(student.id);
          });
          suggestions.appendChild(div);
        });
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!studentSearch.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.style.display = 'none';
      }
    });
  }

  // Setup marks entry section
  function setupMarksEntry() {
    const classSelect = document.getElementById('marksClassSelect');
    const marksSection = document.getElementById('marksEntrySection');
    
    classSelect.addEventListener('change', () => {
      if (classSelect.value) {
        marksSection.style.display = 'block';
        generateMarkInputs();
        document.getElementById('studentSearch').value = '';
        document.getElementById('currentStudentInfo').style.display = 'none';
        selectedStudentId = null;
        document.getElementById('saveMarksBtn').disabled = true;
        
        // Load students for the selected class
        loadStudentsForMarks(classSelect.value);
      } else {
        marksSection.style.display = 'none';
      }
    });
  }

  // Load students for marks entry
  async function loadStudentsForMarks(classId) {
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        const studentData = {
          id: doc.id,
          ...doc.data()
        };
        currentStudents.push(studentData);
      });
    } catch (error) {
      console.error('Error loading students for marks:', error);
    }
  }

  // Generate mark input fields based on subjects
  function generateMarkInputs() {
    const marksGrid = document.getElementById('marksGrid');
    marksGrid.innerHTML = '';
    
    currentSubjects.forEach(subject => {
      const div = document.createElement('div');
      div.className = 'mark-input';
      div.innerHTML = `
        <label>${subject.name}</label>
        <input type="number" min="0" max="100" placeholder="0-100" data-subject="${subject.id}">
      `;
      marksGrid.appendChild(div);
    });
  }

  // Load student marks if they exist
  async function loadStudentMarks(studentId) {
    try {
      const termPeriod = document.getElementById('termPeriodSelect').value;
      const term = getCurrentTerm();
      const marksDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}_${termPeriod}`)
      );
      
      if (marksDoc.exists()) {
        const marks = marksDoc.data();
        currentSubjects.forEach(subject => {
          const input = document.querySelector(`input[data-subject="${subject.id}"]`);
          if (input && marks[subject.id] !== undefined) {
            input.value = marks[subject.id];
          } else {
            input.value = '';
          }
        });
      } else {
        // Clear all inputs
        document.querySelectorAll('.mark-input input').forEach(input => {
          input.value = '';
        });
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
  }

  // Handle saving marks
  async function handleSaveMarks() {
    if (!selectedStudentId) {
      showMarksAlert('Please select a student first', 'error');
      return;
    }

    const termPeriod = document.getElementById('termPeriodSelect').value;
    if (!termPeriod) {
      showMarksAlert('Please select a term period', 'error');
      return;
    }

    const marks = {};
    let hasMarks = false;
    
    currentSubjects.forEach(subject => {
      const input = document.querySelector(`input[data-subject="${subject.id}"]`);
      const value = parseInt(input.value);
      if (!isNaN(value) && value >= 0 && value <= 100) {
        marks[subject.id] = value;
        hasMarks = true;
      }
    });

    if (!hasMarks) {
      showMarksAlert('Please enter at least one mark', 'warning');
      return;
    }

    try {
      const term = getCurrentTerm();
      
      // Save marks to Firestore
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${selectedStudentId}_${term}_${termPeriod}`),
        {
          studentId: selectedStudentId,
          schoolId: currentSchool.id,
          term: term,
          termPeriod: termPeriod,
          ...marks,
          updatedAt: new Date()
        }
      );

      showMarksAlert('Marks saved successfully!', 'success');
      
      // Clear form after a delay
      setTimeout(() => {
        document.getElementById('studentSearch').value = '';
        document.getElementById('currentStudentInfo').style.display = 'none';
        selectedStudentId = null;
        document.getElementById('saveMarksBtn').disabled = true;
        document.querySelectorAll('.mark-input input').forEach(input => {
          input.value = '';
        });
      }, 1500);
    } catch (error) {
      console.error('Error saving marks:', error);
      showMarksAlert('Error saving marks. Please try again.', 'error');
    }
  }

  // Show alert in marks section
  function showMarksAlert(message, type) {
    const alert = document.getElementById('marksAlert');
    alert.className = `alert ${type}`;
    alert.querySelector('span').textContent = message;
    alert.style.display = 'flex';
    
    setTimeout(() => {
      alert.style.display = 'none';
    }, 3000);
  }

  // Setup reports tab
  async function setupReportsTab() {
    await populateReportClassSelector();
    document.getElementById('reportsEmptyState').style.display = 'block';
    document.getElementById('reportPreview').style.display = 'none';
    document.getElementById('statsGrid').style.display = 'none';
  }

  // Populate class selector in reports
  async function populateReportClassSelector() {
    const select = document.getElementById('reportClassSelect');
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    currentClasses.forEach(classObj => {
      const option = document.createElement('option');
      option.value = classObj.id;
      option.textContent = classObj.name;
      select.appendChild(option);
    });
  }

  // Update student dropdown based on selected class
  async function updateStudentDropdown() {
    const classId = document.getElementById('reportClassSelect').value;
    const select = document.getElementById('reportStudentSelect');
    
    // Clear existing options except first one
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    if (!classId) return;
    
    const classStudents = currentStudents.filter(s => s.classId === classId);
    classStudents.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = student.name;
      select.appendChild(option);
    });
  }

  // Generate report
  async function generateReport() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const termPeriod = document.getElementById('reportTermPeriodSelect').value;
    
    try {
      const term = getCurrentTerm();
      
      // Get all marks from Firestore
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term),
        window.firebase.where('termPeriod', '==', termPeriod)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const allMarks = [];
      
      marksSnapshot.forEach(doc => {
        allMarks.push({
          id: doc.id,
          ...doc.data()
        });
      });

      // Filter based on selection
      let filteredData = allMarks;
      
      if (classId) {
        const classStudents = currentStudents.filter(s => s.classId === classId);
        const studentIds = classStudents.map(s => s.id);
        filteredData = filteredData.filter(mark => studentIds.includes(mark.studentId));
      }
      
      if (studentId) {
        filteredData = filteredData.filter(mark => mark.studentId === studentId);
      }

      if (filteredData.length === 0) {
        document.getElementById('reportsEmptyState').style.display = 'block';
        document.getElementById('reportPreview').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'none';
        return;
      }

      // Display report
      displayReport(filteredData, termPeriod);
      calculateStatistics(filteredData);
      
      document.getElementById('reportsEmptyState').style.display = 'none';
      document.getElementById('reportPreview').style.display = 'block';
      document.getElementById('statsGrid').style.display = 'grid';
    } catch (error) {
      console.error('Error generating report:', error);
      alert('Error generating report. Please try again.');
    }
  }

  // Display report in table
  function displayReport(data, termPeriod) {
    // For now, just show the first student's data in the enhanced preview
    if (data.length > 0) {
      const mark = data[0];
      const student = currentStudents.find(s => s.id === mark.studentId);
      const classObj = currentClasses.find(c => c.id === student.classId);
      
      // Update preview with student data
      previewSchoolCode.textContent = currentSchool.code;
      previewStudentName.textContent = student.name;
      previewStudentClass.textContent = classObj ? classObj.name : 'N/A';
      previewReportDate.textContent = new Date().toLocaleDateString();
      previewReportTitle.textContent = getReportTitle(termPeriod); // UPDATED: Use new function
      
      // Calculate totals and averages
      let totalMarks = 0;
      let subjectCount = 0;
      
      // Clear previous subject scores
      previewSubjectScores.innerHTML = '';
      
      // Add subject scores to the table
      currentSubjects.forEach(subject => {
        const score = mark[subject.id] || 0;
        const grade = score > 0 ? calculateGrade(score, currentSchool.level) : '-';
        
        if (score > 0) {
          totalMarks += score;
          subjectCount++;
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${subject.name}</td>
          <td>${score > 0 ? score : '-'}</td>
          <td>${grade}</td>
        `;
        previewSubjectScores.appendChild(row);
      });
      
      // Calculate summary values
      const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
      const aggregate = calculateAggregate(mark);
      const division = calculateDivision(average, aggregate);
      
      // Update summary table
      previewTotalMarks.textContent = totalMarks;
      previewAverageMark.textContent = average;
      previewAggregates.textContent = aggregate;
      previewFinalGrade.textContent = division;
    }
  }

  // Calculate aggregate for primary school
  function calculateAggregate(marks) {
    // For primary schools, aggregate is calculated based on grades
    if (currentSchool.level === 'primary') {
      let aggregate = 0;
      
      currentSubjects.forEach(subject => {
        const score = marks[subject.id] || 0;
        if (score > 0) {
          // Convert score to points (1-9 scale)
          if (score >= 90) aggregate += 1; // D1
          else if (score >= 80) aggregate += 2; // D2
          else if (score >= 70) aggregate += 3; // C3
          else if (score >= 60) aggregate += 4; // C4
          else if (score >= 50) aggregate += 5; // C5
          else if (score >= 40) aggregate += 6; // C6
          else if (score >= 30) aggregate += 7; // P7
          else if (score >= 20) aggregate += 8; // P8
          else aggregate += 9; // F9
        }
      });
      
      return aggregate;
    } else {
      // For secondary schools, use a different calculation
      let totalPoints = 0;
      let subjectCount = 0;
      
      currentSubjects.forEach(subject => {
        const score = marks[subject.id] || 0;
        if (score > 0) {
          // Convert score to points (1-5 scale)
          if (score >= 80) totalPoints += 1; // A
          else if (score >= 70) totalPoints += 2; // B
          else if (score >= 60) totalPoints += 3; // C
          else if (score >= 50) totalPoints += 4; // D
          else totalPoints += 5; // E
          subjectCount++;
        }
      });
      
      return subjectCount > 0 ? Math.round(totalPoints / subjectCount) : 0;
    }
  }

  // Calculate statistics
  function calculateStatistics(data) {
    let totalStudents = data.length;
    let allScores = [];
    
    data.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        if (mark[subject.id] !== undefined) {
          total += mark[subject.id];
          count++;
        }
      });
      
      if (count > 0) {
        allScores.push(total / count);
      }
    });
    
    const avgScore = allScores.length > 0 ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length) : 0;
    const highScore = allScores.length > 0 ? Math.round(Math.max(...allScores)) : 0;
    const lowScore = allScores.length > 0 ? Math.round(Math.min(...allScores)) : 0;
    
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
  }

  // Export to PDF with enhanced report card format
  async function exportReportCard() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Get the selected class and student
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const termPeriod = document.getElementById('reportTermPeriodSelect').value;
    
    const term = getCurrentTerm();
    
    // Get all marks from Firestore
    const marksQuery = window.firebase.query(
      window.firebase.collection(window.firebase.db, 'marks'),
      window.firebase.where('schoolId', '==', currentSchool.id),
      window.firebase.where('term', '==', term),
      window.firebase.where('termPeriod', '==', termPeriod)
    );
    
    const marksSnapshot = await window.firebase.getDocs(marksQuery);
    const allMarks = [];
    
    marksSnapshot.forEach(doc => {
      allMarks.push({
        id: doc.id,
        ...doc.data()
      });
    });

    // Filter based on selection
    let filteredData = allMarks;
    
    if (classId) {
      const classStudents = currentStudents.filter(s => s.classId === classId);
      const studentIds = classStudents.map(s => s.id);
      filteredData = filteredData.filter(mark => studentIds.includes(mark.studentId));
    }
    
    if (studentId) {
      filteredData = filteredData.filter(mark => mark.studentId === studentId);
    }

    // Generate individual report for each student
    for (let i = 0; i < filteredData.length; i++) {
      const mark = filteredData[i];
      if (i > 0) {
        doc.addPage();
      }
      
      const student = currentStudents.find(s => s.id === mark.studentId);
      if (!student) continue;
      
      const classObj = currentClasses.find(c => c.id === student.classId);
      
      // Calculate totals and averages
      let totalMarks = 0;
      let subjectCount = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id] || 0;
        if (score > 0) {
          totalMarks += score;
          subjectCount++;
        }
      });
      
      const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
      const aggregate = calculateAggregate(mark);
      const division = calculateDivision(average, aggregate);
      
      // Add header with logo and school name
      doc.setFontSize(20);
      doc.setTextColor(67, 97, 238);
      doc.text('Skore Point', 20, 30);
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text('A product of SERUSOFT', 20, 38);
      
      // Add school logo if available
      if (schoolLogoUrl) {
        try {
          // Create an image element to load the logo
          const logoImg = new Image();
          logoImg.crossOrigin = 'Anonymous';
          logoImg.src = schoolLogoUrl;
          
          // Wait for the image to load
          await new Promise((resolve) => {
            logoImg.onload = resolve;
            logoImg.onerror = resolve; // Continue even if image fails to load
          });
          
          // Add the logo to the PDF
          doc.addImage(logoImg, 'JPEG', 150, 20, 40, 40);
        } catch (error) {
          console.error('Error adding logo to PDF:', error);
          // Fallback: Add a placeholder if logo fails to load
          doc.setFillColor(200, 200, 200);
          doc.rect(150, 20, 40, 40, 'F');
          doc.setTextColor(100, 100, 100);
          doc.text('School Logo', 155, 45);
        }
      }
      
      // Add school name and info
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text(currentSchool.name, 105, 60, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`School Code: ${currentSchool.code}`, 105, 68, { align: 'center' });
      
      // Add student info
      doc.setFontSize(14);
      doc.text(getReportTitle(termPeriod), 105, 90, { align: 'center' }); // UPDATED: Use new function
      doc.setFontSize(12);
      doc.text(`Student Name: ${student.name}`, 20, 110);
      doc.text(`Class: ${classObj ? classObj.name : 'N/A'}`, 20, 120);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 130);
      
      // Add table header
      let yPos = 150;
      doc.setFillColor(67, 97, 238);
      doc.rect(20, yPos, 170, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(10);
      doc.text('SUBJECT', 25, yPos + 7);
      doc.text('SCORE', 120, yPos + 7);
      doc.text('GRADE', 150, yPos + 7);
      
      // Add subject rows
      yPos += 10;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id] || 0;
        const grade = score > 0 ? calculateGrade(score, currentSchool.level) : '-';
        
        doc.setFillColor(240, 240, 240);
        doc.rect(20, yPos, 170, 10, 'F');
        doc.setTextColor(0, 0, 0);
        doc.text(subject.name, 25, yPos + 7);
        doc.text(score > 0 ? score.toString() : '-', 120, yPos + 7);
        doc.text(grade, 150, yPos + 7);
        
        yPos += 10;
      });
      
      // Add summary table
      yPos += 15;
      doc.setFillColor(67, 97, 238);
      doc.rect(20, yPos, 170, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.text('TOTAL MARKS', 25, yPos + 7);
      doc.text('AVERAGE MARK', 65, yPos + 7);
      doc.text('AGGREGATES', 120, yPos + 7);
      doc.text('FINAL GRADE/DIVISION', 150, yPos + 7);
      
      yPos += 10;
      doc.setFillColor(240, 240, 240);
      doc.rect(20, yPos, 170, 10, 'F');
      doc.setTextColor(0, 0, 0);
      doc.text(totalMarks.toString(), 25, yPos + 7);
      doc.text(average.toString(), 65, yPos + 7);
      doc.text(aggregate.toString(), 120, yPos + 7);
      doc.text(division, 150, yPos + 7);
      
      // Add teacher and head teacher remarks
      yPos += 20;
      doc.text('Class Teacher\'s Remarks:', 20, yPos);
      yPos += 10;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      
      yPos += 20;
      doc.text('Head Teacher\'s Remarks:', 20, yPos);
      yPos += 10;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      
      // Add next term information
      yPos += 20;
      doc.text('Next Term Begins On:', 20, yPos);
      yPos += 10;
      doc.line(20, yPos, 190, yPos);
      
      // Add signatures
      yPos += 30;
      doc.text('Class Teacher Signature', 40, yPos);
      doc.text('Head Teacher Signature', 105, yPos);
      doc.text('School Stamp', 150, yPos);
    }
    
    // Save the PDF
    doc.save(`Skore_Point_Report_Cards_${currentSchool.name}_${new Date().toISOString().split('T')[0]}.pdf`);
  }

  // Calculate grade based on score and school level
  function calculateGrade(score, level) {
    const gradingScale = GRADING_SCALES[level];
    
    if (level === 'primary') {
      if (score >= 90) return gradingScale[0]; // D1
      if (score >= 80) return gradingScale[1]; // D2
      if (score >= 70) return gradingScale[2]; // C3
      if (score >= 60) return gradingScale[3]; // C4
      if (score >= 50) return gradingScale[4]; // C5
      if (score >= 40) return gradingScale[5]; // C6
      if (score >= 30) return gradingScale[6]; // P7
      if (score >= 20) return gradingScale[7]; // P8
      return gradingScale[8]; // F9
    } else {
      // Secondary school grading
      if (score >= 80) return gradingScale[0]; // A
      if (score >= 70) return gradingScale[1]; // B
      if (score >= 60) return gradingScale[2]; // C
      if (score >= 50) return gradingScale[3]; // D
      return gradingScale[4]; // E
    }
  }

  // Calculate division based on average and aggregate
  function calculateDivision(average, aggregate) {
    if (currentSchool.level === 'primary') {
      if (aggregate <= 12) return 'Division 1';
      if (aggregate <= 24) return 'Division 2';
      if (aggregate <= 36) return 'Division 3';
      return 'Division 4';
    } else {
      if (average >= 80) return 'Division 1';
      if (average >= 60) return 'Division 2';
      if (average >= 40) return 'Division 3';
      return 'Division 4';
    }
  }

  // Export to Excel for class analysis
  function exportClassAnalysis() {
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Get the selected class and term period
    const classId = document.getElementById('reportClassSelect').value;
    const termPeriod = document.getElementById('reportTermPeriodSelect').value;
    
    const term = getCurrentTerm();
    
    // Get all marks from Firestore
    const marksQuery = window.firebase.query(
      window.firebase.collection(window.firebase.db, 'marks'),
      window.firebase.where('schoolId', '==', currentSchool.id),
      window.firebase.where('term', '==', term),
      window.firebase.where('termPeriod', '==', termPeriod)
    );
    
    window.firebase.getDocs(marksQuery).then(marksSnapshot => {
      const allMarks = [];
      
      marksSnapshot.forEach(doc => {
        allMarks.push({
          id: doc.id,
          ...doc.data()
        });
    });

      // Filter based on selection
      let filteredData = allMarks;
      
      if (classId) {
        const classStudents = currentStudents.filter(s => s.classId === classId);
        const studentIds = classStudents.map(s => s.id);
        filteredData = filteredData.filter(mark => studentIds.includes(mark.studentId));
      }

      // Calculate positions
      const studentsWithTotals = filteredData.map(mark => {
        const student = currentStudents.find(s => s.id === mark.studentId);
        if (!student) return null;
        
        const classObj = currentClasses.find(c => c.id === student.classId);
        
        let total = 0;
        let count = 0;
        
        currentSubjects.forEach(subject => {
          const score = mark[subject.id] || 0;
          if (score > 0) {
            total += score;
            count++;
          }
        });
        
        const average = count > 0 ? Math.round(total / count) : 0;
        const aggregate = calculateAggregate(mark);
        
        return {
          student,
          classObj,
          total,
          average,
          aggregate,
          marks: mark
        };
      }).filter(item => item !== null);
      
      // Sort by total marks (descending)
      studentsWithTotals.sort((a, b) => b.total - a.total);
      
      // Add positions
      studentsWithTotals.forEach((item, index) => {
        item.position = index + 1;
      });

      // Create worksheet data
      const subjectNames = currentSubjects.map(s => s.name);
      const headers = ['Name', ...subjectNames, 'Total', 'Avg', 'Aggregate', 'Position'];
      
      const wsData = [headers];
      
      // Add data rows
      studentsWithTotals.forEach(item => {
        const row = [item.student.name];
        
        currentSubjects.forEach(subject => {
          const score = item.marks[subject.id] || 0;
          row.push(score > 0 ? score : '-');
        });
        
        row.push(item.total);
        row.push(item.average);
        row.push(item.aggregate);
        row.push(item.position);
        
        wsData.push(row);
      });
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Class Analysis');
      
      // Save the file
      XLSX.writeFile(wb, `Skore_Point_Class_Analysis_${currentSchool.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
    }).catch(error => {
      console.error('Error exporting class analysis:', error);
      alert('Error exporting class analysis. Please try again.');
    });
  }

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const loading = document.getElementById('loginLoading');
    const errorBox = document.getElementById('loginError');

    loading.style.display = 'block';
    errorBox.style.display = 'none';

    try {
      await window.firebase.signInWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      // User is signed in, onAuthStateChanged will handle the rest
    } catch (error) {
      loading.style.display = 'none';
      errorBox.querySelector('span').textContent = error.message;
      errorBox.style.display = 'flex';
    }
  }

  // Handle registration
  async function handleRegister(e) {
    e.preventDefault();
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const subject = document.getElementById('regSubject').value;
    const password = document.getElementById('regPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    const error = document.getElementById('registerError');
    const success = document.getElementById('registerSuccess');
    const loading = document.getElementById('registerLoading');

    error.style.display = 'none';
    success.style.display = 'none';

    if (password !== confirm) {
      error.querySelector('span').textContent = 'Passwords do not match.';
      error.style.display = 'flex';
      return;
    }

    if (password.length < 6) {
      error.querySelector('span').textContent = 'Password must be at least 6 characters.';
      error.style.display = 'flex';
      return;
    }

    loading.style.display = 'block';
    
    try {
      const userCredential = await window.firebase.createUserWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      
      // Update user profile with name
      await window.firebase.updateProfile(window.firebase.auth.currentUser, {
        displayName: name
      });
      
      // Create user document in Firestore
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'users', userCredential.user.uid),
        {
          name: name,
          email: email,
          subject: subject,
          role: 'admin', // Set as admin by default
          createdAt: new Date()
        }
      );
      
      loading.style.display = 'none';
      success.style.display = 'flex';
      
      setTimeout(() => {
        showSection(dashboardSection);
      }, 2000);
    } catch (error) {
      loading.style.display = 'none';
      error.querySelector('span').textContent = error.message;
      error.style.display = 'flex';
    }
  }

  // Handle joining a school
  async function handleJoinSchool(e) {
    e.preventDefault();
    const schoolName = document.getElementById('joinSchoolName').value;
    const schoolCode = document.getElementById('joinSchoolCode').value;
    const errorBox = document.getElementById('joinSchoolError');

    try {
      // Find school by name and code
      const schoolsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'schools'),
        window.firebase.where('name', '==', schoolName),
        window.firebase.where('code', '==', schoolCode)
      );
      
      const querySnapshot = await window.firebase.getDocs(schoolsQuery);
      
      if (querySnapshot.empty) {
        errorBox.querySelector('span').textContent = 'School not found. Please check the name and code.';
        errorBox.style.display = 'flex';
        return;
      }
      
      // School found, add user to school
      const schoolDoc = querySnapshot.docs[0];
      currentSchool = {
        id: schoolDoc.id,
        ...schoolDoc.data()
      };
      
      // Update user document with school ID
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolDoc.id,
          role: 'teacher' // Set as teacher when joining a school
        }
      );
      
      // Update UI
      currentSchoolName.textContent = currentSchool.name;
      currentSchoolCode.textContent = currentSchool.code;
      document.getElementById('schoolInfo').style.display = 'block';
      manageSchoolCard.style.display = 'block';
      
      // Update school card info
      schoolCardName.textContent = currentSchool.name;
      schoolCardCode.textContent = currentSchool.code;
      
      // Load school logo if available
      if (currentSchool.logoUrl) {
        schoolLogoUrl = currentSchool.logoUrl;
        schoolCardLogo.src = currentSchool.logoUrl;
        schoolCardLogo.style.display = 'block';
        
        // Also set the logo in the management section
        managementSchoolLogo.src = currentSchool.logoUrl;
        schoolLogoContainer.style.display = 'block';
      }
      
      // Show management tabs
      managementTabs.style.display = 'flex';
      
      hideFullScreenForm();
      showSection(dashboardSection);
    } catch (error) {
      console.error('Error joining school:', error);
      errorBox.querySelector('span').textContent = 'Error joining school. Please try again.';
      errorBox.style.display = 'flex';
    }
  }

  // Handle registering a new school
  async function handleRegisterSchool(e) {
    e.preventDefault();
    const schoolName = document.getElementById('registerSchoolName').value;
    const schoolLocation = document.getElementById('registerSchoolLocation').value;
    const schoolPhone = document.getElementById('registerSchoolPhone').value;
    const schoolLevel = document.getElementById('registerSchoolLevel').value;
    const logoUrl = document.getElementById('logoUrl').value;
    const errorBox = document.getElementById('registerSchoolError');
    const successBox = document.getElementById('registerSchoolSuccess');

    if (!schoolLevel) {
      errorBox.querySelector('span').textContent = 'Please select a school level.';
      errorBox.style.display = 'flex';
      return;
    }

    try {
      // Generate a random 6-character code
      const schoolCode = generateSchoolCode();
      
      // Create school document
      const schoolRef = await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'schools'),
        {
          name: schoolName,
          location: schoolLocation,
          phone: schoolPhone,
          level: schoolLevel,
          code: schoolCode,
          logoUrl: logoUrl,
          createdBy: currentUser.uid,
          createdAt: new Date()
        }
      );
      
      // Update user document with school ID
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolRef.id,
          role: 'admin' // Set as admin when creating a school
        }
      );
      
      // Add default subjects based on school level
      const defaultSubjects = DEFAULT_SUBJECTS[schoolLevel];
      for (const subjectName of defaultSubjects) {
        await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'subjects'),
          {
            name: subjectName,
            schoolId: schoolRef.id,
            createdAt: new Date()
          }
        );
      }
      
      // Add default classes for secondary schools
      if (schoolLevel === 'secondary') {
        for (const className of DEFAULT_SECONDARY_CLASSES) {
          await window.firebase.addDoc(
            window.firebase.collection(window.firebase.db, 'classes'),
            {
              name: className,
              schoolId: schoolRef.id,
              createdAt: new Date()
            }
          );
        }
      }
      
      // Set current school
      currentSchool = {
        id: schoolRef.id,
        name: schoolName,
        location: schoolLocation,
        phone: schoolPhone,
        level: schoolLevel,
        code: schoolCode,
        logoUrl: logoUrl
      };
      
      // Update UI
      currentSchoolName.textContent = currentSchool.name;
      currentSchoolCode.textContent = currentSchool.code;
      document.getElementById('schoolInfo').style.display = 'block';
      manageSchoolCard.style.display = 'block';
      
      // Update school card info
      schoolCardName.textContent = currentSchool.name;
      schoolCardCode.textContent = currentSchool.code;
      
      // Load school logo if available
      if (currentSchool.logoUrl) {
        schoolLogoUrl = currentSchool.logoUrl;
        schoolCardLogo.src = currentSchool.logoUrl;
        schoolCardLogo.style.display = 'block';
        
        // Also set the logo in the management section
        managementSchoolLogo.src = currentSchool.logoUrl;
        schoolLogoContainer.style.display = 'block';
      }
      
      // Show management tabs
      managementTabs.style.display = 'flex';
      
      successBox.style.display = 'flex';
      
      setTimeout(() => {
        hideFullScreenForm();
        showSection(dashboardSection);
      }, 2000);
    } catch (error) {
      console.error('Error registering school:', error);
      errorBox.querySelector('span').textContent = 'Error registering school. Please try again.';
      errorBox.style.display = 'flex';
    }
  }

  // Generate a random school code
  function generateSchoolCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Handle adding a class
  async function handleAddClass(e) {
    e.preventDefault();
    const className = document.getElementById('className').value;
    
    try {
      // Add class to school
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'classes'),
        {
          name: className,
          schoolId: currentSchool.id,
          createdAt: new Date()
        }
      );
      
      // Clear form and reload classes
      document.getElementById('className').value = '';
      loadClasses();
      populateClassSelectors();
    } catch (error) {
      console.error('Error adding class:', error);
      alert('Error adding class. Please try again.');
    }
  }

  // Handle adding a subject
  async function handleAddSubject(e) {
    e.preventDefault();
    const subjectName = document.getElementById('subjectName').value;
    
    try {
      // Add subject to school
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'subjects'),
        {
          name: subjectName,
          schoolId: currentSchool.id,
          createdAt: new Date()
        }
      );
      
      // Clear form and reload subjects
      document.getElementById('subjectName').value = '';
      loadSubjects();
    } catch (error) {
      console.error('Error adding subject:', error);
      alert('Error adding subject. Please try again.');
    }
  }

  // Load classes for the current school
  async function loadClasses() {
    try {
      const classesQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'classes'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(classesQuery);
      currentClasses = [];
      const classList = document.getElementById('classList');
      classList.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const classData = {
          id: doc.id,
          ...doc.data()
        };
        currentClasses.push(classData);
        
        // Add to UI
        const classCard = document.createElement('div');
        classCard.className = 'class-card';
        classCard.innerHTML = `
          <h4>${classData.name}</h4>
          <p>Created: ${classData.createdAt.toDate().toLocaleDateString()}</p>
          <div class="card-actions">
            <button class="btn btn-success" onclick="viewClass('${doc.id}')"><i class="fas fa-eye"></i> View</button>
            <button class="btn btn-danger" onclick="deleteClass('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        classList.appendChild(classCard);
      });
    } catch (error) {
      console.error('Error loading classes:', error);
    }
  }

  // Load subjects for the current school
  async function loadSubjects() {
    try {
      const subjectsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'subjects'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(subjectsQuery);
      currentSubjects = [];
      const subjectsList = document.getElementById('subjectsList');
      subjectsList.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const subjectData = {
          id: doc.id,
          ...doc.data()
        };
        currentSubjects.push(subjectData);
        
        // Add to UI
        const subjectCard = document.createElement('div');
        subjectCard.className = 'subject-card';
        subjectCard.innerHTML = `
          <h4>${subjectData.name}</h4>
          <p>Created: ${subjectData.createdAt.toDate().toLocaleDateString()}</p>
          <div class="card-actions">
            <button class="btn btn-danger" onclick="deleteSubject('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        subjectsList.appendChild(subjectCard);
      });
    } catch (error) {
      console.error('Error loading subjects:', error);
    }
  }

  // Load students for the selected class
  async function loadStudents() {
    const classId = document.getElementById('studentClassSelect').value;
    if (!classId) return;
    
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const studentData = {
          id: doc.id,
          ...doc.data()
        };
        currentStudents.push(studentData);
        
        // Add to UI
        const studentCard = document.createElement('div');
        studentCard.className = 'student-card';
        studentCard.innerHTML = `
          <h4>${studentData.name}</h4>
          <p>Class: ${getClassName(studentData.classId)}</p>
          <div class="card-actions">
            <button class="btn btn-danger" onclick="deleteStudent('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        studentList.appendChild(studentCard);
      });
    } catch (error) {
      console.error('Error loading students:', error);
    }
  }

  // Get class name by ID
  function getClassName(classId) {
    const classObj = currentClasses.find(c => c.id === classId);
    return classObj ? classObj.name : 'Unknown Class';
  }

  // Populate class selectors in various forms
  function populateClassSelectors() {
    const studentClassSelect = document.getElementById('studentClassSelect');
    const marksClassSelect = document.getElementById('marksClassSelect');
    const reportClassSelect = document.getElementById('reportClassSelect');
    
    // Clear existing options except the first one
    while (studentClassSelect.options.length > 1) {
      studentClassSelect.remove(1);
    }
    while (marksClassSelect.options.length > 1) {
      marksClassSelect.remove(1);
    }
    while (reportClassSelect.options.length > 1) {
      reportClassSelect.remove(1);
    }
    
    // Add classes to selectors
    currentClasses.forEach(classObj => {
      const option1 = document.createElement('option');
      option1.value = classObj.id;
      option1.textContent = classObj.name;
      studentClassSelect.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = classObj.id;
      option2.textContent = classObj.name;
      marksClassSelect.appendChild(option2);
      
      const option3 = document.createElement('option');
      option3.value = classObj.id;
      option3.textContent = classObj.name;
      reportClassSelect.appendChild(option3);
    });
    
    // Add event listeners
    studentClassSelect.addEventListener('change', loadStudents);
  }

  // Handle student upload from Excel file
  async function handleStudentUpload() {
    const fileInput = document.getElementById('studentFile');
    const classId = document.getElementById('studentClassSelect').value;
    const errorBox = document.getElementById('studentUploadError');
    const successBox = document.getElementById('studentUploadSuccess');
    
    if (!classId) {
      errorBox.querySelector('span').textContent = 'Please select a class first.';
      errorBox.style.display = 'flex';
      return;
    }
    
    if (!fileInput.files.length) return;
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Assume first sheet
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        // Process each row (student)
        for (const row of jsonData) {
          // Assuming the first column contains student names
          const studentName = row[Object.keys(row)[0]];
          
          if (studentName) {
            await window.firebase.addDoc(
              window.firebase.collection(window.firebase.db, 'students'),
              {
                name: studentName,
                classId: classId,
                schoolId: currentSchool.id,
                createdAt: new Date()
              }
            );
          }
        }
        
        successBox.style.display = 'flex';
        fileInput.value = '';
        loadStudents(); // Refresh student list
      } catch (error) {
        console.error('Error processing Excel file:', error);
        errorBox.querySelector('span').textContent = 'Error processing Excel file. Please check the format.';
        errorBox.style.display = 'flex';
      }
    };
    
    reader.readAsArrayBuffer(file);
  }

  // Logout user
  async function logout() {
    try {
      await window.firebase.signOut(window.firebase.auth);
      currentUser = null;
      currentSchool = null;
      isSchoolPortalOpen = false;
      navbar.style.display = 'none';
      showSection(loginSection);
    } catch (error) {
      console.error('Error signing out:', error);
    }
  }

  // Placeholder functions for class, student and subject actions
  window.viewClass = (classId) => {
    alert(`View class ${classId}`);
  };
  
  window.deleteClass = async (classId) => {
    if (confirm('Are you sure you want to delete this class? This will also delete all students in this class.')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'classes', classId)
        );
        loadClasses();
        populateClassSelectors();
      } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please try again.');
      }
    }
  };
  
  window.deleteStudent = async (studentId) => {
    if (confirm('Are you sure you want to delete this student?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'students', studentId)
        );
        loadStudents();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student. Please try again.');
      }
    }
  };
  
  window.deleteSubject = async (subjectId) => {
    if (confirm('Are you sure you want to delete this subject?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'subjects', subjectId)
        );
        loadSubjects();
      } catch (error) {
        console.error('Error deleting subject:', error);
        alert('Error deleting subject. Please try again.');
      }
    }
  };
</script>
</body> 
</html>

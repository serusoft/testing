<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skore Point | Professional School Report Card Generator</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4361ee">
  <meta name="description" content="Professional School Report Card Generator by SERUSOFT">
  <link rel="manifest" href="/testing/manifest.json">
  <link rel="icon" href="/testing/skore-icon.jpg" type="image/jpeg">
  <link rel="apple-touch-icon" href="/testing/skore-icon.jpg">
  
  <!-- PWA Install Detection -->
  <script>
    // Check if app is installed
    window.addEventListener('appinstalled', () => {
      localStorage.setItem('pwaInstalled', 'true');
      console.log('PWA installed successfully');
    });

    // Detect standalone mode
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      localStorage.setItem('pwaInstalled', 'true');
    }
  </script>
  
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #4895ef;
      --secondary: #4cc9f0;
      --accent: #7209b7;
      --accent-light: #9d4edd;
      --dark: #0f172a;
      --darker: #0a0f1f;
      --light: #f8fafc;
      --gray: #334155;
      --gray-light: #64748b;
      --gray-lighter: #cbd5e1;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      --shadow-light: 0 5px 15px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      --card-gradient: linear-gradient(135deg, rgba(67, 97, 238, 0.08) 0%, rgba(114, 9, 183, 0.08) 100%);
      --border-radius: 12px;
      --border-radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      font-size: 15px;
      line-height: 1.5;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient);
      opacity: 0.03;
      z-index: -1;
    }

    /* Install Prompt */
    .install-prompt {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--darker);
      border: 2px solid var(--primary);
      border-radius: var(--border-radius);
      padding: 20px;
      z-index: 9999;
      box-shadow: var(--shadow);
      max-width: 350px;
      animation: slideInRight 0.5s ease-out;
      display: none;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .install-prompt h4 {
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .install-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Container Management */
    .container {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .container.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Fixed Navigation Bar */
    .navbar {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    .navbar-brand {
      font-size: 24px;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-brand i {
      font-size: 22px;
    }

    .navbar-nav {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-link {
      color: var(--light);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .nav-link.active {
      background: var(--primary);
    }

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      z-index: 1000;
      padding: 10px 0;
    }

    .mobile-bottom-nav.active {
      display: flex;
    }

    .mobile-nav-items {
      display: flex;
      justify-content: space-around;
      width: 100%;
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--gray-lighter);
      text-decoration: none;
      padding: 8px;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
      min-width: 60px;
      font-size: 12px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .mobile-nav-item:hover,
    .mobile-nav-item.active {
      color: var(--primary);
      background: rgba(67, 97, 238, 0.1);
    }

    .mobile-nav-item i {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .mobile-nav-item span {
      font-size: 11px;
      font-weight: 500;
      text-align: center;
    }

    /* Portal Exit Button - Visible only on desktop */
    .portal-exit-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--error);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      box-shadow: var(--shadow);
      display: none;
    }

    .portal-exit-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }

    /* Launch Screen */
    .launch-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .launch-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      z-index: 2;
      max-width: 800px;
      width: 100%;
      height: 100%;
    }

    .logo-wrapper {
      position: relative;
      margin-bottom: 40px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .logo {
      font-size: clamp(40px, 8vw, 80px);
      font-weight: 800;
      color: white;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
      position: relative;
      display: inline-block;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                     0 0 30px rgba(255, 255, 255, 0.4);
      }
      to {
        text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
                     0 0 50px rgba(255, 255, 255, 0.6);
      }
    }

    .tagline {
      font-size: clamp(18px, 4vw, 24px);
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 50px;
      animation: fadeIn 2s ease-in;
      font-weight: 300;
      letter-spacing: 1px;
      line-height: 1.4;
      max-width: 600px;
    }

    .loader {
      width: min(300px, 80%);
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto;
      position: relative;
    }

    .loader-bar {
      height: 100%;
      background: linear-gradient(90deg, #fff, #f0f0f0, #fff);
      background-size: 200% 100%;
      border-radius: 10px;
      animation: loading 2s ease-in-out infinite;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    @keyframes loading {
      0% {
        width: 0%;
        background-position: 0% 0%;
      }
      50% {
        width: 70%;
        background-position: 100% 0%;
      }
      100% {
        width: 100%;
        background-position: 200% 0%;
      }
    }

    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 80px;
    }

    /* Auth Containers */
    .auth-container {
      width: 100%;
      max-width: 420px;
      background: var(--darker);
      border-radius: var(--border-radius);
      padding: 40px 30px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.6s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
      margin: 20px auto;
    }

    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--gradient);
    }

    .close-auth-form {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--gray-light);
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      z-index: 10;
    }

    .close-auth-form:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--error);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-right: 30px;
    }

    .header h1 {
      font-size: 28px;
      letter-spacing: 1px;
      margin-bottom: 10px;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 700;
    }

    .header p {
      font-size: 15px;
      color: var(--gray-lighter);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    .form-group label {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--gray-lighter);
      font-weight: 500;
    }

    .form-group i {
      margin-right: 8px;
      color: var(--primary-light);
      width: 16px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray);
      border-radius: var(--border-radius-sm);
      background: var(--darker);
      color: var(--light);
      font-size: 15px;
      transition: var(--transition);
      font-family: inherit;
    }

    .form-group select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 40px;
      cursor: pointer;
    }

    .form-group select option {
      background-color: var(--darker);
      color: var(--light);
      padding: 10px;
      font-size: 15px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      background: rgba(255, 255, 255, 0.08);
    }

    .password-toggle {
      position: absolute;
      right: 15px;
      top: 40px;
      background: none;
      border: none;
      color: var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 5px;
      border-radius: 4px;
    }

    .password-toggle:hover {
      color: var(--primary);
      background: rgba(255, 255, 255, 0.05);
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-size: 15px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      touch-action: manipulation;
      user-select: none;
    }

    .btn-block {
      width: 100%;
    }

    .btn-primary {
      background: var(--gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
    }

    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover {
      background: rgba(67, 97, 238, 0.1);
      transform: translateY(-1px);
    }

    /* Alerts */
    .alert {
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in;
    }

    .error { 
      background: rgba(239, 68, 68, 0.15); 
      border: 1px solid var(--error); 
      color: var(--error); 
    }
    
    .success { 
      background: rgba(16, 185, 129, 0.15); 
      border: 1px solid var(--success); 
      color: var(--success); 
    }
    
    .warning { 
      background: rgba(245, 158, 11, 0.15); 
      border: 1px solid var(--warning); 
      color: var(--warning); 
    }
    
    .info { 
      background: rgba(59, 130, 246, 0.15); 
      border: 1px solid var(--info); 
      color: var(--info); 
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 10px;
    }

    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }

    /* Dashboard */
    .dashboard {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-header h1 {
      font-size: clamp(24px, 5vw, 32px);
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }

    .user-info {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 400px;
    }

    .user-profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--primary);
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-light);
    }

    .user-profile-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .user-role {
      font-weight: 700;
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      align-self: flex-start;
    }

    .user-role.admin {
      background: rgba(67, 97, 238, 0.2);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .user-role.teacher {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .user-name {
      font-weight: 600;
      color: var(--light);
      font-size: 18px;
    }

    .user-email {
      color: var(--gray-light);
      font-size: 14px;
    }

    .logout-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      touch-action: manipulation;
      align-self: flex-start;
      margin-top: 10px;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .card {
      background: var(--card-gradient);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--shadow-light);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
      border-color: rgba(67, 97, 238, 0.3);
    }

    .card i {
      font-size: 40px;
      margin-bottom: 20px;
      color: var(--primary-light);
    }

    .card h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--light);
    }

    .card p {
      color: var(--gray-lighter);
      font-size: 15px;
      line-height: 1.6;
    }

    .school-logo {
      max-width: 150px;
      max-height: 100px;
      margin: 15px 0;
      object-fit: contain;
      background: white;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--gray-lighter);
    }

    /* Enhanced Report Card for PDF */
    .enhanced-report-card {
      background: white;
      color: #333;
      border-radius: 0;
      padding: 30px;
      margin-top: 30px;
      border: 2px solid var(--primary);
      position: relative;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      page-break-inside: avoid;
      box-shadow: 0 0 0 20px #f8fafc;
    }

    .enhanced-report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient);
    }

    .header-section {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #4361ee;
    }

    .logo-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    .skore-logo {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .school-logo-large {
      width: 100px;
      height: 100px;
      object-fit: contain;
      border: 1px solid #e2e8f0;
      padding: 5px;
      background: white;
      border-radius: 8px;
    }

    .school-name {
      font-size: 24px;
      font-weight: 800;
      color: #4361ee;
      margin-top: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .product-info {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .report-title {
      font-size: 18px;
      font-weight: 700;
      margin: 15px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #333;
    }

    .student-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 20px;
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .student-details {
      flex: 1;
      min-width: 250px;
    }

    .student-details div {
      margin-bottom: 8px;
      font-size: 14px;
    }

    .student-details strong {
      color: #334155;
      min-width: 150px;
      display: inline-block;
    }

    .subject-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
      font-size: 13px;
      border: 1px solid #e2e8f0;
    }

    .subject-table th {
      background: #f8fafc;
      font-weight: 700;
      text-align: left;
      padding: 12px 15px;
      border-bottom: 2px solid #e2e8f0;
      color: #334155;
      border-right: 1px solid #e2e8f0;
    }

    .subject-table th:last-child {
      border-right: none;
    }

    .subject-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e2e8f0;
      border-right: 1px solid #e2e8f0;
    }

    .subject-table td:last-child {
      border-right: none;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
      font-size: 13px;
      border: 1px solid #e2e8f0;
    }

    .summary-table th {
      background: #4361ee;
      color: white;
      font-weight: 700;
      text-align: center;
      padding: 15px;
      border: 1px solid #4361ee;
    }

    .summary-table td {
      padding: 15px;
      text-align: center;
      border: 1px solid #e2e8f0;
      font-weight: 600;
      font-size: 14px;
    }

    .remarks-section {
      margin: 25px 0;
    }

    .remarks-section h4 {
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 14px;
      color: #334155;
    }

    .signature-line {
      border-top: 1px solid #333;
      margin-top: 5px;
      padding-top: 5px;
      height: 40px;
    }

    .next-term-info {
      margin-top: 20px;
      font-size: 13px;
    }

    .signature-lines {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      flex-wrap: wrap;
      gap: 20px;
      border-top: 2px solid #4361ee;
      padding-top: 20px;
    }

    .signature-box {
      text-align: center;
      flex: 1;
      min-width: 150px;
    }

    .signature-box div {
      margin-top: 40px;
      font-weight: 600;
      color: #334155;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .navbar {
        padding: 12px 15px;
      }
      
      .navbar-nav {
        display: none !important;
      }
      
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-info {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .card {
        padding: 20px !important;
      }
      
      .portal-exit-btn {
        display: none !important;
      }
      
      .enhanced-report-card {
        padding: 15px;
        margin: 10px;
      }
      
      .logo-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .skore-logo {
        width: 40px;
        height: 40px;
      }
      
      .school-logo-large {
        width: 80px;
        height: 80px;
      }
      
      .student-info {
        padding: 15px;
      }
      
      .signature-lines {
        flex-direction: column;
        gap: 30px;
      }
    }

    @media (min-width: 769px) {
      .mobile-bottom-nav {
        display: none !important;
      }
    }

    /* Utility Classes */
    .text-center {
      text-align: center;
    }

    .mb-20 {
      margin-bottom: 20px;
    }

    .mb-30 {
      margin-bottom: 30px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .mt-30 {
      margin-top: 30px;
    }

    .d-none {
      display: none;
    }

    .d-flex {
      display: flex;
    }

    .w-100 {
      width: 100%;
    }
    
    .required {
      color: var(--error);
    }
    
    /* Offline Indicator */
    .offline-indicator {
      position: fixed;
      top: 80px;
      left: 0;
      right: 0;
      background: var(--warning);
      color: var(--dark);
      text-align: center;
      padding: 10px;
      font-weight: 600;
      z-index: 999;
      display: none;
    }

    .offline-indicator.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Install Prompt -->
  <div class="install-prompt" id="installPrompt">
    <h4><i class="fas fa-download"></i> Install Skore Point</h4>
    <p>Install this app for quick access and offline use on your device.</p>
    <div class="install-buttons">
      <button class="btn btn-primary" id="installPWA">
        <i class="fas fa-plus"></i> Install App
      </button>
      <button class="btn btn-light" id="dismissInstall">
        <i class="fas fa-times"></i> Dismiss
      </button>
    </div>
  </div>

  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">
    <i class="fas fa-wifi-slash"></i> You are currently offline
  </div>

  <!-- LAUNCH SCREEN -->
  <div class="launch-screen" id="launchScreen">
    <div class="launch-container">
      <div class="logo-wrapper">
        <div class="logo">Skore Point</div>
      </div>
      <div class="tagline">Professional School Report Card Generator by SERUSOFT</div>
      <div class="loader">
        <div class="loader-bar"></div>
      </div>
    </div>
  </div>

  <!-- FIXED NAVIGATION BAR -->
  <nav class="navbar" id="navbar">
    <div class="navbar-brand">
      <i class="fas fa-graduation-cap"></i> Skore Point
    </div>
    <div class="navbar-nav">
      <a href="#" class="nav-link" id="userGuideBtn">
        <i class="fas fa-question-circle"></i> User Guide
      </a>
      <button class="logout-btn" id="desktopLogoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>

  <!-- MOBILE BOTTOM NAVIGATION -->
  <div class="mobile-bottom-nav" id="mobileBottomNav">
    <div class="mobile-nav-items">
      <button class="mobile-nav-item" data-tab="classes">
        <i class="fas fa-chalkboard"></i>
        <span>Classes</span>
      </button>
      <button class="mobile-nav-item" data-tab="students">
        <i class="fas fa-users"></i>
        <span>Students</span>
      </button>
      <button class="mobile-nav-item" data-tab="subjects">
        <i class="fas fa-book"></i>
        <span>Subjects</span>
      </button>
      <button class="mobile-nav-item" data-tab="marks">
        <i class="fas fa-edit"></i>
        <span>Marks</span>
      </button>
      <button class="mobile-nav-item" data-tab="reports">
        <i class="fas fa-chart-bar"></i>
        <span>Reports</span>
      </button>
      <button class="mobile-nav-item" id="mobileExitBtn">
        <i class="fas fa-door-open"></i>
        <span>Exit</span>
      </button>
    </div>
  </div>

  <!-- DESKTOP PORTAL EXIT BUTTON -->
  <button class="portal-exit-btn" id="portalExitBtn">
    <i class="fas fa-door-open"></i> Exit Portal
  </button>

  <!-- MAIN CONTENT CONTAINER -->
  <div class="main-container">
    
    <!-- LOGIN SECTION -->
    <div class="container" id="loginSection">
      <div class="auth-container">
        <button class="close-auth-form" id="closeLoginForm">
          <i class="fas fa-times"></i>
        </button>
        <div class="header">
          <h1>Welcome Back</h1>
          <p>Sign in to your account</p>
        </div>

        <div id="loginError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="loginErrorText"></span>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input type="email" id="loginEmail" placeholder="teacher@school.edu" required>
          </div>

          <div class="form-group">
            <label for="loginPassword">
              <i class="fas fa-lock"></i> Password
            </label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
            <button type="button" class="password-toggle" id="loginToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-sign-in-alt"></i> Sign In
          </button>
        </form>

        <div class="footer-links text-center mt-20">
          <p>
            Don't have an account? 
            <button id="goRegister">Create Account</button>
          </p>
          <p>
            <button id="forgotPassword">Forgot Password?</button>
          </p>
        </div>
      </div>
    </div>

    <!-- REGISTER SECTION -->
    <div class="container" id="registerSection">
      <div class="auth-container">
        <button class="close-auth-form" id="closeRegisterForm">
          <i class="fas fa-times"></i>
        </button>
        <div class="header">
          <h1>Create Account</h1>
          <p>Join Skore Point today</p>
        </div>

        <div id="registerError" class="alert error d-none">
          <i class="fas fa-exclamation-circle"></i>
          <span id="registerErrorText"></span>
        </div>

        <form id="registerForm">
          <div class="form-group">
            <label for="regName">
              <i class="fas fa-user"></i> Full Name
            </label>
            <input type="text" id="regName" placeholder="John Doe" required>
          </div>

          <div class="form-group">
            <label for="regEmail">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input type="email" id="regEmail" placeholder="john@school.edu" required>
          </div>

          <div class="form-group">
            <label for="regPassword">
              <i class="fas fa-lock"></i> Password
            </label>
            <input type="password" id="regPassword" placeholder="Minimum 6 characters" required minlength="6">
            <button type="button" class="password-toggle" id="registerToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <div class="form-group">
            <label for="confirmPassword">
              <i class="fas fa-lock"></i> Confirm Password
            </label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <button type="button" class="password-toggle" id="confirmToggle">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-user-plus"></i> Create Account
          </button>
        </form>

        <div class="footer-links text-center mt-20">
          <p>
            Already have an account? 
            <button id="goLogin">Sign In</button>
          </p>
        </div>
      </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div class="container" id="dashboardSection">
      <div class="dashboard">
        <div class="dashboard-header">
          <h1>Dashboard</h1>
          <div class="user-info" id="userInfoCard">
            <!-- Dynamic content -->
          </div>
        </div>

        <div class="dashboard-cards">
          <!-- School Portal Card -->
          <div class="card" id="manageSchoolCard" style="display: none;">
            <i class="fas fa-school"></i>
            <h3>School Portal</h3>
            <p>Access your school's management portal to manage classes, students, and generate reports.</p>
            <div id="schoolCardInfo" class="mt-30">
              <img id="schoolCardLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
              <h4 id="schoolCardName"></h4>
              <p>Code: <strong id="schoolCardCode"></strong></p>
              <div class="mt-20">
                <button class="btn btn-success btn-block" id="openSchoolPortalBtn">
                  <i class="fas fa-door-open"></i> Enter Portal
                </button>
              </div>
            </div>
          </div>

          <div class="card" id="joinSchoolCard">
            <i class="fas fa-user-plus"></i>
            <h3>Join School</h3>
            <p>Join an existing school using the school name and unique access code provided by your administrator.</p>
            <button class="btn btn-secondary btn-block mt-20" id="joinSchoolBtn">
              <i class="fas fa-sign-in-alt"></i> Join School
            </button>
          </div>

          <div class="card" id="registerSchoolCard">
            <i class="fas fa-plus-circle"></i>
            <h3>Register School</h3>
            <p>Create a new school on Skore Point and become the administrator. Get a unique code for other teachers to join.</p>
            <button class="btn btn-primary btn-block mt-20" id="registerSchoolBtn">
              <i class="fas fa-school"></i> Register School
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCHOOL MANAGEMENT SECTION -->
    <div class="container" id="schoolManagementSection">
      <div class="school-management">
        <div class="management-header">
          <div>
            <h2 id="managementSchoolName">School Name</h2>
            <div class="school-code mt-10">
              School Code: <span id="managementSchoolCode"></span>
            </div>
          </div>
          <img id="managementSchoolLogo" class="school-logo" src="" alt="School Logo" style="display:none;">
        </div>

        <!-- Desktop Tabs -->
        <div class="management-tabs" id="managementTabs">
          <button class="tab active" data-tab="classes">
            <i class="fas fa-chalkboard"></i> Classes
          </button>
          <button class="tab" data-tab="students">
            <i class="fas fa-users"></i> Students
          </button>
          <button class="tab" data-tab="subjects">
            <i class="fas fa-book"></i> Subjects
          </button>
          <button class="tab" data-tab="marks">
            <i class="fas fa-edit"></i> Enter Marks
          </button>
          <button class="tab" data-tab="reports">
            <i class="fas fa-chart-bar"></i> Reports & Analytics
          </button>
        </div>

        <!-- Reports Tab Content -->
        <div class="tab-content active" id="reportsTab">
          <div class="reports-container">
            <div class="report-filters">
              <h4 class="mb-20">Generate Report</h4>
              <div class="filter-grid">
                <div class="form-group">
                  <label><i class="fas fa-chalkboard"></i> Class</label>
                  <select id="reportClassSelect" class="w-100">
                    <option value="">All Classes</option>
                  </select>
                </div>
                <div class="form-group">
                  <label><i class="fas fa-user-graduate"></i> Student</label>
                  <select id="reportStudentSelect" class="w-100" disabled>
                    <option value="">All Students</option>
                  </select>
                </div>
                <div class="form-group">
                  <label><i class="fas fa-calendar-alt"></i> Term</label>
                  <select id="reportTermSelect" class="w-100">
                    <option value="beginning">Beginning of Term</option>
                    <option value="mid">Mid Term</option>
                    <option value="end">End of Term</option>
                  </select>
                </div>
              </div>
              <div class="report-actions">
                <button class="btn btn-primary" id="generateReportBtn">
                  <i class="fas fa-chart-bar"></i> Generate Report
                </button>
                <button class="btn btn-success d-none" id="exportPDFBtn">
                  <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button class="btn btn-warning d-none" id="exportExcelBtn">
                  <i class="fas fa-file-excel"></i> Export Excel
                </button>
              </div>
            </div>

            <div id="reportPreview" class="d-none">
              <h4 class="mb-20">Report Preview</h4>
              <div id="enhancedReportCard" class="enhanced-report-card">
                <!-- Dynamic report card -->
              </div>
            </div>

            <div class="empty-state" id="reportsEmptyState">
              <i class="fas fa-chart-line"></i>
              <h3>No Data Available</h3>
              <p>Select filters and generate a report to see student performance analytics.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="joinSchoolModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Join a School</h3>
        <button class="close-modal" id="closeJoinSchoolModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="joinSchoolForm">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="joinSchoolName" placeholder="Enter exact school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-key"></i> School Code</label>
          <input type="text" id="joinSchoolCode" placeholder="6-digit school code" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-sign-in-alt"></i> Join School
        </button>
      </form>
    </div>
  </div>

  <div class="modal" id="registerSchoolModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Register a School</h3>
        <button class="close-modal" id="closeRegisterSchoolModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="registerSchoolForm">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="registerSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> School Location</label>
          <input type="text" id="registerSchoolLocation" placeholder="City, Country" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-plus-circle"></i> Register School
        </button>
      </form>
    </div>
  </div>

  <div class="modal" id="forgotPasswordModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Reset Password</h3>
        <button class="close-modal" id="closeForgotPasswordModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="forgotPasswordForm">
        <div class="form-group">
          <label><i class="fas fa-envelope"></i> Email Address</label>
          <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i class="fas fa-key"></i> Send Reset Link
        </button>
      </form>
    </div>
  </div>

<script>
  // Global State
  let currentUser = null;
  let currentUserData = null;
  let currentSchool = null;
  let currentClasses = [];
  let currentStudents = [];
  let currentSubjects = [];
  let isSchoolPortalOpen = false;
  let isMobileView = window.innerWidth <= 768;
  let deferredPrompt = null;
  let isAppInstalled = false;

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyASIdYdW94ZJQXsc6BN9Bc28eou0yjPE1U",
    authDomain: "upgrade-16092.firebaseapp.com",
    projectId: "upgrade-16092",
    storageBucket: "upgrade-16092.firebasestorage.app",
    messagingSenderId: "466381827996",
    appId: "1:466381827996:web:6f030e68c526e734a26259",
    measurementId: "G-RGCH68RJ8H"
  };

  // Initialize Firebase
  async function initializeFirebase() {
    try {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js');
      const { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js');
      const { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, getDoc, updateDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Store in window for global access
      window.firebase = {
        auth,
        db,
        firestore: {
          collection, addDoc, getDocs, query, where, doc, setDoc, getDoc, updateDoc, deleteDoc
        },
        authMethods: {
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          signOut,
          sendPasswordResetEmail
        }
      };

      console.log('Firebase initialized successfully');
      return true;
    } catch (error) {
      console.error('Firebase initialization error:', error);
      return false;
    }
  }

  // DOM Elements
  const elements = {
    installPrompt: document.getElementById('installPrompt'),
    offlineIndicator: document.getElementById('offlineIndicator'),
    launchScreen: document.getElementById('launchScreen'),
    navbar: document.getElementById('navbar'),
    mobileBottomNav: document.getElementById('mobileBottomNav'),
    portalExitBtn: document.getElementById('portalExitBtn'),
    mobileExitBtn: document.getElementById('mobileExitBtn'),
    
    // Containers
    loginSection: document.getElementById('loginSection'),
    registerSection: document.getElementById('registerSection'),
    dashboardSection: document.getElementById('dashboardSection'),
    schoolManagementSection: document.getElementById('schoolManagementSection'),
    
    // Modals
    joinSchoolModal: document.getElementById('joinSchoolModal'),
    registerSchoolModal: document.getElementById('registerSchoolModal'),
    forgotPasswordModal: document.getElementById('forgotPasswordModal'),
    
    // Buttons
    installPWA: document.getElementById('installPWA'),
    dismissInstall: document.getElementById('dismissInstall'),
    goRegister: document.getElementById('goRegister'),
    goLogin: document.getElementById('goLogin'),
    joinSchoolBtn: document.getElementById('joinSchoolBtn'),
    registerSchoolBtn: document.getElementById('registerSchoolBtn'),
    openSchoolPortalBtn: document.getElementById('openSchoolPortalBtn'),
    desktopLogoutBtn: document.getElementById('desktopLogoutBtn'),
    userGuideBtn: document.getElementById('userGuideBtn'),
    forgotPassword: document.getElementById('forgotPassword'),
    
    // Forms
    loginForm: document.getElementById('loginForm'),
    registerForm: document.getElementById('registerForm'),
    joinSchoolForm: document.getElementById('joinSchoolForm'),
    registerSchoolForm: document.getElementById('registerSchoolForm'),
    forgotPasswordForm: document.getElementById('forgotPasswordForm'),
    
    // Report elements
    generateReportBtn: document.getElementById('generateReportBtn'),
    exportPDFBtn: document.getElementById('exportPDFBtn'),
    exportExcelBtn: document.getElementById('exportExcelBtn'),
    reportClassSelect: document.getElementById('reportClassSelect'),
    reportStudentSelect: document.getElementById('reportStudentSelect'),
    reportTermSelect: document.getElementById('reportTermSelect'),
    enhancedReportCard: document.getElementById('enhancedReportCard'),
    reportsEmptyState: document.getElementById('reportsEmptyState'),
    reportPreview: document.getElementById('reportPreview')
  };

  // Initialize application
  document.addEventListener('DOMContentLoaded', async () => {
    // Check mobile view
    checkMobileView();
    window.addEventListener('resize', checkMobileView);
    
    // Show launch screen
    elements.launchScreen.style.display = 'flex';
    
    try {
      // Initialize Firebase
      const firebaseInitialized = await initializeFirebase();
      
      if (firebaseInitialized) {
        // Setup auth state listener
        window.firebase.auth.onAuthStateChanged(async (user) => {
          if (user) {
            currentUser = user;
            await loadUserData(user.uid);
            showContainer('dashboardSection');
            hideLaunchScreen();
          } else {
            hideLaunchScreen();
            showContainer('loginSection');
          }
        });
      }
    } catch (error) {
      console.error('App initialization error:', error);
      hideLaunchScreen();
      showContainer('loginSection');
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Setup PWA
    setupPWA();
    
    // Check if already installed
    if (localStorage.getItem('pwaInstalled') === 'true') {
      isAppInstalled = true;
    }
    
    // Hide launch screen after 2 seconds
    setTimeout(hideLaunchScreen, 2000);
  });

  // Setup PWA
  function setupPWA() {
    // Listen for beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install prompt after 5 seconds if not already installed
      setTimeout(() => {
        if (!isAppInstalled && deferredPrompt) {
          showInstallPrompt();
        }
      }, 5000);
    });
    
    // Listen for app installed event
    window.addEventListener('appinstalled', () => {
      isAppInstalled = true;
      localStorage.setItem('pwaInstalled', 'true');
      hideInstallPrompt();
    });
    
    // Check online/offline status
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
    
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/testing/sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }
  }

  // Show install prompt
  function showInstallPrompt() {
    elements.installPrompt.style.display = 'block';
  }

  // Hide install prompt
  function hideInstallPrompt() {
    elements.installPrompt.style.display = 'none';
  }

  // Update online status
  function updateOnlineStatus() {
    if (navigator.onLine) {
      elements.offlineIndicator.classList.remove('show');
    } else {
      elements.offlineIndicator.classList.add('show');
    }
  }

  // Check mobile view
  function checkMobileView() {
    isMobileView = window.innerWidth <= 768;
    if (isSchoolPortalOpen) {
      if (isMobileView) {
        elements.mobileBottomNav.style.display = 'flex';
        elements.mobileBottomNav.classList.add('active');
        elements.portalExitBtn.style.display = 'none';
      } else {
        elements.mobileBottomNav.style.display = 'none';
        elements.mobileBottomNav.classList.remove('active');
        elements.portalExitBtn.style.display = 'flex';
      }
    }
  }

  // Load user data
  async function loadUserData(userId) {
    try {
      const userDoc = await window.firebase.firestore.getDoc(
        window.firebase.firestore.doc(window.firebase.db, 'users', userId)
      );
      
      if (userDoc.exists()) {
        currentUserData = userDoc.data();
        updateUserProfileCard();
        
        if (currentUserData.schoolId) {
          await loadSchoolData(currentUserData.schoolId);
        } else {
          document.getElementById('manageSchoolCard').style.display = 'none';
        }
      } else {
        // Create user document
        await window.firebase.firestore.setDoc(
          window.firebase.firestore.doc(window.firebase.db, 'users', userId),
          {
            name: currentUser.displayName || 'User',
            email: currentUser.email,
            role: 'teacher',
            createdAt: new Date()
          }
        );
        
        currentUserData = {
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          role: 'teacher'
        };
        
        updateUserProfileCard();
      }
    } catch (error) {
      console.error('Error loading user data:', error);
    }
  }

  // Update user profile card
  function updateUserProfileCard() {
    const userInfoCard = document.getElementById('userInfoCard');
    if (!userInfoCard) return;
    
    const initials = getInitials(currentUserData.name || 'U');
    const role = currentUserData.role || 'teacher';
    const name = currentUserData.name || 'User';
    const email = currentUser.email || '';
    
    userInfoCard.innerHTML = `
      <div class="user-profile-img">
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">${initials}</div>
      </div>
      <div class="user-details">
        <span class="user-role ${role}">${role.toUpperCase()}</span>
        <span class="user-name">${name}</span>
        <span class="user-email">${email}</span>
        <button class="logout-btn mobile-only" id="mobileLogoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    `;
    
    // Re-attach logout button event
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    if (mobileLogoutBtn) {
      mobileLogoutBtn.addEventListener('click', handleLogout);
    }
  }

  // Get initials
  function getInitials(name) {
    if (!name) return 'U';
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
  }

  // Load school data
  async function loadSchoolData(schoolId) {
    try {
      const schoolDoc = await window.firebase.firestore.getDoc(
        window.firebase.firestore.doc(window.firebase.db, 'schools', schoolId)
      );
      
      if (schoolDoc.exists()) {
        currentSchool = {
          id: schoolDoc.id,
          ...schoolDoc.data()
        };
        
        // Update dashboard school card
        document.getElementById('manageSchoolCard').style.display = 'block';
        document.getElementById('schoolCardName').textContent = currentSchool.name;
        document.getElementById('schoolCardCode').textContent = currentSchool.code;
        
        // Update school logo
        if (currentSchool.logoUrl) {
          document.getElementById('schoolCardLogo').src = currentSchool.logoUrl;
          document.getElementById('schoolCardLogo').style.display = 'block';
        }
        
        // Load school data
        await loadClasses();
        await loadStudents();
        await loadSubjects();
      }
    } catch (error) {
      console.error('Error loading school data:', error);
    }
  }

  // Setup event listeners
  function setupEventListeners() {
    // Navigation
    elements.goRegister.addEventListener('click', () => showContainer('registerSection'));
    elements.goLogin.addEventListener('click', () => showContainer('loginSection'));
    elements.joinSchoolBtn.addEventListener('click', () => elements.joinSchoolModal.classList.add('active'));
    elements.registerSchoolBtn.addEventListener('click', () => elements.registerSchoolModal.classList.add('active'));
    elements.openSchoolPortalBtn.addEventListener('click', openSchoolPortal);
    elements.desktopLogoutBtn.addEventListener('click', handleLogout);
    elements.userGuideBtn.addEventListener('click', showUserGuide);
    elements.forgotPassword.addEventListener('click', () => elements.forgotPasswordModal.classList.add('active'));
    
    // Exit buttons
    elements.portalExitBtn.addEventListener('click', closeSchoolPortal);
    elements.mobileExitBtn.addEventListener('click', closeSchoolPortal);
    
    // PWA install
    elements.installPWA.addEventListener('click', installPWA);
    elements.dismissInstall.addEventListener('click', hideInstallPrompt);
    
    // Form submissions
    elements.loginForm.addEventListener('submit', handleLogin);
    elements.registerForm.addEventListener('submit', handleRegister);
    elements.joinSchoolForm.addEventListener('submit', handleJoinSchool);
    elements.registerSchoolForm.addEventListener('submit', handleRegisterSchool);
    elements.forgotPasswordForm.addEventListener('submit', handleForgotPassword);
    
    // Reports
    elements.generateReportBtn.addEventListener('submit', generateReport);
    elements.exportPDFBtn.addEventListener('submit', exportReportCard);
    elements.exportExcelBtn.addEventListener('submit', exportClassAnalysis);
    elements.reportClassSelect.addEventListener('change', updateReportStudentSelect);
    
    // Close modals
    document.querySelectorAll('.close-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.closest('.modal').classList.remove('active');
      });
    });
    
    // Mobile tabs
    document.querySelectorAll('.mobile-nav-item[data-tab]').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const tabId = item.dataset.tab;
        
        // Update active state
        document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // Switch tab
        switchTab(tabId);
      });
    });
    
    // Desktop tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
      });
    });
  }

  // Install PWA
  async function installPWA() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('User accepted the install prompt');
      }
      deferredPrompt = null;
      hideInstallPrompt();
    }
  }

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
      await window.firebase.authMethods.signInWithEmailAndPassword(
        window.firebase.auth, email, password
      );
    } catch (error) {
      alert('Login failed: ' + error.message);
    }
  }

  // Handle registration
  async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (password !== confirmPassword) {
      alert('Passwords do not match');
      return;
    }
    
    try {
      const userCredential = await window.firebase.authMethods.createUserWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      
      // Create user document
      await window.firebase.firestore.setDoc(
        window.firebase.firestore.doc(window.firebase.db, 'users', userCredential.user.uid),
        {
          name: name,
          email: email,
          role: 'teacher',
          createdAt: new Date()
        }
      );
      
      alert('Account created successfully!');
      showContainer('dashboardSection');
      
    } catch (error) {
      alert('Registration failed: ' + error.message);
    }
  }

  // Handle join school
  async function handleJoinSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('joinSchoolName').value.trim();
    const schoolCode = document.getElementById('joinSchoolCode').value.trim().toUpperCase();
    
    try {
      // Find school
      const schoolsQuery = window.firebase.firestore.query(
        window.firebase.firestore.collection(window.firebase.db, 'schools'),
        window.firebase.firestore.where('name', '==', schoolName),
        window.firebase.firestore.where('code', '==', schoolCode)
      );
      
      const querySnapshot = await window.firebase.firestore.getDocs(schoolsQuery);
      
      if (querySnapshot.empty) {
        alert('School not found. Please check the name and code.');
        return;
      }
      
      const schoolDoc = querySnapshot.docs[0];
      currentSchool = {
        id: schoolDoc.id,
        ...schoolDoc.data()
      };
      
      // Update user document
      await window.firebase.firestore.updateDoc(
        window.firebase.firestore.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolDoc.id
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolDoc.id;
      
      // Update UI
      document.getElementById('schoolCardName').textContent = currentSchool.name;
      document.getElementById('schoolCardCode').textContent = currentSchool.code;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Load school data
      await loadSchoolData(schoolDoc.id);
      
      // Hide modal
      elements.joinSchoolModal.classList.remove('active');
      
      alert(`Successfully joined ${currentSchool.name}!`);
      
    } catch (error) {
      console.error('Error joining school:', error);
      alert('Error joining school. Please try again.');
    }
  }

  // Handle register school
  async function handleRegisterSchool(e) {
    e.preventDefault();
    
    const schoolName = document.getElementById('registerSchoolName').value.trim();
    const schoolLocation = document.getElementById('registerSchoolLocation').value.trim();
    
    try {
      // Generate school code
      const schoolCode = generateSchoolCode();
      
      // Create school document
      const schoolData = {
        name: schoolName,
        location: schoolLocation,
        code: schoolCode,
        createdBy: currentUser.uid,
        admins: [currentUser.uid],
        teachers: [currentUser.uid],
        createdAt: new Date()
      };
      
      const schoolRef = await window.firebase.firestore.addDoc(
        window.firebase.firestore.collection(window.firebase.db, 'schools'),
        schoolData
      );
      
      // Update user document
      await window.firebase.firestore.updateDoc(
        window.firebase.firestore.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolRef.id,
          role: 'admin'
        }
      );
      
      // Update current user data
      currentUserData.schoolId = schoolRef.id;
      currentUserData.role = 'admin';
      
      // Update user profile card
      updateUserProfileCard();
      
      // Add default subjects and classes
      await addDefaultData(schoolRef.id);
      
      // Update current school data
      currentSchool = {
        id: schoolRef.id,
        ...schoolData
      };
      
      // Update UI
      document.getElementById('schoolCardName').textContent = schoolName;
      document.getElementById('schoolCardCode').textContent = schoolCode;
      document.getElementById('manageSchoolCard').style.display = 'block';
      
      // Hide modal
      elements.registerSchoolModal.classList.remove('active');
      
      alert('School registered successfully!');
      
    } catch (error) {
      console.error('Error registering school:', error);
      alert('Error registering school. Please try again.');
    }
  }

  // Handle forgot password
  async function handleForgotPassword(e) {
    e.preventDefault();
    
    const email = document.getElementById('forgotPasswordEmail').value;
    
    try {
      await window.firebase.authMethods.sendPasswordResetEmail(window.firebase.auth, email);
      alert('Password reset email sent! Check your inbox.');
      elements.forgotPasswordModal.classList.remove('active');
    } catch (error) {
      console.error('Error sending password reset:', error);
      alert('Error sending password reset email. Please try again.');
    }
  }

  // Add default data
  async function addDefaultData(schoolId) {
    // Add default subjects
    const defaultSubjects = ['Mathematics', 'English', 'Science', 'Social Studies'];
    
    for (const subjectName of defaultSubjects) {
      await window.firebase.firestore.addDoc(
        window.firebase.firestore.collection(window.firebase.db, 'subjects'),
        {
          name: subjectName,
          schoolId: schoolId,
          createdAt: new Date()
        }
      );
    }
    
    // Add default classes
    const defaultClasses = ['Primary 1', 'Primary 2', 'Primary 3', 'Primary 4'];
    
    for (const className of defaultClasses) {
      await window.firebase.firestore.addDoc(
        window.firebase.firestore.collection(window.firebase.db, 'classes'),
        {
          name: className,
          schoolId: schoolId,
          createdAt: new Date()
        }
      );
    }
  }

  // Load classes
  async function loadClasses() {
    if (!currentSchool) return;
    
    try {
      const classesQuery = window.firebase.firestore.query(
        window.firebase.firestore.collection(window.firebase.db, 'classes'),
        window.firebase.firestore.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.firestore.getDocs(classesQuery);
      currentClasses = [];
      
      querySnapshot.forEach(doc => {
        currentClasses.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      // Update class selectors
      updateClassSelectors();
      
    } catch (error) {
      console.error('Error loading classes:', error);
    }
  }

  // Load students
  async function loadStudents() {
    if (!currentSchool) return;
    
    try {
      const studentsQuery = window.firebase.firestore.query(
        window.firebase.firestore.collection(window.firebase.db, 'students'),
        window.firebase.firestore.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.firestore.getDocs(studentsQuery);
      currentStudents = [];
      
      querySnapshot.forEach(doc => {
        currentStudents.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
    } catch (error) {
      console.error('Error loading students:', error);
    }
  }

  // Load subjects
  async function loadSubjects() {
    if (!currentSchool) return;
    
    try {
      const subjectsQuery = window.firebase.firestore.query(
        window.firebase.firestore.collection(window.firebase.db, 'subjects'),
        window.firebase.firestore.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.firestore.getDocs(subjectsQuery);
      currentSubjects = [];
      
      querySnapshot.forEach(doc => {
        currentSubjects.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
    } catch (error) {
      console.error('Error loading subjects:', error);
    }
  }

  // Update class selectors
  function updateClassSelectors() {
    const select = elements.reportClassSelect;
    
    // Clear existing options except first
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    // Add classes
    currentClasses.forEach(classObj => {
      const option = document.createElement('option');
      option.value = classObj.id;
      option.textContent = classObj.name;
      select.appendChild(option);
    });
  }

  // Generate school code
  function generateSchoolCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Open school portal
  function openSchoolPortal() {
    isSchoolPortalOpen = true;
    
    // Update management section
    document.getElementById('managementSchoolName').textContent = currentSchool.name;
    document.getElementById('managementSchoolCode').textContent = currentSchool.code;
    
    // Update school logo
    if (currentSchool.logoUrl) {
      const managementLogo = document.getElementById('managementSchoolLogo');
      managementLogo.src = currentSchool.logoUrl;
      managementLogo.style.display = 'block';
    }
    
    // Show exit button
    if (isMobileView) {
      elements.mobileBottomNav.style.display = 'flex';
      elements.mobileBottomNav.classList.add('active');
    } else {
      elements.portalExitBtn.style.display = 'flex';
    }
    
    // Show management section
    showContainer('schoolManagementSection');
    
    // Load initial data
    loadClasses();
  }

  // Close school portal
  function closeSchoolPortal() {
    isSchoolPortalOpen = false;
    
    // Hide exit button
    elements.portalExitBtn.style.display = 'none';
    
    // Hide mobile bottom nav
    elements.mobileBottomNav.style.display = 'none';
    elements.mobileBottomNav.classList.remove('active');
    
    // Show dashboard
    showContainer('dashboardSection');
  }

  // Switch tab
  function switchTab(tabId) {
    // Update active tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.mobile-nav-item').forEach(m => m.classList.remove('active'));
    
    // Activate selected tab
    const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
    const selectedMobileTab = document.querySelector(`.mobile-nav-item[data-tab="${tabId}"]`);
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedMobileTab) selectedMobileTab.classList.add('active');
    
    const tabContent = document.getElementById(`${tabId}Tab`);
    if (tabContent) {
      tabContent.classList.add('active');
    }
  }

  // Update report student select
  async function updateReportStudentSelect() {
    const classId = elements.reportClassSelect.value;
    const select = elements.reportStudentSelect;
    
    // Clear existing options
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    if (!classId) {
      select.disabled = true;
      return;
    }
    
    select.disabled = false;
    
    try {
      const studentsQuery = window.firebase.firestore.query(
        window.firebase.firestore.collection(window.firebase.db, 'students'),
        window.firebase.firestore.where('classId', '==', classId),
        window.firebase.firestore.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.firestore.getDocs(studentsQuery);
      
      querySnapshot.forEach(doc => {
        const student = { id: doc.id, ...doc.data() };
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        select.appendChild(option);
      });
      
    } catch (error) {
      console.error('Error loading students for reports:', error);
    }
  }

  // Generate report
  async function generateReport() {
    const classId = elements.reportClassSelect.value;
    const studentId = elements.reportStudentSelect.value;
    const term = elements.reportTermSelect.value;
    
    try {
      if (studentId) {
        // Generate student report
        await generateStudentReport(studentId, term);
      } else if (classId) {
        // Generate class report
        await generateClassReport(classId, term);
      } else {
        // Generate school report
        await generateSchoolReport(term);
      }
      
    } catch (error) {
      console.error('Error generating report:', error);
      elements.reportsEmptyState.classList.remove('d-none');
      elements.reportPreview.classList.add('d-none');
      elements.exportPDFBtn.classList.add('d-none');
      elements.exportExcelBtn.classList.add('d-none');
    }
  }

  // Generate student report
  async function generateStudentReport(studentId, term) {
    const student = currentStudents.find(s => s.id === studentId);
    if (!student) return;
    
    const classObj = currentClasses.find(c => c.id === student.classId);
    
    // Get marks
    let marks = {};
    try {
      const marksDoc = await window.firebase.firestore.getDoc(
        window.firebase.firestore.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
      );
      
      if (marksDoc.exists()) {
        marks = marksDoc.data();
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
    
    // Calculate statistics
    let totalMarks = 0;
    let subjectCount = 0;
    const subjectScores = [];
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        totalMarks += score;
        subjectCount++;
        subjectScores.push({
          name: subject.name,
          score: score,
          grade: calculateGrade(score)
        });
      }
    });
    
    const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
    const aggregate = calculateAggregate(marks);
    const division = calculateDivision(average);
    
    // Generate report card HTML
    elements.enhancedReportCard.innerHTML = `
      <div class="header-section">
        <div class="logo-row">
          <img src="/testing/skore-icon.jpg" alt="Skore Point" class="skore-logo">
          <img src="${currentSchool.logoUrl || '/testing/skore-icon.jpg'}" alt="School Logo" class="school-logo-large">
        </div>
        <div class="school-name">${currentSchool.name}</div>
        <div class="product-info">A product of SERUSOFT</div>
        <div class="report-title">END OF TERM 3 STUDENT PROGRESS REPORT</div>
      </div>
      
      <div class="student-info">
        <div class="student-details">
          <div><strong>Student Name:</strong> ${student.name}</div>
          <div><strong>Class:</strong> ${classObj ? classObj.name : 'N/A'}</div>
        </div>
        <div class="student-details">
          <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
        </div>
      </div>
      
      ${subjectScores.length > 0 ? `
        <table class="subject-table">
          <thead>
            <tr>
              <th>SUBJECT</th>
              <th>SCORE</th>
              <th>GRADE</th>
            </tr>
          </thead>
          <tbody>
            ${subjectScores.map(score => `
              <tr>
                <td>${score.name}</td>
                <td>${score.score}</td>
                <td>${score.grade}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        
        <table class="summary-table">
          <thead>
            <tr>
              <th>TOTAL MARKS</th>
              <th>AVERAGE MARK</th>
              <th>AGGREGATES</th>
              <th>FINAL GRADE/DIVISION</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${totalMarks}</td>
              <td>${average}</td>
              <td>${aggregate}</td>
              <td>${division}</td>
            </tr>
          </tbody>
        </table>
      ` : '<p class="text-center" style="color: #666; margin: 20px 0;">No marks entered for this student.</p>'}
      
      <div class="remarks-section">
        <h4>Class Teacher's Remarks:</h4>
        <div class="signature-line"></div>
        <div class="signature-line"></div>
        
        <h4 style="margin-top: 15px;">Head Teacher's Remarks:</h4>
        <div class="signature-line"></div>
        
        <div class="next-term-info">
          <p><strong>Next Term Begins On:</strong> ________________________________</p>
        </div>
      </div>
      
      <div class="signature-lines">
        <div class="signature-box">
          <div class="signature-line" style="width: 80%; margin: 0 auto;"></div>
          <div>Class Teacher Signature</div>
        </div>
        <div class="signature-box">
          <div class="signature-line" style="width: 80%; margin: 0 auto;"></div>
          <div>Head Teacher Signature</div>
        </div>
        <div class="signature-box">
          <div style="width: 80px; height: 80px; border: 2px dashed #666; margin: 0 auto;"></div>
          <div>School Stamp</div>
        </div>
      </div>
    `;
    
    // Show report
    elements.reportsEmptyState.classList.add('d-none');
    elements.reportPreview.classList.remove('d-none');
    elements.exportPDFBtn.classList.remove('d-none');
    elements.exportExcelBtn.classList.add('d-none');
  }

  // Generate class report
  async function generateClassReport(classId, term) {
    const classObj = currentClasses.find(c => c.id === classId);
    
    // Get all marks for this class
    const marksData = [];
    const classStudents = currentStudents.filter(s => s.classId === classId);
    
    for (const student of classStudents) {
      try {
        const marksDoc = await window.firebase.firestore.getDoc(
          window.firebase.firestore.doc(window.firebase.db, 'marks', `${student.id}_${term}`)
        );
        
        if (marksDoc.exists()) {
          marksData.push({
            studentId: student.id,
            ...marksDoc.data()
          });
        }
      } catch (error) {
        console.error('Error loading marks for student:', student.id, error);
      }
    }
    
    // Calculate class statistics
    const studentAverages = [];
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        studentAverages.push(total / count);
      }
    });
    
    const totalStudents = classStudents.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    // Generate class report HTML
    elements.enhancedReportCard.innerHTML = `
      <div class="header-section">
        <div class="logo-row">
          <img src="/testing/skore-icon.jpg" alt="Skore Point" class="skore-logo">
          <img src="${currentSchool.logoUrl || '/testing/skore-icon.jpg'}" alt="School Logo" class="school-logo-large">
        </div>
        <div class="school-name">${currentSchool.name}</div>
        <div class="product-info">A product of SERUSOFT</div>
        <div class="report-title">CLASS PERFORMANCE REPORT - TERM 3</div>
      </div>
      
      <div class="student-info">
        <div class="student-details">
          <div><strong>Class:</strong> ${classObj ? classObj.name : 'N/A'}</div>
          <div><strong>Total Students:</strong> ${totalStudents}</div>
        </div>
        <div class="student-details">
          <div><strong>Term:</strong> End of Term 3</div>
          <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">Class Statistics</h4>
      <table class="subject-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Class Average</td>
            <td>${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td>${highScore}%</td>
            <td>Excellent</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td>${lowScore}%</td>
            <td>Needs Improvement</td>
          </tr>
          <tr>
            <td>Students Assessed</td>
            <td>${studentAverages.length}</td>
            <td>${studentAverages.length}/${totalStudents} students</td>
          </tr>
        </tbody>
      </table>
      
      <div class="remarks-section">
        <h4>Class Teacher's Remarks:</h4>
        <div class="signature-line"></div>
        <div class="signature-line"></div>
      </div>
    `;
    
    // Show report
    elements.reportsEmptyState.classList.add('d-none');
    elements.reportPreview.classList.remove('d-none');
    elements.exportPDFBtn.classList.add('d-none');
    elements.exportExcelBtn.classList.remove('d-none');
  }

  // Generate school report
  async function generateSchoolReport(term) {
    // Calculate school statistics
    const studentAverages = [];
    const classAverages = {};
    
    currentClasses.forEach(classObj => {
      classAverages[classObj.id] = [];
    });
    
    // Get all marks
    const marksQuery = window.firebase.firestore.query(
      window.firebase.firestore.collection(window.firebase.db, 'marks'),
      window.firebase.firestore.where('schoolId', '==', currentSchool.id),
      window.firebase.firestore.where('term', '==', term)
    );
    
    const marksSnapshot = await window.firebase.firestore.getDocs(marksQuery);
    const marksData = [];
    
    marksSnapshot.forEach(doc => {
      marksData.push({ id: doc.id, ...doc.data() });
    });
    
    marksData.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id];
        if (score !== undefined && score > 0) {
          total += score;
          count++;
        }
      });
      
      if (count > 0) {
        const average = total / count;
        studentAverages.push(average);
        
        // Add to class average
        const student = currentStudents.find(s => s.id === mark.studentId);
        if (student && classAverages[student.classId]) {
          classAverages[student.classId].push(average);
        }
      }
    });
    
    // Calculate statistics
    const totalStudents = currentStudents.length;
    const avgScore = studentAverages.length > 0 ? Math.round(studentAverages.reduce((a, b) => a + b) / studentAverages.length) : 0;
    const highScore = studentAverages.length > 0 ? Math.round(Math.max(...studentAverages)) : 0;
    const lowScore = studentAverages.length > 0 ? Math.round(Math.min(...studentAverages)) : 0;
    
    // Generate school report HTML
    elements.enhancedReportCard.innerHTML = `
      <div class="header-section">
        <div class="logo-row">
          <img src="/testing/skore-icon.jpg" alt="Skore Point" class="skore-logo">
          <img src="${currentSchool.logoUrl || '/testing/skore-icon.jpg'}" alt="School Logo" class="school-logo-large">
        </div>
        <div class="school-name">${currentSchool.name}</div>
        <div class="product-info">A product of SERUSOFT</div>
        <div class="report-title">SCHOOL PERFORMANCE REPORT - TERM 3</div>
      </div>
      
      <div class="student-info">
        <div class="student-details">
          <div><strong>Total Students:</strong> ${totalStudents}</div>
          <div><strong>Students Assessed:</strong> ${studentAverages.length}</div>
        </div>
        <div class="student-details">
          <div><strong>Term:</strong> End of Term 3</div>
          <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
        </div>
      </div>
      
      <h4 style="margin: 20px 0 10px; color: #4361ee;">School Statistics</h4>
      <table class="subject-table">
        <thead>
          <tr>
            <th>STATISTIC</th>
            <th>VALUE</th>
            <th>REMARKS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>School Average</td>
            <td>${avgScore}%</td>
            <td>${getPerformanceRemarks(avgScore)}</td>
          </tr>
          <tr>
            <td>Highest Average</td>
            <td>${highScore}%</td>
            <td>Outstanding</td>
          </tr>
          <tr>
            <td>Lowest Average</td>
            <td>${lowScore}%</td>
            <td>Needs Attention</td>
          </tr>
        </tbody>
      </table>
      
      <h4 style="margin: 30px 0 10px; color: #4361ee;">Class Performance</h4>
      <table class="subject-table">
        <thead>
          <tr>
            <th>CLASS</th>
            <th>AVERAGE SCORE</th>
            <th>STUDENTS ASSESSED</th>
            <th>PERFORMANCE</th>
          </tr>
        </thead>
        <tbody>
          ${currentClasses.map(classObj => {
            const averages = classAverages[classObj.id] || [];
            const classAverage = averages.length > 0 ? Math.round(averages.reduce((a, b) => a + b) / averages.length) : 0;
            const classStudents = currentStudents.filter(s => s.classId === classObj.id).length;
            return `
              <tr>
                <td>${classObj.name}</td>
                <td>${classAverage}%</td>
                <td>${averages.length}/${classStudents}</td>
                <td>${getPerformanceRemarks(classAverage)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      
      <div class="remarks-section">
        <h4>Head Teacher's Remarks:</h4>
        <div class="signature-line"></div>
      </div>
    `;
    
    // Show report
    elements.reportsEmptyState.classList.add('d-none');
    elements.reportPreview.classList.remove('d-none');
    elements.exportPDFBtn.classList.add('d-none');
    elements.exportExcelBtn.classList.remove('d-none');
  }

  // Export report card as PDF
  async function exportReportCard() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Add border
    doc.setDrawColor(67, 97, 238);
    doc.setLineWidth(2);
    doc.rect(5, 5, 200, 287);
    
    // Add Skore Point logo
    const skoreLogoUrl = '/testing/skore-icon.jpg';
    const schoolLogoUrl = currentSchool.logoUrl || '/testing/skore-icon.jpg';
    
    // Add logos
    doc.addImage(skoreLogoUrl, 'JPEG', 20, 15, 20, 20);
    doc.addImage(schoolLogoUrl, 'JPEG', 170, 15, 20, 20);
    
    // Add school name
    doc.setFontSize(18);
    doc.setTextColor(67, 97, 238);
    doc.text(currentSchool.name, 105, 25, { align: 'center' });
    
    // Add report title
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text('END OF TERM 3 STUDENT PROGRESS REPORT', 105, 35, { align: 'center' });
    
    // Get student info
    const studentId = elements.reportStudentSelect.value;
    const student = currentStudents.find(s => s.id === studentId);
    const classObj = currentClasses.find(c => c.id === student.classId);
    
    // Add student info
    doc.setFontSize(12);
    doc.text(`Student Name: ${student.name}`, 20, 50);
    doc.text(`Class: ${classObj ? classObj.name : 'N/A'}`, 20, 57);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 64);
    
    // Get marks data
    const term = elements.reportTermSelect.value;
    let marks = {};
    try {
      const marksDoc = await window.firebase.firestore.getDoc(
        window.firebase.firestore.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
      );
      
      if (marksDoc.exists()) {
        marks = marksDoc.data();
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
    
    // Prepare table data
    const tableData = [];
    let totalMarks = 0;
    let subjectCount = 0;
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        const grade = calculateGrade(score);
        tableData.push([subject.name, score.toString(), grade]);
        totalMarks += score;
        subjectCount++;
      }
    });
    
    if (tableData.length > 0) {
      // Add subjects table
      doc.autoTable({
        startY: 70,
        head: [['SUBJECT', 'SCORE', 'GRADE']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [67, 97, 238] },
        margin: { left: 20, right: 20 }
      });
      
      const finalY = doc.lastAutoTable.finalY + 10;
      
      // Calculate statistics
      const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
      const aggregate = calculateAggregate(marks);
      const division = calculateDivision(average);
      
      // Add summary table
      const summaryData = [
        ['TOTAL MARKS', 'AVERAGE MARK', 'AGGREGATES', 'FINAL GRADE/DIVISION'],
        [totalMarks.toString(), average.toString(), aggregate.toString(), division]
      ];
      
      doc.autoTable({
        startY: finalY,
        head: [summaryData[0]],
        body: [summaryData[1]],
        theme: 'grid',
        headStyles: { fillColor: [67, 97, 238] },
        margin: { left: 20, right: 20 }
      });
      
      const finalY2 = doc.lastAutoTable.finalY + 15;
      
      // Add remarks
      doc.setFontSize(12);
      doc.text('Class Teacher\'s Remarks:', 20, finalY2);
      doc.line(20, finalY2 + 5, 190, finalY2 + 5);
      doc.line(20, finalY2 + 10, 190, finalY2 + 10);
      
      doc.text('Head Teacher\'s Remarks:', 20, finalY2 + 20);
      doc.line(20, finalY2 + 25, 190, finalY2 + 25);
      
      doc.text('Next Term Begins On: ________________________________', 20, finalY2 + 35);
      
      // Add signatures
      const signatureY = finalY2 + 50;
      doc.line(30, signatureY, 80, signatureY);
      doc.text('Class Teacher Signature', 55, signatureY + 10, { align: 'center' });
      
      doc.line(110, signatureY, 160, signatureY);
      doc.text('Head Teacher Signature', 135, signatureY + 10, { align: 'center' });
      
      // Add school stamp
      doc.rect(175, signatureY - 5, 20, 20);
      doc.text('School Stamp', 185, signatureY + 25, { align: 'center' });
    }
    
    // Save PDF
    doc.save(`Report_Card_${student.name}_${new Date().toISOString().slice(0, 10)}.pdf`);
  }

  // Export class analysis as Excel
  async function exportClassAnalysis() {
    const classId = elements.reportClassSelect.value;
    const term = elements.reportTermSelect.value;
    const classObj = currentClasses.find(c => c.id === classId);
    
    // Get all students in class
    const classStudents = currentStudents.filter(s => s.classId === classId);
    
    // Prepare data
    const studentData = [];
    
    for (const student of classStudents) {
      let marks = {};
      try {
        const marksDoc = await window.firebase.firestore.getDoc(
          window.firebase.firestore.doc(window.firebase.db, 'marks', `${student.id}_${term}`)
        );
        
        if (marksDoc.exists()) {
          marks = marksDoc.data();
        }
      } catch (error) {
        console.error('Error loading marks:', error);
      }
      
      // Calculate student statistics
      let totalMarks = 0;
      let subjectCount = 0;
      const subjectScores = {};
      
      currentSubjects.forEach(subject => {
        const score = marks[subject.id];
        if (score !== undefined && score > 0) {
          subjectScores[subject.name] = score;
          totalMarks += score;
          subjectCount++;
        } else {
          subjectScores[subject.name] = 0;
        }
      });
      
      const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
      
      studentData.push({
        name: student.name,
        ...subjectScores,
        total: totalMarks,
        average: average,
        grade: calculateGrade(average)
      });
    }
    
    // Sort by average (descending)
    studentData.sort((a, b) => b.average - a.average);
    
    // Create workbook with multiple sheets
    const wb = XLSX.utils.book_new();
    
    // Sheet 1: Student Performance
    const performanceData = [
      ['CLASS PERFORMANCE ANALYSIS'],
      ['Class:', classObj ? classObj.name : 'N/A'],
      ['Term:', 'End of Term 3'],
      ['Date:', new Date().toLocaleDateString()],
      [''],
      ['STUDENT PERFORMANCE'],
      ['Rank', 'Student Name', ...currentSubjects.map(s => s.name), 'Total', 'Average', 'Grade', 'Remarks']
    ];
    
    studentData.forEach((student, index) => {
      performanceData.push([
        index + 1,
        student.name,
        ...currentSubjects.map(subject => student[subject.name] || 0),
        student.total,
        student.average,
        student.grade,
        getPerformanceRemarks(student.average)
      ]);
    });
    
    // Sheet 2: Grade Distribution
    const gradeDistribution = {};
    studentData.forEach(student => {
      const grade = student.grade;
      gradeDistribution[grade] = (gradeDistribution[grade] || 0) + 1;
    });
    
    const distributionData = [
      ['GRADE DISTRIBUTION ANALYSIS'],
      ['Grade', 'Count', 'Percentage%']
    ];
    
    const totalStudents = studentData.length;
    Object.entries(gradeDistribution).forEach(([grade, count]) => {
      const percentage = totalStudents > 0 ? Math.round((count / totalStudents) * 100) : 0;
      distributionData.push([grade, count, percentage]);
    });
    
    // Sheet 3: Statistics Summary
    const averages = studentData.map(s => s.average);
    const classAverage = averages.length > 0 ? Math.round(averages.reduce((a, b) => a + b) / averages.length) : 0;
    const highest = Math.max(...averages);
    const lowest = Math.min(...averages);
    
    const summaryData = [
      ['PERFORMANCE STATISTICS'],
      ['Statistic', 'Value'],
      ['Total Students', totalStudents],
      ['Class Average', classAverage],
      ['Highest Average', highest],
      ['Lowest Average', lowest],
      ['Students Above 80%', averages.filter(a => a >= 80).length],
      ['Students 60-79%', averages.filter(a => a >= 60 && a < 80).length],
      ['Students 40-59%', averages.filter(a => a >= 40 && a < 60).length],
      ['Students Below 40%', averages.filter(a => a < 40).length]
    ];
    
    // Create worksheets
    const ws1 = XLSX.utils.aoa_to_sheet(performanceData);
    const ws2 = XLSX.utils.aoa_to_sheet(distributionData);
    const ws3 = XLSX.utils.aoa_to_sheet(summaryData);
    
    // Set column widths
    const colWidths = [
      { wch: 10 },
      { wch: 25 },
      ...currentSubjects.map(() => ({ wch: 15 })),
      { wch: 10 },
      { wch: 10 },
      { wch: 10 },
      { wch: 20 }
    ];
    
    ws1['!cols'] = colWidths;
    ws2['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 15 }];
    ws3['!cols'] = [{ wch: 25 }, { wch: 15 }];
    
    // Add worksheets to workbook
    XLSX.utils.book_append_sheet(wb, ws1, 'Student Performance');
    XLSX.utils.book_append_sheet(wb, ws2, 'Grade Distribution');
    XLSX.utils.book_append_sheet(wb, ws3, 'Statistics');
    
    // Save the file
    const fileName = `${classObj ? classObj.name.replace(/\s+/g, '_') : 'Class'}_Analysis_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
  }

  // Calculate grade
  function calculateGrade(score) {
    if (score >= 90) return 'D1';
    if (score >= 80) return 'D2';
    if (score >= 70) return 'C3';
    if (score >= 60) return 'C4';
    if (score >= 50) return 'C5';
    if (score >= 40) return 'C6';
    if (score >= 30) return 'P7';
    if (score >= 20) return 'P8';
    return 'F9';
  }

  // Calculate aggregate
  function calculateAggregate(marks) {
    let totalPoints = 0;
    let subjectCount = 0;
    
    currentSubjects.forEach(subject => {
      const score = marks[subject.id];
      if (score !== undefined && score > 0) {
        const grade = calculateGrade(score);
        const gradePoints = {
          'D1': 1, 'D2': 2, 'C3': 3, 'C4': 4,
          'C5': 5, 'C6': 6, 'P7': 7, 'P8': 8, 'F9': 9
        }[grade] || 9;
        
        totalPoints += gradePoints;
        subjectCount++;
      }
    });
    
    return subjectCount > 0 ? totalPoints : 0;
  }

  // Calculate division
  function calculateDivision(average) {
    if (average >= 80) return 'Division 1';
    if (average >= 60) return 'Division 2';
    if (average >= 40) return 'Division 3';
    return 'Division 4';
  }

  // Get performance remarks
  function getPerformanceRemarks(average) {
    if (average >= 80) return 'Excellent';
    if (average >= 70) return 'Very Good';
    if (average >= 60) return 'Good';
    if (average >= 50) return 'Satisfactory';
    if (average >= 40) return 'Fair';
    return 'Needs Improvement';
  }

  // Handle logout
  async function handleLogout() {
    try {
      await window.firebase.authMethods.signOut(window.firebase.auth);
      currentUser = null;
      currentUserData = null;
      currentSchool = null;
      isSchoolPortalOpen = false;
      elements.mobileBottomNav.style.display = 'none';
      elements.mobileBottomNav.classList.remove('active');
      elements.portalExitBtn.style.display = 'none';
      showContainer('loginSection');
    } catch (error) {
      console.error('Error signing out:', error);
      alert('Error signing out. Please try again.');
    }
  }

  // Show user guide
  function showUserGuide() {
    alert(`Skore Point User Guide

GETTING STARTED:
1. Create a user account
2. Join an existing school or register a new one
3. Access the school portal to manage your data

FEATURES:
 Generate professional report cards with logos
 Export PDF reports with proper formatting
 Export Excel analysis with multiple sheets
 Grade distribution analysis
 Student ranking by performance

REPORT CARDS:
 Includes both Skore Point and school logos
 Professional border design
 Proper signature sections
 Grade and division calculations

EXCEL EXPORTS:
 Student Performance sheet with ranking
 Grade Distribution analysis
 Statistics summary
 Professional formatting

INSTALLATION:
 Install as PWA on any device
 Works offline
 Fast loading
 Native app experience

SUPPORT:
For assistance, contact your school administrator.`);
  }

  // Utility functions
  function showContainer(containerId) {
    document.querySelectorAll('.container').forEach(container => {
      container.classList.remove('active');
    });
    
    const container = document.getElementById(containerId);
    if (container) {
      container.classList.add('active');
    }
  }

  function hideLaunchScreen() {
    elements.launchScreen.style.display = 'none';
  }
</script>
</body>
</html>
